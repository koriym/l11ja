
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/koriym/laravel11-ja/billing.html">
      
      
        <link rel="prev" href="starter-kits.html">
      
      
        <link rel="next" href="cashier-paddle.html">
      
      
      <link rel="icon" href="assets/images/favicon_io/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.35">
    
    
      
        <title>Cashier (Stripe) - L11JA</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.35f28582.min.css">
      
      


    
    

    

    
      <link rel="stylesheet" href="assets/css/php.css">
    
      <link rel="stylesheet" href="assets/css/mkdocs_material_extra.css">
    
      <link rel="stylesheet" href="assets/css/extra.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-G60CEHXLQ1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-G60CEHXLQ1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-G60CEHXLQ1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    

  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#laravel-cashier-stripe" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <!-- Determine classes -->



<!-- Header -->
<header class="md-header" data-md-component="header">
  <nav
          class="md-header__inner md-grid"
          aria-label="Header"
  >

    <!-- Link to home -->
    <a
            href="."
            title="L11JA"
            class="md-header__button md-logo"
            aria-label="L11JA"
            data-md-component="logo"
    >
      
  <img src="assets/images/logo.png" alt="logo">

    </a>

    <!-- Button to open drawer -->
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            <span style="font-family: 'Noto Sans'; font-size: 20px" >
            L11JA
            </span>
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            <span style="font-family: 'Noto Sans Batak'; font-size: 20px" >
            
              Cashier (Stripe)
            
            </span>
          </span>
        </div>
      </div>
    </div>

    <!-- Color palette toggle -->
    

    <!-- User preference: color palette -->
    
    <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    

    <!-- Site language selector -->
    

    <!-- Button to open search modal -->
    
    <label class="md-header__button md-icon" for="__search">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
    </label>

    <!-- Search interface -->
    <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    

    <!-- Repository information -->
    
    <div class="md-header__source">
      

<!--
  Check whether the repository is hosted on one of the supported code hosting
  platforms (GitHub, GitLab or Bitbucket) to show icon.
-->


  


<!-- Repository containing source -->
<a href="https://github.com/koriym/l11ja" title="source.link.title"
    class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" fill="#000"/></svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
    
  </nav>

  <!-- Navigation tabs (sticky) -->
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="releases.html" class="md-tabs__link">
          
  
  プロローグ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="installation.html" class="md-tabs__link">
          
  
  はじめに

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="lifecycle.html" class="md-tabs__link">
          
  
  アーキテクチャ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="routing.html" class="md-tabs__link">
          
  
  基本

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="artisan.html" class="md-tabs__link">
          
  
  掘り下げる

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="authentication.html" class="md-tabs__link">
          
  
  セキュリティ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="database.html" class="md-tabs__link">
          
  
  データベース

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="eloquent.html" class="md-tabs__link">
          
  
  Eloquent ORM

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="testing.html" class="md-tabs__link">
          
  
  テスト

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="starter-kits.html" class="md-tabs__link">
          
  
  パッケージ

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="L11JA" class="md-nav__button md-logo" aria-label="L11JA" data-md-component="logo">
      
  <img src="assets/images/logo.png" alt="logo">

    </a>
    L11JA
  </label>
  
    <div class="md-nav__source">
      

<!--
  Check whether the repository is hosted on one of the supported code hosting
  platforms (GitHub, GitLab or Bitbucket) to show icon.
-->


  


<!-- Repository containing source -->
<a href="https://github.com/koriym/l11ja" title="source.link.title"
    class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" fill="#000"/></svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    プロローグ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            プロローグ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="releases.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リリースノート
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="upgrade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    アップグレードガイド
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="contributions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    貢献ガイド
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            はじめに
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="installation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    インストール
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="configuration.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    設定
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="structure.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ディレクトリ構造
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="frontend.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    フロントエンド
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="starter-kits.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    スターターキット
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="deployment.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    デプロイ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    アーキテクチャ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            アーキテクチャ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="lifecycle.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リクエストライフサイクル
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="container.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    サービスコンテナ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="providers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    サービスプロバイダ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="facades.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ファサード
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    基本
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            基本
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="routing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ルーティング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="middleware.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ミドルウェア
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="csrf.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSRF保護
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="controllers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コントローラ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="requests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リクエスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="responses.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    レスポンス
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="views.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ビュー
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="blade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bladeテンプレート
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="vite.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    アセットバンドル
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="urls.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    URL生成
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="session.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    セッション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="validation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    バリデーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="errors.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    エラー処理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="logging.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ログ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    掘り下げる
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            掘り下げる
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="artisan.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Artisanコンソール
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="broadcasting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ブロードキャスティング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cache.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    キャッシュ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="collections.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コレクション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="concurrency.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    並行処理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="context.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コンテキスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="contracts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コントラクト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="events.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    イベント
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="filesystem.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ファイルストレージ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="helpers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ヘルパー
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http-client.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTPクライアント
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="localization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ローカライゼーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mail.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    メール
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="notifications.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    通知
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="packages.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    パッケージ開発
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="processes.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    プロセス
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="queues.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    キュー
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="rate-limiting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    レート制限
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="strings.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文字列
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="scheduling.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    タスクスケジューリング
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    セキュリティ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            セキュリティ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="authentication.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    認証
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="authorization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    認可
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="verification.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    メール確認
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="encryption.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    暗号化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="hashing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ハッシュ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="passwords.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    パスワードリセット
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    データベース
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            データベース
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="database.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="queries.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    クエリビルダ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pagination.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ページネーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="migrations.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    マイグレーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="seeding.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    シーディング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="redis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Eloquent ORM
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Eloquent ORM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-relationships.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リレーションシップ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-collections.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コレクション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-mutators.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ミューテータ / キャスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-resources.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    APIリソース
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-serialization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    シリアライゼーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-factories.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ファクトリ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    テスト
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            テスト
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="testing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http-tests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTPテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="console-tests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コンソールテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dusk.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ブラウザテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="database-testing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    データベース
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mocking.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    モック
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="">
            
  
  <span class="md-ellipsis">
    パッケージ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            パッケージ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="starter-kits.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    スターターキット
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Cashier (Stripe)
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="billing.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Cashier (Stripe)
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      はじめに
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cashier" class="md-nav__link">
    <span class="md-ellipsis">
      Cashierのアップグレード
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      インストール
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      設定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      課金可能なモデル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      APIキー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      通貨設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      税金設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      ログ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      カスタムモデルの使用
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      クイックスタート
    </span>
  </a>
  
    <nav class="md-nav" aria-label="クイックスタート">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      商品の販売
    </span>
  </a>
  
    <nav class="md-nav" aria-label="商品の販売">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stripe-checkout" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe Checkoutにメタデータを提供する
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの販売
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの販売">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクライブ済みミドルウェアの構築
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      顧客が請求プランを管理できるようにする
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      顧客
    </span>
  </a>
  
    <nav class="md-nav" aria-label="顧客">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      顧客の取得
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      顧客の作成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      顧客の更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      残高
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id" class="md-nav__link">
    <span class="md-ellipsis">
      税ID
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stripe" class="md-nav__link">
    <span class="md-ellipsis">
      顧客データをStripeと同期する
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      請求ポータル
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法
    </span>
  </a>
  
    <nav class="md-nav" aria-label="支払い方法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の保存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="支払い方法の保存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのための支払い方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      単一請求のための支払い方法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の取得
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の存在確認
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      デフォルトの支払い方法の更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の追加
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の削除
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプション
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプション">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの作成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの作成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      請求書メールによる定期支払いの回収
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      数量
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      追加の詳細
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      クーポン
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの追加
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stripe_1" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe ダッシュボードからのサブスクリプションの作成
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションステータスの確認
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションステータスの確認">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      キャンセルされたサブスクリプションのステータス
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      不完全および過去のステータス
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのスコープ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      価格の変更
    </span>
  </a>
  
    <nav class="md-nav" aria-label="価格の変更">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      按分計算
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの数量
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの数量">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      複数の製品を持つサブスクリプションの数量
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      複数の製品を持つサブスクリプション
    </span>
  </a>
  
    <nav class="md-nav" aria-label="複数の製品を持つサブスクリプション">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      価格の入れ替え
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      日割り計算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      数量の更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションアイテム
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      複数のサブスクリプション
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    <span class="md-ellipsis">
      従量課金制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="従量課金制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    <span class="md-ellipsis">
      使用量の報告
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    <span class="md-ellipsis">
      使用量レコードの取得
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの税金
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの税金">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    <span class="md-ellipsis">
      税率の同期
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    <span class="md-ellipsis">
      税免除
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのアンカー日付
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのキャンセル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの再開
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの試用期間
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの試用期間">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    <span class="md-ellipsis">
      事前に支払い方法を収集する
    </span>
  </a>
  
    <nav class="md-nav" aria-label="事前に支払い方法を収集する">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stripe-cashier" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe / Cashierでの試用日数の定義
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    <span class="md-ellipsis">
      事前に支払い方法を収集しない
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    <span class="md-ellipsis">
      試用期間の延長
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stripe-webhook" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe Webhookの処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Stripe Webhookの処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#webhookscsrf" class="md-nav__link">
    <span class="md-ellipsis">
      WebhooksとCSRF保護
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webhook" class="md-nav__link">
    <span class="md-ellipsis">
      Webhookイベントハンドラの定義
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webhook_1" class="md-nav__link">
    <span class="md-ellipsis">
      Webhook署名の検証
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    <span class="md-ellipsis">
      一括請求
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一括請求">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    <span class="md-ellipsis">
      単一請求
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_65" class="md-nav__link">
    <span class="md-ellipsis">
      請求書付き請求
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_66" class="md-nav__link">
    <span class="md-ellipsis">
      支払いインテントの作成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_67" class="md-nav__link">
    <span class="md-ellipsis">
      返金
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_68" class="md-nav__link">
    <span class="md-ellipsis">
      請求書
    </span>
  </a>
  
    <nav class="md-nav" aria-label="請求書">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_69" class="md-nav__link">
    <span class="md-ellipsis">
      請求書の取得
    </span>
  </a>
  
    <nav class="md-nav" aria-label="請求書の取得">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_70" class="md-nav__link">
    <span class="md-ellipsis">
      請求書情報の表示
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_71" class="md-nav__link">
    <span class="md-ellipsis">
      今後の請求書
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_72" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプション請求書のプレビュー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pdf" class="md-nav__link">
    <span class="md-ellipsis">
      請求書PDFの生成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="請求書PDFの生成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_73" class="md-nav__link">
    <span class="md-ellipsis">
      カスタム請求書レンダラー
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_74" class="md-nav__link">
    <span class="md-ellipsis">
      チェックアウト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="チェックアウト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_75" class="md-nav__link">
    <span class="md-ellipsis">
      商品のチェックアウト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="商品のチェックアウト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_76" class="md-nav__link">
    <span class="md-ellipsis">
      プロモーションコード
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_77" class="md-nav__link">
    <span class="md-ellipsis">
      単発課金のチェックアウト
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_78" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのチェックアウト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションのチェックアウト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stripe-checkout_1" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe Checkoutとトライアル期間
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_79" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションとウェブフック
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id_1" class="md-nav__link">
    <span class="md-ellipsis">
      税IDの収集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_80" class="md-nav__link">
    <span class="md-ellipsis">
      ゲストチェックアウト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_81" class="md-nav__link">
    <span class="md-ellipsis">
      失敗した支払いの処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="失敗した支払いの処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_82" class="md-nav__link">
    <span class="md-ellipsis">
      支払いの確認
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_83" class="md-nav__link">
    <span class="md-ellipsis">
      強力な顧客認証
    </span>
  </a>
  
    <nav class="md-nav" aria-label="強力な顧客認証">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_84" class="md-nav__link">
    <span class="md-ellipsis">
      追加の確認を必要とする支払い
    </span>
  </a>
  
    <nav class="md-nav" aria-label="追加の確認を必要とする支払い">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_85" class="md-nav__link">
    <span class="md-ellipsis">
      不完全および遅延状態
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_86" class="md-nav__link">
    <span class="md-ellipsis">
      セッション外支払い通知
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stripe-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe SDK
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_87" class="md-nav__link">
    <span class="md-ellipsis">
      テスト
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cashier-paddle.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashier (Paddle)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dusk.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ブラウザテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="envoy.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Envoy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fortify.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fortify
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="folio.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Folio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="homestead.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Homestead
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="horizon.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Horizon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mix.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mix
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="octane.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Octane
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="passport.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Passport
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pennant.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pennant
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pint.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pint
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="precognition.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Precognition
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="prompts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prompts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pulse.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pulse
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="reverb.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reverb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sail.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sail
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sanctum.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sanctum
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="scout.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scout
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="socialite.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Socialite
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="telescope.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Telescope
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="valet.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Valet
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      はじめに
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cashier" class="md-nav__link">
    <span class="md-ellipsis">
      Cashierのアップグレード
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      インストール
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      設定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      課金可能なモデル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      APIキー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      通貨設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      税金設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      ログ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      カスタムモデルの使用
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      クイックスタート
    </span>
  </a>
  
    <nav class="md-nav" aria-label="クイックスタート">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      商品の販売
    </span>
  </a>
  
    <nav class="md-nav" aria-label="商品の販売">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stripe-checkout" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe Checkoutにメタデータを提供する
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの販売
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの販売">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクライブ済みミドルウェアの構築
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      顧客が請求プランを管理できるようにする
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      顧客
    </span>
  </a>
  
    <nav class="md-nav" aria-label="顧客">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      顧客の取得
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      顧客の作成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      顧客の更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      残高
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id" class="md-nav__link">
    <span class="md-ellipsis">
      税ID
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stripe" class="md-nav__link">
    <span class="md-ellipsis">
      顧客データをStripeと同期する
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      請求ポータル
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法
    </span>
  </a>
  
    <nav class="md-nav" aria-label="支払い方法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の保存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="支払い方法の保存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのための支払い方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      単一請求のための支払い方法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の取得
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の存在確認
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      デフォルトの支払い方法の更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の追加
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      支払い方法の削除
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプション
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプション">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの作成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの作成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      請求書メールによる定期支払いの回収
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      数量
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      追加の詳細
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      クーポン
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの追加
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stripe_1" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe ダッシュボードからのサブスクリプションの作成
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションステータスの確認
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションステータスの確認">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      キャンセルされたサブスクリプションのステータス
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      不完全および過去のステータス
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのスコープ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      価格の変更
    </span>
  </a>
  
    <nav class="md-nav" aria-label="価格の変更">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      按分計算
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの数量
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの数量">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      複数の製品を持つサブスクリプションの数量
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      複数の製品を持つサブスクリプション
    </span>
  </a>
  
    <nav class="md-nav" aria-label="複数の製品を持つサブスクリプション">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      価格の入れ替え
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      日割り計算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      数量の更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションアイテム
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      複数のサブスクリプション
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    <span class="md-ellipsis">
      従量課金制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="従量課金制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    <span class="md-ellipsis">
      使用量の報告
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    <span class="md-ellipsis">
      使用量レコードの取得
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの税金
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの税金">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    <span class="md-ellipsis">
      税率の同期
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    <span class="md-ellipsis">
      税免除
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのアンカー日付
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのキャンセル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの再開
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションの試用期間
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションの試用期間">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    <span class="md-ellipsis">
      事前に支払い方法を収集する
    </span>
  </a>
  
    <nav class="md-nav" aria-label="事前に支払い方法を収集する">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stripe-cashier" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe / Cashierでの試用日数の定義
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    <span class="md-ellipsis">
      事前に支払い方法を収集しない
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    <span class="md-ellipsis">
      試用期間の延長
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stripe-webhook" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe Webhookの処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Stripe Webhookの処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#webhookscsrf" class="md-nav__link">
    <span class="md-ellipsis">
      WebhooksとCSRF保護
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webhook" class="md-nav__link">
    <span class="md-ellipsis">
      Webhookイベントハンドラの定義
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#webhook_1" class="md-nav__link">
    <span class="md-ellipsis">
      Webhook署名の検証
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    <span class="md-ellipsis">
      一括請求
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一括請求">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    <span class="md-ellipsis">
      単一請求
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_65" class="md-nav__link">
    <span class="md-ellipsis">
      請求書付き請求
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_66" class="md-nav__link">
    <span class="md-ellipsis">
      支払いインテントの作成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_67" class="md-nav__link">
    <span class="md-ellipsis">
      返金
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_68" class="md-nav__link">
    <span class="md-ellipsis">
      請求書
    </span>
  </a>
  
    <nav class="md-nav" aria-label="請求書">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_69" class="md-nav__link">
    <span class="md-ellipsis">
      請求書の取得
    </span>
  </a>
  
    <nav class="md-nav" aria-label="請求書の取得">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_70" class="md-nav__link">
    <span class="md-ellipsis">
      請求書情報の表示
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_71" class="md-nav__link">
    <span class="md-ellipsis">
      今後の請求書
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_72" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプション請求書のプレビュー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pdf" class="md-nav__link">
    <span class="md-ellipsis">
      請求書PDFの生成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="請求書PDFの生成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_73" class="md-nav__link">
    <span class="md-ellipsis">
      カスタム請求書レンダラー
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_74" class="md-nav__link">
    <span class="md-ellipsis">
      チェックアウト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="チェックアウト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_75" class="md-nav__link">
    <span class="md-ellipsis">
      商品のチェックアウト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="商品のチェックアウト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_76" class="md-nav__link">
    <span class="md-ellipsis">
      プロモーションコード
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_77" class="md-nav__link">
    <span class="md-ellipsis">
      単発課金のチェックアウト
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_78" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションのチェックアウト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="サブスクリプションのチェックアウト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#stripe-checkout_1" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe Checkoutとトライアル期間
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_79" class="md-nav__link">
    <span class="md-ellipsis">
      サブスクリプションとウェブフック
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#id_1" class="md-nav__link">
    <span class="md-ellipsis">
      税IDの収集
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_80" class="md-nav__link">
    <span class="md-ellipsis">
      ゲストチェックアウト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_81" class="md-nav__link">
    <span class="md-ellipsis">
      失敗した支払いの処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="失敗した支払いの処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_82" class="md-nav__link">
    <span class="md-ellipsis">
      支払いの確認
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_83" class="md-nav__link">
    <span class="md-ellipsis">
      強力な顧客認証
    </span>
  </a>
  
    <nav class="md-nav" aria-label="強力な顧客認証">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_84" class="md-nav__link">
    <span class="md-ellipsis">
      追加の確認を必要とする支払い
    </span>
  </a>
  
    <nav class="md-nav" aria-label="追加の確認を必要とする支払い">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_85" class="md-nav__link">
    <span class="md-ellipsis">
      不完全および遅延状態
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_86" class="md-nav__link">
    <span class="md-ellipsis">
      セッション外支払い通知
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stripe-sdk" class="md-nav__link">
    <span class="md-ellipsis">
      Stripe SDK
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_87" class="md-nav__link">
    <span class="md-ellipsis">
      テスト
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/koriym/l11ja/edit/ja/billing.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="laravel-cashier-stripe">Laravel Cashier (Stripe)<a class="headerlink" href="#laravel-cashier-stripe" title="Permanent link">&para;</a></h1>
<ul>
<li><a href="#introduction">はじめに</a></li>
<li><a href="#upgrading-cashier">Cashierのアップグレード</a></li>
<li><a href="#installation">インストール</a></li>
<li><a href="#configuration">設定</a><ul>
<li><a href="#billable-model">課金可能なモデル</a></li>
<li><a href="#api-keys">APIキー</a></li>
<li><a href="#currency-configuration">通貨設定</a></li>
<li><a href="#tax-configuration">税金設定</a></li>
<li><a href="#logging">ログ</a></li>
<li><a href="#using-custom-models">カスタムモデルの使用</a></li>
</ul>
</li>
<li><a href="#quickstart">クイックスタート</a><ul>
<li><a href="#quickstart-selling-products">商品の販売</a></li>
<li><a href="#quickstart-selling-subscriptions">サブスクリプションの販売</a></li>
</ul>
</li>
<li><a href="#customers">顧客</a><ul>
<li><a href="#retrieving-customers">顧客の取得</a></li>
<li><a href="#creating-customers">顧客の作成</a></li>
<li><a href="#updating-customers">顧客の更新</a></li>
<li><a href="#balances">残高</a></li>
<li><a href="#tax-ids">税金ID</a></li>
<li><a href="#syncing-customer-data-with-stripe">顧客データのStripeとの同期</a></li>
<li><a href="#billing-portal">請求ポータル</a></li>
</ul>
</li>
<li><a href="#payment-methods">支払い方法</a><ul>
<li><a href="#storing-payment-methods">支払い方法の保存</a></li>
<li><a href="#retrieving-payment-methods">支払い方法の取得</a></li>
<li><a href="#payment-method-presence">支払い方法の存在確認</a></li>
<li><a href="#updating-the-default-payment-method">デフォルトの支払い方法の更新</a></li>
<li><a href="#adding-payment-methods">支払い方法の追加</a></li>
<li><a href="#deleting-payment-methods">支払い方法の削除</a></li>
</ul>
</li>
<li><a href="#subscriptions">サブスクリプション</a><ul>
<li><a href="#creating-subscriptions">サブスクリプションの作成</a></li>
<li><a href="#checking-subscription-status">サブスクリプションのステータス確認</a></li>
<li><a href="#changing-prices">価格の変更</a></li>
<li><a href="#subscription-quantity">サブスクリプションの数量</a></li>
<li><a href="#subscriptions-with-multiple-products">複数商品のサブスクリプション</a></li>
<li><a href="#multiple-subscriptions">複数のサブスクリプション</a></li>
<li><a href="#metered-billing">従量課金</a></li>
<li><a href="#subscription-taxes">サブスクリプションの税金</a></li>
<li><a href="#subscription-anchor-date">サブスクリプションのアンカー日</a></li>
<li><a href="#cancelling-subscriptions">サブスクリプションのキャンセル</a></li>
<li><a href="#resuming-subscriptions">サブスクリプションの再開</a></li>
</ul>
</li>
<li><a href="#subscription-trials">サブスクリプションのトライアル</a><ul>
<li><a href="#with-payment-method-up-front">事前に支払い方法を登録</a></li>
<li><a href="#without-payment-method-up-front">事前に支払い方法を登録しない</a></li>
<li><a href="#extending-trials">トライアル期間の延長</a></li>
</ul>
</li>
<li><a href="#handling-stripe-webhooks">Stripe Webhookの処理</a><ul>
<li><a href="#defining-webhook-event-handlers">Webhookイベントハンドラの定義</a></li>
<li><a href="#verifying-webhook-signatures">Webhook署名の検証</a></li>
</ul>
</li>
<li><a href="#single-charges">一括支払い</a><ul>
<li><a href="#simple-charge">シンプルな支払い</a></li>
<li><a href="#charge-with-invoice">請求書付きの支払い</a></li>
<li><a href="#creating-payment-intents">支払いインテントの作成</a></li>
<li><a href="#refunding-charges">支払いの返金</a></li>
</ul>
</li>
<li><a href="#checkout">チェックアウト</a><ul>
<li><a href="#product-checkouts">商品のチェックアウト</a></li>
<li><a href="#single-charge-checkouts">一括支払いのチェックアウト</a></li>
<li><a href="#subscription-checkouts">サブスクリプションのチェックアウト</a></li>
<li><a href="#collecting-tax-ids">税金IDの収集</a></li>
<li><a href="#guest-checkouts">ゲストチェックアウト</a></li>
</ul>
</li>
<li><a href="#invoices">請求書</a><ul>
<li><a href="#retrieving-invoices">請求書の取得</a></li>
<li><a href="#upcoming-invoices">次回の請求書</a></li>
<li><a href="#previewing-subscription-invoices">サブスクリプション請求書のプレビュー</a></li>
<li><a href="#generating-invoice-pdfs">請求書PDFの生成</a></li>
</ul>
</li>
<li><a href="#handling-failed-payments">失敗した支払いの処理</a><ul>
<li><a href="#confirming-payments">支払いの確認</a></li>
</ul>
</li>
<li><a href="#strong-customer-authentication">強力な顧客認証 (SCA)</a><ul>
<li><a href="#payments-requiring-additional-confirmation">追加確認が必要な支払い</a></li>
<li><a href="#off-session-payment-notifications">セッション外の支払い通知</a></li>
</ul>
</li>
<li><a href="#stripe-sdk">Stripe SDK</a></li>
<li><a href="#testing">テスト</a></li>
</ul>
<p><a name="introduction"></a></p>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p><a href="https://github.com/laravel/cashier-stripe">Laravel Cashier Stripe</a> は、<a href="https://stripe.com">Stripe</a> のサブスクリプション課金サービスに対して、表現力豊かで流暢なインターフェースを提供します。サブスクリプション課金コードのほとんどの定型コードを処理します。サブスクリプション管理に加えて、Cashierはクーポン、サブスクリプションの切り替え、サブスクリプションの「数量」、キャンセル猶予期間、さらには請求書のPDF生成まで処理できます。</p>
<p><a name="upgrading-cashier"></a></p>
<h2 id="cashier">Cashierのアップグレード<a class="headerlink" href="#cashier" title="Permanent link">&para;</a></h2>
<p>Cashierを新しいバージョンにアップグレードする際には、<a href="https://github.com/laravel/cashier-stripe/blob/master/UPGRADE.md">アップグレードガイド</a>を注意深く確認することが重要です。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>重大な変更を防ぐために、Cashierは固定のStripe APIバージョンを使用します。Cashier 15はStripe APIバージョン <code>2023-10-16</code> を使用しています。Stripe APIバージョンは、新しいStripe機能と改善を利用するためにマイナーリリースで更新されます。</p>
</div>
<p><a name="installation"></a></p>
<h2 id="_2">インストール<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>まず、Composerパッケージマネージャを使用してStripe用のCashierパッケージをインストールします:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>composer<span class="w"> </span>require<span class="w"> </span>laravel/cashier
</code></pre></div>
<p>パッケージをインストールした後、<code>vendor:publish</code> Artisanコマンドを使用してCashierのマイグレーションを公開します:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>vendor:publish<span class="w"> </span>--tag<span class="o">=</span><span class="s2">&quot;cashier-migrations&quot;</span>
</code></pre></div>
<p>次に、データベースをマイグレートします:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>migrate
</code></pre></div>
<p>Cashierのマイグレーションにより、<code>users</code>テーブルにいくつかのカラムが追加されます。また、すべての顧客のサブスクリプションを保持するための新しい<code>subscriptions</code>テーブルと、複数の価格を持つサブスクリプションのための<code>subscription_items</code>テーブルが作成されます。</p>
<p>必要に応じて、<code>vendor:publish</code> Artisanコマンドを使用してCashierの設定ファイルを公開することもできます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>vendor:publish<span class="w"> </span>--tag<span class="o">=</span><span class="s2">&quot;cashier-config&quot;</span>
</code></pre></div>
<p>最後に、CashierがすべてのStripeイベントを適切に処理できるように、<a href="#handling-stripe-webhooks">CashierのWebhook処理の設定</a>を忘れずに行ってください。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Stripeは、Stripe識別子を格納するために使用されるカラムが大文字と小文字を区別することを推奨しています。したがって、MySQLを使用する場合は、<code>stripe_id</code>カラムの照合順序が<code>utf8_bin</code>に設定されていることを確認してください。これに関する詳細情報は、<a href="https://stripe.com/docs/upgrades#what-changes-does-stripe-consider-to-be-backwards-compatible">Stripeのドキュメント</a>で確認できます。</p>
</div>
<p><a name="configuration"></a></p>
<h2 id="_3">設定<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p><a name="billable-model"></a></p>
<h3 id="_4">課金可能なモデル<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>Cashierを使用する前に、課金可能なモデル定義に<code>Billable</code>トレイトを追加してください。通常、これは<code>App\Models\User</code>モデルになります。このトレイトは、サブスクリプションの作成、クーポンの適用、支払い方法情報の更新など、一般的な課金タスクを実行するためのさまざまなメソッドを提供します:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Laravel\Cashier\Billable</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Authenticatable</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">Billable</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Cashierは、課金可能なモデルがLaravelに付属の<code>App\Models\User</code>クラスであると想定しています。これを変更したい場合は、<code>useCustomerModel</code>メソッドを介して別のモデルを指定できます。このメソッドは通常、<code>AppServiceProvider</code>クラスの<code>boot</code>メソッドで呼び出されます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Cashier\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Laravel\Cashier\Cashier</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * 任意のアプリケーションサービスのブートストラップ</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nx">Cashier</span><span class="o">::</span><span class="na">useCustomerModel</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Laravelの提供する<code>App\Models\User</code>モデル以外のモデルを使用する場合は、<a href="#installation">Cashierのマイグレーション</a>を公開し、代替モデルのテーブル名に合わせて変更する必要があります。</p>
</div>
<p><a name="api-keys"></a></p>
<h3 id="api">APIキー<a class="headerlink" href="#api" title="Permanent link">&para;</a></h3>
<p>次に、アプリケーションの<code>.env</code>ファイルでStripe APIキーを設定する必要があります。StripeコントロールパネルからStripe APIキーを取得できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="na">STRIPE_KEY</span><span class="o">=</span><span class="s">your-stripe-key</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="na">STRIPE_SECRET</span><span class="o">=</span><span class="s">your-stripe-secret</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="na">STRIPE_WEBHOOK_SECRET</span><span class="o">=</span><span class="s">your-stripe-webhook-secret</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>アプリケーションの<code>.env</code>ファイルで<code>STRIPE_WEBHOOK_SECRET</code>環境変数を定義して、受信するWebhookが実際にStripeからのものであることを確認する必要があります。</p>
</div>
<p><a name="currency-configuration"></a></p>
<h3 id="_5">通貨設定<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>Cashierのデフォルト通貨は米ドル（USD）です。アプリケーションの<code>.env</code>ファイル内で<code>CASHIER_CURRENCY</code>環境変数を設定することで、デフォルト通貨を変更できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="na">CASHIER_CURRENCY</span><span class="o">=</span><span class="s">eur</span>
</code></pre></div>
<p>Cashierの通貨を設定するだけでなく、請求書に表示される金額の書式設定に使用されるロケールを指定することもできます。内部では、Cashierは<a href="https://www.php.net/manual/en/class.numberformatter.php">PHPの<code>NumberFormatter</code>クラス</a>を使用して通貨ロケールを設定します:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="na">CASHIER_CURRENCY_LOCALE</span><span class="o">=</span><span class="s">nl_BE</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>en</code>以外のロケールを使用するには、<code>ext-intl</code> PHP拡張機能がサーバーにインストールおよび設定されていることを確認してください。</p>
</div>
<p><a name="tax-configuration"></a></p>
<h3 id="_6">税金設定<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p><a href="https://stripe.com/tax">Stripe Tax</a>のおかげで、Stripeによって生成されるすべての請求書に対して自動的に税金を計算することが可能です。アプリケーションの<code>App\Providers\AppServiceProvider</code>クラスの<code>boot</code>メソッドで<code>calculateTaxes</code>メソッドを呼び出すことで、自動税金計算を有効にできます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Laravel\Cashier\Cashier</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * 任意のアプリケーションサービスのブートストラップ</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nx">Cashier</span><span class="o">::</span><span class="na">calculateTaxes</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>税金計算が有効になると、新しいサブスクリプションと生成される一括請求書に対して自動税金計算が行われます。</p>
<p>この機能が正しく機能するためには、顧客の請求詳細（顧客の名前、住所、税金IDなど）をStripeに同期する必要があります。Cashierが提供する<a href="#syncing-customer-data-with-stripe">顧客データの同期</a>と<a href="#tax-ids">税金ID</a>のメソッドを使用してこれを実現できます。</p>
<p><a name="logging"></a></p>
<h3 id="_7">ログ<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>Cashierでは、致命的なStripeエラーのログに使用されるログチャネルを指定できます。アプリケーションの<code>.env</code>ファイル内で<code>CASHIER_LOGGER</code>環境変数を定義することで、ログチャネルを指定できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="na">CASHIER_LOGGER</span><span class="o">=</span><span class="s">stack</span>
</code></pre></div>
<p>StripeへのAPI呼び出しで生成される例外は、アプリケーションのデフォルトのログチャネルを通じてログに記録されます。</p>
<p><a name="using-custom-models"></a></p>
<h3 id="_8">カスタムモデルの使用<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>自分のモデルを定義し、対応するCashierモデルを拡張することで、Cashierが内部的に使用するモデルを自由に拡張できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">use</span> <span class="nx">Laravel\Cashier\Subscription</span> <span class="k">as</span> <span class="nx">CashierSubscription</span><span class="p">;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="k">class</span> <span class="nc">Subscription</span> <span class="k">extends</span> <span class="nx">CashierSubscription</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="p">{</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="c1">// ...</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="p">}</span>
</code></pre></div>
<p>モデルを定義した後、<code>Laravel\Cashier\Cashier</code>クラスを介してカスタムモデルを使用するようにCashierに指示できます。通常、アプリケーションの<code>App\Providers\AppServiceProvider</code>クラスの<code>boot</code>メソッドでCashierにカスタムモデルについて通知する必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">use</span> <span class="nx">App\Models\Cashier\Subscription</span><span class="p">;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">use</span> <span class="nx">App\Models\Cashier\SubscriptionItem</span><span class="p">;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="sd">/**</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="sd"> * Bootstrap any application services.</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="sd"> */</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="p">{</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>    <span class="nx">Cashier</span><span class="o">::</span><span class="na">useSubscriptionModel</span><span class="p">(</span><span class="nx">Subscription</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a>    <span class="nx">Cashier</span><span class="o">::</span><span class="na">useSubscriptionItemModel</span><span class="p">(</span><span class="nx">SubscriptionItem</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="p">}</span>
</code></pre></div>
<p><a name="quickstart"></a></p>
<h2 id="_9">クイックスタート<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p><a name="quickstart-selling-products"></a></p>
<h3 id="_10">商品の販売<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Stripe Checkoutを利用する前に、Stripeダッシュボードで固定価格の商品を定義する必要があります。さらに、<a href="#handling-stripe-webhooks">CashierのWebhook処理を設定</a>する必要があります。</p>
</div>
<p>アプリケーションを通じて商品やサブスクリプションの請求を行うことは、難しい場合があります。しかし、Cashierと<a href="https://stripe.com/payments/checkout">Stripe Checkout</a>のおかげで、現代で堅牢な支払いの統合を簡単に構築できます。</p>
<p>顧客に非定期的な、一括払いの商品を請求するために、Cashierを使用して顧客をStripe Checkoutにリダイレクトし、そこで支払い詳細を提供し、購入を確認します。支払いがCheckoutを通じて行われると、顧客はアプリケーション内で選択した成功URLにリダイレクトされます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>    <span class="nv">$stripePriceId</span> <span class="o">=</span> <span class="s1">&#39;price_deluxe_album&#39;</span><span class="p">;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="nv">$quantity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkout</span><span class="p">([</span><span class="nv">$stripePriceId</span> <span class="o">=&gt;</span> <span class="nv">$quantity</span><span class="p">],</span> <span class="p">[</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>        <span class="s1">&#39;success_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;checkout-success&#39;</span><span class="p">),</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>        <span class="s1">&#39;cancel_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;checkout-cancel&#39;</span><span class="p">),</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="p">]);</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;checkout&#39;</span><span class="p">);</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="nx">Route</span><span class="o">::</span><span class="na">view</span><span class="p">(</span><span class="s1">&#39;/checkout/success&#39;</span><span class="p">,</span> <span class="s1">&#39;checkout.success&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;checkout-success&#39;</span><span class="p">);</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="nx">Route</span><span class="o">::</span><span class="na">view</span><span class="p">(</span><span class="s1">&#39;/checkout/cancel&#39;</span><span class="p">,</span> <span class="s1">&#39;checkout.cancel&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;checkout-cancel&#39;</span><span class="p">);</span>
</code></pre></div>
<p>上記の例でわかるように、指定された「価格識別子」に対して顧客をStripe Checkoutにリダイレクトするために、Cashierが提供する<code>checkout</code>メソッドを使用します。Stripeを使用する場合、「価格」は<a href="https://stripe.com/docs/products-prices/how-products-and-prices-work">特定の商品の定義された価格</a>を指します。</p>
<p>必要に応じて、<code>checkout</code>メソッドは自動的にStripeに顧客を作成し、そのStripe顧客レコードをアプリケーションのデータベース内の対応するユーザーに接続します。チェックアウトセッションが完了すると、顧客は専用の成功またはキャンセルページにリダイレクトされ、そこで情報メッセージを表示できます。</p>
<p><a name="providing-meta-data-to-stripe-checkout"></a></p>
<h4 id="stripe-checkout">Stripe Checkoutにメタデータを提供する<a class="headerlink" href="#stripe-checkout" title="Permanent link">&para;</a></h4>
<p>商品を販売する際、アプリケーションで定義された<code>Cart</code>や<code>Order</code>モデルを介して完了した注文や購入した商品を追跡するのが一般的です。顧客をStripe Checkoutにリダイレクトして購入を完了させる際、既存の注文識別子を提供して、顧客がアプリケーションに戻った際に対応する注文と購入を関連付ける必要がある場合があります。</p>
<p>これを実現するために、<code>checkout</code>メソッドに<code>metadata</code>の配列を提供できます。顧客がチェックアウトプロセスを開始すると、保留中の<code>Order</code>がアプリケーション内に作成されると想像してください。この例の<code>Cart</code>と<code>Order</code>モデルは説明のためのものであり、Cashierによって提供されるものではありません。独自のアプリケーションのニーズに基づいてこれらの概念を自由に実装できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">use</span> <span class="nx">App\Models\Cart</span><span class="p">;</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">use</span> <span class="nx">App\Models\Order</span><span class="p">;</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/cart/{cart}/checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">Cart</span> <span class="nv">$cart</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>    <span class="nv">$order</span> <span class="o">=</span> <span class="nx">Order</span><span class="o">::</span><span class="na">create</span><span class="p">([</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>        <span class="s1">&#39;cart_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>        <span class="s1">&#39;price_ids&#39;</span> <span class="o">=&gt;</span> <span class="nv">$cart</span><span class="o">-&gt;</span><span class="na">price_ids</span><span class="p">,</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>        <span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;incomplete&#39;</span><span class="p">,</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="p">]);</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkout</span><span class="p">(</span><span class="nv">$order</span><span class="o">-&gt;</span><span class="na">price_ids</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="s1">&#39;success_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;checkout-success&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;?session_id={CHECKOUT_SESSION_ID}&#39;</span><span class="p">,</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="s1">&#39;cancel_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;checkout-cancel&#39;</span><span class="p">),</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="s1">&#39;metadata&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;order_id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">],</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>    <span class="p">]);</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;checkout&#39;</span><span class="p">);</span>
</code></pre></div>
<p>上記の例でわかるように、顧客がチェックアウトプロセスを開始すると、カート/注文に関連するすべてのStripe価格識別子を<code>checkout</code>メソッドに提供します。もちろん、これらのアイテムを顧客が追加する際に「ショッピングカート」または注文に関連付けるのはアプリケーションの責任です。また、<code>metadata</code>配列を介して注文のIDをStripe Checkoutセッションに提供します。最後に、Checkout成功ルートに<code>CHECKOUT_SESSION_ID</code>テンプレート変数を追加しました。Stripeが顧客をアプリケーションにリダイレクトする際、このテンプレート変数は自動的にCheckoutセッションIDで埋められます。</p>
<p>次に、Checkout成功ルートを構築しましょう。これは、顧客がStripe Checkoutを通じて購入を完了した後にリダイレクトされるルートです。このルート内で、Stripe CheckoutセッションIDと関連するStripe Checkoutインスタンスを取得し、提供されたメタデータにアクセスして顧客の注文を適切に更新できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">use</span> <span class="nx">App\Models\Order</span><span class="p">;</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="k">use</span> <span class="nx">Laravel\Cashier\Cashier</span><span class="p">;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/checkout/success&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>    <span class="nv">$sessionId</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">);</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$sessionId</span> <span class="o">===</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>        <span class="k">return</span><span class="p">;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>    <span class="p">}</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>    <span class="nv">$session</span> <span class="o">=</span> <span class="nx">Cashier</span><span class="o">::</span><span class="na">stripe</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkout</span><span class="o">-&gt;</span><span class="na">sessions</span><span class="o">-&gt;</span><span class="na">retrieve</span><span class="p">(</span><span class="nv">$sessionId</span><span class="p">);</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$session</span><span class="o">-&gt;</span><span class="na">payment_status</span> <span class="o">!==</span> <span class="s1">&#39;paid&#39;</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>        <span class="k">return</span><span class="p">;</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    <span class="p">}</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>    <span class="nv">$orderId</span> <span class="o">=</span> <span class="nv">$session</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;order_id&#39;</span><span class="p">]</span> <span class="o">??</span> <span class="k">null</span><span class="p">;</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>    <span class="nv">$order</span> <span class="o">=</span> <span class="nx">Order</span><span class="o">::</span><span class="na">findOrFail</span><span class="p">(</span><span class="nv">$orderId</span><span class="p">);</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>    <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">update</span><span class="p">([</span><span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;completed&#39;</span><span class="p">]);</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a>    <span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">&#39;checkout-success&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;order&#39;</span> <span class="o">=&gt;</span> <span class="nv">$order</span><span class="p">]);</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;checkout-success&#39;</span><span class="p">);</span>
</code></pre></div>
<p>Checkoutセッションオブジェクトに含まれるデータの詳細については、Stripeのドキュメントを参照してください。</p>
<p><a name="quickstart-selling-subscriptions"></a></p>
<h3 id="_11">サブスクリプションの販売<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Stripe Checkoutを利用する前に、Stripeダッシュボードで固定価格の商品を定義する必要があります。さらに、<a href="#handling-stripe-webhooks">CashierのWebhook処理を設定</a>する必要があります。</p>
</div>
<p>アプリケーションを通じて商品やサブスクリプションの請求を行うことは、難しい場合があります。しかし、Cashierと<a href="https://stripe.com/payments/checkout">Stripe Checkout</a>のおかげで、現代で堅牢な支払いの統合を簡単に構築できます。</p>
<p>CashierとStripe Checkoutを使用してサブスクリプションを販売する方法を学ぶために、基本的な月次（<code>price_basic_monthly</code>）と年次（<code>price_basic_yearly</code>）のプランを持つサブスクリプションサービスのシンプルなシナリオを考えてみましょう。これらの2つの価格は、Stripeダッシュボードで「Basic」商品（<code>pro_basic</code>）の下にグループ化される可能性があります。さらに、サブスクリプションサービスは<code>pro_expert</code>としてExpertプランを提供するかもしれません。</p>
<p>まず、顧客がサービスにサブスクライブする方法を見てみましょう。もちろん、顧客はアプリケーションの価格ページでBasicプランの「サブスクライブ」ボタンをクリックする可能性があります。このボタンまたはリンクは、選択したプランのStripe Checkoutセッションを作成するLaravelルートにユーザーを誘導する必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/subscription-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>        <span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_basic_monthly&#39;</span><span class="p">)</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>        <span class="o">-&gt;</span><span class="na">trialDays</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>        <span class="o">-&gt;</span><span class="na">allowPromotionCodes</span><span class="p">()</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>        <span class="o">-&gt;</span><span class="na">checkout</span><span class="p">([</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>            <span class="s1">&#39;success_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-success-route&#39;</span><span class="p">),</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>            <span class="s1">&#39;cancel_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-cancel-route&#39;</span><span class="p">),</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>        <span class="p">]);</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="p">});</span>
</code></pre></div>
<p>上記の例でわかるように、顧客をBasicプランにサブスクライブさせるために、Stripe Checkoutセッションにリダイレクトします。チェックアウトが成功またはキャンセルされると、顧客は<code>checkout</code>メソッドに提供したURLにリダイレクトされます。サブスクリプションが実際に開始された時点を知るために（一部の支払い方法は処理に数秒かかるため）、<a href="#handling-stripe-webhooks">CashierのWebhook処理を設定</a>する必要もあります。</p>
<p>顧客がサブスクリプションを開始できるようになったので、アプリケーションの一部をサブスクライブしたユーザーのみがアクセスできるように制限する必要があります。もちろん、Cashierの<code>Billable</code>トレイトが提供する<code>subscribed</code>メソッドを介してユーザーの現在のサブスクリプションステータスを常に確認できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="x">@if ($user-&gt;subscribed())</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="x">    &lt;p&gt;You are subscribed.&lt;/p&gt;</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="x">@endif</span>
</code></pre></div>
<p>特定の商品または価格にサブスクライブしているかどうかを簡単に確認することもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="x">@if ($user-&gt;subscribedToProduct(&#39;pro_basic&#39;))</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="x">    &lt;p&gt;You are subscribed to our Basic product.&lt;/p&gt;</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="x">@endif</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="x">@if ($user-&gt;subscribedToPrice(&#39;price_basic_monthly&#39;))</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="x">    &lt;p&gt;You are subscribed to our monthly Basic plan.&lt;/p&gt;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="x">@endif</span>
</code></pre></div>
<p><a name="quickstart-building-a-subscribed-middleware"></a></p>
<h4 id="_12">サブスクライブ済みミドルウェアの構築<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>便宜上、受信リクエストがサブスクライブしたユーザーからのものであるかどうかを判断する<a href="middleware.html">ミドルウェア</a>を作成したい場合があります。このミドルウェアを定義したら、サブスクライブしていないユーザーがルートにアクセスできないように、ルートに簡単に割り当てることができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="k">namespace</span> <span class="nx">App\Http\Middleware</span><span class="p">;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="k">use</span> <span class="nx">Closure</span><span class="p">;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="k">class</span> <span class="nc">Subscribed</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="p">{</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">Closure</span> <span class="nv">$next</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a>    <span class="p">{</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">subscribed</span><span class="p">())</span> <span class="p">{</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>            <span class="c1">// このユーザーはサブスクライブしていません。</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a>            <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;subscribe&#39;</span><span class="p">);</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>        <span class="p">}</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>        <span class="k">return</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a>    <span class="p">}</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">class</span> <span class="nc">Subscribed</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="p">{</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>    <span class="sd">/**</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="sd">     * Handle an incoming request.</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="sd">     */</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">Closure</span> <span class="nv">$next</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="p">{</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">?-&gt;</span><span class="na">subscribed</span><span class="p">())</span> <span class="p">{</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>            <span class="c1">// Redirect user to billing page and ask them to subscribe...</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>            <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/billing&#39;</span><span class="p">);</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>        <span class="p">}</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>        <span class="k">return</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="p">}</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="p">}</span>
</code></pre></div>
<p>ミドルウェアが定義されたら、ルートに割り当てることができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">use</span> <span class="nx">App\Http\Middleware\Subscribed</span><span class="p">;</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/dashboard&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>    <span class="c1">// ...</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">([</span><span class="nx">Subscribed</span><span class="o">::</span><span class="na">class</span><span class="p">]);</span>
</code></pre></div>
<p><a name="quickstart-allowing-customers-to-manage-their-billing-plan"></a></p>
<h4 id="_13">顧客が請求プランを管理できるようにする<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>もちろん、顧客は別の製品や「階層」にサブスクリプションプランを変更したいと思うかもしれません。これを許可する最も簡単な方法は、顧客をStripeの<a href="https://stripe.com/docs/no-code/customer-portal">Customer Billing Portal</a>に誘導することです。これは、顧客が請求書をダウンロードしたり、支払い方法を更新したり、サブスクリプションプランを変更したりできるホストされたユーザーインターフェースを提供します。</p>
<p>まず、ユーザーをBilling Portalセッションを開始するために使用するLaravelルートに誘導するアプリケーション内にリンクまたはボタンを定義します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="x">&lt;a href=&quot;{{ route(&#39;billing&#39;) }}&quot;&gt;</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="x">    Billing</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="x">&lt;/a&gt;</span>
</code></pre></div>
<p>次に、Stripe Customer Billing Portalセッションを開始し、ユーザーをPortalにリダイレクトするルートを定義しましょう。<code>redirectToBillingPortal</code>メソッドは、ユーザーがPortalを終了したときに戻るべきURLを受け取ります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/billing&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">redirectToBillingPortal</span><span class="p">(</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">));</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">([</span><span class="s1">&#39;auth&#39;</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;billing&#39;</span><span class="p">);</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CashierのWebhook処理を設定している限り、CashierはStripeからの着信Webhookを調査することで、アプリケーションのCashier関連のデータベーステーブルを自動的に同期させます。したがって、例えば、ユーザーがStripeのCustomer Billing Portalを介してサブスクリプションをキャンセルした場合、Cashierは対応するWebhookを受け取り、アプリケーションのデータベースでサブスクリプションを「キャンセル済み」とマークします。</p>
</div>
<p><a name="customers"></a></p>
<h2 id="_14">顧客<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h2>
<p><a name="retrieving-customers"></a></p>
<h3 id="_15">顧客の取得<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p><code>Cashier::findBillable</code>メソッドを使用して、Stripe IDで顧客を取得できます。このメソッドは、課金可能なモデルのインスタンスを返します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">use</span> <span class="nx">Laravel\Cashier\Cashier</span><span class="p">;</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="nv">$user</span> <span class="o">=</span> <span class="nx">Cashier</span><span class="o">::</span><span class="na">findBillable</span><span class="p">(</span><span class="nv">$stripeId</span><span class="p">);</span>
</code></pre></div>
<p><a name="creating-customers"></a></p>
<h3 id="_16">顧客の作成<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>場合によっては、サブスクリプションを開始せずにStripe顧客を作成したいことがあります。これは、<code>createAsStripeCustomer</code>メソッドを使用して行うことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="nv">$stripeCustomer</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">createAsStripeCustomer</span><span class="p">();</span>
</code></pre></div>
<p>顧客がStripeで作成されたら、後でサブスクリプションを開始できます。Stripe APIがサポートする追加の<a href="https://stripe.com/docs/api/customers/create">顧客作成パラメータ</a>を渡すために、オプションの<code>$options</code>配列を提供することもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="nv">$stripeCustomer</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">createAsStripeCustomer</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</code></pre></div>
<p>課金可能なモデルのStripe顧客オブジェクトを返したい場合は、<code>asStripeCustomer</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nv">$stripeCustomer</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">asStripeCustomer</span><span class="p">();</span>
</code></pre></div>
<p>指定された課金可能なモデルのStripe顧客オブジェクトを取得したいが、そのモデルがすでにStripe内の顧客であるかどうかわからない場合は、<code>createOrGetStripeCustomer</code>メソッドを使用できます。このメソッドは、Stripeにまだ顧客が存在しない場合、新しい顧客を作成します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nv">$stripeCustomer</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">createOrGetStripeCustomer</span><span class="p">();</span>
</code></pre></div>
<p><a name="updating-customers"></a></p>
<h3 id="_17">顧客の更新<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>場合によっては、追加情報を使用してStripe顧客を直接更新したいことがあります。これは、<code>updateStripeCustomer</code>メソッドを使用して行うことができます。このメソッドは、<a href="https://stripe.com/docs/api/customers/update">Stripe APIがサポートする顧客更新オプション</a>の配列を受け取ります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nv">$stripeCustomer</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">updateStripeCustomer</span><span class="p">(</span><span class="nv">$options</span><span class="p">);</span>
</code></pre></div>
<p><a name="balances"></a></p>
<h3 id="_18">残高<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>Stripeでは、顧客の「残高」にクレジットまたはデビットを行うことができます。後で、この残高は新しい請求書でクレジットまたはデビットされます。顧客の総残高を確認するには、課金可能なモデルで利用可能な<code>balance</code>メソッドを使用できます。<code>balance</code>メソッドは、顧客の通貨での残高のフォーマットされた文字列表現を返します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nv">$balance</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">balance</span><span class="p">();</span>
</code></pre></div>
<p>顧客の残高にクレジットを行うには、<code>creditBalance</code>メソッドに値を提供します。必要に応じて、説明を提供することもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">creditBalance</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Premium customer top-up.&#39;</span><span class="p">);</span>
</code></pre></div>
<p><code>debitBalance</code>メソッドに値を提供すると、顧客の残高がデビットされます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">debitBalance</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="s1">&#39;Bad usage penalty.&#39;</span><span class="p">);</span>
</code></pre></div>
<p><code>applyBalance</code>メソッドは、顧客の新しい顧客残高トランザクションを作成します。これらのトランザクションレコードを<code>balanceTransactions</code>メソッドを使用して取得することができます。これは、顧客が確認するためのクレジットとデビットのログを提供するのに便利です。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="c1">// すべてのトランザクションを取得...</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="nv">$transactions</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">balanceTransactions</span><span class="p">();</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$transactions</span> <span class="k">as</span> <span class="nv">$transaction</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>    <span class="c1">// トランザクション金額...</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>    <span class="nv">$amount</span> <span class="o">=</span> <span class="nv">$transaction</span><span class="o">-&gt;</span><span class="na">amount</span><span class="p">();</span> <span class="c1">// $2.31</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a>    <span class="c1">// 関連する請求書を取得（利用可能な場合）...</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>    <span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$transaction</span><span class="o">-&gt;</span><span class="na">invoice</span><span class="p">();</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="p">}</span>
</code></pre></div>
<p><a name="tax-ids"></a></p>
<h3 id="id">税ID<a class="headerlink" href="#id" title="Permanent link">&para;</a></h3>
<p>Cashierは、顧客の税IDを管理する簡単な方法を提供します。例えば、<code>taxIds</code>メソッドを使用して、顧客に割り当てられたすべての<a href="https://stripe.com/docs/api/customer_tax_ids/object">税ID</a>をコレクションとして取得できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nv">$taxIds</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">taxIds</span><span class="p">();</span>
</code></pre></div>
<p>顧客の特定の税IDをその識別子で取得することもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="nv">$taxId</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">findTaxId</span><span class="p">(</span><span class="s1">&#39;txi_belgium&#39;</span><span class="p">);</span>
</code></pre></div>
<p>有効な<a href="https://stripe.com/docs/api/customer_tax_ids/object#tax_id_object-type">タイプ</a>と値を<code>createTaxId</code>メソッドに提供することで、新しい税IDを作成できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nv">$taxId</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">createTaxId</span><span class="p">(</span><span class="s1">&#39;eu_vat&#39;</span><span class="p">,</span> <span class="s1">&#39;BE0123456789&#39;</span><span class="p">);</span>
</code></pre></div>
<p><code>createTaxId</code>メソッドは、VAT IDを顧客のアカウントに即座に追加します。<a href="https://stripe.com/docs/invoicing/customer/tax-ids#validation">VAT IDの検証もStripeによって行われます</a>が、これは非同期プロセスです。検証の更新については、<code>customer.tax_id.updated</code> Webhookイベントを購読し、<a href="https://stripe.com/docs/api/customer_tax_ids/object#tax_id_object-verification">VAT IDの<code>verification</code>パラメータ</a>を検査することで通知を受けることができます。Webhookの処理に関する詳細については、<a href="#handling-stripe-webhooks">Webhookハンドラの定義に関するドキュメント</a>を参照してください。</p>
<p>税IDは、<code>deleteTaxId</code>メソッドを使用して削除できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">deleteTaxId</span><span class="p">(</span><span class="s1">&#39;txi_belgium&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="syncing-customer-data-with-stripe"></a></p>
<h3 id="stripe">顧客データをStripeと同期する<a class="headerlink" href="#stripe" title="Permanent link">&para;</a></h3>
<p>通常、アプリケーションのユーザーが名前、メールアドレス、またはその他の情報を更新し、それがStripeにも保存されている場合、Stripeに更新を通知する必要があります。これにより、Stripeの情報がアプリケーションの情報と同期します。</p>
<p>これを自動化するには、課金可能なモデルの<code>updated</code>イベントに反応するイベントリスナーを定義できます。その後、イベントリスナー内で、モデルの<code>syncStripeCustomerDetails</code>メソッドを呼び出すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="k">use</span> <span class="k">function</span> <span class="nf">Illuminate\Events\queueable</span><span class="p">;</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="sd">/**</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="sd"> * The &quot;booted&quot; method of the model.</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="sd"> */</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">booted</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="p">{</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>    <span class="k">static</span><span class="o">::</span><span class="na">updated</span><span class="p">(</span><span class="nx">queueable</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">User</span> <span class="nv">$customer</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$customer</span><span class="o">-&gt;</span><span class="na">hasStripeId</span><span class="p">())</span> <span class="p">{</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>            <span class="nv">$customer</span><span class="o">-&gt;</span><span class="na">syncStripeCustomerDetails</span><span class="p">();</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>        <span class="p">}</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a>    <span class="p">}));</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="p">}</span>
</code></pre></div>
<p>これで、顧客モデルが更新されるたびに、その情報がStripeと同期されます。便宜上、Cashierは顧客の初期作成時に自動的に顧客の情報をStripeと同期します。</p>
<p>Stripeとの顧客情報の同期に使用される列をカスタマイズするには、Cashierが提供するさまざまなメソッドをオーバーライドします。例えば、<code>stripeName</code>メソッドをオーバーライドして、Cashierが顧客情報をStripeと同期する際に顧客の「名前」と見なすべき属性をカスタマイズできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="sd">/**</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="sd"> * Get the customer name that should be synced to Stripe.</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="sd"> */</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">stripeName</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span><span class="o">|</span><span class="k">null</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="p">{</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">company_name</span><span class="p">;</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="p">}</span>
</code></pre></div>
<p>同様に、<code>stripeEmail</code>、<code>stripePhone</code>、<code>stripeAddress</code>、および<code>stripePreferredLocales</code>メソッドをオーバーライドできます。これらのメソッドは、<a href="https://stripe.com/docs/api/customers/update">Stripe顧客オブジェクトの更新</a>時に対応する顧客パラメータに情報を同期します。顧客情報の同期プロセスを完全に制御したい場合は、<code>syncStripeCustomerDetails</code>メソッドをオーバーライドできます。</p>
<p><a name="billing-portal"></a></p>
<h3 id="_19">請求ポータル<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>Stripeは、<a href="https://stripe.com/docs/billing/subscriptions/customer-portal">請求ポータルを簡単に設定する方法</a>を提供しています。これにより、顧客はサブスクリプション、支払い方法、請求履歴を管理できます。コントローラまたはルートから課金可能なモデルの<code>redirectToBillingPortal</code>メソッドを呼び出すことで、ユーザーを請求ポータルにリダイレクトできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/billing-portal&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">redirectToBillingPortal</span><span class="p">();</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="p">});</span>
</code></pre></div>
<p>デフォルトでは、ユーザーがサブスクリプションの管理を終えると、アプリケーションの<code>home</code>ルートに戻るためのリンクがStripe請求ポータル内に表示されます。<code>redirectToBillingPortal</code>メソッドに引数としてURLを渡すことで、ユーザーが戻るべきカスタムURLを指定できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/billing-portal&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">redirectToBillingPortal</span><span class="p">(</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;billing&#39;</span><span class="p">));</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="p">});</span>
</code></pre></div>
<p>請求ポータルへのURLを生成したいが、HTTPリダイレクトレスポンスを生成したくない場合は、<code>billingPortalUrl</code>メソッドを呼び出すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$url</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">billingPortalUrl</span><span class="p">(</span><span class="nx">route</span><span class="p">(</span><span class="s1">&#39;billing&#39;</span><span class="p">));</span>
</code></pre></div>
<p><a name="payment-methods"></a></p>
<h2 id="_20">支払い方法<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h2>
<p><a name="storing-payment-methods"></a></p>
<h3 id="_21">支払い方法の保存<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>Stripeを使用してサブスクリプションを作成したり、「一括」請求を行うには、支払い方法を保存し、その識別子をStripeから取得する必要があります。これを実現するためのアプローチは、支払い方法をサブスクリプションに使用するか、単一の請求に使用するかによって異なります。それぞれについて以下で説明します。</p>
<p><a name="payment-methods-for-subscriptions"></a></p>
<h4 id="_22">サブスクリプションのための支払い方法<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>顧客のクレジットカード情報をサブスクリプションで将来使用するために保存する場合、Stripeの「Setup Intents」APIを使用して、顧客の支払い方法の詳細を安全に収集する必要があります。「Setup Intent」は、顧客の支払い方法に請求する意図をStripeに示します。Cashierの<code>Billable</code>トレイトには、新しいSetup Intentを簡単に作成するための<code>createSetupIntent</code>メソッドが含まれています。このメソッドは、顧客の支払い方法の詳細を収集するフォームをレンダリングするルートまたはコントローラから呼び出す必要があります:</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">&#39;update-payment-method&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;intent&#39;</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">createSetupIntent</span><span class="p">()</span>
<span class="p">]);</span>
</code></pre></div>
<p>Setup Intentを作成し、それをビューに渡した後、そのシークレットを支払い方法を収集する要素に添付する必要があります。例えば、この「支払い方法を更新する」フォームを考えてみましょう:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;card-holder-name&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="cm">&lt;!-- Stripe Elements Placeholder --&gt;</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;card-element&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;card-button&quot;</span> <span class="na">data-secret</span><span class="o">=</span><span class="s">&quot;{{ $intent-&gt;client_secret }}&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>    Update Payment Method
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</code></pre></div>
<p>次に、Stripe.jsライブラリを使用して、<a href="https://stripe.com/docs/stripe-js">Stripe Element</a>をフォームに添付し、顧客の支払い詳細を安全に収集することができます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://js.stripe.com/v3/&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Stripe</span><span class="p">(</span><span class="s1">&#39;stripe-public-key&#39;</span><span class="p">);</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">elements</span><span class="p">();</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cardElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">elements</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">&#39;card&#39;</span><span class="p">);</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="w">    </span><span class="nx">cardElement</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="s1">&#39;#card-element&#39;</span><span class="p">);</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
<p>次に、カードを検証し、<a href="https://stripe.com/docs/js/setup_intents/confirm_card_setup">Stripeの<code>confirmCardSetup</code>メソッド</a>を使用して、Stripeから安全な「支払い方法識別子」を取得できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">cardHolderName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;card-holder-name&#39;</span><span class="p">);</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">cardButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;card-button&#39;</span><span class="p">);</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="kd">const</span><span class="w"> </span><span class="nx">clientSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cardButton</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">secret</span><span class="p">;</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="nx">cardButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">setupIntent</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">confirmCardSetup</span><span class="p">(</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">        </span><span class="nx">clientSecret</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">            </span><span class="nx">payment_method</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">                </span><span class="nx">card</span><span class="o">:</span><span class="w"> </span><span class="nx">cardElement</span><span class="p">,</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">                </span><span class="nx">billing_details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">cardHolderName</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="w">        </span><span class="c1">// ユーザーに &quot;error.message&quot; を表示...</span>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">        </span><span class="c1">// カードが正常に検証されました...</span>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="p">});</span>
</code></pre></div>
<p>カードがStripeによって検証された後、結果の<code>setupIntent.payment_method</code>識別子をLaravelアプリケーションに渡すことができます。これは、顧客に支払い方法を<a href="#adding-payment-methods">新しく追加する</a>か、<a href="#updating-the-default-payment-method">デフォルトの支払い方法を更新する</a>ために使用できます。また、支払い方法識別子をすぐに使用して<a href="#creating-subscriptions">新しいサブスクリプションを作成する</a>こともできます。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Setup Intentsと顧客の支払い詳細の収集について詳しく知りたい場合は、Stripeが提供する<a href="https://stripe.com/docs/payments/save-and-reuse#php">この概要</a>を確認してください。</p>
</div>
<p><a name="payment-methods-for-single-charges"></a></p>
<h4 id="_23">単一請求のための支払い方法<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p>もちろん、顧客の支払い方法に対して単一の請求を行う場合、支払い方法識別子を一度だけ使用する必要があります。Stripeの制限により、顧客の保存されたデフォルトの支払い方法を単一の請求に使用することはできません。顧客にStripe.jsライブラリを使用して支払い方法の詳細を入力してもらう必要があります。例えば、次のフォームを考えてみましょう:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="p">&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;card-holder-name&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="cm">&lt;!-- Stripe Elements Placeholder --&gt;</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;card-element&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="p">&lt;</span><span class="nt">button</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;card-button&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>    Process Payment
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</code></pre></div>
<p>このようなフォームを定義した後、Stripe.jsライブラリを使用して、<a href="https://stripe.com/docs/stripe-js">Stripe Element</a>をフォームに添付し、顧客の支払い詳細を安全に収集することができます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://js.stripe.com/v3/&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Stripe</span><span class="p">(</span><span class="s1">&#39;stripe-public-key&#39;</span><span class="p">);</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">elements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">elements</span><span class="p">();</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cardElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">elements</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">&#39;card&#39;</span><span class="p">);</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">    </span><span class="nx">cardElement</span><span class="p">.</span><span class="nx">mount</span><span class="p">(</span><span class="s1">&#39;#card-element&#39;</span><span class="p">);</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
<p>次に、カードを検証し、<a href="https://stripe.com/docs/stripe-js/reference#stripe-create-payment-method">Stripeの<code>createPaymentMethod</code>メソッド</a>を使用して、Stripeから安全な「支払い方法識別子」を取得できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">cardHolderName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;card-holder-name&#39;</span><span class="p">);</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">cardButton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;card-button&#39;</span><span class="p">);</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="nx">cardButton</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">paymentMethod</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">stripe</span><span class="p">.</span><span class="nx">createPaymentMethod</span><span class="p">(</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">        </span><span class="s1">&#39;card&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">cardElement</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">            </span><span class="nx">billing_details</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">cardHolderName</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">        </span><span class="c1">// ユーザーに &quot;error.message&quot; を表示...</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">        </span><span class="c1">// カードが正常に検証されました...</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="p">});</span>
</code></pre></div>
<p>カードが正常に検証された場合、<code>paymentMethod.id</code>をLaravelアプリケーションに渡し、<a href="#simple-charge">単一の請求を処理する</a>ことができます。</p>
<p><a name="retrieving-payment-methods"></a></p>
<h3 id="_24">支払い方法の取得<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>請求可能なモデルインスタンスの<code>paymentMethods</code>メソッドは、<code>Laravel\Cashier\PaymentMethod</code>インスタンスのコレクションを返します:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$paymentMethods</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">paymentMethods</span><span class="p">();</span>
</code></pre></div>
<p>デフォルトでは、このメソッドはすべてのタイプの支払い方法を返します。特定のタイプの支払い方法を取得するには、<code>type</code>を引数としてメソッドに渡すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$paymentMethods</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">paymentMethods</span><span class="p">(</span><span class="s1">&#39;sepa_debit&#39;</span><span class="p">);</span>
</code></pre></div>
<p>顧客のデフォルトの支払い方法を取得するには、<code>defaultPaymentMethod</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$paymentMethod</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">defaultPaymentMethod</span><span class="p">();</span>
</code></pre></div>
<p>請求可能なモデルに添付されている特定の支払い方法を取得するには、<code>findPaymentMethod</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$paymentMethod</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">findPaymentMethod</span><span class="p">(</span><span class="nv">$paymentMethodId</span><span class="p">);</span>
</code></pre></div>
<p><a name="payment-method-presence"></a></p>
<h3 id="_25">支払い方法の存在確認<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>請求可能なモデルがアカウントにデフォルトの支払い方法を添付しているかどうかを確認するには、<code>hasDefaultPaymentMethod</code>メソッドを呼び出します:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">hasDefaultPaymentMethod</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>請求可能なモデルがアカウントに少なくとも1つの支払い方法を添付しているかどうかを確認するには、<code>hasPaymentMethod</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">hasPaymentMethod</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>このメソッドは、請求可能なモデルに支払い方法があるかどうかを判断します。特定のタイプの支払い方法が存在するかどうかを判断するには、<code>type</code>を引数としてメソッドに渡すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">hasPaymentMethod</span><span class="p">(</span><span class="s1">&#39;sepa_debit&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p><a name="updating-the-default-payment-method"></a></p>
<h3 id="_26">デフォルトの支払い方法の更新<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p><code>updateDefaultPaymentMethod</code>メソッドを使用して、顧客のデフォルトの支払い方法情報を更新できます。このメソッドはStripeの支払い方法識別子を受け取り、新しい支払い方法をデフォルトの請求支払い方法として割り当てます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">updateDefaultPaymentMethod</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">);</span>
</code></pre></div>
<p>Stripeの顧客のデフォルトの支払い方法情報とデフォルトの支払い方法情報を同期するには、<code>updateDefaultPaymentMethodFromStripe</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">updateDefaultPaymentMethodFromStripe</span><span class="p">();</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>顧客のデフォルトの支払い方法は、請求書の発行と新しいサブスクリプションの作成にのみ使用できます。Stripeによる制限により、単一の請求には使用できません。</p>
</div>
<p><a name="adding-payment-methods"></a></p>
<h3 id="_27">支払い方法の追加<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>新しい支払い方法を追加するには、請求可能なモデルの<code>addPaymentMethod</code>メソッドを呼び出し、支払い方法識別子を渡すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">addPaymentMethod</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">);</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>支払い方法識別子の取得方法については、<a href="#storing-payment-methods">支払い方法の保存に関するドキュメント</a>を確認してください。</p>
</div>
<p><a name="deleting-payment-methods"></a></p>
<h3 id="_28">支払い方法の削除<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>支払い方法を削除するには、削除したい<code>Laravel\Cashier\PaymentMethod</code>インスタンスの<code>delete</code>メソッドを呼び出すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$paymentMethod</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
</code></pre></div>
<p>請求可能なモデルから特定の支払い方法を削除するには、<code>deletePaymentMethod</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">deletePaymentMethod</span><span class="p">(</span><span class="s1">&#39;pm_visa&#39;</span><span class="p">);</span>
</code></pre></div>
<p>請求可能なモデルのすべての支払い方法情報を削除するには、<code>deletePaymentMethods</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">deletePaymentMethods</span><span class="p">();</span>
</code></pre></div>
<p>デフォルトでは、このメソッドはすべてのタイプの支払い方法を削除します。特定のタイプの支払い方法を削除するには、<code>type</code>を引数としてメソッドに渡すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">deletePaymentMethods</span><span class="p">(</span><span class="s1">&#39;sepa_debit&#39;</span><span class="p">);</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ユーザーがアクティブなサブスクリプションを持っている場合、アプリケーションはデフォルトの支払い方法を削除することを許可しないでください。</p>
</div>
<p><a name="subscriptions"></a></p>
<h2 id="_29">サブスクリプション<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h2>
<p>サブスクリプションは、顧客に定期的な支払いを設定する方法を提供します。Stripeのサブスクリプションは、Cashierによって管理され、複数のサブスクリプション価格、サブスクリプション数量、トライアルなどをサポートしています。</p>
<p><a name="creating-subscriptions"></a></p>
<h3 id="_30">サブスクリプションの作成<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h3>
<p>サブスクリプションを作成するには、まず請求可能なモデルのインスタンスを取得します。これは通常、<code>App\Models\User</code>のインスタンスになります。モデルインスタンスを取得したら、<code>newSubscription</code>メソッドを使用してモデルのサブスクリプションを作成できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;/user/subscribe&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>    <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>        <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a>    <span class="p">)</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">paymentMethodId</span><span class="p">);</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a>    <span class="c1">// ...</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="p">});</span>
</code></pre></div>
<p><code>newSubscription</code> メソッドに渡される最初の引数は、サブスクリプションの内部タイプです。アプリケーションが単一のサブスクリプションのみを提供する場合、これを <code>default</code> または <code>primary</code> と呼ぶかもしれません。このサブスクリプションタイプは、内部アプリケーションの使用のみを目的としており、ユーザーに表示されることを意図していません。さらに、スペースを含めず、サブスクリプションを作成した後に変更してはいけません。2番目の引数は、ユーザーがサブスクライブしている特定の価格です。この値は、Stripe における価格の識別子に対応している必要があります。</p>
<p><a href="#storing-payment-methods">Stripe の支払い方法識別子</a>または Stripe の <code>PaymentMethod</code> オブジェクトを受け入れる <code>create</code> メソッドは、サブスクリプションを開始し、請求可能なモデルの Stripe 顧客 ID やその他の関連する請求情報でデータベースを更新します。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>支払い方法識別子を直接 <code>create</code> サブスクリプションメソッドに渡すと、自動的にユーザーの保存された支払い方法に追加されます。</p>
</div>
<p><a name="collecting-recurring-payments-via-invoice-emails"></a></p>
<h4 id="_31">請求書メールによる定期支払いの回収<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h4>
<p>顧客の定期支払いを自動的に回収する代わりに、Stripe に顧客に請求書をメールで送信し、定期支払いが期日になるたびに顧客が手動で請求書を支払うように指示することができます。顧客は、請求書による定期支払いを回収する際に、事前に支払い方法を提供する必要はありません。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">createAndSendInvoice</span><span class="p">();</span>
</code></pre></div>
<p>顧客がサブスクリプションがキャンセルされる前に請求書を支払うために与えられる時間は、<code>days_until_due</code> オプションによって決定されます。デフォルトでは30日ですが、このオプションに特定の値を提供することもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">createAndSendInvoice</span><span class="p">([],</span> <span class="p">[</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>    <span class="s1">&#39;days_until_due&#39;</span> <span class="o">=&gt;</span> <span class="mi">30</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="p">]);</span>
</code></pre></div>
<p><a name="subscription-quantities"></a></p>
<h4 id="_32">数量<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<p>サブスクリプションを作成する際に価格に特定の<a href="https://stripe.com/docs/billing/subscriptions/quantities">数量</a>を設定したい場合は、サブスクリプションビルダーで <code>quantity</code> メソッドを呼び出してからサブスクリプションを作成する必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>     <span class="o">-&gt;</span><span class="na">quantity</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>     <span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">);</span>
</code></pre></div>
<p><a name="additional-details"></a></p>
<h4 id="_33">追加の詳細<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h4>
<p>Stripe がサポートする追加の<a href="https://stripe.com/docs/api/customers/create">顧客</a>または<a href="https://stripe.com/docs/api/subscriptions/create">サブスクリプション</a>オプションを指定したい場合は、それらを <code>create</code> メソッドの2番目と3番目の引数として渡すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="nv">$email</span><span class="p">,</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="p">],</span> <span class="p">[</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a>    <span class="s1">&#39;metadata&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;note&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Some extra information.&#39;</span><span class="p">],</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="p">]);</span>
</code></pre></div>
<p><a name="coupons"></a></p>
<h4 id="_34">クーポン<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<p>サブスクリプションを作成する際にクーポンを適用したい場合は、<code>withCoupon</code> メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>     <span class="o">-&gt;</span><span class="na">withCoupon</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>     <span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">);</span>
</code></pre></div>
<p>または、<a href="https://stripe.com/docs/billing/subscriptions/discounts/codes">Stripe のプロモーションコード</a>を適用したい場合は、<code>withPromotionCode</code> メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>     <span class="o">-&gt;</span><span class="na">withPromotionCode</span><span class="p">(</span><span class="s1">&#39;promo_code_id&#39;</span><span class="p">)</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>     <span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">);</span>
</code></pre></div>
<p>指定されたプロモーションコード ID は、プロモーションコードに割り当てられた Stripe API ID である必要があり、顧客向けのプロモーションコードではありません。顧客向けのプロモーションコードに基づいてプロモーションコード ID を見つける必要がある場合は、<code>findPromotionCode</code> メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1">// 顧客向けのコードでプロモーションコード ID を見つける...</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="nv">$promotionCode</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">findPromotionCode</span><span class="p">(</span><span class="s1">&#39;SUMMERSALE&#39;</span><span class="p">);</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="c1">// 顧客向けのコードでアクティブなプロモーションコード ID を見つける...</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="nv">$promotionCode</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">findActivePromotionCode</span><span class="p">(</span><span class="s1">&#39;SUMMERSALE&#39;</span><span class="p">);</span>
</code></pre></div>
<p>上記の例では、返される <code>$promotionCode</code> オブジェクトは <code>Laravel\Cashier\PromotionCode</code> のインスタンスです。このクラスは、基礎となる <code>Stripe\PromotionCode</code> オブジェクトを装飾します。プロモーションコードに関連するクーポンを取得するには、<code>coupon</code> メソッドを呼び出すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nv">$coupon</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">findPromotionCode</span><span class="p">(</span><span class="s1">&#39;SUMMERSALE&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">coupon</span><span class="p">();</span>
</code></pre></div>
<p>クーポンインスタンスを使用して、割引額やクーポンが固定割引かパーセントベースの割引かを判断できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$coupon</span><span class="o">-&gt;</span><span class="na">isPercentage</span><span class="p">())</span> <span class="p">{</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>    <span class="k">return</span> <span class="nv">$coupon</span><span class="o">-&gt;</span><span class="na">percentOff</span><span class="p">()</span><span class="o">.</span><span class="s1">&#39;%&#39;</span><span class="p">;</span> <span class="c1">// 21.5%</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>    <span class="k">return</span> <span class="nv">$coupon</span><span class="o">-&gt;</span><span class="na">amountOff</span><span class="p">();</span> <span class="c1">// $5.99</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="p">}</span>
</code></pre></div>
<p>また、現在顧客またはサブスクリプションに適用されている割引を取得することもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="nv">$discount</span> <span class="o">=</span> <span class="nv">$billable</span><span class="o">-&gt;</span><span class="na">discount</span><span class="p">();</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="nv">$discount</span> <span class="o">=</span> <span class="nv">$subscription</span><span class="o">-&gt;</span><span class="na">discount</span><span class="p">();</span>
</code></pre></div>
<p>返される <code>Laravel\Cashier\Discount</code> インスタンスは、基礎となる <code>Stripe\Discount</code> オブジェクトインスタンスを装飾します。この割引に関連するクーポンを取得するには、<code>coupon</code> メソッドを呼び出すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="nv">$coupon</span> <span class="o">=</span> <span class="nv">$subscription</span><span class="o">-&gt;</span><span class="na">discount</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">coupon</span><span class="p">();</span>
</code></pre></div>
<p>顧客またはサブスクリプションに新しいクーポンまたはプロモーションコードを適用したい場合は、<code>applyCoupon</code> または <code>applyPromotionCode</code> メソッドを介して行うことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="nv">$billable</span><span class="o">-&gt;</span><span class="na">applyCoupon</span><span class="p">(</span><span class="s1">&#39;coupon_id&#39;</span><span class="p">);</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="nv">$billable</span><span class="o">-&gt;</span><span class="na">applyPromotionCode</span><span class="p">(</span><span class="s1">&#39;promotion_code_id&#39;</span><span class="p">);</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="nv">$subscription</span><span class="o">-&gt;</span><span class="na">applyCoupon</span><span class="p">(</span><span class="s1">&#39;coupon_id&#39;</span><span class="p">);</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="nv">$subscription</span><span class="o">-&gt;</span><span class="na">applyPromotionCode</span><span class="p">(</span><span class="s1">&#39;promotion_code_id&#39;</span><span class="p">);</span>
</code></pre></div>
<p>覚えておいてください。プロモーションコードに割り当てられた Stripe API ID を使用し、顧客向けのプロモーションコードではありません。特定の時点で顧客またはサブスクリプションに適用できるクーポンまたはプロモーションコードは1つだけです。</p>
<p>この件に関する詳細は、Stripe のドキュメントを参照してください。<a href="https://stripe.com/docs/billing/subscriptions/coupons">クーポン</a>と<a href="https://stripe.com/docs/billing/subscriptions/coupons/codes">プロモーションコード</a>に関するドキュメントです。</p>
<p><a name="adding-subscriptions"></a></p>
<h4 id="_35">サブスクリプションの追加<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h4>
<p>顧客がすでにデフォルトの支払い方法を持っている場合、サブスクリプションビルダーで <code>add</code> メソッドを呼び出して、サブスクリプションを追加することができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">();</span>
</code></pre></div>
<p><a name="creating-subscriptions-from-the-stripe-dashboard"></a></p>
<h4 id="stripe_1">Stripe ダッシュボードからのサブスクリプションの作成<a class="headerlink" href="#stripe_1" title="Permanent link">&para;</a></h4>
<p>Stripe ダッシュボード自体からサブスクリプションを作成することもできます。その場合、Cashier は新しく追加されたサブスクリプションを同期し、それらに <code>default</code> タイプを割り当てます。ダッシュボードで作成されたサブスクリプションに割り当てられるサブスクリプションタイプをカスタマイズするには、<a href="#defining-webhook-event-handlers">webhook イベントハンドラを定義</a>します。</p>
<p>さらに、Stripe ダッシュボードを介して1つのタイプのサブスクリプションのみを作成できます。アプリケーションが異なるタイプを使用する複数のサブスクリプションを提供する場合、Stripe ダッシュボードを介して追加できるのは1つのタイプのサブスクリプションのみです。</p>
<p>最後に、アプリケーションが提供するサブスクリプションタイプごとに1つのアクティブなサブスクリプションのみを追加するようにしてください。顧客が2つの <code>default</code> サブスクリプションを持っている場合、Cashier は最新に追加されたサブスクリプションのみを使用しますが、両方ともアプリケーションのデータベースと同期されます。</p>
<p><a name="checking-subscription-status"></a></p>
<h3 id="_36">サブスクリプションステータスの確認<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h3>
<p>顧客がアプリケーションにサブスクライブした後、さまざまな便利なメソッドを使用してサブスクリプションステータスを簡単に確認できます。まず、<code>subscribed</code> メソッドは、顧客がアクティブなサブスクリプションを持っている場合、たとえサブスクリプションが現在試用期間内であっても <code>true</code> を返します。<code>subscribed</code> メソッドは、サブスクリプションのタイプを最初の引数として受け取ります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscribed</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>    <span class="c1">// ...</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="p">}</span>
</code></pre></div>
<p><code>subscribed</code> メソッドは、<a href="middleware.html">ルートミドルウェア</a>に適した候補でもあり、ユーザーのサブスクリプションステータスに基づいてルートとコントローラへのアクセスをフィルタリングできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="k">namespace</span> <span class="nx">App\Http\Middleware</span><span class="p">;</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="k">use</span> <span class="nx">Closure</span><span class="p">;</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a><span class="k">class</span> <span class="nc">EnsureUserIsSubscribed</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="p">{</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a>    <span class="sd">/**</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="sd">     * 受信リクエストを処理します。</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="sd">     *</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a><span class="sd">     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a><span class="sd">     */</span>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">Closure</span> <span class="nv">$next</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a>    <span class="p">{</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">subscribed</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a>            <span class="c1">// このユーザーは有料顧客ではありません...</span>
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a>            <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/billing&#39;</span><span class="p">);</span>
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a>        <span class="p">}</span>
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a>
<a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a>        <span class="k">return</span> <span class="nv">$next</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
<a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a>    <span class="p">}</span>
<a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a><span class="p">}</span>
</code></pre></div>
<p>ユーザーがまだ試用期間内かどうかを判断したい場合は、<code>onTrial</code> メソッドを使用できます。このメソッドは、ユーザーがまだ試用期間内であることを示す警告を表示する必要があるかどうかを判断するのに役立ちます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">onTrial</span><span class="p">())</span> <span class="p">{</span>
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>    <span class="c1">// ...</span>
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="p">}</span>
</code></pre></div>
<p><code>subscribedToProduct</code> メソッドは、ユーザーが指定された Stripe 製品の識別子に基づいて特定の製品にサブスクライブしているかどうかを判断するために使用できます。Stripe では、製品は価格のコレクションです。この例では、ユーザーの <code>default</code> サブスクリプションがアプリケーションの "premium" 製品にアクティブにサブスクライブしているかどうかを判断します。指定された Stripe 製品識別子は、Stripe ダッシュボード内の製品の識別子の1つに対応している必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscribedToProduct</span><span class="p">(</span><span class="s1">&#39;prod_premium&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>    <span class="c1">// ...</span>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="p">}</span>
</code></pre></div>
<p><code>subscribedToProduct</code> メソッドに配列を渡すことで、ユーザーの <code>default</code> サブスクリプションがアプリケーションの "basic" または "premium" 製品にアクティブにサブスクライブしているかどうかを判断できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscribedToProduct</span><span class="p">([</span><span class="s1">&#39;prod_basic&#39;</span><span class="p">,</span> <span class="s1">&#39;prod_premium&#39;</span><span class="p">],</span> <span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>    <span class="c1">// ...</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="p">}</span>
</code></pre></div>
<p><code>subscribedToPrice</code>メソッドは、顧客のサブスクリプションが特定の価格IDに対応しているかどうかを判断するために使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscribedToPrice</span><span class="p">(</span><span class="s1">&#39;price_basic_monthly&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p><code>recurring</code>メソッドは、ユーザーが現在サブスクライブしており、試用期間を超えているかどうかを判断するために使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">recurring</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ユーザーが同じタイプの2つのサブスクリプションを持っている場合、<code>subscription</code>メソッドは常に最新のサブスクリプションを返します。例えば、ユーザーが<code>default</code>というタイプの2つのサブスクリプションレコードを持っているかもしれません。しかし、そのうちの1つは古く、期限切れのサブスクリプションであり、もう1つは現在、アクティブなサブスクリプションです。最新のサブスクリプションが常に返され、古いサブスクリプションはデータベースに保持されて履歴の確認に使用されます。</p>
</div>
<p><a name="cancelled-subscription-status"></a></p>
<h4 id="_37">キャンセルされたサブスクリプションのステータス<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h4>
<p>ユーザーが一度アクティブなサブスクライバーであったが、サブスクリプションをキャンセルしたかどうかを判断するには、<code>canceled</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">canceled</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>また、ユーザーがサブスクリプションをキャンセルしたが、まだサブスクリプションが完全に期限切れになるまでの「猶予期間」にいるかどうかを判断することもできます。例えば、ユーザーが3月5日にサブスクリプションをキャンセルし、元々3月10日に期限切れになる予定であった場合、ユーザーは3月10日まで「猶予期間」にいます。この間、<code>subscribed</code>メソッドは依然として<code>true</code>を返します:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">onGracePeriod</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>ユーザーがサブスクリプションをキャンセルし、「猶予期間」を超えているかどうかを判断するには、<code>ended</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">ended</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p><a name="incomplete-and-past-due-status"></a></p>
<h4 id="_38">不完全および過去のステータス<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h4>
<p>サブスクリプションの作成後に二次的な支払いアクションが必要な場合、サブスクリプションは<code>incomplete</code>とマークされます。サブスクリプションのステータスは、Cashierの<code>subscriptions</code>データベーステーブルの<code>stripe_status</code>列に保存されます。</p>
<p>同様に、価格を変更する際に二次的な支払いアクションが必要な場合、サブスクリプションは<code>past_due</code>とマークされます。サブスクリプションがこれらの状態のいずれかにある場合、顧客が支払いを確認するまでアクティブになりません。請求可能なモデルまたはサブスクリプションインスタンスの<code>hasIncompletePayment</code>メソッドを使用して、サブスクリプションに不完全な支払いがあるかどうかを判断できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">hasIncompletePayment</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">hasIncompletePayment</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>サブスクリプションに不完全な支払いがある場合、ユーザーをCashierの支払い確認ページに誘導し、<code>latestPayment</code>識別子を渡す必要があります。サブスクリプションインスタンスで利用可能な<code>latestPayment</code>メソッドを使用して、この識別子を取得できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ route(&#39;cashier.payment&#39;, $subscription-&gt;latestPayment()-&gt;id) }}&quot;</span><span class="p">&gt;</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>    支払いを確認してください。
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>
<p>サブスクリプションが<code>past_due</code>または<code>incomplete</code>状態にある場合でも、サブスクリプションをアクティブと見なしたい場合は、Cashierが提供する<code>keepPastDueSubscriptionsActive</code>および<code>keepIncompleteSubscriptionsActive</code>メソッドを使用できます。通常、これらのメソッドは<code>App\Providers\AppServiceProvider</code>の<code>register</code>メソッドで呼び出す必要があります:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Laravel\Cashier\Cashier</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * 任意のアプリケーションサービスを登録します。</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="nx">Cashier</span><span class="o">::</span><span class="na">keepPastDueSubscriptionsActive</span><span class="p">();</span>
    <span class="nx">Cashier</span><span class="o">::</span><span class="na">keepIncompleteSubscriptionsActive</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>サブスクリプションが<code>incomplete</code>状態にある場合、支払いが確認されるまで変更できません。したがって、<code>swap</code>および<code>updateQuantity</code>メソッドは、サブスクリプションが<code>incomplete</code>状態にある場合に例外をスローします。</p>
</div>
<p><a name="subscription-scopes"></a></p>
<h4 id="_39">サブスクリプションのスコープ<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<p>ほとんどのサブスクリプションのステータスは、クエリスコープとしても利用可能であり、特定の状態のサブスクリプションを簡単にデータベースからクエリできます:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// すべてのアクティブなサブスクリプションを取得...</span>
<span class="nv">$subscriptions</span> <span class="o">=</span> <span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">active</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="c1">// ユーザーのキャンセルされたすべてのサブスクリプションを取得...</span>
<span class="nv">$subscriptions</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscriptions</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">canceled</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>利用可能なスコープの完全なリストは以下の通りです:</p>
<div class="highlight"><pre><span></span><code><span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">active</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">canceled</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">ended</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">incomplete</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">notCanceled</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">notOnGracePeriod</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">notOnTrial</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">onGracePeriod</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">onTrial</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">pastDue</span><span class="p">();</span>
<span class="nx">Subscription</span><span class="o">::</span><span class="na">query</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">recurring</span><span class="p">();</span>
</code></pre></div>
<p><a name="changing-prices"></a></p>
<h3 id="_40">価格の変更<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>顧客がアプリケーションにサブスクライブした後、新しいサブスクリプション価格に変更したい場合があります。顧客を新しい価格に変更するには、Stripe価格の識別子を<code>swap</code>メソッドに渡します。価格を変更する際、ユーザーが以前にキャンセルしたサブスクリプションを再アクティブ化したいと想定されます。指定された価格識別子は、Stripeダッシュボードで利用可能なStripe価格識別子に対応する必要があります:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nx">App\Models\User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">swap</span><span class="p">(</span><span class="s1">&#39;price_yearly&#39;</span><span class="p">);</span>
</code></pre></div>
<p>顧客が試用期間中である場合、試用期間は維持されます。また、サブスクリプションに「数量」が存在する場合、その数量も維持されます。</p>
<p>価格を変更し、顧客が現在の試用期間をキャンセルする場合は、<code>skipTrial</code>メソッドを呼び出すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">skipTrial</span><span class="p">()</span>
        <span class="o">-&gt;</span><span class="na">swap</span><span class="p">(</span><span class="s1">&#39;price_yearly&#39;</span><span class="p">);</span>
</code></pre></div>
<p>価格を変更し、顧客に次の請求サイクルを待たずに即座に請求する場合は、<code>swapAndInvoice</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">swapAndInvoice</span><span class="p">(</span><span class="s1">&#39;price_yearly&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="prorations"></a></p>
<h4 id="_41">按分計算<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h4>
<p>デフォルトでは、Stripeは価格間の変更時に按分計算された料金を請求します。<code>noProrate</code>メソッドを使用して、按分計算された料金を請求せずにサブスクリプションの価格を更新できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">noProrate</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">swap</span><span class="p">(</span><span class="s1">&#39;price_yearly&#39;</span><span class="p">);</span>
</code></pre></div>
<p>サブスクリプションの按分計算についての詳細は、<a href="https://stripe.com/docs/billing/subscriptions/prorations">Stripeのドキュメント</a>を参照してください。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>noProrate</code>メソッドを<code>swapAndInvoice</code>メソッドの前に実行しても、按分計算には影響しません。請求書は常に発行されます。</p>
</div>
<p><a name="subscription-quantity"></a></p>
<h3 id="_42">サブスクリプションの数量<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>サブスクリプションは、「数量」によって影響を受けることがあります。例えば、プロジェクト管理アプリケーションがプロジェクトごとに月額$10を請求する場合があります。<code>incrementQuantity</code>および<code>decrementQuantity</code>メソッドを使用して、サブスクリプションの数量を簡単に増減できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">incrementQuantity</span><span class="p">();</span>

<span class="c1">// サブスクリプションの現在の数量に5を追加...</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">incrementQuantity</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">decrementQuantity</span><span class="p">();</span>

<span class="c1">// サブスクリプションの現在の数量から5を減算...</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">decrementQuantity</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</code></pre></div>
<p>または、<code>updateQuantity</code>メソッドを使用して特定の数量を設定することもできます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">updateQuantity</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</code></pre></div>
<p><code>noProrate</code>メソッドを使用して、按分計算された料金を請求せずにサブスクリプションの数量を更新できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">noProrate</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">updateQuantity</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</code></pre></div>
<p>サブスクリプションの数量についての詳細は、<a href="https://stripe.com/docs/subscriptions/quantities">Stripeのドキュメント</a>を参照してください。</p>
<p><a name="quantities-for-subscription-with-multiple-products"></a></p>
<h4 id="_43">複数の製品を持つサブスクリプションの数量<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h4>
<p>サブスクリプションが<a href="#subscriptions-with-multiple-products">複数の製品を持つサブスクリプション</a>である場合、数量を増減する価格のIDを増減メソッドの第2引数として渡す必要があります:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">incrementQuantity</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;price_chat&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="subscriptions-with-multiple-products"></a></p>
<h3 id="_44">複数の製品を持つサブスクリプション<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p><a href="https://stripe.com/docs/billing/subscriptions/multiple-products">複数の製品を持つサブスクリプション</a>を使用すると、単一のサブスクリプションに複数の請求製品を割り当てることができます。例えば、顧客サービス「ヘルプデスク」アプリケーションが月額$10の基本サブスクリプション価格を持ち、ライブチャットアドオン製品を追加で月額$15で提供する場合を想像してください。複数の製品を持つサブスクリプションの情報は、Cashierの<code>subscription_items</code>データベーステーブルに保存されます。</p>
<p><code>newSubscription</code>メソッドに価格の配列を第2引数として渡すことで、特定のサブスクリプションに複数の製品を指定できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;/user/subscribe&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;price_monthly&#39;</span><span class="p">,</span>
        <span class="s1">&#39;price_chat&#39;</span><span class="p">,</span>
    <span class="p">])</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">paymentMethodId</span><span class="p">);</span>

    <span class="c1">// ...</span>
<span class="p">});</span>
</code></pre></div>
<p>上記の例では、顧客は<code>default</code>サブスクリプションに2つの価格が添付されます。それぞれの価格は、それぞれの請求間隔で請求されます。必要に応じて、<code>quantity</code>メソッドを使用して各価格の特定の数量を示すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;price_monthly&#39;</span><span class="p">,</span> <span class="s1">&#39;price_chat&#39;</span><span class="p">])</span>
    <span class="o">-&gt;</span><span class="na">quantity</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;price_chat&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">);</span>
</code></pre></div>
<p>既存のサブスクリプションに別の価格を追加する場合は、サブスクリプションの<code>addPrice</code>メソッドを呼び出すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">addPrice</span><span class="p">(</span><span class="s1">&#39;price_chat&#39;</span><span class="p">);</span>
</code></pre></div>
<p>上記の例では、新しい価格を追加し、次の請求サイクルで顧客に請求されます。顧客に即座に請求したい場合は、<code>addPriceAndInvoice</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">addPriceAndInvoice</span><span class="p">(</span><span class="s1">&#39;price_chat&#39;</span><span class="p">);</span>
</code></pre></div>
<p>特定の数量で価格を追加したい場合は、<code>addPrice</code>または<code>addPriceAndInvoice</code>メソッドの第2引数として数量を渡すことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">addPrice</span><span class="p">(</span><span class="s1">&#39;price_chat&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</code></pre></div>
<p>サブスクリプションから価格を削除するには、<code>removePrice</code>メソッドを使用します:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">removePrice</span><span class="p">(</span><span class="s1">&#39;price_chat&#39;</span><span class="p">);</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>サブスクリプションの最後の価格を削除することはできません。代わりに、サブスクリプションをキャンセルするだけです。</p>
</div>
<p><a name="swapping-prices"></a></p>
<h4 id="_45">価格の入れ替え<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h4>
<p>複数の製品が添付されたサブスクリプションの価格を変更することもできます。例えば、顧客が<code>price_basic</code>サブスクリプションと<code>price_chat</code>アドオン製品を持っており、顧客を<code>price_basic</code>から<code>price_pro</code>にアップグレードしたいとします:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">swap</span><span class="p">([</span><span class="s1">&#39;price_pro&#39;</span><span class="p">,</span> <span class="s1">&#39;price_chat&#39;</span><span class="p">]);</span>
</code></pre></div>
<p>上記の例を実行すると、<code>price_basic</code>の基礎となるサブスクリプションアイテムが削除され、<code>price_chat</code>のアイテムが保持されます。さらに、<code>price_pro</code>の新しいサブスクリプションアイテムが作成されます。</p>
<p>サブスクリプションアイテムのオプションを指定するには、<code>swap</code>メソッドにキー/値のペアの配列を渡すことができます。例えば、サブスクリプション価格の数量を指定する必要がある場合:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">swap</span><span class="p">([</span>
    <span class="s1">&#39;price_pro&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;quantity&#39;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;price_chat&#39;</span>
<span class="p">]);</span>
</code></pre></div>
<p>サブスクリプションの単一の価格を入れ替えたい場合は、サブスクリプションアイテム自体の<code>swap</code>メソッドを使用して行うことができます。このアプローチは、サブスクリプションの他の価格の既存のメタデータをすべて保持したい場合に特に便利です:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">findItemOrFail</span><span class="p">(</span><span class="s1">&#39;price_basic&#39;</span><span class="p">)</span>
        <span class="o">-&gt;</span><span class="na">swap</span><span class="p">(</span><span class="s1">&#39;price_pro&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="proration"></a></p>
<h4 id="_46">日割り計算<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<p>デフォルトでは、Stripeは複数の製品を持つサブスクリプションから価格を追加または削除する際に日割り請求を行います。日割り計算なしで価格調整を行いたい場合は、価格操作に<code>noProrate</code>メソッドを連鎖させる必要があります:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">noProrate</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">removePrice</span><span class="p">(</span><span class="s1">&#39;price_chat&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="swapping-quantities"></a></p>
<h4 id="_47">数量の更新<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h4>
<p>個々のサブスクリプション価格の数量を更新したい場合は、価格のIDをメソッドに追加の引数として渡すことで、<a href="#subscription-quantity">既存の数量メソッド</a>を使用して行うことができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">incrementQuantity</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;price_chat&#39;</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">decrementQuantity</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;price_chat&#39;</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">updateQuantity</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;price_chat&#39;</span><span class="p">);</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>サブスクリプションに複数の価格がある場合、<code>Subscription</code>モデルの<code>stripe_price</code>および<code>quantity</code>属性は<code>null</code>になります。個々の価格属性にアクセスするには、<code>Subscription</code>モデルで利用可能な<code>items</code>リレーションを使用する必要があります。</p>
</div>
<p><a name="subscription-items"></a></p>
<h4 id="_48">サブスクリプションアイテム<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h4>
<p>サブスクリプションに複数の価格がある場合、データベースの<code>subscription_items</code>テーブルに複数のサブスクリプション「アイテム」が保存されます。これらには、サブスクリプションの<code>items</code>リレーションを介してアクセスできます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$subscriptionItem</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">items</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>

<span class="c1">// 特定のアイテムのStripe価格と数量を取得...</span>
<span class="nv">$stripePrice</span> <span class="o">=</span> <span class="nv">$subscriptionItem</span><span class="o">-&gt;</span><span class="na">stripe_price</span><span class="p">;</span>
<span class="nv">$quantity</span> <span class="o">=</span> <span class="nv">$subscriptionItem</span><span class="o">-&gt;</span><span class="na">quantity</span><span class="p">;</span>
</code></pre></div>
<p><code>``

特定の価格を取得するには、</code>findItemOrFail`メソッドを使用することもできます:

    $user = User::find(1);

    $subscriptionItem = $user-&gt;subscription('default')-&gt;findItemOrFail('price_chat');

<a name="multiple-subscriptions"></a></p>
<h3 id="_49">複数のサブスクリプション<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>Stripeでは、顧客が同時に複数のサブスクリプションを持つことができます。例えば、ジムを運営しており、水泳サブスクリプションとダンベルサブスクリプションを提供しているとします。それぞれのサブスクリプションは異なる価格設定を持つことができます。もちろん、顧客はどちらか一方または両方のプランに加入できるべきです。

アプリケーションがサブスクリプションを作成する際、<code>newSubscription</code>メソッドにサブスクリプションのタイプを指定できます。タイプは、ユーザーが開始しているサブスクリプションのタイプを表す任意の文字列です:

    use Illuminate\Http\Request;

    Route::post('/swimming/subscribe', function (Request $request) {
        $request-&gt;user()-&gt;newSubscription('swimming')
            -&gt;price('price_swimming_monthly')
            -&gt;create($request-&gt;paymentMethodId);

        // ...
    });

この例では、顧客のために月次の水泳サブスクリプションを開始しました。しかし、後で年次サブスクリプションに切り替えたい場合があります。顧客のサブスクリプションを調整する際、<code>swimming</code>サブスクリプションの価格を入れ替えるだけです:

    $user-&gt;subscription('swimming')-&gt;swap('price_swimming_yearly');

もちろん、サブスクリプションを完全にキャンセルすることもできます:

    $user-&gt;subscription('swimming')-&gt;cancel();

<a name="metered-billing"></a></p>
<h3 id="_50">従量課金制<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p><a href="https://stripe.com/docs/billing/subscriptions/metered-billing">従量課金制</a>を使用すると、請求サイクル中の製品使用量に基づいて顧客に請求できます。例えば、顧客が月に送信するテキストメッセージやメールの数に基づいて請求することができます。

従量課金制を開始するには、まずStripeダッシュボードで従量課金制の価格を持つ新しい製品を作成する必要があります。次に、<code>meteredPrice</code>を使用して、従量課金制の価格IDを顧客のサブスクリプションに追加します:

    use Illuminate\Http\Request;

    Route::post('/user/subscribe', function (Request $request) {
        $request-&gt;user()-&gt;newSubscription('default')
            -&gt;meteredPrice('price_metered')
            -&gt;create($request-&gt;paymentMethodId);

        // ...
    });

<a href="#checkout">Stripe Checkout</a>を介して従量課金制のサブスクリプションを開始することもできます:

    $checkout = Auth::user()
            -&gt;newSubscription('default', [])
            -&gt;meteredPrice('price_metered')
            -&gt;checkout();

    return view('your-checkout-view', [
        'checkout' =&gt; $checkout,
    ]);

<a name="reporting-usage"></a></p>
<h4 id="_51">使用量の報告<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h4>
<p>顧客がアプリケーションを使用すると、正確に請求できるようにStripeに使用量を報告する必要があります。従量課金制のサブスクリプションの使用量を増やすには、<code>reportUsage</code>メソッドを使用できます:

    $user = User::find(1);

    $user-&gt;subscription('default')-&gt;reportUsage();

デフォルトでは、請求期間に1の「使用量」が追加されます。代わりに、顧客の請求期間に追加する特定の「使用量」を渡すことができます:

    $user = User::find(1);

    $user-&gt;subscription('default')-&gt;reportUsage(15);

アプリケーションが単一のサブスクリプションで複数の価格を提供する場合、使用量を報告する従量課金制の価格を指定するために<code>reportUsageFor</code>メソッドを使用する必要があります:

    $user = User::find(1);

    $user-&gt;subscription('default')-&gt;reportUsageFor('price_metered', 15);

場合によっては、以前に報告した使用量を更新する必要があります。これを行うには、<code>reportUsage</code>の第2引数としてタイムスタンプまたは<code>DateTimeInterface</code>インスタンスを渡すことができます。そうすると、Stripeはその時点で報告された使用量を更新します。指定された日付と時刻が現在の請求期間内にある限り、以前の使用量レコードを更新し続けることができます:

    $user = User::find(1);

    $user-&gt;subscription('default')-&gt;reportUsage(5, $timestamp);

<a name="retrieving-usage-records"></a></p>
<h4 id="_52">使用量レコードの取得<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h4>
<p>顧客の過去の使用量を取得するには、サブスクリプションインスタンスの<code>usageRecords</code>メソッドを使用できます:

    $user = User::find(1);

    $usageRecords = $user-&gt;subscription('default')-&gt;usageRecords();

アプリケーションが単一のサブスクリプションで複数の価格を提供する場合、使用量レコードを取得する従量課金制の価格を指定するために<code>usageRecordsFor</code>メソッドを使用する必要があります:

    $user = User::find(1);

    $usageRecords = $user-&gt;subscription('default')-&gt;usageRecordsFor('price_metered');

<code>usageRecords</code>および<code>usageRecordsFor</code>メソッドは、使用量レコードの連想配列を含むCollectionインスタンスを返します。この配列を反復処理して、顧客の総使用量を表示できます:

    @foreach ($usageRecords as $usageRecord)
        - 期間開始: {{ $usageRecord['period']['start'] }}
        - 期間終了: {{ $usageRecord['period']['end'] }}
        - 総使用量: {{ $usageRecord['total_usage'] }}
    @endforeach

使用量データの完全なリファレンスとStripeのカーソルベースのページネーションの使用方法については、<a href="https://stripe.com/docs/api/usage_records/subscription_item_summary_list">公式のStripe APIドキュメント</a>を参照してください。

<a name="subscription-taxes"></a></p>
<h3 id="_53">サブスクリプションの税金<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>手動で税率を計算する代わりに、<a href="#tax-configuration">Stripe Taxを使用して自動的に税金を計算</a>できます。</p>
<p>ユーザーがサブスクリプションに支払う税金を指定するには、課金可能なモデルに<code>taxRates</code>メソッドを実装し、Stripeの税率IDを含む配列を返す必要があります。これらの税率は、<a href="https://dashboard.stripe.com/test/tax-rates">Stripeダッシュボード</a>で定義できます:</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd"> * 顧客のサブスクリプションに適用される税金。</span>
<span class="sd"> *</span>
<span class="sd"> * @return array&lt;int, string&gt;</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">taxRates</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;txr_id&#39;</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<p><code>taxRates</code>メソッドを使用すると、顧客ごとに税率を適用できます。これは、複数の国と税率を持つユーザーベースに役立つかもしれません。</p>
<p>複数の製品を含むサブスクリプションを提供している場合、請求可能なモデルに<code>priceTaxRates</code>メソッドを実装することで、各価格に異なる税率を定義できます：</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd"> * 顧客のサブスクリプションに適用されるべき税率</span>
<span class="sd"> *</span>
<span class="sd"> * @return array&lt;string, array&lt;int, string&gt;&gt;</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">priceTaxRates</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="s1">&#39;price_monthly&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;txr_id&#39;</span><span class="p">],</span>
    <span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<p>WARNING:<br />
<code>taxRates</code>メソッドはサブスクリプション料金にのみ適用されます。「一括請求」を行うためにCashierを使用している場合、その時点で税率を手動で指定する必要があります。</p>
<p><a name="syncing-tax-rates"></a></p>
</div>
<h4 id="_54">税率の同期<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h4>
<p><code>taxRates</code>メソッドが返すハードコードされた税率IDを変更する場合、ユーザーの既存のサブスクリプションの税設定はそのまま残ります。既存のサブスクリプションの税額を新しい<code>taxRates</code>の値で更新したい場合は、ユーザーのサブスクリプションインスタンスで<code>syncTaxRates</code>メソッドを呼び出す必要があります：

    $user-&gt;subscription('default')-&gt;syncTaxRates();

これにより、複数の製品を持つサブスクリプションのアイテム税率も同期されます。アプリケーションが複数の製品を持つサブスクリプションを提供している場合、請求可能なモデルが<a href="#subscription-taxes">前述</a>の<code>priceTaxRates</code>メソッドを実装していることを確認する必要があります。

<a name="tax-exemption"></a></p>
<h4 id="_55">税免除<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h4>
<p>Cashierは、顧客が税免除かどうかを判断するための<code>isNotTaxExempt</code>、<code>isTaxExempt</code>、および<code>reverseChargeApplies</code>メソッドも提供します。これらのメソッドは、顧客の税免除ステータスを決定するためにStripe APIを呼び出します：

    use App\Models\User;

    $user = User::find(1);

    $user-&gt;isTaxExempt();
    $user-&gt;isNotTaxExempt();
    $user-&gt;reverseChargeApplies();

</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>これらのメソッドは、<code>Laravel\Cashier\Invoice</code>オブジェクトでも利用可能です。ただし、<code>Invoice</code>オブジェクトで呼び出される場合、メソッドは請求書が作成された時点での免除ステータスを決定します。</p>
<p><a name="subscription-anchor-date"></a></p>
</div>
<h3 id="_56">サブスクリプションのアンカー日付<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>デフォルトでは、請求サイクルのアンカーはサブスクリプションが作成された日付、または試用期間が使用されている場合は試用が終了する日付です。請求アンカー日付を変更したい場合は、<code>anchorBillingCycleOn</code>メソッドを使用できます：

    use Illuminate\Http\Request;

    Route::post('/user/subscribe', function (Request $request) {
        $anchor = Carbon::parse('first day of next month');

        $request-&gt;user()-&gt;newSubscription('default', 'price_monthly')
                    -&gt;anchorBillingCycleOn($anchor-&gt;startOfDay())
                    -&gt;create($request-&gt;paymentMethodId);

        // ...
    });

サブスクリプションの請求サイクルを管理するための詳細については、<a href="https://stripe.com/docs/billing/subscriptions/billing-cycle">Stripeの請求サイクルドキュメント</a>を参照してください。

<a name="cancelling-subscriptions"></a></p>
<h3 id="_57">サブスクリプションのキャンセル<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h3>
<p>サブスクリプションをキャンセルするには、ユーザーのサブスクリプションで<code>cancel</code>メソッドを呼び出します：

    $user-&gt;subscription('default')-&gt;cancel();

サブスクリプションがキャンセルされると、Cashierは自動的に<code>subscriptions</code>データベーステーブルの<code>ends_at</code>カラムを設定します。このカラムは、<code>subscribed</code>メソッドがいつ<code>false</code>を返すべきかを知るために使用されます。

例えば、顧客が3月1日にサブスクリプションをキャンセルしたが、サブスクリプションは3月5日まで終了予定でなかった場合、<code>subscribed</code>メソッドは3月5日まで<code>true</code>を返し続けます。これは、通常、顧客が請求サイクルの終了までアプリケーションを使用し続けることが許可されているためです。

<code>onGracePeriod</code>メソッドを使用して、ユーザーがサブスクリプションをキャンセルしたが、まだ「猶予期間」にいるかどうかを判断できます：

    if ($user-&gt;subscription('default')-&gt;onGracePeriod()) {
        // ...
    }

サブスクリプションを即座にキャンセルしたい場合は、ユーザーのサブスクリプションで<code>cancelNow</code>メソッドを呼び出します：

    $user-&gt;subscription('default')-&gt;cancelNow();

サブスクリプションを即座にキャンセルし、未請求の従量制使用料金や新規/保留中の比例配分請求項目を請求したい場合は、ユーザーのサブスクリプションで<code>cancelNowAndInvoice</code>メソッドを呼び出します：

    $user-&gt;subscription('default')-&gt;cancelNowAndInvoice();

特定の時点でサブスクリプションをキャンセルすることもできます：

    $user-&gt;subscription('default')-&gt;cancelAt(
        now()-&gt;addDays(10)
    );

最後に、関連するユーザーモデルを削除する前に、常にユーザーサブスクリプションをキャンセルする必要があります：

    $user-&gt;subscription('default')-&gt;cancelNow();

    $user-&gt;delete();

<a name="resuming-subscriptions"></a></p>
<h3 id="_58">サブスクリプションの再開<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h3>
<p>顧客がサブスクリプションをキャンセルし、再開したい場合は、サブスクリプションで<code>resume</code>メソッドを呼び出すことができます。顧客は、サブスクリプションを再開するためにまだ「猶予期間」内でなければなりません：

    $user-&gt;subscription('default')-&gt;resume();

顧客がサブスクリプションをキャンセルし、サブスクリプションが完全に期限切れになる前にそのサブスクリプションを再開する場合、顧客はすぐに請求されません。代わりに、サブスクリプションは再アクティブ化され、元の請求サイクルで請求されます。

<a name="subscription-trials"></a></p>
<h2 id="_59">サブスクリプションの試用期間<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h2>
<p><a name="with-payment-method-up-front"></a></p>
<h3 id="_60">事前に支払い方法を収集する<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h3>
<p>顧客に試用期間を提供しながら、支払い方法の情報を事前に収集したい場合、サブスクリプションを作成する際に<code>trialDays</code>メソッドを使用する必要があります：

    use Illuminate\Http\Request;

    Route::post('/user/subscribe', function (Request $request) {
        $request-&gt;user()-&gt;newSubscription('default', 'price_monthly')
                    -&gt;trialDays(10)
                    -&gt;create($request-&gt;paymentMethodId);

        // ...
    });

このメソッドは、データベース内のサブスクリプションレコードに試用期間の終了日を設定し、Stripeにこの日付まで顧客への請求を開始しないよう指示します。<code>trialDays</code>メソッドを使用すると、CashierはStripeで設定された価格のデフォルトの試用期間を上書きします。

</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>顧客のサブスクリプションが試用終了日の前にキャンセルされない場合、試用が終了するとすぐに請求されますので、ユーザーに試用終了日を通知することを確認してください。</p>
<p><code>trialUntil</code>メソッドを使用すると、試用期間がいつ終了するかを指定する<code>DateTime</code>インスタンスを提供できます：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Carbon\Carbon</span><span class="p">;</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">trialUntil</span><span class="p">(</span><span class="nx">Carbon</span><span class="o">::</span><span class="na">now</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">addDays</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
            <span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">);</span>
</code></pre></div>
<p>ユーザーが試用期間内にいるかどうかを判断するには、ユーザーインスタンスの<code>onTrial</code>メソッドまたはサブスクリプションインスタンスの<code>onTrial</code>メソッドを使用できます。以下の2つの例は同等です：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">onTrial</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">onTrial</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>サブスクリプションの試用を即座に終了させるには、<code>endTrial</code>メソッドを使用できます：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">endTrial</span><span class="p">();</span>
</code></pre></div>
<p>既存の試用が期限切れかどうかを判断するには、<code>hasExpiredTrial</code>メソッドを使用できます：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">hasExpiredTrial</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">hasExpiredTrial</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p><a name="defining-trial-days-in-stripe-cashier"></a></p>
</div>
<h4 id="stripe-cashier">Stripe / Cashierでの試用日数の定義<a class="headerlink" href="#stripe-cashier" title="Permanent link">&para;</a></h4>
<p>Stripeダッシュボードで価格の試用日数を定義するか、常にCashierを使用して明示的に渡すかを選択できます。Stripeで価格の試用日数を定義することを選択した場合、過去にサブスクリプションを持っていた顧客の新しいサブスクリプションを含む新しいサブスクリプションは、<code>skipTrial()</code>メソッドを明示的に呼び出さない限り、常に試用期間を受け取ることに注意してください。

<a name="without-payment-method-up-front"></a></p>
<h3 id="_61">事前に支払い方法を収集しない<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h3>
<p>顧客の支払い方法の情報を事前に収集せずに試用期間を提供したい場合、ユーザーレコードの<code>trial_ends_at</code>カラムを希望する試用終了日に設定できます。これは通常、ユーザー登録時に行われます：

    use App\Models\User;

    $user = User::create([
        // ...
        'trial_ends_at' =&gt; now()-&gt;addDays(10),
    ]);

</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>請求可能なモデルのクラス定義内で<code>trial_ends_at</code>属性に<a href="eloquent-mutators.html#date-casting">日付キャスト</a>を追加することを確認してください。</p>
<p>Cashierはこのタイプの試用を「汎用試用」と呼びます。これは、既存のサブスクリプションに添付されていないためです。請求可能なモデルインスタンスの<code>onTrial</code>メソッドは、現在の日付が<code>trial_ends_at</code>の値を過ぎていない場合に<code>true</code>を返します：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">onTrial</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ユーザーは試用期間内です...</span>
<span class="p">}</span>
</code></pre></div>
<p>ユーザーの準備ができたら、通常どおり<code>newSubscription</code>メソッドを使用して実際のサブスクリプションを作成できます：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">);</span>
</code></pre></div>
<p>ユーザーの試用終了日を取得するには、<code>trialEndsAt</code>メソッドを使用できます。このメソッドは、ユーザーが試用期間内であればCarbon日付インスタンスを返し、そうでなければ<code>null</code>を返します。また、デフォルト以外の特定のサブスクリプションの試用終了日を取得したい場合は、オプションのサブスクリプションタイプパラメータを渡すこともできます：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">onTrial</span><span class="p">())</span> <span class="p">{</span>
    <span class="nv">$trialEndsAt</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">trialEndsAt</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>ユーザーがまだ「汎用」試用期間内であり、実際のサブスクリプションをまだ作成していないかどうかを知りたい場合は、<code>onGenericTrial</code>メソッドを使用することもできます：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">onGenericTrial</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// ユーザーは「汎用」試用期間内です...</span>
<span class="p">}</span>
</code></pre></div>
<p><a name="extending-trials"></a></p>
</div>
<h3 id="_62">試用期間の延長<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h3>
<p><code>extendTrial</code>メソッドを使用すると、サブスクリプションが作成された後にサブスクリプションの試用期間を延長することができます。試用期間が既に終了し、顧客が既にサブスクリプションの請求を受けている場合でも、延長された試用期間を提供することができます。試用期間内に費やした時間は、顧客の次の請求書から差し引かれます。

    use App\Models\User;

    $subscription = User::find(1)-&gt;subscription('default');

    // 試用期間を今から7日後に終了させる...
    $subscription-&gt;extendTrial(
        now()-&gt;addDays(7)
    );

    // 試用期間にさらに5日追加する...
    $subscription-&gt;extendTrial(
        $subscription-&gt;trial_ends_at-&gt;addDays(5)
    );

<a name="handling-stripe-webhooks"></a></p>
<h2 id="stripe-webhook">Stripe Webhookの処理<a class="headerlink" href="#stripe-webhook" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ローカル開発中にWebhookをテストするために、<a href="https://stripe.com/docs/stripe-cli">Stripe CLI</a>を使用することができます。</p>
<p>Stripeは、Webhookを介してアプリケーションにさまざまなイベントを通知することができます。デフォルトでは、CashierのWebhookコントローラーを指すルートがCashierサービスプロバイダーによって自動的に登録されます。このコントローラーは、すべての受信Webhookリクエストを処理します。</p>
<p>デフォルトでは、CashierのWebhookコントローラーは、Stripeの設定で定義された失敗した請求が多すぎるサブスクリプションのキャンセル、顧客の更新、顧客の削除、サブスクリプションの更新、および支払い方法の変更を自動的に処理します。ただし、すぐにわかるように、このコントローラーを拡張して、お好みのStripe Webhookイベントを処理することができます。</p>
<p>アプリケーションがStripe Webhookを処理できるようにするには、StripeコントロールパネルでWebhook URLを設定してください。デフォルトでは、CashierのWebhookコントローラーは<code>/stripe/webhook</code> URLパスに応答します。Stripeコントロールパネルで有効にする必要があるすべてのWebhookの完全なリストは次のとおりです。</p>
<ul>
<li><code>customer.subscription.created</code></li>
<li><code>customer.subscription.updated</code></li>
<li><code>customer.subscription.deleted</code></li>
<li><code>customer.updated</code></li>
<li><code>customer.deleted</code></li>
<li><code>payment_method.automatically_updated</code></li>
<li><code>invoice.payment_action_required</code></li>
<li><code>invoice.payment_succeeded</code></li>
</ul>
<p>便宜上、Cashierには<code>cashier:webhook</code> Artisanコマンドが含まれています。このコマンドは、Cashierに必要なすべてのイベントをリッスンするStripeにWebhookを作成します。</p>
<p><code>shell
php artisan cashier:webhook</code></p>
</div>
<p>デフォルトでは、作成されたWebhookは<code>APP_URL</code>環境変数とCashierに含まれる<code>cashier.webhook</code>ルートで定義されたURLを指します。コマンドを呼び出す際に別のURLを使用したい場合は、<code>--url</code>オプションを指定できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>cashier:webhook<span class="w"> </span>--url<span class="w"> </span><span class="s2">&quot;https://example.com/stripe/webhook&quot;</span>
</code></pre></div>
<p>作成されたWebhookは、Cashierのバージョンと互換性のあるStripe APIバージョンを使用します。別のStripeバージョンを使用したい場合は、<code>--api-version</code>オプションを指定できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>cashier:webhook<span class="w"> </span>--api-version<span class="o">=</span><span class="s2">&quot;2019-12-03&quot;</span>
</code></pre></div>
<p>作成後、Webhookはすぐにアクティブになります。準備が整うまでWebhookを無効にしておきたい場合は、コマンドを呼び出す際に<code>--disabled</code>オプションを指定できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>cashier:webhook<span class="w"> </span>--disabled
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Cashierに含まれる<a href="#verifying-webhook-signatures">Webhook署名検証</a>ミドルウェアを使用して、受信Stripe Webhookリクエストを保護するようにしてください。</p>
</div>
<p><a name="webhooks-csrf-protection"></a></p>
<h4 id="webhookscsrf">WebhooksとCSRF保護<a class="headerlink" href="#webhookscsrf" title="Permanent link">&para;</a></h4>
<p>Stripe WebhookはLaravelの<a href="csrf.html">CSRF保護</a>をバイパスする必要があるため、アプリケーションの<code>bootstrap/app.php</code>ファイルで<code>stripe/*</code>をCSRF保護から除外するようにしてください。</p>
<div class="highlight"><pre><span></span><code><span class="o">-&gt;</span><span class="na">withMiddleware</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Middleware</span> <span class="nv">$middleware</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$middleware</span><span class="o">-&gt;</span><span class="na">validateCsrfTokens</span><span class="p">(</span><span class="nx">except</span><span class="o">:</span> <span class="p">[</span>
        <span class="s1">&#39;stripe/*&#39;</span><span class="p">,</span>
    <span class="p">]);</span>
<span class="p">})</span>
</code></pre></div>
<p><a name="defining-webhook-event-handlers"></a></p>
<h3 id="webhook">Webhookイベントハンドラの定義<a class="headerlink" href="#webhook" title="Permanent link">&para;</a></h3>
<p>Cashierは、失敗した請求に対するサブスクリプションのキャンセルやその他の一般的なStripe Webhookイベントを自動的に処理します。ただし、追加のWebhookイベントを処理したい場合は、Cashierによってディスパッチされる次のイベントをリッスンすることで行うことができます。</p>
<ul>
<li><code>Laravel\Cashier\Events\WebhookReceived</code></li>
<li><code>Laravel\Cashier\Events\WebhookHandled</code></li>
</ul>
<p>両方のイベントには、Stripe Webhookの完全なペイロードが含まれています。例えば、<code>invoice.payment_succeeded</code> Webhookを処理したい場合は、イベントを処理する<a href="events.html#defining-listeners">リスナー</a>を登録することができます。</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Listeners</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Laravel\Cashier\Events\WebhookReceived</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">StripeEventListener</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * Handle received Stripe webhooks.</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">WebhookReceived</span> <span class="nv">$event</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$event</span><span class="o">-&gt;</span><span class="na">payload</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;invoice.payment_succeeded&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Handle the incoming event...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><a name="verifying-webhook-signatures"></a></p>
<h3 id="webhook_1">Webhook署名の検証<a class="headerlink" href="#webhook_1" title="Permanent link">&para;</a></h3>
<p>Webhookを保護するために、<a href="https://stripe.com/docs/webhooks/signatures">StripeのWebhook署名</a>を使用することができます。便宜上、Cashierには受信Stripe Webhookリクエストが有効であることを検証するミドルウェアが自動的に含まれています。</p>
<p>Webhook検証を有効にするには、アプリケーションの<code>.env</code>ファイルに<code>STRIPE_WEBHOOK_SECRET</code>環境変数が設定されていることを確認してください。Webhook <code>secret</code>は、Stripeアカウントのダッシュボードから取得できます。</p>
<p><a name="single-charges"></a></p>
<h2 id="_63">一括請求<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h2>
<p><a name="simple-charge"></a></p>
<h3 id="_64">単一請求<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h3>
<p>顧客に対して一括請求を行いたい場合は、請求可能なモデルインスタンスで<code>charge</code>メソッドを使用できます。<code>charge</code>メソッドの第2引数として、<a href="#payment-methods-for-single-charges">支払い方法識別子</a>を指定する必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;/purchase&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$stripeCharge</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">charge</span><span class="p">(</span>
        <span class="mi">100</span><span class="p">,</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">paymentMethodId</span>
    <span class="p">);</span>

    <span class="c1">// ...</span>
<span class="p">});</span>
</code></pre></div>
<p><code>charge</code>メソッドは、第3引数として配列を受け取り、基礎となるStripe請求作成に渡すオプションを指定できます。請求作成時に利用可能なオプションについては、<a href="https://stripe.com/docs/api/charges/create">Stripeドキュメント</a>を参照してください。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">charge</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nv">$paymentMethod</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;custom_option&#39;</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div>
<p>また、顧客やユーザーを基にせずに<code>charge</code>メソッドを使用することもできます。そのためには、アプリケーションの請求可能モデルの新しいインスタンスで<code>charge</code>メソッドを呼び出します。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>

<span class="nv">$stripeCharge</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">User</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">charge</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nv">$paymentMethod</span><span class="p">);</span>
</code></pre></div>
<p><code>charge</code>メソッドは、請求が失敗した場合に例外をスローします。請求が成功した場合、メソッドから<code>Laravel\Cashier\Payment</code>のインスタンスが返されます。</p>
<div class="highlight"><pre><span></span><code><span class="k">try</span> <span class="p">{</span>
    <span class="nv">$payment</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">charge</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nv">$paymentMethod</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>charge</code>メソッドは、アプリケーションで使用される通貨の最小単位で支払い金額を受け取ります。例えば、顧客が米ドルで支払う場合、金額はペニーで指定する必要があります。</p>
</div>
<p><a name="charge-with-invoice"></a></p>
<h3 id="_65">請求書付き請求<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h3>
<p>時には、一括請求を行い、顧客にPDF請求書を提供する必要があるかもしれません。<code>invoicePrice</code>メソッドを使用すると、それが可能になります。例えば、顧客に5枚の新しいTシャツを請求してみましょう。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">invoicePrice</span><span class="p">(</span><span class="s1">&#39;price_tshirt&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</code></pre></div>
<p>請求書は、顧客のデフォルト支払い方法に対して即座に請求されます。<code>invoicePrice</code>メソッドは、第3引数として配列を受け取ります。この配列には、請求書アイテムの請求オプションが含まれます。メソッドの第4引数も配列で、請求書自体の請求オプションが含まれます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">invoicePrice</span><span class="p">(</span><span class="s1">&#39;price_tshirt&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;discounts&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">[</span><span class="s1">&#39;coupon&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;SUMMER21SALE&#39;</span><span class="p">]</span>
    <span class="p">],</span>
<span class="p">],</span> <span class="p">[</span>
    <span class="s1">&#39;default_tax_rates&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;txr_id&#39;</span><span class="p">],</span>
<span class="p">]);</span>
</code></pre></div>
<p><code>invoicePrice</code>と同様に、<code>tabPrice</code>メソッドを使用して、複数のアイテム（請求書ごとに最大250アイテム）に対して一括請求を行うことができます。これにより、顧客の「タブ」にアイテムを追加し、顧客に請求することができます。例えば、顧客に5枚のTシャツと2つのマグカップを請求してみましょう。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">tabPrice</span><span class="p">(</span><span class="s1">&#39;price_tshirt&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">tabPrice</span><span class="p">(</span><span class="s1">&#39;price_mug&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">invoice</span><span class="p">();</span>
</code></pre></div>
<p>また、<code>invoiceFor</code>メソッドを使用して、顧客のデフォルト支払い方法に対して「一括請求」を行うこともできます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">invoiceFor</span><span class="p">(</span><span class="s1">&#39;One Time Fee&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
</code></pre></div>
<p><code>invoiceFor</code>メソッドは使用可能ですが、事前に定義された価格を使用する<code>invoicePrice</code>および<code>tabPrice</code>メソッドを使用することをお勧めします。これにより、Stripeダッシュボード内で製品ごとの販売に関するより良い分析とデータにアクセスできます。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>invoice</code>、<code>invoicePrice</code>、および<code>invoiceFor</code>メソッドは、失敗した請求を再試行するStripe請求書を作成します。請求が失敗した場合に請求書を再試行しないようにするには、最初の請求が失敗した後にStripe APIを使用して請求書を閉じる必要があります。</p>
</div>
<p><a name="creating-payment-intents"></a></p>
<h3 id="_66">支払いインテントの作成<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h3>
<p>請求可能なモデルインスタンスで<code>pay</code>メソッドを呼び出すことで、新しいStripe支払いインテントを作成できます。このメソッドを呼び出すと、<code>Laravel\Cashier\Payment</code>インスタンスにラップされた支払いインテントが作成されます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;/pay&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$payment</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">pay</span><span class="p">(</span>
        <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="nv">$payment</span><span class="o">-&gt;</span><span class="na">client_secret</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div>
<p>支払いインテントを作成した後、クライアントシークレットをアプリケーションのフロントエンドに返すことで、ユーザーがブラウザで支払いを完了できるようになります。Stripeの支払いインテントを使用して完全な支払いフローを構築する方法について詳しく知りたい場合は、<a href="https://stripe.com/docs/payments/accept-a-payment?platform=web">Stripeのドキュメント</a>を参照してください。</p>
<p><code>pay</code>メソッドを使用する場合、Stripeダッシュボード内で有効になっているデフォルトの支払い方法が顧客に提供されます。代わりに、特定の支払い方法のみを許可したい場合は、<code>payWith</code>メソッドを使用できます：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">&#39;/pay&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$payment</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">payWith</span><span class="p">(</span>
        <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;card&#39;</span><span class="p">,</span> <span class="s1">&#39;bancontact&#39;</span><span class="p">]</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="nv">$payment</span><span class="o">-&gt;</span><span class="na">client_secret</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>pay</code>と<code>payWith</code>メソッドは、アプリケーションで使用される通貨の最小単位で支払い金額を受け付けます。例えば、顧客が米ドルで支払う場合、金額はペニーで指定する必要があります。</p>
</div>
<p><a name="refunding-charges"></a></p>
<h3 id="_67">返金<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>Stripeの請求を返金する必要がある場合、<code>refund</code>メソッドを使用できます。このメソッドは、最初の引数としてStripeの<a href="#payment-methods-for-single-charges">支払いインテントID</a>を受け取ります：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$payment</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">charge</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nv">$paymentMethodId</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">refund</span><span class="p">(</span><span class="nv">$payment</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
</code></pre></div>
<p><a name="invoices"></a></p>
<h2 id="_68">請求書<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h2>
<p><a name="retrieving-invoices"></a></p>
<h3 id="_69">請求書の取得<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p><code>invoices</code>メソッドを使用して、課金可能なモデルの請求書の配列を簡単に取得できます。<code>invoices</code>メソッドは、<code>Laravel\Cashier\Invoice</code>インスタンスのコレクションを返します：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$invoices</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">invoices</span><span class="p">();</span>
</code></pre></div>
<p>結果に保留中の請求書を含めたい場合は、<code>invoicesIncludingPending</code>メソッドを使用できます：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$invoices</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">invoicesIncludingPending</span><span class="p">();</span>
</code></pre></div>
<p><code>findInvoice</code>メソッドを使用して、IDで特定の請求書を取得できます：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">findInvoice</span><span class="p">(</span><span class="nv">$invoiceId</span><span class="p">);</span>
</code></pre></div>
<p><a name="displaying-invoice-information"></a></p>
<h4 id="_70">請求書情報の表示<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h4>
<p>顧客の請求書をリストアップする際に、請求書のメソッドを使用して関連する請求書情報を表示できます。例えば、テーブルにすべての請求書をリストアップし、ユーザーが簡単にダウンロードできるようにすることができます：</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="nx">table</span><span class="o">&gt;</span>
    <span class="o">@</span><span class="k">foreach</span> <span class="p">(</span><span class="nv">$invoices</span> <span class="k">as</span> <span class="nv">$invoice</span><span class="p">)</span>
        <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span><span class="p">{{</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">date</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">toFormattedDateString</span><span class="p">()</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="nx">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;</span><span class="p">{{</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">total</span><span class="p">()</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="nx">td</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/invoice/{{ </span><span class="si">$invoice-&gt;id</span><span class="s2"> }}&quot;</span><span class="o">&gt;</span><span class="nx">Download</span><span class="o">&lt;/</span><span class="nx">a</span><span class="o">&gt;&lt;/</span><span class="nx">td</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="nx">tr</span><span class="o">&gt;</span>
    <span class="o">@</span><span class="k">endforeach</span>
<span class="o">&lt;/</span><span class="nx">table</span><span class="o">&gt;</span>
</code></pre></div>
<p><a name="upcoming-invoices"></a></p>
<h3 id="_71">今後の請求書<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h3>
<p>顧客の今後の請求書を取得するには、<code>upcomingInvoice</code>メソッドを使用できます：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">upcomingInvoice</span><span class="p">();</span>
</code></pre></div>
<p>同様に、顧客が複数のサブスクリプションを持っている場合、特定のサブスクリプションの今後の請求書を取得することもできます：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">upcomingInvoice</span><span class="p">();</span>
</code></pre></div>
<p><a name="previewing-subscription-invoices"></a></p>
<h3 id="_72">サブスクリプション請求書のプレビュー<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h3>
<p><code>previewInvoice</code>メソッドを使用して、価格変更を行う前に請求書をプレビューできます。これにより、特定の価格変更が行われた場合に顧客の請求書がどのように見えるかを確認できます：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">previewInvoice</span><span class="p">(</span><span class="s1">&#39;price_yearly&#39;</span><span class="p">);</span>
</code></pre></div>
<p>複数の新しい価格で請求書をプレビューするために、<code>previewInvoice</code>メソッドに価格の配列を渡すこともできます：</p>
<div class="highlight"><pre><span></span><code><span class="nv">$invoice</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">previewInvoice</span><span class="p">([</span><span class="s1">&#39;price_yearly&#39;</span><span class="p">,</span> <span class="s1">&#39;price_metered&#39;</span><span class="p">]);</span>
</code></pre></div>
<p><a name="generating-invoice-pdfs"></a></p>
<h3 id="pdf">請求書PDFの生成<a class="headerlink" href="#pdf" title="Permanent link">&para;</a></h3>
<p>請求書PDFを生成する前に、Composerを使用してDompdfライブラリをインストールする必要があります。これは、Cashierのデフォルトの請求書レンダラーです：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="nx">composer</span> <span class="k">require</span> <span class="nx">dompdf</span><span class="o">/</span><span class="nx">dompdf</span>
</code></pre></div>
<p>ルートまたはコントローラ内から、<code>downloadInvoice</code>メソッドを使用して、指定された請求書のPDFダウンロードを生成できます。このメソッドは、請求書のダウンロードに必要な適切なHTTPレスポンスを自動的に生成します：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/user/invoice/{invoice}&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$invoiceId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">downloadInvoice</span><span class="p">(</span><span class="nv">$invoiceId</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>デフォルトでは、請求書上のすべてのデータは、Stripeに保存された顧客と請求書のデータから派生します。ファイル名は<code>app.name</code>設定値に基づいています。ただし、<code>downloadInvoice</code>メソッドに2番目の引数として配列を提供することで、このデータの一部をカスタマイズできます。この配列を使用して、会社や製品の詳細などの情報をカスタマイズできます：</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">downloadInvoice</span><span class="p">(</span><span class="nv">$invoiceId</span><span class="p">,</span> <span class="p">[</span>
    <span class="s1">&#39;vendor&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Your Company&#39;</span><span class="p">,</span>
    <span class="s1">&#39;product&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Your Product&#39;</span><span class="p">,</span>
    <span class="s1">&#39;street&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Main Str. 1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;location&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;2000 Antwerp, Belgium&#39;</span><span class="p">,</span>
    <span class="s1">&#39;phone&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;+32 499 00 00 00&#39;</span><span class="p">,</span>
    <span class="s1">&#39;email&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;info@example.com&#39;</span><span class="p">,</span>
    <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;https://example.com&#39;</span><span class="p">,</span>
    <span class="s1">&#39;vendorVat&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;BE123456789&#39;</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div>
<p><code>downloadInvoice</code>メソッドは、3番目の引数を介してカスタムファイル名も許可します。このファイル名には、自動的に<code>.pdf</code>が付加されます：</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">downloadInvoice</span><span class="p">(</span><span class="nv">$invoiceId</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">&#39;my-invoice&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="custom-invoice-render"></a></p>
<h4 id="_73">カスタム請求書レンダラー<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h4>
<p>Cashierでは、カスタム請求書レンダラーを使用することも可能です。デフォルトでは、Cashierは<code>DompdfInvoiceRenderer</code>実装を使用し、<a href="https://github.com/dompdf/dompdf">dompdf</a> PHPライブラリを使用してCashierの請求書を生成します。ただし、<code>Laravel\Cashier\Contracts\InvoiceRenderer</code>インターフェースを実装することで、任意のレンダラーを使用できます。例えば、サードパーティのPDFレンダリングサービスへのAPIコールを使用して請求書PDFをレンダリングすることができます：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Http</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Laravel\Cashier\Contracts\InvoiceRenderer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Laravel\Cashier\Invoice</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ApiInvoiceRenderer</span> <span class="k">implements</span> <span class="nx">InvoiceRenderer</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 指定された請求書をレンダリングし、生のPDFバイトを返します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nx">Invoice</span> <span class="nv">$invoice</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$data</span> <span class="o">=</span> <span class="p">[],</span> <span class="k">array</span> <span class="nv">$options</span> <span class="o">=</span> <span class="p">[])</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="nv">$html</span> <span class="o">=</span> <span class="nv">$invoice</span><span class="o">-&gt;</span><span class="na">view</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">Http</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;https://example.com/html-to-pdf&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;html&#39;</span> <span class="o">=&gt;</span> <span class="nv">$html</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">body</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>請求書レンダラー契約を実装したら、アプリケーションの<code>config/cashier.php</code>設定ファイル内の<code>cashier.invoices.renderer</code>設定値を更新する必要があります。この設定値は、カスタムレンダラー実装のクラス名に設定する必要があります。</p>
<p><a name="checkout"></a></p>
<h2 id="_74">チェックアウト<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h2>
<p>Cashier Stripeは、<a href="https://stripe.com/payments/checkout">Stripe Checkout</a>もサポートしています。Stripe Checkoutは、支払いを受け付けるためのカスタムページを実装する手間を省いてくれる、事前に構築されたホストされた支払いページを提供します。</p>
<p>以下のドキュメントには、CashierでStripe Checkoutを使い始める方法についての情報が含まれています。Stripe Checkoutについてより詳しく知りたい場合は、<a href="https://stripe.com/docs/payments/checkout">StripeのCheckoutに関する独自のドキュメント</a>も確認することを検討してください。</p>
<p><a name="product-checkouts"></a></p>
<h3 id="_75">商品のチェックアウト<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>Stripeダッシュボード内で作成された既存の商品のチェックアウトを実行するには、課金可能なモデルの<code>checkout</code>メソッドを使用します。<code>checkout</code>メソッドは、新しいStripe Checkoutセッションを開始します。デフォルトでは、Stripe Price IDを渡す必要があります：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/product-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkout</span><span class="p">(</span><span class="s1">&#39;price_tshirt&#39;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>必要に応じて、商品の数量を指定することもできます：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/product-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkout</span><span class="p">([</span><span class="s1">&#39;price_tshirt&#39;</span> <span class="o">=&gt;</span> <span class="mi">15</span><span class="p">]);</span>
<span class="p">});</span>
</code></pre></div>
<p>顧客がこのルートにアクセスすると、Stripeのチェックアウトページにリダイレクトされます。ユーザーが購入を正常に完了するかキャンセルすると、デフォルトで<code>home</code>ルートの場所にリダイレクトされますが、<code>success_url</code>と<code>cancel_url</code>オプションを使用してカスタムコールバックURLを指定できます：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/product-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkout</span><span class="p">([</span><span class="s1">&#39;price_tshirt&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span>
        <span class="s1">&#39;success_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-success-route&#39;</span><span class="p">),</span>
        <span class="s1">&#39;cancel_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-cancel-route&#39;</span><span class="p">),</span>
    <span class="p">]);</span>
<span class="p">});</span>
</code></pre></div>
<p><code>success_url</code>チェックアウトオプションを定義する際に、StripeにチェックアウトセッションIDをクエリ文字列パラメータとして追加するよう指示できます。そのためには、<code>success_url</code>クエリ文字列にリテラル文字列<code>{CHECKOUT_SESSION_ID}</code>を追加します。Stripeはこのプレースホルダを実際のチェックアウトセッションIDに置き換えます：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Stripe\Checkout\Session</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Stripe\Customer</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/product-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkout</span><span class="p">([</span><span class="s1">&#39;price_tshirt&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span>
        <span class="s1">&#39;success_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;checkout-success&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;?session_id={CHECKOUT_SESSION_ID}&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cancel_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;checkout-cancel&#39;</span><span class="p">),</span>
    <span class="p">]);</span>
<span class="p">});</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/checkout-success&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$checkoutSession</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">stripe</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkout</span><span class="o">-&gt;</span><span class="na">sessions</span><span class="o">-&gt;</span><span class="na">retrieve</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">));</span>

    <span class="k">return</span> <span class="nx">view</span><span class="p">(</span><span class="s1">&#39;checkout.success&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;checkoutSession&#39;</span> <span class="o">=&gt;</span> <span class="nv">$checkoutSession</span><span class="p">]);</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;checkout-success&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="checkout-promotion-codes"></a></p>
<h4 id="_76">プロモーションコード<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h4>
<p>デフォルトでは、Stripe Checkoutは<a href="https://stripe.com/docs/billing/subscriptions/discounts/codes">ユーザーが利用可能なプロモーションコード</a>を許可しません。幸いなことに、チェックアウトページでこれらを有効にする簡単な方法があります。そのためには、<code>allowPromotionCodes</code>メソッドを呼び出すことができます：</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/product-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">allowPromotionCodes</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">checkout</span><span class="p">(</span><span class="s1">&#39;price_tshirt&#39;</span><span class="p">);</span>
</code></pre></div>
<p>});</p>
<p><a name="single-charge-checkouts"></a></p>
<h3 id="_77">単発課金のチェックアウト<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>また、Stripeダッシュボードで作成されていないアドホックな商品の単純な課金を行うこともできます。そのためには、請求可能なモデルの<code>checkoutCharge</code>メソッドを使用し、課金可能な金額、商品名、およびオプションの数量を渡します。顧客がこのルートにアクセスすると、Stripeのチェックアウトページにリダイレクトされます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/charge-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkoutCharge</span><span class="p">(</span><span class="mi">1200</span><span class="p">,</span> <span class="s1">&#39;T-Shirt&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="p">});</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>checkoutCharge</code>メソッドを使用する場合、Stripeは常に新しい商品と価格をStripeダッシュボードに作成します。したがって、Stripeダッシュボードで事前に商品を作成し、代わりに<code>checkout</code>メソッドを使用することをお勧めします。</p>
</div>
<p><a name="subscription-checkouts"></a></p>
<h3 id="_78">サブスクリプションのチェックアウト<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Stripe Checkoutを使用してサブスクリプションを開始するには、Stripeダッシュボードで<code>customer.subscription.created</code>ウェブフックを有効にする必要があります。このウェブフックは、データベースにサブスクリプションレコードを作成し、関連するすべてのサブスクリプションアイテムを保存します。</p>
</div>
<p>Stripe Checkoutを使用してサブスクリプションを開始することもできます。Cashierのサブスクリプションビルダーメソッドでサブスクリプションを定義した後、<code>checkout</code>メソッドを呼び出すことができます。顧客がこのルートにアクセスすると、Stripeのチェックアウトページにリダイレクトされます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/subscription-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>        <span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span>
<a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>        <span class="o">-&gt;</span><span class="na">checkout</span><span class="p">();</span>
<a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a><span class="p">});</span>
</code></pre></div>
<p>商品のチェックアウトと同様に、成功とキャンセルのURLをカスタマイズできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a>
<a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/subscription-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span>
<a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a>        <span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span>
<a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a>        <span class="o">-&gt;</span><span class="na">checkout</span><span class="p">([</span>
<a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a>            <span class="s1">&#39;success_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-success-route&#39;</span><span class="p">),</span>
<a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a>            <span class="s1">&#39;cancel_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-cancel-route&#39;</span><span class="p">),</span>
<a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>        <span class="p">]);</span>
<a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a><span class="p">});</span>
</code></pre></div>
<p>もちろん、サブスクリプションのチェックアウトにプロモーションコードを有効にすることもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a>
<a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/subscription-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a>    <span class="k">return</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span>
<a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a>        <span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span>
<a id="__codelineno-73-6" name="__codelineno-73-6" href="#__codelineno-73-6"></a>        <span class="o">-&gt;</span><span class="na">allowPromotionCodes</span><span class="p">()</span>
<a id="__codelineno-73-7" name="__codelineno-73-7" href="#__codelineno-73-7"></a>        <span class="o">-&gt;</span><span class="na">checkout</span><span class="p">();</span>
<a id="__codelineno-73-8" name="__codelineno-73-8" href="#__codelineno-73-8"></a><span class="p">});</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>残念ながら、Stripe Checkoutはサブスクリプションを開始する際にすべてのサブスクリプションの課金オプションをサポートしていません。サブスクリプションビルダーで<code>anchorBillingCycleOn</code>メソッドを使用したり、日割り計算の動作を設定したり、支払いの動作を設定したりしても、Stripe Checkoutセッション中には何の効果もありません。利用可能なパラメータについては、<a href="https://stripe.com/docs/api/checkout/sessions/create">Stripe CheckoutセッションAPIドキュメント</a>を参照してください。</p>
</div>
<p><a name="stripe-checkout-trial-periods"></a></p>
<h4 id="stripe-checkout_1">Stripe Checkoutとトライアル期間<a class="headerlink" href="#stripe-checkout_1" title="Permanent link">&para;</a></h4>
<p>もちろん、Stripe Checkoutを使用して完了するサブスクリプションを構築する際に、トライアル期間を定義できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="nv">$checkout</span> <span class="o">=</span> <span class="nx">Auth</span><span class="o">::</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>    <span class="o">-&gt;</span><span class="na">trialDays</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>    <span class="o">-&gt;</span><span class="na">checkout</span><span class="p">();</span>
</code></pre></div>
<p>ただし、トライアル期間は少なくとも48時間でなければなりません。これは、Stripe Checkoutがサポートする最小のトライアル時間です。</p>
<p><a name="stripe-checkout-subscriptions-and-webhooks"></a></p>
<h4 id="_79">サブスクリプションとウェブフック<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h4>
<p>StripeとCashierはウェブフックを介してサブスクリプションのステータスを更新することを忘れないでください。したがって、顧客が支払い情報を入力した後にアプリケーションに戻ったときに、サブスクリプションがまだアクティブでない可能性があります。このシナリオを処理するために、支払いまたはサブスクリプションが保留中であることをユーザーに通知するメッセージを表示することができます。</p>
<p><a name="collecting-tax-ids"></a></p>
<h3 id="id_1">税IDの収集<a class="headerlink" href="#id_1" title="Permanent link">&para;</a></h3>
<p>チェックアウトは、顧客の税IDの収集もサポートしています。セッションを作成する際に<code>collectTaxIds</code>メソッドを呼び出すことで、これをチェックアウトセッションで有効にできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="nv">$checkout</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">collectTaxIds</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">checkout</span><span class="p">(</span><span class="s1">&#39;price_tshirt&#39;</span><span class="p">);</span>
</code></pre></div>
<p>このメソッドが呼び出されると、顧客が会社として購入しているかどうかを示す新しいチェックボックスが顧客に表示されます。もしそうなら、税ID番号を提供する機会があります。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>アプリケーションのサービスプロバイダで<a href="#tax-configuration">自動税収集</a>を既に設定している場合、この機能は自動的に有効になり、<code>collectTaxIds</code>メソッドを呼び出す必要はありません。</p>
</div>
<p><a name="guest-checkouts"></a></p>
<h3 id="_80">ゲストチェックアウト<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h3>
<p><code>Checkout::guest</code>メソッドを使用すると、アプリケーションのゲスト（アカウントを持たないユーザー）のチェックアウトセッションを開始できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="k">use</span> <span class="nx">Laravel\Cashier\Checkout</span><span class="p">;</span>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/product-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a>    <span class="k">return</span> <span class="nx">Checkout</span><span class="o">::</span><span class="na">guest</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="s1">&#39;price_tshirt&#39;</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-76-6" name="__codelineno-76-6" href="#__codelineno-76-6"></a>        <span class="s1">&#39;success_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-success-route&#39;</span><span class="p">),</span>
<a id="__codelineno-76-7" name="__codelineno-76-7" href="#__codelineno-76-7"></a>        <span class="s1">&#39;cancel_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-cancel-route&#39;</span><span class="p">),</span>
<a id="__codelineno-76-8" name="__codelineno-76-8" href="#__codelineno-76-8"></a>    <span class="p">]);</span>
<a id="__codelineno-76-9" name="__codelineno-76-9" href="#__codelineno-76-9"></a><span class="p">});</span>
</code></pre></div>
<p>既存のユーザーのチェックアウトセッションを作成する場合と同様に、<code>Laravel\Cashier\CheckoutBuilder</code>インスタンスで利用可能な追加のメソッドを使用して、ゲストチェックアウトセッションをカスタマイズできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="k">use</span> <span class="nx">Laravel\Cashier\Checkout</span><span class="p">;</span>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a><span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/product-checkout&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a>    <span class="k">return</span> <span class="nx">Checkout</span><span class="o">::</span><span class="na">guest</span><span class="p">()</span>
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>        <span class="o">-&gt;</span><span class="na">withPromotionCode</span><span class="p">(</span><span class="s1">&#39;promo-code&#39;</span><span class="p">)</span>
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a>        <span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="s1">&#39;price_tshirt&#39;</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-77-8" name="__codelineno-77-8" href="#__codelineno-77-8"></a>            <span class="s1">&#39;success_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-success-route&#39;</span><span class="p">),</span>
<a id="__codelineno-77-9" name="__codelineno-77-9" href="#__codelineno-77-9"></a>            <span class="s1">&#39;cancel_url&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;your-cancel-route&#39;</span><span class="p">),</span>
<a id="__codelineno-77-10" name="__codelineno-77-10" href="#__codelineno-77-10"></a>        <span class="p">]);</span>
<a id="__codelineno-77-11" name="__codelineno-77-11" href="#__codelineno-77-11"></a><span class="p">});</span>
</code></pre></div>
<p>ゲストチェックアウトが完了した後、Stripeは<code>checkout.session.completed</code>ウェブフックイベントをディスパッチできます。そのため、このイベントをアプリケーションに実際に送信するように<a href="https://dashboard.stripe.com/webhooks">Stripeウェブフックを設定</a>してください。Stripeダッシュボード内でウェブフックが有効になったら、<a href="#handling-stripe-webhooks">Cashierでウェブフックを処理</a>できます。ウェブフックペイロードに含まれるオブジェクトは、顧客の注文を履行するために検査できる<a href="https://stripe.com/docs/api/checkout/sessions/object"><code>checkout</code>オブジェクト</a>になります。</p>
<p><a name="handling-failed-payments"></a></p>
<h2 id="_81">失敗した支払いの処理<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h2>
<p>時には、サブスクリプションや単発の課金の支払いが失敗することがあります。この場合、Cashierは<code>Laravel\Cashier\Exceptions\IncompletePayment</code>例外をスローし、これが発生したことを通知します。この例外をキャッチした後、2つの選択肢があります。</p>
<p>まず、顧客をCashierに含まれる専用の支払い確認ページにリダイレクトすることができます。このページには、Cashierのサービスプロバイダを介して登録された名前付きルートが既にあります。したがって、<code>IncompletePayment</code>例外をキャッチし、ユーザーを支払い確認ページにリダイレクトできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="k">use</span> <span class="nx">Laravel\Cashier\Exceptions\IncompletePayment</span><span class="p">;</span>
<a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>
<a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="k">try</span> <span class="p">{</span>
<a id="__codelineno-78-4" name="__codelineno-78-4" href="#__codelineno-78-4"></a>    <span class="nv">$subscription</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">newSubscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;price_monthly&#39;</span><span class="p">)</span>
<a id="__codelineno-78-5" name="__codelineno-78-5" href="#__codelineno-78-5"></a>                            <span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$paymentMethod</span><span class="p">);</span>
<a id="__codelineno-78-6" name="__codelineno-78-6" href="#__codelineno-78-6"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">IncompletePayment</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-78-7" name="__codelineno-78-7" href="#__codelineno-78-7"></a>    <span class="k">return</span> <span class="nx">redirect</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">route</span><span class="p">(</span>
<a id="__codelineno-78-8" name="__codelineno-78-8" href="#__codelineno-78-8"></a>        <span class="s1">&#39;cashier.payment&#39;</span><span class="p">,</span>
<a id="__codelineno-78-9" name="__codelineno-78-9" href="#__codelineno-78-9"></a>        <span class="p">[</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">payment</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span> <span class="s1">&#39;redirect&#39;</span> <span class="o">=&gt;</span> <span class="nx">route</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">)]</span>
<a id="__codelineno-78-10" name="__codelineno-78-10" href="#__codelineno-78-10"></a>    <span class="p">);</span>
<a id="__codelineno-78-11" name="__codelineno-78-11" href="#__codelineno-78-11"></a><span class="p">}</span>
</code></pre></div>
<p>支払い確認ページで、顧客はクレジットカード情報を再度入力し、Stripeが要求する追加のアクション（例：「3D Secure」の確認）を実行するよう求められます。支払いを確認した後、ユーザーは上記で指定した<code>redirect</code>パラメータで提供されたURLにリダイレクトされます。リダイレクト時に、<code>message</code>（文字列）と<code>success</code>（整数）のクエリ文字列変数がURLに追加されます。支払いページは現在、以下の支払い方法タイプをサポートしています。</p>
<div class="content-list">
<ul>
<li>クレジットカード</li>
<li>アリペイ</li>
<li>Bancontact</li>
<li>BECS Direct Debit</li>
<li>EPS</li>
<li>Giropay</li>
<li>iDEAL</li>
<li>SEPA Direct Debit</li>
</ul>
</div>
<p>あるいは、Stripeに支払い確認を処理させることもできます。この場合、支払い確認ページにリダイレクトする代わりに、<a href="https://dashboard.stripe.com/account/billing/automatic">Stripeの自動請求メール</a>をStripeダッシュボードで設定できます。ただし、<code>IncompletePayment</code>例外がキャッチされた場合、ユーザーにさらなる支払い確認手順を含むメールを受け取ることを通知する必要があります。</p>
<p>支払い例外は、<code>Billable</code>トレイトを使用するモデルの<code>charge</code>、<code>invoiceFor</code>、および<code>invoice</code>メソッドでスローされる可能性があります。サブスクリプションとのやり取りでは、<code>SubscriptionBuilder</code>の<code>create</code>メソッド、および<code>Subscription</code>と<code>SubscriptionItem</code>モデルの<code>incrementAndInvoice</code>と<code>swapAndInvoice</code>メソッドで不完全な支払い例外がスローされる可能性があります。</p>
<p>既存のサブスクリプションに不完全な支払いがあるかどうかを判断するには、請求可能モデルまたはサブスクリプションインスタンスの<code>hasIncompletePayment</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">hasIncompletePayment</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">))</span> <span class="p">{</span>
<a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>    <span class="c1">// ...</span>
<a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="p">}</span>
<a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a>
<a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">hasIncompletePayment</span><span class="p">())</span> <span class="p">{</span>
<a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a>    <span class="c1">// ...</span>
<a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="p">}</span>
</code></pre></div>
<p>不完全な支払いの特定のステータスを取得するには、例外インスタンスの<code>payment</code>プロパティを検査できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="k">use</span> <span class="nx">Laravel\Cashier\Exceptions\IncompletePayment</span><span class="p">;</span>
<a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a>
<a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="k">try</span> <span class="p">{</span>
<a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a>    <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">charge</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;pm_card_threeDSecure2Required&#39;</span><span class="p">);</span>
<a id="__codelineno-80-5" name="__codelineno-80-5" href="#__codelineno-80-5"></a><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">IncompletePayment</span> <span class="nv">$exception</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-80-6" name="__codelineno-80-6" href="#__codelineno-80-6"></a>    <span class="c1">// 支払いインテントのステータスを取得...</span>
<a id="__codelineno-80-7" name="__codelineno-80-7" href="#__codelineno-80-7"></a>    <span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">payment</span><span class="o">-&gt;</span><span class="na">status</span><span class="p">;</span>
<a id="__codelineno-80-8" name="__codelineno-80-8" href="#__codelineno-80-8"></a>
<a id="__codelineno-80-9" name="__codelineno-80-9" href="#__codelineno-80-9"></a>    <span class="c1">// 特定の条件をチェック...</span>
<a id="__codelineno-80-10" name="__codelineno-80-10" href="#__codelineno-80-10"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">payment</span><span class="o">-&gt;</span><span class="na">requiresPaymentMethod</span><span class="p">())</span> <span class="p">{</span>
<a id="__codelineno-80-11" name="__codelineno-80-11" href="#__codelineno-80-11"></a>        <span class="c1">// ...</span>
<a id="__codelineno-80-12" name="__codelineno-80-12" href="#__codelineno-80-12"></a>    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$exception</span><span class="o">-&gt;</span><span class="na">payment</span><span class="o">-&gt;</span><span class="na">requiresConfirmation</span><span class="p">())</span> <span class="p">{</span>
<a id="__codelineno-80-13" name="__codelineno-80-13" href="#__codelineno-80-13"></a>        <span class="c1">// ...</span>
<a id="__codelineno-80-14" name="__codelineno-80-14" href="#__codelineno-80-14"></a>    <span class="p">}</span>
<a id="__codelineno-80-15" name="__codelineno-80-15" href="#__codelineno-80-15"></a><span class="p">}</span>
</code></pre></div>
<p><a name="confirming-payments"></a></p>
<h3 id="_82">支払いの確認<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>一部の支払い方法では、支払いを確認するために追加のデータが必要です。例えば、SEPA支払い方法では、支払い処理中に追加の「mandate」データが必要です。このデータは、<code>withPaymentConfirmationOptions</code>メソッドを使用してCashierに提供できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$subscription</span><span class="o">-&gt;</span><span class="na">withPaymentConfirmationOptions</span><span class="p">([</span>
    <span class="s1">&#39;mandate_data&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;...&#39;</span><span class="p">,</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">swap</span><span class="p">(</span><span class="s1">&#39;price_xxx&#39;</span><span class="p">);</span>
</code></pre></div>
<p>支払いを確認する際に受け入れられるすべてのオプションを確認するには、<a href="https://stripe.com/docs/api/payment_intents/confirm">Stripe APIドキュメント</a>を参照してください。</p>
<p><a name="strong-customer-authentication"></a></p>
<h2 id="_83">強力な顧客認証<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h2>
<p>あなたの事業や顧客のいずれかがヨーロッパに拠点を置いている場合、EUの強力な顧客認証（SCA）規制に従う必要があります。これらの規制は、2019年9月に欧州連合によって支払い詐欺を防ぐために課されました。幸いなことに、StripeとCashierはSCAに準拠したアプリケーションの構築に対応しています。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>始める前に、<a href="https://stripe.com/guides/strong-customer-authentication">StripeのPSD2とSCAに関するガイド</a>と、<a href="https://stripe.com/docs/strong-customer-authentication">新しいSCA APIに関するドキュメント</a>を確認してください。</p>
</div>
<p><a name="payments-requiring-additional-confirmation"></a></p>
<h3 id="_84">追加の確認を必要とする支払い<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h3>
<p>SCA規制では、支払いを確認して処理するために追加の検証が必要になることがあります。この場合、Cashierは追加の検証が必要であることを通知する<code>Laravel\Cashier\Exceptions\IncompletePayment</code>例外をスローします。これらの例外の処理方法についての詳細は、<a href="#handling-failed-payments">失敗した支払いの処理</a>に関するドキュメントで確認できます。</p>
<p>StripeまたはCashierによって提示される支払い確認画面は、特定の銀行やカード発行者の支払いフローに合わせて調整されることがあり、追加のカード確認、一時的な小額の請求、別のデバイスでの認証、またはその他の形式の検証が含まれることがあります。</p>
<p><a name="incomplete-and-past-due-state"></a></p>
<h4 id="_85">不完全および遅延状態<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h4>
<p>支払いに追加の確認が必要な場合、サブスクリプションは<code>incomplete</code>または<code>past_due</code>状態のままとなり、その状態は<code>stripe_status</code>データベースカラムで示されます。Cashierは、支払い確認が完了し、アプリケーションがStripeからのWebhookによって完了を通知されると、顧客のサブスクリプションを自動的に有効化します。</p>
<p><code>incomplete</code>と<code>past_due</code>状態についての詳細は、<a href="#incomplete-and-past-due-status">これらの状態に関する追加のドキュメント</a>を参照してください。</p>
<p><a name="off-session-payment-notifications"></a></p>
<h3 id="_86">セッション外支払い通知<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p>SCA規制では、顧客がサブスクリプションがアクティブな間でも支払い詳細を定期的に確認する必要があります。たとえば、サブスクリプションの更新時に発生することがあります。Cashierは、セッション外支払い確認が必要な場合に顧客に通知を送信できます。Cashierの支払い通知は、<code>CASHIER_PAYMENT_NOTIFICATION</code>環境変数を通知クラスに設定することで有効にできます。デフォルトでは、この通知は無効になっています。もちろん、Cashierにはこの目的で使用できる通知クラスが含まれていますが、必要に応じて独自の通知クラスを提供することも自由です。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="na">CASHIER_PAYMENT_NOTIFICATION</span><span class="o">=</span><span class="s">Laravel\Cashier\Notifications\ConfirmPayment</span>
</code></pre></div>
<p>セッション外支払い確認通知が配信されるようにするには、<a href="#handling-stripe-webhooks">Stripe Webhookがアプリケーションに対して設定されている</a>こと、およびStripeダッシュボードで<code>invoice.payment_action_required</code> Webhookが有効になっていることを確認してください。さらに、<code>Billable</code>モデルはLaravelの<code>Illuminate\Notifications\Notifiable</code>トレイトを使用する必要があります。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>顧客が手動で追加の確認を必要とする支払いを行っている場合でも、通知は送信されます。残念ながら、Stripeは支払いが手動で行われたか「セッション外」で行われたかを知る方法がありません。しかし、顧客が既に支払いを確認した後に支払いページにアクセスすると、「支払い成功」のメッセージが表示されます。顧客は同じ支払いを誤って2回確認し、誤って2回目の請求を受けることはできません。</p>
</div>
<p><a name="stripe-sdk"></a></p>
<h2 id="stripe-sdk">Stripe SDK<a class="headerlink" href="#stripe-sdk" title="Permanent link">&para;</a></h2>
<p>Cashierの多くのオブジェクトは、Stripe SDKオブジェクトのラッパーです。Stripeオブジェクトと直接やり取りしたい場合は、<code>asStripe</code>メソッドを使用して便利に取得できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$stripeSubscription</span> <span class="o">=</span> <span class="nv">$subscription</span><span class="o">-&gt;</span><span class="na">asStripeSubscription</span><span class="p">();</span>

<span class="nv">$stripeSubscription</span><span class="o">-&gt;</span><span class="na">application_fee_percent</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

<span class="nv">$stripeSubscription</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</code></pre></div>
<p>Stripeサブスクリプションを直接更新するには、<code>updateStripeSubscription</code>メソッドを使用することもできます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$subscription</span><span class="o">-&gt;</span><span class="na">updateStripeSubscription</span><span class="p">([</span><span class="s1">&#39;application_fee_percent&#39;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">]);</span>
</code></pre></div>
<p><code>Stripe\StripeClient</code>クライアントを直接使用したい場合は、<code>Cashier</code>クラスの<code>stripe</code>メソッドを呼び出すことができます。たとえば、このメソッドを使用して<code>StripeClient</code>インスタンスにアクセスし、Stripeアカウントから価格のリストを取得できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Laravel\Cashier\Cashier</span><span class="p">;</span>

<span class="nv">$prices</span> <span class="o">=</span> <span class="nx">Cashier</span><span class="o">::</span><span class="na">stripe</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">prices</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>
</code></pre></div>
<p><a name="testing"></a></p>
<h2 id="_87">テスト<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h2>
<p>Cashierを使用するアプリケーションをテストする際、Stripe APIへの実際のHTTPリクエストをモックすることができます。ただし、これにはCashier自身の動作を部分的に再実装する必要があります。したがって、テストが実際のStripe APIにアクセスすることを推奨します。これは遅くなりますが、アプリケーションが期待通りに動作していることをより確信できます。遅いテストは、Pest / PHPUnitの独自のテストグループ内に配置することができます。</p>
<p>テスト時には、Cashier自体にはすでに優れたテストスイートがあるため、アプリケーションのサブスクリプションと支払いフローのテストに集中し、Cashierのすべての基礎的な動作をテストする必要はありません。</p>
<p>始めるには、Stripeシークレットの<strong>テスト</strong>バージョンを<code>phpunit.xml</code>ファイルに追加します。</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="nx">env</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;STRIPE_SECRET&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;sk_test_&lt;your-key&gt;&quot;</span><span class="o">/&gt;</span>
</code></pre></div>
<p>これで、テスト中にCashierとやり取りするたびに、実際のAPIリクエストがStripeのテスト環境に送信されます。便宜上、テスト中に使用できるサブスクリプションや価格をStripeのテストアカウントに事前に入力しておく必要があります。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>クレジットカードの拒否や失敗など、さまざまな請求シナリオをテストするために、Stripeが提供する幅広い<a href="https://stripe.com/docs/testing">テスト用カード番号とトークン</a>を使用できます。</p>
</div>









  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
<nav class="md-footer-nav">
    
    
</nav>

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["back-to-top", "navigation.expand", "navigation.tabs", "navigation.footer", "navigation.sections", "navigation.expand", "content.code.copy", "hide_repository_button", "content.code.annotate", "content.tabs.link", "toc.none", "content.action.edit"], "search": "assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  </body>
</html>