
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/koriym/laravel11-ja/queues.html">
      
      
        <link rel="prev" href="processes.html">
      
      
        <link rel="next" href="rate-limiting.html">
      
      
      <link rel="icon" href="assets/images/favicon_io/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.35">
    
    
      
        <title>キュー - L11JA</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.35f28582.min.css">
      
      


    
    

    

    
      <link rel="stylesheet" href="assets/css/php.css">
    
      <link rel="stylesheet" href="assets/css/mkdocs_material_extra.css">
    
      <link rel="stylesheet" href="assets/css/extra.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-G60CEHXLQ1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-G60CEHXLQ1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-G60CEHXLQ1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    

  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <!-- Determine classes -->



<!-- Header -->
<header class="md-header" data-md-component="header">
  <nav
          class="md-header__inner md-grid"
          aria-label="Header"
  >

    <!-- Link to home -->
    <a
            href="."
            title="L11JA"
            class="md-header__button md-logo"
            aria-label="L11JA"
            data-md-component="logo"
    >
      
  <img src="assets/images/logo.png" alt="logo">

    </a>

    <!-- Button to open drawer -->
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            <span style="font-family: 'Noto Sans'; font-size: 20px" >
            L11JA
            </span>
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            <span style="font-family: 'Noto Sans Batak'; font-size: 20px" >
            
              キュー
            
            </span>
          </span>
        </div>
      </div>
    </div>

    <!-- Color palette toggle -->
    

    <!-- User preference: color palette -->
    
    <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    

    <!-- Site language selector -->
    

    <!-- Button to open search modal -->
    
    <label class="md-header__button md-icon" for="__search">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
    </label>

    <!-- Search interface -->
    <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    

    <!-- Repository information -->
    
    <div class="md-header__source">
      

<!--
  Check whether the repository is hosted on one of the supported code hosting
  platforms (GitHub, GitLab or Bitbucket) to show icon.
-->


  


<!-- Repository containing source -->
<a href="https://github.com/koriym/l11ja" title="source.link.title"
    class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" fill="#000"/></svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
    
  </nav>

  <!-- Navigation tabs (sticky) -->
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="releases.html" class="md-tabs__link">
          
  
  プロローグ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="installation.html" class="md-tabs__link">
          
  
  はじめに

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="lifecycle.html" class="md-tabs__link">
          
  
  アーキテクチャ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="routing.html" class="md-tabs__link">
          
  
  基本

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="artisan.html" class="md-tabs__link">
          
  
  掘り下げる

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="authentication.html" class="md-tabs__link">
          
  
  セキュリティ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="database.html" class="md-tabs__link">
          
  
  データベース

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="eloquent.html" class="md-tabs__link">
          
  
  Eloquent ORM

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="testing.html" class="md-tabs__link">
          
  
  テスト

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="starter-kits.html" class="md-tabs__link">
          
  
  パッケージ

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="L11JA" class="md-nav__button md-logo" aria-label="L11JA" data-md-component="logo">
      
  <img src="assets/images/logo.png" alt="logo">

    </a>
    L11JA
  </label>
  
    <div class="md-nav__source">
      

<!--
  Check whether the repository is hosted on one of the supported code hosting
  platforms (GitHub, GitLab or Bitbucket) to show icon.
-->


  


<!-- Repository containing source -->
<a href="https://github.com/koriym/l11ja" title="source.link.title"
    class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" fill="#000"/></svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    プロローグ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            プロローグ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="releases.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リリースノート
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="upgrade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    アップグレードガイド
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="contributions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    貢献ガイド
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            はじめに
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="installation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    インストール
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="configuration.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    設定
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="structure.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ディレクトリ構造
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="frontend.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    フロントエンド
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="starter-kits.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    スターターキット
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="deployment.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    デプロイ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    アーキテクチャ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            アーキテクチャ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="lifecycle.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リクエストライフサイクル
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="container.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    サービスコンテナ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="providers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    サービスプロバイダ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="facades.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ファサード
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    基本
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            基本
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="routing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ルーティング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="middleware.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ミドルウェア
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="csrf.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSRF保護
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="controllers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コントローラ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="requests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リクエスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="responses.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    レスポンス
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="views.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ビュー
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="blade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bladeテンプレート
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="vite.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    アセットバンドル
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="urls.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    URL生成
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="session.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    セッション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="validation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    バリデーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="errors.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    エラー処理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="logging.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ログ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    掘り下げる
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            掘り下げる
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="artisan.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Artisanコンソール
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="broadcasting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ブロードキャスティング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cache.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    キャッシュ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="collections.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コレクション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="concurrency.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    並行処理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="context.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コンテキスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="contracts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コントラクト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="events.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    イベント
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="filesystem.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ファイルストレージ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="helpers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ヘルパー
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http-client.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTPクライアント
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="localization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ローカライゼーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mail.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    メール
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="notifications.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    通知
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="packages.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    パッケージ開発
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="processes.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    プロセス
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    キュー
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="queues.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    キュー
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      はじめに
    </span>
  </a>
  
    <nav class="md-nav" aria-label="はじめに">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      接続とキュー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      ドライバの注意事項と前提条件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ドライバの注意事項と前提条件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      データベース
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis" class="md-nav__link">
    <span class="md-ellipsis">
      Redis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      その他のドライバの前提条件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの作成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブの作成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブクラスの生成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      クラス構造
    </span>
  </a>
  
    <nav class="md-nav" aria-label="クラス構造">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#handle" class="md-nav__link">
    <span class="md-ellipsis">
      handleメソッドの依存性注入
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      キューに入れられたリレーション
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      ユニークジョブ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ユニークジョブ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      処理が開始されるまでジョブをユニークに保つ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      ユニークジョブロック
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      暗号化されたジョブ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブミドルウェア
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブミドルウェア">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      レート制限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの重複を防ぐ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブの重複を防ぐ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブクラス間でロックキーを共有する
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      例外のスロットリング
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブのスキップ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブのディスパッチ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブのディスパッチ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      遅延ディスパッチ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="遅延ディスパッチ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      レスポンスがブラウザに送信された後にディスパッチ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      同期ディスパッチ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブとデータベーストランザクション
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブとデータベーストランザクション">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      インラインでのコミットディスパッチ動作の指定
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの連鎖
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブの連鎖">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      連鎖接続とキュー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      連鎖へのジョブの追加
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      連鎖の失敗
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      キューと接続のカスタマイズ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="キューと接続のカスタマイズ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      特定のキューへのディスパッチ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      特定の接続へのディスパッチ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      最大ジョブ試行回数/タイムアウト値の指定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="最大ジョブ試行回数/タイムアウト値の指定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      最大試行回数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      時間ベースの試行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      最大例外数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      タイムアウト
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      タイムアウト時に失敗
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      エラー処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="エラー処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      手動でジョブをリリース
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      手動でジョブを失敗
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブのバッチ処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブのバッチ処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      バッチ可能なジョブの定義
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      バッチのディスパッチ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="バッチのディスパッチ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの命名
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの接続とキュー
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      チェーンとバッチ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      バッチへのジョブの追加
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの検査
    </span>
  </a>
  
    <nav class="md-nav" aria-label="バッチの検査">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    <span class="md-ellipsis">
      ルートからのバッチの返却
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    <span class="md-ellipsis">
      バッチのキャンセル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの失敗
    </span>
  </a>
  
    <nav class="md-nav" aria-label="バッチの失敗">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    <span class="md-ellipsis">
      失敗の許可
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したバッチジョブの再試行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの整理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDBへのバッチの保存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamoDBへのバッチの保存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodb_1" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDBバッチテーブルの設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb_2" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB の設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb_3" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB でのバッチのプルーニング
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    <span class="md-ellipsis">
      クロージャのキューイング
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    <span class="md-ellipsis">
      キューワーカーの実行
    </span>
  </a>
  
    <nav class="md-nav" aria-label="キューワーカーの実行">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#queuework" class="md-nav__link">
    <span class="md-ellipsis">
      queue:work コマンド
    </span>
  </a>
  
    <nav class="md-nav" aria-label="queue:work コマンド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    <span class="md-ellipsis">
      複数のキューワーカーの実行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    <span class="md-ellipsis">
      接続とキューの指定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    <span class="md-ellipsis">
      指定された数のジョブの処理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    <span class="md-ellipsis">
      すべてのキューイングされたジョブを処理してから終了
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    <span class="md-ellipsis">
      指定された秒数のジョブの処理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    <span class="md-ellipsis">
      ワーカーのスリープ時間
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_65" class="md-nav__link">
    <span class="md-ellipsis">
      メンテナンスモードとキュー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_66" class="md-nav__link">
    <span class="md-ellipsis">
      リソースの考慮事項
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_67" class="md-nav__link">
    <span class="md-ellipsis">
      キューの優先度
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_68" class="md-nav__link">
    <span class="md-ellipsis">
      キューワーカーとデプロイ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_69" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの有効期限とタイムアウト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブの有効期限とタイムアウト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_70" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの有効期限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_71" class="md-nav__link">
    <span class="md-ellipsis">
      ワーカーのタイムアウト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supervisor" class="md-nav__link">
    <span class="md-ellipsis">
      Supervisorの設定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Supervisorの設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supervisor_1" class="md-nav__link">
    <span class="md-ellipsis">
      Supervisorのインストール
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supervisor_2" class="md-nav__link">
    <span class="md-ellipsis">
      Supervisorの設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supervisor_3" class="md-nav__link">
    <span class="md-ellipsis">
      Supervisorの起動
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_72" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="失敗したジョブの処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_73" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの後処理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_74" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの再試行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_75" class="md-nav__link">
    <span class="md-ellipsis">
      存在しないモデルの無視
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_76" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの整理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb_4" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブを DynamoDB に保存する
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_77" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの保存を無効にする
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_78" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブのイベント
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_79" class="md-nav__link">
    <span class="md-ellipsis">
      キューからジョブをクリアする
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_80" class="md-nav__link">
    <span class="md-ellipsis">
      キューの監視
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_81" class="md-nav__link">
    <span class="md-ellipsis">
      テスト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="テスト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_82" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブのサブセットをフェイクする
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_83" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブチェーンのテスト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブチェーンのテスト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_84" class="md-nav__link">
    <span class="md-ellipsis">
      チェーンの変更のテスト
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_85" class="md-nav__link">
    <span class="md-ellipsis">
      チェーンされたバッチのテスト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_86" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブバッチのテスト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブバッチのテスト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_87" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブ / バッチの相互作用のテスト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_88" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブ / キューの相互作用のテスト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_89" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブイベント
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="rate-limiting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    レート制限
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="strings.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文字列
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="scheduling.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    タスクスケジューリング
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    セキュリティ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            セキュリティ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="authentication.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    認証
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="authorization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    認可
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="verification.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    メール確認
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="encryption.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    暗号化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="hashing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ハッシュ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="passwords.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    パスワードリセット
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    データベース
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            データベース
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="database.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="queries.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    クエリビルダ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pagination.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ページネーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="migrations.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    マイグレーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="seeding.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    シーディング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="redis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Eloquent ORM
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Eloquent ORM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-relationships.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リレーションシップ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-collections.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コレクション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-mutators.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ミューテータ / キャスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-resources.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    APIリソース
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-serialization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    シリアライゼーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-factories.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ファクトリ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    テスト
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            テスト
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="testing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http-tests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTPテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="console-tests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コンソールテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dusk.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ブラウザテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="database-testing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    データベース
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mocking.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    モック
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    パッケージ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            パッケージ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="starter-kits.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    スターターキット
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="billing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashier (Stripe)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cashier-paddle.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashier (Paddle)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dusk.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ブラウザテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="envoy.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Envoy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fortify.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fortify
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="folio.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Folio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="homestead.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Homestead
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="horizon.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Horizon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mix.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mix
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="octane.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Octane
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="passport.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Passport
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pennant.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pennant
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pint.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pint
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="precognition.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Precognition
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="prompts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prompts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pulse.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pulse
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="reverb.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reverb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sail.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sail
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sanctum.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sanctum
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="scout.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scout
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="socialite.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Socialite
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="telescope.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Telescope
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="valet.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Valet
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      はじめに
    </span>
  </a>
  
    <nav class="md-nav" aria-label="はじめに">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      接続とキュー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      ドライバの注意事項と前提条件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ドライバの注意事項と前提条件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      データベース
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis" class="md-nav__link">
    <span class="md-ellipsis">
      Redis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      その他のドライバの前提条件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの作成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブの作成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブクラスの生成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      クラス構造
    </span>
  </a>
  
    <nav class="md-nav" aria-label="クラス構造">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#handle" class="md-nav__link">
    <span class="md-ellipsis">
      handleメソッドの依存性注入
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      キューに入れられたリレーション
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      ユニークジョブ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ユニークジョブ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      処理が開始されるまでジョブをユニークに保つ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      ユニークジョブロック
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      暗号化されたジョブ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブミドルウェア
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブミドルウェア">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      レート制限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの重複を防ぐ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブの重複を防ぐ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブクラス間でロックキーを共有する
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      例外のスロットリング
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブのスキップ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブのディスパッチ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブのディスパッチ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      遅延ディスパッチ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="遅延ディスパッチ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      レスポンスがブラウザに送信された後にディスパッチ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      同期ディスパッチ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブとデータベーストランザクション
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブとデータベーストランザクション">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      インラインでのコミットディスパッチ動作の指定
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの連鎖
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブの連鎖">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      連鎖接続とキュー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      連鎖へのジョブの追加
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      連鎖の失敗
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      キューと接続のカスタマイズ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="キューと接続のカスタマイズ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      特定のキューへのディスパッチ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      特定の接続へのディスパッチ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      最大ジョブ試行回数/タイムアウト値の指定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="最大ジョブ試行回数/タイムアウト値の指定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      最大試行回数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      時間ベースの試行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      最大例外数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      タイムアウト
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      タイムアウト時に失敗
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      エラー処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="エラー処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      手動でジョブをリリース
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      手動でジョブを失敗
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブのバッチ処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブのバッチ処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      バッチ可能なジョブの定義
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      バッチのディスパッチ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="バッチのディスパッチ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの命名
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの接続とキュー
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      チェーンとバッチ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      バッチへのジョブの追加
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの検査
    </span>
  </a>
  
    <nav class="md-nav" aria-label="バッチの検査">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    <span class="md-ellipsis">
      ルートからのバッチの返却
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    <span class="md-ellipsis">
      バッチのキャンセル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの失敗
    </span>
  </a>
  
    <nav class="md-nav" aria-label="バッチの失敗">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    <span class="md-ellipsis">
      失敗の許可
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したバッチジョブの再試行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    <span class="md-ellipsis">
      バッチの整理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDBへのバッチの保存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DynamoDBへのバッチの保存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodb_1" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDBバッチテーブルの設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb_2" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB の設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb_3" class="md-nav__link">
    <span class="md-ellipsis">
      DynamoDB でのバッチのプルーニング
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    <span class="md-ellipsis">
      クロージャのキューイング
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    <span class="md-ellipsis">
      キューワーカーの実行
    </span>
  </a>
  
    <nav class="md-nav" aria-label="キューワーカーの実行">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#queuework" class="md-nav__link">
    <span class="md-ellipsis">
      queue:work コマンド
    </span>
  </a>
  
    <nav class="md-nav" aria-label="queue:work コマンド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    <span class="md-ellipsis">
      複数のキューワーカーの実行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    <span class="md-ellipsis">
      接続とキューの指定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    <span class="md-ellipsis">
      指定された数のジョブの処理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    <span class="md-ellipsis">
      すべてのキューイングされたジョブを処理してから終了
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    <span class="md-ellipsis">
      指定された秒数のジョブの処理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    <span class="md-ellipsis">
      ワーカーのスリープ時間
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_65" class="md-nav__link">
    <span class="md-ellipsis">
      メンテナンスモードとキュー
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_66" class="md-nav__link">
    <span class="md-ellipsis">
      リソースの考慮事項
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_67" class="md-nav__link">
    <span class="md-ellipsis">
      キューの優先度
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_68" class="md-nav__link">
    <span class="md-ellipsis">
      キューワーカーとデプロイ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_69" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの有効期限とタイムアウト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブの有効期限とタイムアウト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_70" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブの有効期限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_71" class="md-nav__link">
    <span class="md-ellipsis">
      ワーカーのタイムアウト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#supervisor" class="md-nav__link">
    <span class="md-ellipsis">
      Supervisorの設定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Supervisorの設定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#supervisor_1" class="md-nav__link">
    <span class="md-ellipsis">
      Supervisorのインストール
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supervisor_2" class="md-nav__link">
    <span class="md-ellipsis">
      Supervisorの設定
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#supervisor_3" class="md-nav__link">
    <span class="md-ellipsis">
      Supervisorの起動
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_72" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの処理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="失敗したジョブの処理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_73" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの後処理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_74" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの再試行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_75" class="md-nav__link">
    <span class="md-ellipsis">
      存在しないモデルの無視
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_76" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの整理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dynamodb_4" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブを DynamoDB に保存する
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_77" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブの保存を無効にする
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_78" class="md-nav__link">
    <span class="md-ellipsis">
      失敗したジョブのイベント
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_79" class="md-nav__link">
    <span class="md-ellipsis">
      キューからジョブをクリアする
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_80" class="md-nav__link">
    <span class="md-ellipsis">
      キューの監視
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_81" class="md-nav__link">
    <span class="md-ellipsis">
      テスト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="テスト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_82" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブのサブセットをフェイクする
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_83" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブチェーンのテスト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブチェーンのテスト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_84" class="md-nav__link">
    <span class="md-ellipsis">
      チェーンの変更のテスト
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_85" class="md-nav__link">
    <span class="md-ellipsis">
      チェーンされたバッチのテスト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_86" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブバッチのテスト
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ジョブバッチのテスト">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_87" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブ / バッチの相互作用のテスト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_88" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブ / キューの相互作用のテスト
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_89" class="md-nav__link">
    <span class="md-ellipsis">
      ジョブイベント
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/koriym/l11ja/edit/ja/queues.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="_1">キュー<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<ul>
<li><a href="#introduction">はじめに</a><ul>
<li><a href="#connections-vs-queues">接続とキュー</a></li>
<li><a href="#driver-prerequisites">ドライバの注意事項と前提条件</a></li>
</ul>
</li>
<li><a href="#creating-jobs">ジョブの作成</a><ul>
<li><a href="#generating-job-classes">ジョブクラスの生成</a></li>
<li><a href="#class-structure">クラス構造</a></li>
<li><a href="#unique-jobs">ユニークジョブ</a></li>
<li><a href="#encrypted-jobs">暗号化ジョブ</a></li>
</ul>
</li>
<li><a href="#job-middleware">ジョブミドルウェア</a><ul>
<li><a href="#rate-limiting">レート制限</a></li>
<li><a href="#preventing-job-overlaps">ジョブの重複防止</a></li>
<li><a href="#throttling-exceptions">例外のスロットリング</a></li>
<li><a href="#skipping-jobs">ジョブのスキップ</a></li>
</ul>
</li>
<li><a href="#dispatching-jobs">ジョブのディスパッチ</a><ul>
<li><a href="#delayed-dispatching">遅延ディスパッチ</a></li>
<li><a href="#synchronous-dispatching">同期ディスパッチ</a></li>
<li><a href="#jobs-and-database-transactions">ジョブとデータベーストランザクション</a></li>
<li><a href="#job-chaining">ジョブの連鎖</a></li>
<li><a href="#customizing-the-queue-and-connection">キューと接続のカスタマイズ</a></li>
<li><a href="#max-job-attempts-and-timeout">最大試行回数 / タイムアウト値の指定</a></li>
<li><a href="#error-handling">エラー処理</a></li>
</ul>
</li>
<li><a href="#job-batching">ジョブのバッチ処理</a><ul>
<li><a href="#defining-batchable-jobs">バッチ可能なジョブの定義</a></li>
<li><a href="#dispatching-batches">バッチのディスパッチ</a></li>
<li><a href="#chains-and-batches">連鎖とバッチ</a></li>
<li><a href="#adding-jobs-to-batches">バッチへのジョブの追加</a></li>
<li><a href="#inspecting-batches">バッチの検査</a></li>
<li><a href="#cancelling-batches">バッチのキャンセル</a></li>
<li><a href="#batch-failures">バッチの失敗</a></li>
<li><a href="#pruning-batches">バッチの整理</a></li>
<li><a href="#storing-batches-in-dynamodb">DynamoDBへのバッチの保存</a></li>
</ul>
</li>
<li><a href="#queueing-closures">クロージャのキューイング</a></li>
<li><a href="#running-the-queue-worker">キューワーカーの実行</a><ul>
<li><a href="#the-queue-work-command"><code>queue:work</code>コマンド</a></li>
<li><a href="#queue-priorities">キューの優先度</a></li>
<li><a href="#queue-workers-and-deployment">キューワーカーとデプロイ</a></li>
<li><a href="#job-expirations-and-timeouts">ジョブの有効期限とタイムアウト</a></li>
</ul>
</li>
<li><a href="#supervisor-configuration">Supervisorの設定</a></li>
<li><a href="#dealing-with-failed-jobs">失敗したジョブの処理</a><ul>
<li><a href="#cleaning-up-after-failed-jobs">失敗したジョブの後処理</a></li>
<li><a href="#retrying-failed-jobs">失敗したジョブの再試行</a></li>
<li><a href="#ignoring-missing-models">モデルの欠落を無視する</a></li>
<li><a href="#pruning-failed-jobs">失敗したジョブの整理</a></li>
<li><a href="#storing-failed-jobs-in-dynamodb">DynamoDBへの失敗したジョブの保存</a></li>
<li><a href="#disabling-failed-job-storage">失敗したジョブの保存の無効化</a></li>
<li><a href="#failed-job-events">失敗したジョブのイベント</a></li>
</ul>
</li>
<li><a href="#clearing-jobs-from-queues">キューからのジョブのクリア</a></li>
<li><a href="#monitoring-your-queues">キューの監視</a></li>
<li><a href="#testing">テスト</a><ul>
<li><a href="#faking-a-subset-of-jobs">ジョブの一部をフェイクする</a></li>
<li><a href="#testing-job-chains">ジョブの連鎖のテスト</a></li>
<li><a href="#testing-job-batches">ジョブのバッチのテスト</a></li>
<li><a href="#testing-job-queue-interactions">ジョブ / キューの相互作用のテスト</a></li>
</ul>
</li>
<li><a href="#job-events">ジョブイベント</a></li>
</ul>
<p><a name="introduction"></a></p>
<h2 id="_2">はじめに<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Webアプリケーションを構築していると、CSVファイルの解析やアップロードされたファイルの保存など、一般的なWebリクエスト中に実行するには時間がかかりすぎるタスクが発生することがあります。幸いなことに、Laravelでは簡単にキューに入れられるジョブを作成し、バックグラウンドで処理することができます。時間のかかるタスクをキューに移すことで、アプリケーションはWebリクエストに対して高速に応答し、顧客により良いユーザーエクスペリエンスを提供することができます。</p>
<p>Laravelのキューは、<a href="https://aws.amazon.com/sqs/">Amazon SQS</a>、<a href="https://redis.io">Redis</a>、リレーショナルデータベースなど、さまざまなキューバックエンドに対して統一されたキューイングAPIを提供します。</p>
<p>Laravelのキュー設定オプションは、アプリケーションの<code>config/queue.php</code>設定ファイルに保存されています。このファイルには、フレームワークに含まれる各キュードライバの接続設定が含まれています。これには、データベース、<a href="https://aws.amazon.com/sqs/">Amazon SQS</a>、<a href="https://redis.io">Redis</a>、<a href="https://beanstalkd.github.io/">Beanstalkd</a>ドライバ、およびジョブを即座に実行する同期ドライバ（ローカル開発用）が含まれます。<code>null</code>キュードライバも含まれており、キューに入れられたジョブを破棄します。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Laravelは現在、Redisを使用したキューのための美しいダッシュボードと設定システムであるHorizonを提供しています。詳細については、完全な<a href="horizon.html">Horizonドキュメント</a>を確認してください。</p>
</div>
<p><a name="connections-vs-queues"></a></p>
<h3 id="_3">接続とキュー<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>Laravelのキューを始める前に、「接続」と「キュー」の違いを理解することが重要です。<code>config/queue.php</code>設定ファイルには、<code>connections</code>設定配列があります。このオプションは、Amazon SQS、Beanstalk、Redisなどのバックエンドキューサービスへの接続を定義します。ただし、特定のキュー接続には、キューに入れられたジョブの異なるスタックまたはパイルと考えることができる複数の「キュー」があります。</p>
<p><code>queue</code>設定ファイルの各接続設定例には、<code>queue</code>属性が含まれていることに注意してください。これは、ジョブが特定の接続に送信されるときにデフォルトでディスパッチされるキューです。言い換えると、ジョブをディスパッチするときに明示的にどのキューにディスパッチするかを定義しない場合、ジョブは接続設定の<code>queue</code>属性で定義されたキューに配置されます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="c1">// このジョブはデフォルト接続のデフォルトキューに送信されます...</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">();</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="c1">// このジョブはデフォルト接続の &quot;emails&quot; キューに送信されます...</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">onQueue</span><span class="p">(</span><span class="s1">&#39;emails&#39;</span><span class="p">);</span>
</code></pre></div>
<p>一部のアプリケーションでは、複数のキューにジョブをプッシュする必要がないかもしれませんが、代わりに単純なキューを1つ持つことを好みます。しかし、複数のキューにジョブをプッシュすることは、ジョブの処理方法を優先順位付けしたり、セグメント化したりすることを望むアプリケーションにとって特に便利です。Laravelのキューワーカーでは、処理するキューを優先順位で指定できるためです。たとえば、<code>high</code>キューにジョブをプッシュする場合、より高い処理優先度を持つワーカーを実行できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--queue<span class="o">=</span>high,default
</code></pre></div>
<p><a name="driver-prerequisites"></a></p>
<h3 id="_4">ドライバの注意事項と前提条件<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p><a name="database"></a></p>
<h4 id="_5">データベース<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p><code>database</code>キュードライバを使用するには、ジョブを保持するためのデータベーステーブルが必要です。通常、これはLaravelのデフォルトの<code>0001_01_01_000002_create_jobs_table.php</code><a href="migrations.html">データベースマイグレーション</a>に含まれています。ただし、アプリケーションにこのマイグレーションが含まれていない場合は、<code>make:queue-table</code> Artisanコマンドを使用して作成できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>make:queue-table
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>php<span class="w"> </span>artisan<span class="w"> </span>migrate
</code></pre></div>
<p><a name="redis"></a></p>
<h4 id="redis">Redis<a class="headerlink" href="#redis" title="Permanent link">&para;</a></h4>
<p><code>redis</code>キュードライバを使用するには、<code>config/database.php</code>設定ファイルでRedisデータベース接続を設定する必要があります。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>serializer</code>と<code>compression</code>のRedisオプションは、<code>redis</code>キュードライバではサポートされていません。</p>
</div>
<p><strong>Redisクラスタ</strong></p>
<p>Redisキュー接続がRedisクラスタを使用している場合、キュー名には<a href="https://redis.io/docs/reference/cluster-spec/#hash-tags">キーのハッシュタグ</a>を含める必要があります。これは、特定のキューのすべてのRedisキーが同じハッシュスロットに配置されるようにするために必要です。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="s1">&#39;redis&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>    <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>    <span class="s1">&#39;connection&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;REDIS_QUEUE_CONNECTION&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">),</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>    <span class="s1">&#39;queue&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;REDIS_QUEUE&#39;</span><span class="p">,</span> <span class="s1">&#39;{default}&#39;</span><span class="p">),</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="s1">&#39;retry_after&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;REDIS_QUEUE_RETRY_AFTER&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="s1">&#39;block_for&#39;</span> <span class="o">=&gt;</span> <span class="k">null</span><span class="p">,</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="s1">&#39;after_commit&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="p">],</span>
</code></pre></div>
<p><strong>ブロッキング</strong></p>
<p>Redisキューを使用する場合、<code>block_for</code>設定オプションを使用して、ドライバがジョブが利用可能になるまで待機する時間を指定できます。これにより、ワーカーループを繰り返し、Redisデータベースを再ポーリングする前に待機するよりも効率的になります。たとえば、ジョブが利用可能になるまで5秒間ブロックするように値を<code>5</code>に設定できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="s1">&#39;redis&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>    <span class="s1">&#39;connection&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;REDIS_QUEUE_CONNECTION&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">),</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="s1">&#39;queue&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;REDIS_QUEUE&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">),</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="s1">&#39;retry_after&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;REDIS_QUEUE_RETRY_AFTER&#39;</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="s1">&#39;block_for&#39;</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="s1">&#39;after_commit&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="p">],</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>block_for</code>を<code>0</code>に設定すると、キューワーカーはジョブが利用可能になるまで無期限にブロックします。これにより、次のジョブが処理されるまで<code>SIGTERM</code>などのシグナルが処理されなくなります。</p>
</div>
<p><a name="other-driver-prerequisites"></a></p>
<h4 id="_6">その他のドライバの前提条件<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>以下の依存関係は、リストされたキュードライバに必要です。これらの依存関係は、Composerパッケージマネージャを介してインストールできます。</p>
<div class="content-list">
<ul>
<li>Amazon SQS: <code>aws/aws-sdk-php ~3.0</code></li>
<li>Beanstalkd: <code>pda/pheanstalk ~5.0</code></li>
<li>Redis: <code>predis/predis ~2.0</code> または phpredis PHP拡張</li>
</ul>
</div>
<p><a name="creating-jobs"></a></p>
<h2 id="_7">ジョブの作成<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p><a name="generating-job-classes"></a></p>
<h3 id="_8">ジョブクラスの生成<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>デフォルトでは、アプリケーションのすべてのキュー可能なジョブは、<code>app/Jobs</code>ディレクトリに保存されます。<code>app/Jobs</code>ディレクトリが存在しない場合、<code>make:job</code> Artisanコマンドを実行すると作成されます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>make:job<span class="w"> </span>ProcessPodcast
</code></pre></div>
<p>生成されたクラスは、<code>Illuminate\Contracts\Queue\ShouldQueue</code>インターフェースを実装しており、Laravelにジョブを非同期で実行するためにキューにプッシュする必要があることを示します。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ジョブスタブは、<a href="artisan.html#stub-customization">スタブの公開</a>を使用してカスタマイズできます。</p>
</div>
<p><a name="class-structure"></a></p>
<h3 id="_9">クラス構造<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>ジョブクラスは非常にシンプルで、通常、ジョブがキューによって処理されるときに呼び出される<code>handle</code>メソッドのみを含みます。始めるために、ジョブクラスの例を見てみましょう。この例では、ポッドキャストの公開サービスを管理しており、アップロードされたポッドキャストファイルを公開する前に処理する必要があると想定します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="k">use</span> <span class="nx">App\Models\Podcast</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="k">use</span> <span class="nx">App\Services\AudioProcessor</span><span class="p">;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="k">use</span> <span class="nx">Illuminate\Bus\Queueable</span><span class="p">;</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="k">use</span> <span class="nx">Illuminate\Foundation\Bus\Dispatchable</span><span class="p">;</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\InteractsWithQueue</span><span class="p">;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\SerializesModels</span><span class="p">;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="k">class</span> <span class="nc">ProcessPodcast</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="p">{</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="k">use</span> <span class="nx">Dispatchable</span><span class="p">,</span> <span class="nx">InteractsWithQueue</span><span class="p">,</span> <span class="nx">Queueable</span><span class="p">,</span> <span class="nx">SerializesModels</span><span class="p">;</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="sd">/**</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="sd">     * 新しいジョブインスタンスの作成</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="sd">     *</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="sd">     * @param  Podcast  $podcast</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="sd">     * @return void</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="sd">     */</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>        <span class="k">public</span> <span class="nx">Podcast</span> <span class="nv">$podcast</span><span class="p">,</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>    <span class="p">)</span> <span class="p">{}</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>    <span class="sd">/**</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="sd">     * ジョブの実行</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="sd">     *</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="sd">     * @param  AudioProcessor  $processor</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="sd">     * @return void</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="sd">     */</span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">AudioProcessor</span> <span class="nv">$processor</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>    <span class="p">{</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>        <span class="c1">// ポッドキャストファイルの処理</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>    <span class="p">}</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">use</span> <span class="nx">App\Models\Podcast</span><span class="p">;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="k">use</span> <span class="nx">App\Services\AudioProcessor</span><span class="p">;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">use</span> <span class="nx">Illuminate\Foundation\Queue\Queueable</span><span class="p">;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="k">class</span> <span class="nc">ProcessPodcast</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="p">{</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>    <span class="k">use</span> <span class="nx">Queueable</span><span class="p">;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="sd">     * 新しいジョブインスタンスの生成</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="sd">     */</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>        <span class="k">public</span> <span class="nx">Podcast</span> <span class="nv">$podcast</span><span class="p">,</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>    <span class="p">)</span> <span class="p">{}</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>    <span class="sd">/**</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="sd">     * ジョブの実行</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="sd">     */</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">AudioProcessor</span> <span class="nv">$processor</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>    <span class="p">{</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>        <span class="c1">// アップロードされたポッドキャストの処理...</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>    <span class="p">}</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="p">}</span>
</code></pre></div>
<p>この例では、キューに入れられたジョブのコンストラクタに直接<a href="eloquent.html">Eloquentモデル</a>を渡すことができることに注目してください。ジョブが使用している<code>Queueable</code>トレイトのおかげで、Eloquentモデルとその読み込まれたリレーションは、ジョブが処理される際に適切にシリアライズおよびアンシリアライズされます。</p>
<p>キューに入れられたジョブがコンストラクタでEloquentモデルを受け取る場合、モデルの識別子のみがキューにシリアライズされます。ジョブが実際に処理されるとき、キューシステムは自動的にデータベースから完全なモデルインスタンスとその読み込まれたリレーションを再取得します。このモデルのシリアライズ方法により、キュードライバに送信されるジョブのペイロードを大幅に小さくすることができます。</p>
<p><a name="handle-method-dependency-injection"></a></p>
<h4 id="handle"><code>handle</code>メソッドの依存性注入<a class="headerlink" href="#handle" title="Permanent link">&para;</a></h4>
<p><code>handle</code>メソッドは、ジョブがキューによって処理されるときに呼び出されます。<code>handle</code>メソッドのジョブに依存関係をタイプヒントできることに注意してください。Laravelの<a href="container.html">サービスコンテナ</a>が自動的にこれらの依存関係を注入します。</p>
<p>コンテナが<code>handle</code>メソッドに依存関係を注入する方法を完全に制御したい場合は、コンテナの<code>bindMethod</code>メソッドを使用できます。<code>bindMethod</code>メソッドは、ジョブとコンテナを受け取るコールバックを受け取ります。コールバック内で、<code>handle</code>メソッドを好きなように呼び出すことができます。通常、このメソッドは<code>App\Providers\AppServiceProvider</code><a href="providers.html">サービスプロバイダ</a>の<code>boot</code>メソッドから呼び出すべきです：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">use</span> <span class="nx">App\Services\AudioProcessor</span><span class="p">;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Foundation\Application</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">bindMethod</span><span class="p">([</span><span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;handle&#39;</span><span class="p">],</span> <span class="k">function</span> <span class="p">(</span><span class="nx">ProcessPodcast</span> <span class="nv">$job</span><span class="p">,</span> <span class="nx">Application</span> <span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="k">return</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$app</span><span class="o">-&gt;</span><span class="na">make</span><span class="p">(</span><span class="nx">AudioProcessor</span><span class="o">::</span><span class="na">class</span><span class="p">));</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="p">});</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>生の画像コンテンツなどのバイナリデータは、キューに入れられたジョブに渡される前に<code>base64_encode</code>関数を通過させる必要があります。そうしないと、ジョブがキューに配置されるときにJSONに正しくシリアライズされない可能性があります。</p>
</div>
<p><a name="handling-relationships"></a></p>
<h4 id="_10">キューに入れられたリレーション<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>ジョブがキューに入れられるとき、読み込まれたすべてのEloquentモデルのリレーションもシリアライズされるため、シリアライズされたジョブ文字列が非常に大きくなることがあります。さらに、ジョブがデシリアライズされ、モデルのリレーションがデータベースから再取得されるとき、それらは完全に取得されます。ジョブがキューに入れられるプロセス中にモデルがシリアライズされる前に適用された以前のリレーション制約は、ジョブがデシリアライズされるときに適用されません。したがって、特定のリレーションのサブセットで作業したい場合は、キューに入れられたジョブ内でそのリレーションを再制約する必要があります。</p>
<p>または、リレーションがシリアライズされないようにするために、プロパティ値を設定するときにモデルの<code>withoutRelations</code>メソッドを呼び出すことができます。このメソッドは、読み込まれたリレーションを持たないモデルのインスタンスを返します：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="sd">/**</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="sd"> * 新しいジョブインスタンスの生成</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="sd"> */</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="nx">Podcast</span> <span class="nv">$podcast</span><span class="p">,</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">podcast</span> <span class="o">=</span> <span class="nv">$podcast</span><span class="o">-&gt;</span><span class="na">withoutRelations</span><span class="p">();</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="p">}</span>
</code></pre></div>
<p>PHPのコンストラクタプロパティプロモーションを使用していて、Eloquentモデルがそのリレーションをシリアライズしないように指定したい場合は、<code>WithoutRelations</code>属性を使用できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Attributes\WithoutRelations</span><span class="p">;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="sd">/**</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="sd"> * 新しいジョブインスタンスの生成</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="sd"> */</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="p">#[</span><span class="nd">WithoutRelations</span><span class="p">]</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>    <span class="k">public</span> <span class="nx">Podcast</span> <span class="nv">$podcast</span><span class="p">,</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="p">)</span> <span class="p">{}</span>
</code></pre></div>
<p>ジョブが単一のモデルではなく、Eloquentモデルのコレクションまたは配列を受け取る場合、そのコレクション内のモデルは、ジョブがデシリアライズおよび実行されるときにそのリレーションが復元されません。これは、多数のモデルを扱うジョブで過剰なリソース使用を防ぐためです。</p>
<p><a name="unique-jobs"></a></p>
<h3 id="_11">ユニークジョブ<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ユニークジョブには、<a href="cache.html#atomic-locks">ロック</a>をサポートするキャッシュドライバが必要です。現在、<code>memcached</code>、<code>redis</code>、<code>dynamodb</code>、<code>database</code>、<code>file</code>、および<code>array</code>キャッシュドライバがアトミックロックをサポートしています。さらに、ユニークジョブの制約はバッチ内のジョブには適用されません。</p>
</div>
<p>特定のジョブのインスタンスがキューに一度に1つしか存在しないようにしたい場合があります。そのためには、ジョブクラスに<code>ShouldBeUnique</code>インターフェースを実装することができます。このインターフェースは、クラスに追加のメソッドを定義する必要はありません：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldBeUnique</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="k">class</span> <span class="nc">UpdateSearchIndex</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span><span class="p">,</span> <span class="nx">ShouldBeUnique</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="p">{</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>    <span class="o">...</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="p">}</span>
</code></pre></div>
<p>上記の例では、<code>UpdateSearchIndex</code>ジョブはユニークです。したがって、ジョブの別のインスタンスがすでにキューにあり、処理が完了していない場合、ジョブはディスパッチされません。</p>
<p>特定のケースでは、ジョブをユニークにする特定の「キー」を定義したり、ジョブがユニークでなくなるまでのタイムアウトを指定したい場合があります。これを実現するために、ジョブクラスに<code>uniqueId</code>および<code>uniqueFor</code>プロパティまたはメソッドを定義できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="k">use</span> <span class="nx">App\Models\Product</span><span class="p">;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldBeUnique</span><span class="p">;</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="k">class</span> <span class="nc">UpdateSearchIndex</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span><span class="p">,</span> <span class="nx">ShouldBeUnique</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="p">{</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>    <span class="sd">/**</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="sd">     * 製品インスタンス</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="sd">     *</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="sd">     * @var \App\Product</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="sd">     */</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>    <span class="k">public</span> <span class="nv">$product</span><span class="p">;</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    <span class="sd">/**</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="sd">     * ジョブのユニークロックが解除されるまでの秒数</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="sd">     *</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a><span class="sd">     * @var int</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a><span class="sd">     */</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>    <span class="k">public</span> <span class="nv">$uniqueFor</span> <span class="o">=</span> <span class="mi">3600</span><span class="p">;</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>    <span class="sd">/**</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="sd">     * ジョブのユニークIDを取得</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="sd">     */</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">uniqueId</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>    <span class="p">{</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">product</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a>    <span class="p">}</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a><span class="p">}</span>
</code></pre></div>
<p>上記の例では、<code>UpdateSearchIndex</code>ジョブは製品IDによってユニークです。したがって、同じ製品IDを持つジョブの新しいディスパッチは、既存のジョブが処理を完了するまで無視されます。さらに、既存のジョブが1時間以内に処理されない場合、ユニークロックは解除され、同じユニークキーを持つ別のジョブをキューにディスパッチできます。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>アプリケーションが複数のWebサーバーまたはコンテナからジョブをディスパッチする場合、すべてのサーバーが同じ中央キャッシュサーバーと通信するようにして、Laravelがジョブがユニークであるかどうかを正確に判断できるようにする必要があります。</p>
</div>
<p><a name="keeping-jobs-unique-until-processing-begins"></a></p>
<h4 id="_12">処理が開始されるまでジョブをユニークに保つ<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<p>デフォルトでは、ユニークジョブはジョブが処理を完了するか、すべての再試行が失敗した後に「ロック解除」されます。ただし、ジョブが処理される直前にジョブのロックを解除したい場合があります。これを実現するために、ジョブは<code>ShouldBeUnique</code>インターフェースの代わりに<code>ShouldBeUniqueUntilProcessing</code>インターフェースを実装する必要があります：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="k">use</span> <span class="nx">App\Models\Product</span><span class="p">;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldBeUniqueUntilProcessing</span><span class="p">;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="k">class</span> <span class="nc">UpdateSearchIndex</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span><span class="p">,</span> <span class="nx">ShouldBeUniqueUntilProcessing</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="p">{</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>    <span class="c1">// ...</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="p">}</span>
</code></pre></div>
<p><a name="unique-job-locks"></a></p>
<h4 id="_13">ユニークジョブロック<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>舞台裏では、<code>ShouldBeUnique</code>ジョブがディスパッチされると、Laravelは<code>uniqueId</code>キーを使用して<a href="cache.html#atomic-locks">ロック</a>を取得しようとします。ロックが取得されない場合、ジョブはディスパッチされません。このロックは、ジョブが処理を完了するか、すべての再試行が失敗した後に解放されます。デフォルトでは、Laravelはこのロックを取得するためにデフォルトのキャッシュドライバを使用します。ただし、ロックを取得するために別のドライバを使用したい場合は、<code>uniqueVia</code>メソッドを定義して、使用するキャッシュドライバを返すことができます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Cache\Repository</span><span class="p">;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Cache</span><span class="p">;</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="k">class</span> <span class="nc">UpdateSearchIndex</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span><span class="p">,</span> <span class="nx">ShouldBeUnique</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="p">{</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="o">...</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>    <span class="sd">/**</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="sd">     * ユニークジョブロックのためのキャッシュドライバを取得</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="sd">     */</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">uniqueVia</span><span class="p">()</span><span class="o">:</span> <span class="nx">Repository</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="p">{</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="k">return</span> <span class="nx">Cache</span><span class="o">::</span><span class="na">driver</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">);</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>    <span class="p">}</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ジョブの同時処理を制限するだけの場合は、代わりに<a href="queues.html#preventing-job-overlaps"><code>WithoutOverlapping</code></a>ジョブミドルウェアを使用してください。</p>
</div>
<p><a name="encrypted-jobs"></a></p>
<h3 id="_14">暗号化されたジョブ<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<p>Laravelでは、<a href="encryption.html">暗号化</a>を介してジョブのデータのプライバシーと整合性を確保できます。開始するには、ジョブクラスに<code>ShouldBeEncrypted</code>インターフェースを追加するだけです。このインターフェースがクラスに追加されると、Laravelはジョブをキューにプッシュする前に自動的にジョブを暗号化します：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldBeEncrypted</span><span class="p">;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="k">class</span> <span class="nc">UpdateSearchIndex</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span><span class="p">,</span> <span class="nx">ShouldBeEncrypted</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="p">{</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>    <span class="c1">// ...</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="p">}</span>
</code></pre></div>
<p><a name="job-middleware"></a></p>
<h2 id="_15">ジョブミドルウェア<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h2>
<p>ジョブミドルウェアを使用すると、キューに入れられたジョブの実行を囲むカスタムロジックをラップでき、ジョブ自体のボイラープレートを減らすことができます。たとえば、LaravelのRedisレート制限機能を利用して、5秒ごとに1つのジョブのみを処理する<code>handle</code>メソッドを考えてみましょう：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Redis</span><span class="p">;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>    <span class="sd">/**</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="sd">     * ジョブを実行する。</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="sd">     */</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="p">{</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>        <span class="nx">Redis</span><span class="o">::</span><span class="na">throttle</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">every</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>            <span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Lock obtained...&#39;</span><span class="p">);</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>            <span class="c1">// ジョブを処理する...</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>        <span class="p">},</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>            <span class="c1">// ロックを取得できなかった...</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">release</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>        <span class="p">});</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>    <span class="p">}</span>
</code></pre></div>
<p>このコードは有効ですが、Redisのレート制限ロジックが混ざっているため、<code>handle</code>メソッドの実装が煩雑になります。さらに、このレート制限ロジックは、レート制限したい他のジョブにも重複して記述する必要があります。</p>
<p>代わりに、<code>handle</code>メソッド内でレート制限を行うのではなく、レート制限を処理するジョブミドルウェアを定義することができます。Laravelにはジョブミドルウェアのデフォルトの場所がないため、アプリケーション内のどこにでもジョブミドルウェアを配置できます。この例では、ミドルウェアを<code>app/Jobs/Middleware</code>ディレクトリに配置します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="k">namespace</span> <span class="nx">App\Jobs\Middleware</span><span class="p">;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="k">use</span> <span class="nx">Closure</span><span class="p">;</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Redis</span><span class="p">;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="k">class</span> <span class="nc">RateLimited</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="p">{</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="sd">     * キューに入れられたジョブを処理する。</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="sd">     *</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="sd">     * @param  \Closure(object): void  $next</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="sd">     */</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">object</span> <span class="nv">$job</span><span class="p">,</span> <span class="nx">Closure</span> <span class="nv">$next</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>    <span class="p">{</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>        <span class="nx">Redis</span><span class="o">::</span><span class="na">throttle</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>                <span class="o">-&gt;</span><span class="na">block</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">every</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>                <span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$job</span><span class="p">,</span> <span class="nv">$next</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>                    <span class="c1">// ロックを取得した...</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>                    <span class="nv">$next</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>                <span class="p">},</span> <span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$job</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a>                    <span class="c1">// ロックを取得できなかった...</span>
<a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a>
<a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a>                    <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">release</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>                <span class="p">});</span>
<a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>    <span class="p">}</span>
<a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="p">}</span>
</code></pre></div>
<p>ご覧の通り、<a href="middleware.html">ルートミドルウェア</a>と同様に、ジョブミドルウェアは処理中のジョブと、ジョブの処理を続行するために呼び出す必要があるコールバックを受け取ります。</p>
<p>ジョブミドルウェアを作成した後、ジョブの<code>middleware</code>メソッドから返すことでジョブにアタッチできます。このメソッドは<code>make:job</code> Artisanコマンドでスキャフォールドされたジョブには存在しないため、ジョブクラスに手動で追加する必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">use</span> <span class="nx">App\Jobs\Middleware\RateLimited</span><span class="p">;</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="sd">/**</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="sd"> * ジョブが通過する必要があるミドルウェアを取得する。</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="sd"> *</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="sd"> */</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="p">{</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">RateLimited</span><span class="p">];</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ジョブミドルウェアは、キュー可能なイベントリスナー、メール、通知にも割り当てることができます。</p>
</div>
<p><a name="rate-limiting"></a></p>
<h3 id="_16">レート制限<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>Laravelには実際には、ジョブのレート制限に利用できるレート制限ミドルウェアが含まれています。<a href="routing.html#defining-rate-limiters">ルートレートリミッター</a>と同様に、ジョブレートリミッターは<code>RateLimiter</code>ファサードの<code>for</code>メソッドを使用して定義されます。</p>
<p>例えば、ユーザーがデータを1時間に1回バックアップできるようにしたいが、プレミアム顧客にはそのような制限を課したくない場合、<code>AppServiceProvider</code>の<code>boot</code>メソッドで<code>RateLimiter</code>を定義できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">use</span> <span class="nx">Illuminate\Cache\RateLimiting\Limit</span><span class="p">;</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\RateLimiter</span><span class="p">;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="sd">/**</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="sd"> * 任意のアプリケーションサービスをブートストラップする。</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="sd"> */</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="p">{</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>    <span class="nx">RateLimiter</span><span class="o">::</span><span class="na">for</span><span class="p">(</span><span class="s1">&#39;backups&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">object</span> <span class="nv">$job</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>        <span class="k">return</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">vipCustomer</span><span class="p">()</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>                    <span class="o">?</span> <span class="nx">Limit</span><span class="o">::</span><span class="na">none</span><span class="p">()</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>                    <span class="o">:</span> <span class="nx">Limit</span><span class="o">::</span><span class="na">perHour</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">by</span><span class="p">(</span><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a>    <span class="p">});</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="p">}</span>
</code></pre></div>
<p>上記の例では、1時間ごとのレート制限を定義しました。ただし、<code>perMinute</code>メソッドを使用して分単位でレート制限を簡単に定義することもできます。さらに、レート制限の<code>by</code>メソッドには、任意の値を渡すことができます。ただし、この値は通常、顧客ごとにレート制限を分割するために使用されます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">return</span> <span class="nx">Limit</span><span class="o">::</span><span class="na">perMinute</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">by</span><span class="p">(</span><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
</code></pre></div>
<p>レート制限を定義したら、<code>Illuminate\Queue\Middleware\RateLimited</code>ミドルウェアを使用してジョブにレートリミッターをアタッチできます。このミドルウェアは、ジョブがレート制限を超えるたびに、レート制限期間に基づいて適切な遅延でジョブをキューに戻します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\RateLimited</span><span class="p">;</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="sd">/**</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="sd"> * ジョブが通過する必要があるミドルウェアを取得する。</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="sd"> *</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="sd"> */</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="p">{</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">RateLimited</span><span class="p">(</span><span class="s1">&#39;backups&#39;</span><span class="p">)];</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="p">}</span>
</code></pre></div>
<p>レート制限されたジョブをキューに戻すと、ジョブの合計<code>attempts</code>数が増加します。ジョブクラスの<code>tries</code>および<code>maxExceptions</code>プロパティを適切に調整するか、<a href="#time-based-attempts"><code>retryUntil</code>メソッド</a>を使用して、ジョブが再試行されなくなるまでの時間を定義することをお勧めします。</p>
<p>レート制限された場合にジョブを再試行したくない場合は、<code>dontRelease</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="sd">/**</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="sd"> * ジョブが通過する必要があるミドルウェアを取得する。</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="sd"> *</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="sd"> */</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="p">{</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>    <span class="k">return</span> <span class="p">[(</span><span class="k">new</span> <span class="nx">RateLimited</span><span class="p">(</span><span class="s1">&#39;backups&#39;</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">dontRelease</span><span class="p">()];</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Redisを使用している場合は、<code>Illuminate\Queue\Middleware\RateLimitedWithRedis</code>ミドルウェアを使用できます。これはRedis向けに微調整されており、基本的なレート制限ミドルウェアよりも効率的です。</p>
</div>
<p><a name="preventing-job-overlaps"></a></p>
<h3 id="_17">ジョブの重複を防ぐ<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>Laravelには、任意のキーに基づいてジョブの重複を防ぐための<code>Illuminate\Queue\Middleware\WithoutOverlapping</code>ミドルウェアが含まれています。これは、一度に1つのジョブだけが変更できるリソースをキューに入れられたジョブが変更する場合に便利です。</p>
<p>例えば、ユーザーの信用スコアを更新するキューに入れられたジョブがあり、同じユーザーIDに対する信用スコア更新ジョブの重複を防ぎたいとします。これを実現するには、ジョブの<code>middleware</code>メソッドから<code>WithoutOverlapping</code>ミドルウェアを返します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\WithoutOverlapping</span><span class="p">;</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="sd">/**</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="sd"> * ジョブが通過する必要があるミドルウェアを取得する。</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="sd"> *</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="sd"> */</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="p">{</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">WithoutOverlapping</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)];</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="p">}</span>
</code></pre></div>
<p>同じタイプの重複するジョブはすべてキューに戻されます。指定された秒数が経過するまで、解放されたジョブが再試行されるようにすることもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="sd">/**</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="sd"> * ジョブが通過する必要があるミドルウェアを取得する。</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="sd"> *</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="sd"> */</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="p">{</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>    <span class="k">return</span> <span class="p">[(</span><span class="k">new</span> <span class="nx">WithoutOverlapping</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">releaseAfter</span><span class="p">(</span><span class="mi">60</span><span class="p">)];</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="p">}</span>
</code></pre></div>
<p>重複するジョブを再試行しないようにするには、<code>dontRelease</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="sd">/**</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="sd"> * ジョブが通過する必要があるミドルウェアを取得する。</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="sd"> *</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="sd"> */</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="p">{</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>    <span class="k">return</span> <span class="p">[(</span><span class="k">new</span> <span class="nx">WithoutOverlapping</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">dontRelease</span><span class="p">()];</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="p">}</span>
</code></pre></div>
<p><code>WithoutOverlapping</code>ミドルウェアはLaravelのアトミックロック機能によって動作します。時々、ジョブが予期せず失敗したりタイムアウトしたりして、ロックが解放されないことがあります。したがって、<code>expireAfter</code>メソッドを使用して明示的にロックの有効期限を定義できます。例えば、以下の例では、ジョブが処理を開始してから3分後に<code>WithoutOverlapping</code>ロックを解放するようLaravelに指示します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="sd">/**</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="sd"> * ジョブが通過する必要があるミドルウェアを取得する。</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="sd"> *</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="sd"> */</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="p">{</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>    <span class="k">return</span> <span class="p">[(</span><span class="k">new</span> <span class="nx">WithoutOverlapping</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">expireAfter</span><span class="p">(</span><span class="mi">180</span><span class="p">)];</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>WithoutOverlapping</code>ミドルウェアには、<a href="cache.html#atomic-locks">ロック</a>をサポートするキャッシュドライバが必要です。現在、<code>memcached</code>、<code>redis</code>、<code>dynamodb</code>、<code>database</code>、<code>file</code>、<code>array</code>キャッシュドライバはアトミックロックをサポートしています。</p>
</div>
<p><a name="sharing-lock-keys"></a></p>
<h4 id="_18">ジョブクラス間でロックキーを共有する<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h4>
<p>デフォルトでは、<code>WithoutOverlapping</code>ミドルウェアは同じクラスのジョブの重複を防ぎます。したがって、2つの異なるジョブクラスが同じロックキーを使用していても、重複を防ぐことはできません。ただし、<code>shared</code>メソッドを使用してLaravelにジョブクラス間でキーを適用するよう指示できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\WithoutOverlapping</span><span class="p">;</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="k">class</span> <span class="nc">ProviderIsDown</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="p">{</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>    <span class="c1">// ...</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>    <span class="p">{</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>        <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>            <span class="p">(</span><span class="k">new</span> <span class="nx">WithoutOverlapping</span><span class="p">(</span><span class="s2">&quot;status:</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">provider</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">shared</span><span class="p">(),</span>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>        <span class="p">];</span>
<a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a>    <span class="p">}</span>
<a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="p">}</span>
<a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>
<a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="k">class</span> <span class="nc">ProviderIsUp</span>
<a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="p">{</span>
<a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>    <span class="c1">// ...</span>
<a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>
<a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>    <span class="p">{</span>
<a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>        <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a>            <span class="p">(</span><span class="k">new</span> <span class="nx">WithoutOverlapping</span><span class="p">(</span><span class="s2">&quot;status:</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">provider</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">shared</span><span class="p">(),</span>
<a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>        <span class="p">];</span>
<a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>    <span class="p">}</span>
<a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="p">}</span>
</code></pre></div>
<p><a name="throttling-exceptions"></a></p>
<h3 id="_19">例外のスロットリング<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>Laravelには、例外をスロットリングするための<code>Illuminate\Queue\Middleware\ThrottlesExceptions</code>ミドルウェアが含まれています。ジョブが指定された数の例外をスローすると、それ以降のジョブの実行は、指定された時間間隔が経過するまで遅延されます。このミドルウェアは、不安定なサードパーティサービスとやり取りするジョブに特に便利です。</p>
<p>例えば、キューに入れられたジョブがサードパーティAPIとやり取りし始めて例外をスローするとします。例外をスロットリングするには、ジョブの<code>middleware</code>メソッドから<code>ThrottlesExceptions</code>ミドルウェアを返します。通常、このミドルウェアは<a href="#time-based-attempts">時間ベースの試行</a>を実装するジョブと組み合わせる必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">use</span> <span class="nx">DateTime</span><span class="p">;</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\ThrottlesExceptions</span><span class="p">;</span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="sd">/**</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="sd"> * ジョブが通過する必要があるミドルウェアを取得する。</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="sd"> *</span>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="sd"> */</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="p">{</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a>    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">ThrottlesExceptions</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)];</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a><span class="p">}</span>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a><span class="sd">/**</span>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="sd"> * ジョブがタイムアウトする時間を決定する。</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="sd"> */</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">retryUntil</span><span class="p">()</span><span class="o">:</span> <span class="nx">DateTime</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="p">{</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a>    <span class="k">return</span> <span class="nx">now</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">addMinutes</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a><span class="p">}</span>
</code></pre></div>
<p>ミドルウェアが受け入れる最初のコンストラクタ引数は、ジョブがスロットルされるまでに投げることができる例外の数であり、2番目のコンストラクタ引数は、ジョブがスロットルされた後に再試行されるまでに経過する秒数です。上記のコード例では、ジョブが5分以内に10回例外を投げた場合、ジョブを再試行する前に5分待ちます。</p>
<p>ジョブが例外を投げたが、例外のしきい値にまだ達していない場合、通常はジョブがすぐに再試行されます。しかし、ミドルウェアをジョブにアタッチする際に<code>backoff</code>メソッドを呼び出すことで、そのようなジョブが遅延する分数を指定できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\ThrottlesExceptions</span><span class="p">;</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="sd">/**</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="sd"> * ジョブが通過すべきミドルウェアを取得する。</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="sd"> *</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="sd"> */</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="p">{</span>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a>    <span class="k">return</span> <span class="p">[(</span><span class="k">new</span> <span class="nx">ThrottlesExceptions</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">backoff</span><span class="p">(</span><span class="mi">5</span><span class="p">)];</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="p">}</span>
</code></pre></div>
<p>内部的には、このミドルウェアはLaravelのキャッシュシステムを使用してレート制限を実装し、ジョブのクラス名がキャッシュの「キー」として利用されます。ミドルウェアをジョブにアタッチする際に<code>by</code>メソッドを呼び出すことで、このキーを上書きできます。これは、複数のジョブが同じサードパーティサービスとやり取りしており、共通のスロットリング「バケット」を共有したい場合に便利です：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\ThrottlesExceptions</span><span class="p">;</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="sd">/**</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="sd"> * ジョブが通過すべきミドルウェアを取得する。</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="sd"> *</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="sd"> */</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="p">{</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>    <span class="k">return</span> <span class="p">[(</span><span class="k">new</span> <span class="nx">ThrottlesExceptions</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">by</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)];</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="p">}</span>
</code></pre></div>
<p>デフォルトでは、このミドルウェアはすべての例外をスロットルします。ミドルウェアをジョブにアタッチする際に<code>when</code>メソッドを呼び出すことで、この動作を変更できます。例外は、<code>when</code>メソッドに提供されたクロージャが<code>true</code>を返す場合にのみスロットルされます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Client\HttpClientException</span><span class="p">;</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\ThrottlesExceptions</span><span class="p">;</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="sd">/**</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="sd"> * ジョブが通過すべきミドルウェアを取得する。</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="sd"> *</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="sd"> */</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="p">{</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a>    <span class="k">return</span> <span class="p">[(</span><span class="k">new</span> <span class="nx">ThrottlesExceptions</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">when</span><span class="p">(</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a>        <span class="nx">fn</span> <span class="p">(</span><span class="nx">Throwable</span> <span class="nv">$throwable</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$throwable</span> <span class="nx">instanceof</span> <span class="nx">HttpClientException</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a>    <span class="p">)];</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="p">}</span>
</code></pre></div>
<p>スロットルされた例外をアプリケーションの例外ハンドラに報告したい場合、ミドルウェアをジョブにアタッチする際に<code>report</code>メソッドを呼び出すことでそれを行うことができます。オプションで、<code>report</code>メソッドにクロージャを提供し、指定されたクロージャが<code>true</code>を返す場合にのみ例外が報告されるようにすることもできます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Client\HttpClientException</span><span class="p">;</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\ThrottlesExceptions</span><span class="p">;</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="sd">/**</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="sd"> * ジョブが通過すべきミドルウェアを取得する。</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="sd"> *</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="sd"> * @return array&lt;int, object&gt;</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="sd"> */</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="p">{</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a>    <span class="k">return</span> <span class="p">[(</span><span class="k">new</span> <span class="nx">ThrottlesExceptions</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">report</span><span class="p">(</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a>        <span class="nx">fn</span> <span class="p">(</span><span class="nx">Throwable</span> <span class="nv">$throwable</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$throwable</span> <span class="nx">instanceof</span> <span class="nx">HttpClientException</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>    <span class="p">)];</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Redisを使用している場合、<code>Illuminate\Queue\Middleware\ThrottlesExceptionsWithRedis</code>ミドルウェアを使用できます。これはRedisに最適化されており、基本的な例外スロットリングミドルウェアよりも効率的です。</p>
</div>
<p><a name="skipping-jobs"></a></p>
<h3 id="_20">ジョブのスキップ<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p><code>Skip</code>ミドルウェアを使用すると、ジョブのロジックを変更することなく、ジョブをスキップ/削除するように指定できます。<code>Skip::when</code>メソッドは、指定された条件が<code>true</code>と評価された場合にジョブを削除し、<code>Skip::unless</code>メソッドは、条件が<code>false</code>と評価された場合にジョブを削除します：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\Skip</span><span class="p">;</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="sd">/**</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="sd"> * ジョブが通過すべきミドルウェアを取得する。</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="sd"> */</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="p">{</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a>    <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>        <span class="nx">Skip</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="nv">$someCondition</span><span class="p">),</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a>    <span class="p">];</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="p">}</span>
</code></pre></div>
<p><code>when</code>および<code>unless</code>メソッドに<code>Closure</code>を渡して、より複雑な条件評価を行うこともできます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\Skip</span><span class="p">;</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="sd">/**</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="sd"> * ジョブが通過すべきミドルウェアを取得する。</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="sd"> */</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="p">{</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>    <span class="k">return</span> <span class="p">[</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>        <span class="nx">Skip</span><span class="o">::</span><span class="na">when</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span><span class="o">:</span> <span class="nx">bool</span> <span class="p">{</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a>            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shouldSkip</span><span class="p">();</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a>        <span class="p">}),</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a>    <span class="p">];</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="p">}</span>
</code></pre></div>
<p><a name="dispatching-jobs"></a></p>
<h2 id="_21">ジョブのディスパッチ<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h2>
<p>ジョブクラスを作成したら、ジョブ自体の<code>dispatch</code>メソッドを使用してディスパッチできます。<code>dispatch</code>メソッドに渡された引数は、ジョブのコンストラクタに渡されます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="k">use</span> <span class="nx">App\Models\Podcast</span><span class="p">;</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="k">use</span> <span class="nx">Illuminate\Http\RedirectResponse</span><span class="p">;</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a><span class="k">class</span> <span class="nc">PodcastController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="p">{</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>    <span class="sd">/**</span>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="sd">     * 新しいポッドキャストを保存する。</span>
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="sd">     */</span>
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="nx">RedirectResponse</span>
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>    <span class="p">{</span>
<a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a>        <span class="nv">$podcast</span> <span class="o">=</span> <span class="nx">Podcast</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">);</span>
<a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>
<a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a>        <span class="c1">// ...</span>
<a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a>
<a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a>        <span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$podcast</span><span class="p">);</span>
<a id="__codelineno-36-23" name="__codelineno-36-23" href="#__codelineno-36-23"></a>
<a id="__codelineno-36-24" name="__codelineno-36-24" href="#__codelineno-36-24"></a>        <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/podcasts&#39;</span><span class="p">);</span>
<a id="__codelineno-36-25" name="__codelineno-36-25" href="#__codelineno-36-25"></a>    <span class="p">}</span>
<a id="__codelineno-36-26" name="__codelineno-36-26" href="#__codelineno-36-26"></a><span class="p">}</span>
</code></pre></div>
<p>条件付きでジョブをディスパッチしたい場合は、<code>dispatchIf</code>および<code>dispatchUnless</code>メソッドを使用できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatchIf</span><span class="p">(</span><span class="nv">$accountActive</span><span class="p">,</span> <span class="nv">$podcast</span><span class="p">);</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatchUnless</span><span class="p">(</span><span class="nv">$accountSuspended</span><span class="p">,</span> <span class="nv">$podcast</span><span class="p">);</span>
</code></pre></div>
<p>新しいLaravelアプリケーションでは、<code>sync</code>ドライバがデフォルトのキュードライバです。このドライバは、現在のリクエストのフォアグラウンドでジョブを同期的に実行します。これは、ローカル開発中に便利です。ジョブをバックグラウンド処理のために実際にキューに入れたい場合は、アプリケーションの<code>config/queue.php</code>設定ファイル内で異なるキュードライバを指定できます。</p>
<p><a name="delayed-dispatching"></a></p>
<h3 id="_22">遅延ディスパッチ<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>ジョブがキューワーカーによってすぐに処理されるべきでない場合、ディスパッチ時に<code>delay</code>メソッドを使用して指定できます。たとえば、ジョブがディスパッチされてから10分後に処理可能になるように指定します：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="k">use</span> <span class="nx">App\Models\Podcast</span><span class="p">;</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="k">use</span> <span class="nx">Illuminate\Http\RedirectResponse</span><span class="p">;</span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="k">class</span> <span class="nc">PodcastController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="p">{</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>    <span class="sd">/**</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="sd">     * 新しいポッドキャストを保存する。</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a><span class="sd">     */</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="nx">RedirectResponse</span>
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>    <span class="p">{</span>
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>        <span class="nv">$podcast</span> <span class="o">=</span> <span class="nx">Podcast</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">);</span>
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a>
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a>        <span class="c1">// ...</span>
<a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a>
<a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a>        <span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$podcast</span><span class="p">)</span>
<a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a>                    <span class="o">-&gt;</span><span class="na">delay</span><span class="p">(</span><span class="nx">now</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">addMinutes</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a>
<a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a>        <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/podcasts&#39;</span><span class="p">);</span>
<a id="__codelineno-38-26" name="__codelineno-38-26" href="#__codelineno-38-26"></a>    <span class="p">}</span>
<a id="__codelineno-38-27" name="__codelineno-38-27" href="#__codelineno-38-27"></a><span class="p">}</span>
</code></pre></div>
<p>いくつかのケースでは、ジョブにデフォルトの遅延が設定されている場合があります。この遅延をバイパスしてジョブを即時処理のためにディスパッチしたい場合は、<code>withoutDelay</code>メソッドを使用できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$podcast</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">withoutDelay</span><span class="p">();</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Amazon SQSキューサービスの最大遅延時間は15分です。</p>
</div>
<p><a name="dispatching-after-the-response-is-sent-to-browser"></a></p>
<h4 id="_23">レスポンスがブラウザに送信された後にディスパッチ<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p>あるいは、<code>dispatchAfterResponse</code>メソッドを使用して、HTTPレスポンスがユーザーのブラウザに送信された後にジョブをディスパッチすることもできます。これにより、キューに入れられたジョブがまだ実行中であっても、ユーザーはアプリケーションの使用を開始できます。これは通常、約1秒かかるジョブにのみ使用されるべきです。例えば、メールの送信などです。これらは現在のHTTPリクエスト内で処理されるため、この方法でディスパッチされたジョブは、キューワーカーが実行されている必要はありません：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">use</span> <span class="nx">App\Jobs\SendNotification</span><span class="p">;</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="nx">SendNotification</span><span class="o">::</span><span class="na">dispatchAfterResponse</span><span class="p">();</span>
</code></pre></div>
<p>また、<code>dispatch</code>ヘルパーにクロージャを渡し、<code>afterResponse</code>メソッドをチェーンして、HTTPレスポンスがブラウザに送信された後にクロージャを実行することもできます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">use</span> <span class="nx">App\Mail\WelcomeMessage</span><span class="p">;</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Mail</span><span class="p">;</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="nx">dispatch</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>    <span class="nx">Mail</span><span class="o">::</span><span class="na">to</span><span class="p">(</span><span class="s1">&#39;taylor@example.com&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="k">new</span> <span class="nx">WelcomeMessage</span><span class="p">);</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">afterResponse</span><span class="p">();</span>
</code></pre></div>
<p><a name="synchronous-dispatching"></a></p>
<h3 id="_24">同期ディスパッチ<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>ジョブを即座に（同期的に）ディスパッチしたい場合は、<code>dispatchSync</code>メソッドを使用できます。このメソッドを使用すると、ジョブはキューに入れられず、現在のプロセス内で即座に実行されます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="k">use</span> <span class="nx">App\Models\Podcast</span><span class="p">;</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="k">use</span> <span class="nx">Illuminate\Http\RedirectResponse</span><span class="p">;</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="k">class</span> <span class="nc">PodcastController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="p">{</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>    <span class="sd">/**</span>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="sd">     * 新しいポッドキャストを保存する。</span>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="sd">     */</span>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="nx">RedirectResponse</span>
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>    <span class="p">{</span>
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>        <span class="nv">$podcast</span> <span class="o">=</span> <span class="nx">Podcast</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">);</span>
<a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a>
<a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a>        <span class="c1">// Create podcast...</span>
<a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a>
<a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a>        <span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatchSync</span><span class="p">(</span><span class="nv">$podcast</span><span class="p">);</span>
<a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a>
<a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a>        <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/podcasts&#39;</span><span class="p">);</span>
<a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a>    <span class="p">}</span>
<a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="p">}</span>
</code></pre></div>
<p><a name="jobs-and-database-transactions"></a></p>
<h3 id="_25">ジョブとデータベーストランザクション<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>データベーストランザクション内でジョブをディスパッチすることは完全に問題ありませんが、ジョブが実際に成功することができるかどうかに特別な注意を払う必要があります。トランザクション内でジョブをディスパッチすると、親トランザクションがコミットされる前にジョブがワーカーによって処理される可能性があります。この場合、データベーストランザクション中に行ったモデルやデータベースレコードの更新が、まだデータベースに反映されていない可能性があります。さらに、トランザクション中に作成されたモデルやデータベースレコードは、データベースに存在しない可能性があります。</p>
<p>幸いなことに、Laravelはこの問題を回避するためのいくつかの方法を提供しています。まず、キュー接続の設定配列で<code>after_commit</code>接続オプションを設定できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="s1">&#39;redis&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>    <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;redis&#39;</span><span class="p">,</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>    <span class="c1">// ...</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>    <span class="s1">&#39;after_commit&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="p">],</span>
</code></pre></div>
<p><code>after_commit</code>オプションが<code>true</code>の場合、データベーストランザクション内でジョブをディスパッチできます。ただし、Laravelはジョブを実際にディスパッチする前に、開いている親データベーストランザクションがコミットされるのを待ちます。もちろん、現在開いているデータベーストランザクションがない場合、ジョブはすぐにディスパッチされます。</p>
<p>トランザクション中に例外が発生してトランザクションがロールバックされた場合、そのトランザクション中にディスパッチされたジョブは破棄されます。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>after_commit</code>設定オプションを<code>true</code>に設定すると、キューに入れられたイベントリスナー、メール、通知、およびブロードキャストイベントも、すべての開いているデータベーストランザクションがコミットされた後にディスパッチされます。</p>
</div>
<p><a name="specifying-commit-dispatch-behavior-inline"></a></p>
<h4 id="_26">インラインでのコミットディスパッチ動作の指定<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h4>
<p><code>after_commit</code>キュー接続設定オプションを<code>true</code>に設定しない場合でも、特定のジョブがすべての開いているデータベーストランザクションがコミットされた後にディスパッチされるように指定できます。これを実現するには、ディスパッチ操作に<code>afterCommit</code>メソッドをチェーンします：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$podcast</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">afterCommit</span><span class="p">();</span>
</code></pre></div>
<p>同様に、<code>after_commit</code>設定オプションが<code>true</code>に設定されている場合、特定のジョブが開いているデータベーストランザクションのコミットを待たずにすぐにディスパッチされるように指定できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$podcast</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">beforeCommit</span><span class="p">();</span>
</code></pre></div>
<p><a name="job-chaining"></a></p>
<h3 id="_27">ジョブの連鎖<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>ジョブの連鎖により、プライマリジョブが正常に実行された後に順番に実行されるキュージョブのリストを指定できます。シーケンス内の1つのジョブが失敗した場合、残りのジョブは実行されません。キュージョブの連鎖を実行するには、<code>Bus</code>ファサードが提供する<code>chain</code>メソッドを使用できます。Laravelのコマンドバスは、キュージョブのディスパッチが構築される低レベルのコンポーネントです：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">use</span> <span class="nx">App\Jobs\OptimizePodcast</span><span class="p">;</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="k">use</span> <span class="nx">App\Jobs\ReleasePodcast</span><span class="p">;</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Bus</span><span class="p">;</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="nx">Bus</span><span class="o">::</span><span class="na">chain</span><span class="p">([</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>    <span class="k">new</span> <span class="nx">ProcessPodcast</span><span class="p">,</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>    <span class="k">new</span> <span class="nx">OptimizePodcast</span><span class="p">,</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>    <span class="k">new</span> <span class="nx">ReleasePodcast</span><span class="p">,</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="p">])</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<p>ジョブクラスインスタンスの連鎖に加えて、クロージャを連鎖することもできます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="nx">Bus</span><span class="o">::</span><span class="na">chain</span><span class="p">([</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>    <span class="k">new</span> <span class="nx">ProcessPodcast</span><span class="p">,</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>    <span class="k">new</span> <span class="nx">OptimizePodcast</span><span class="p">,</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>    <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a>        <span class="nx">Podcast</span><span class="o">::</span><span class="na">update</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">);</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a>    <span class="p">},</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="p">])</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ジョブ内で<code>$this-&gt;delete()</code>メソッドを使用してジョブを削除しても、連鎖されたジョブの処理は妨げられません。連鎖は、連鎖内のジョブが失敗した場合にのみ実行を停止します。</p>
</div>
<p><a name="chain-connection-queue"></a></p>
<h4 id="_28">連鎖接続とキュー<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<p>連鎖されたジョブに使用する接続とキューを指定したい場合、<code>onConnection</code>と<code>onQueue</code>メソッドを使用できます。これらのメソッドは、キュージョブが別の接続/キューに明示的に割り当てられていない限り、使用されるキュー接続とキュー名を指定します：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="nx">Bus</span><span class="o">::</span><span class="na">chain</span><span class="p">([</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>    <span class="k">new</span> <span class="nx">ProcessPodcast</span><span class="p">,</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a>    <span class="k">new</span> <span class="nx">OptimizePodcast</span><span class="p">,</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>    <span class="k">new</span> <span class="nx">ReleasePodcast</span><span class="p">,</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="p">])</span><span class="o">-&gt;</span><span class="na">onConnection</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">onQueue</span><span class="p">(</span><span class="s1">&#39;podcasts&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<p><a name="adding-jobs-to-the-chain"></a></p>
<h4 id="_29">連鎖へのジョブの追加<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<p>連鎖内の別のジョブから既存のジョブ連鎖にジョブを追加または前に追加する必要がある場合があります。これは、<code>prependToChain</code>と<code>appendToChain</code>メソッドを使用して実現できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="sd">/**</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="sd"> * Execute the job.</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="sd"> */</span>
<a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="p">{</span>
<a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a>    <span class="c1">// ...</span>
<a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a>
<a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>    <span class="c1">// 現在の連鎖に前に追加し、現在のジョブの直後にジョブを実行...</span>
<a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prependToChain</span><span class="p">(</span><span class="k">new</span> <span class="nx">TranscribePodcast</span><span class="p">);</span>
<a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a>
<a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a>    <span class="c1">// 現在の連鎖に追加し、連鎖の最後にジョブを実行...</span>
<a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">appendToChain</span><span class="p">(</span><span class="k">new</span> <span class="nx">TranscribePodcast</span><span class="p">);</span>
<a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="p">}</span>
</code></pre></div>
<p><a name="chain-failures"></a></p>
<h4 id="_30">連鎖の失敗<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h4>
<p>ジョブの連鎖時に、連鎖内のジョブが失敗した場合に呼び出されるクロージャを指定するために<code>catch</code>メソッドを使用できます。指定されたコールバックは、ジョブの失敗を引き起こした<code>Throwable</code>インスタンスを受け取ります：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Bus</span><span class="p">;</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="k">use</span> <span class="nx">Throwable</span><span class="p">;</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="nx">Bus</span><span class="o">::</span><span class="na">chain</span><span class="p">([</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>    <span class="k">new</span> <span class="nx">ProcessPodcast</span><span class="p">,</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>    <span class="k">new</span> <span class="nx">OptimizePodcast</span><span class="p">,</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a>    <span class="k">new</span> <span class="nx">ReleasePodcast</span><span class="p">,</span>
<a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="p">])</span><span class="o">-&gt;</span><span class="na">catch</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Throwable</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>    <span class="c1">// 連鎖内のジョブが失敗しました...</span>
<a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>連鎖コールバックはシリアライズされ、後でLaravelキューによって実行されるため、連鎖コールバック内で<code>$this</code>変数を使用しないでください。</p>
</div>
<p><a name="customizing-the-queue-and-connection"></a></p>
<h3 id="_31">キューと接続のカスタマイズ<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p><a name="dispatching-to-a-particular-queue"></a></p>
<h4 id="_32">特定のキューへのディスパッチ<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h4>
<p>異なるキューにジョブをプッシュすることで、キュージョブを「分類」し、どのキューにどれだけのワーカーを割り当てるかを優先順位付けできます。これにより、キュー設定ファイルで定義された異なるキュー「接続」にジョブをプッシュするのではなく、単一の接続内の特定のキューにジョブをプッシュします。キューを指定するには、ジョブをディスパッチする際に<code>onQueue</code>メソッドを使用します：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="k">use</span> <span class="nx">App\Models\Podcast</span><span class="p">;</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="k">use</span> <span class="nx">Illuminate\Http\RedirectResponse</span><span class="p">;</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="k">class</span> <span class="nc">PodcastController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="p">{</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a>    <span class="sd">/**</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="sd">     * Store a new podcast.</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="sd">     */</span>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="nx">RedirectResponse</span>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a>    <span class="p">{</span>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a>        <span class="nv">$podcast</span> <span class="o">=</span> <span class="nx">Podcast</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">);</span>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a>        <span class="c1">// Create podcast...</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a>        <span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$podcast</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">onQueue</span><span class="p">(</span><span class="s1">&#39;processing&#39;</span><span class="p">);</span>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a>
<a id="__codelineno-51-24" name="__codelineno-51-24" href="#__codelineno-51-24"></a>        <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/podcasts&#39;</span><span class="p">);</span>
<a id="__codelineno-51-25" name="__codelineno-51-25" href="#__codelineno-51-25"></a>    <span class="p">}</span>
<a id="__codelineno-51-26" name="__codelineno-51-26" href="#__codelineno-51-26"></a><span class="p">}</span>
</code></pre></div>
<p>あるいは、ジョブのコンストラクタ内で<code>onQueue</code>メソッドを呼び出して、ジョブのキューを指定することもできます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a> <span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a> <span class="k">use</span> <span class="nx">Illuminate\Foundation\Queue\Queueable</span><span class="p">;</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="k">class</span> <span class="nc">ProcessPodcast</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="p">{</span>
<a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a>    <span class="k">use</span> <span class="nx">Queueable</span><span class="p">;</span>
<a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a>
<a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a>    <span class="sd">/**</span>
<a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="sd">     * Create a new job instance.</span>
<a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="sd">     */</span>
<a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
<a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a>    <span class="p">{</span>
<a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">onQueue</span><span class="p">(</span><span class="s1">&#39;processing&#39;</span><span class="p">);</span>
<a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a>    <span class="p">}</span>
<a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a><span class="p">}</span>
</code></pre></div>
<p><a name="dispatching-to-a-particular-connection"></a></p>
<h4 id="_33">特定の接続へのディスパッチ<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h4>
<p>アプリケーションが複数のキュー接続と対話する場合、<code>onConnection</code>メソッドを使用してジョブをプッシュする接続を指定できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a><span class="k">use</span> <span class="nx">App\Models\Podcast</span><span class="p">;</span>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="k">use</span> <span class="nx">Illuminate\Http\RedirectResponse</span><span class="p">;</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a><span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a><span class="k">class</span> <span class="nc">PodcastController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="p">{</span>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a>    <span class="sd">/**</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a><span class="sd">     * Store a new podcast.</span>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="sd">     */</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span><span class="o">:</span> <span class="nx">RedirectResponse</span>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a>    <span class="p">{</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a>        <span class="nv">$podcast</span> <span class="o">=</span> <span class="nx">Podcast</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">);</span>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a>        <span class="c1">// Create podcast...</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a>
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a>        <span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$podcast</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">onConnection</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">);</span>
<a id="__codelineno-53-23" name="__codelineno-53-23" href="#__codelineno-53-23"></a>
<a id="__codelineno-53-24" name="__codelineno-53-24" href="#__codelineno-53-24"></a>        <span class="k">return</span> <span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/podcasts&#39;</span><span class="p">);</span>
<a id="__codelineno-53-25" name="__codelineno-53-25" href="#__codelineno-53-25"></a>    <span class="p">}</span>
<a id="__codelineno-53-26" name="__codelineno-53-26" href="#__codelineno-53-26"></a><span class="p">}</span>
</code></pre></div>
<p><code>onConnection</code>と<code>onQueue</code>メソッドを一緒にチェーンして、ジョブの接続とキューを指定できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="nx">ProcessPodcast</span><span class="o">::</span><span class="na">dispatch</span><span class="p">(</span><span class="nv">$podcast</span><span class="p">)</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>              <span class="o">-&gt;</span><span class="na">onConnection</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">)</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a>              <span class="o">-&gt;</span><span class="na">onQueue</span><span class="p">(</span><span class="s1">&#39;processing&#39;</span><span class="p">);</span>
</code></pre></div>
<p>あるいは、ジョブのコンストラクタ内で<code>onConnection</code>メソッドを呼び出して、ジョブの接続を指定することもできます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a> <span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a> <span class="k">use</span> <span class="nx">Illuminate\Foundation\Queue\Queueable</span><span class="p">;</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a><span class="k">class</span> <span class="nc">ProcessPodcast</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="p">{</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a>    <span class="k">use</span> <span class="nx">Queueable</span><span class="p">;</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a>    <span class="sd">/**</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="sd">     * Create a new job instance.</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="sd">     */</span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a>    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a>    <span class="p">{</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">onConnection</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">);</span>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a>    <span class="p">}</span>
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a><span class="p">}</span>
</code></pre></div>
<p><a name="max-job-attempts-and-timeout"></a></p>
<h3 id="_34">最大ジョブ試行回数/タイムアウト値の指定<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h3>
<p><a name="max-attempts"></a></p>
<h4 id="_35">最大試行回数<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h4>
<p>キューに入れられたジョブの1つがエラーに遭遇した場合、無期限に再試行し続けることは望ましくないでしょう。そのため、Laravelはジョブを試行できる回数や時間を指定するためのさまざまな方法を提供しています。</p>
<p>ジョブが試行できる最大回数を指定する1つの方法は、Artisanコマンドラインの<code>--tries</code>スイッチを使用することです。これは、処理されるジョブが試行回数を指定していない限り、ワーカーによって処理されるすべてのジョブに適用されます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--tries<span class="o">=</span><span class="m">3</span>
</code></pre></div>
<p>ジョブが最大試行回数を超えると、「失敗した」ジョブと見なされます。失敗したジョブの処理についての詳細は、<a href="#dealing-with-failed-jobs">失敗したジョブのドキュメント</a>を参照してください。<code>queue:work</code>コマンドに<code>--tries=0</code>が指定されている場合、ジョブは無期限に再試行されます。</p>
<p>ジョブクラス自体にジョブが試行できる最大回数を定義することで、より詳細なアプローチを取ることができます。ジョブに最大試行回数が指定されている場合、コマンドラインで指定された<code>--tries</code>の値よりも優先されます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="k">class</span> <span class="nc">ProcessPodcast</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="p">{</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>    <span class="sd">/**</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="sd">     * The number of times the job may be attempted.</span>
<a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="sd">     *</span>
<a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="sd">     * @var int</span>
<a id="__codelineno-57-11" name="__codelineno-57-11" href="#__codelineno-57-11"></a><span class="sd">     */</span>
<a id="__codelineno-57-12" name="__codelineno-57-12" href="#__codelineno-57-12"></a>    <span class="k">public</span> <span class="nv">$tries</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-57-13" name="__codelineno-57-13" href="#__codelineno-57-13"></a><span class="p">}</span>
</code></pre></div>
<p>特定のジョブの最大試行回数を動的に制御する必要がある場合は、ジョブに<code>tries</code>メソッドを定義できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="sd">/**</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="sd"> * Determine number of times the job may be attempted.</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="sd"> */</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">tries</span><span class="p">()</span><span class="o">:</span> <span class="nx">int</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="p">{</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a>    <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="p">}</span>
</code></pre></div>
<p><a name="time-based-attempts"></a></p>
<h4 id="_36">時間ベースの試行<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h4>
<p>ジョブが失敗するまでに何回試行できるかを定義する代わりに、ジョブが試行されなくなる時間を定義することもできます。これにより、指定した期間内でジョブを何度でも試行できます。ジョブが試行されなくなる時間を定義するには、ジョブクラスに<code>retryUntil</code>メソッドを追加します。このメソッドは<code>DateTime</code>インスタンスを返す必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="k">use</span> <span class="nx">DateTime</span><span class="p">;</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="sd">/**</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="sd"> * ジョブがタイムアウトする時間を決定します。</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="sd"> */</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">retryUntil</span><span class="p">()</span><span class="o">:</span> <span class="nx">DateTime</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="p">{</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>    <span class="k">return</span> <span class="nx">now</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">addMinutes</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a href="events.html#queued-event-listeners">キューイベントリスナー</a>に<code>tries</code>プロパティまたは<code>retryUntil</code>メソッドを定義することもできます。</p>
</div>
<p><a name="max-exceptions"></a></p>
<h4 id="_37">最大例外数<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h4>
<p>ジョブを何度も試行させたいが、指定した数の未処理例外が発生した場合に失敗させたい場合があります（<code>release</code>メソッドによって直接リリースされるのではなく）。これを実現するには、ジョブクラスに<code>maxExceptions</code>プロパティを定義します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Redis</span><span class="p">;</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a>
<a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="k">class</span> <span class="nc">ProcessPodcast</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<a id="__codelineno-60-8" name="__codelineno-60-8" href="#__codelineno-60-8"></a><span class="p">{</span>
<a id="__codelineno-60-9" name="__codelineno-60-9" href="#__codelineno-60-9"></a>    <span class="sd">/**</span>
<a id="__codelineno-60-10" name="__codelineno-60-10" href="#__codelineno-60-10"></a><span class="sd">     * ジョブが試行できる回数。</span>
<a id="__codelineno-60-11" name="__codelineno-60-11" href="#__codelineno-60-11"></a><span class="sd">     *</span>
<a id="__codelineno-60-12" name="__codelineno-60-12" href="#__codelineno-60-12"></a><span class="sd">     * @var int</span>
<a id="__codelineno-60-13" name="__codelineno-60-13" href="#__codelineno-60-13"></a><span class="sd">     */</span>
<a id="__codelineno-60-14" name="__codelineno-60-14" href="#__codelineno-60-14"></a>    <span class="k">public</span> <span class="nv">$tries</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
<a id="__codelineno-60-15" name="__codelineno-60-15" href="#__codelineno-60-15"></a>
<a id="__codelineno-60-16" name="__codelineno-60-16" href="#__codelineno-60-16"></a>    <span class="sd">/**</span>
<a id="__codelineno-60-17" name="__codelineno-60-17" href="#__codelineno-60-17"></a><span class="sd">     * 失敗するまでに許容する未処理例外の最大数。</span>
<a id="__codelineno-60-18" name="__codelineno-60-18" href="#__codelineno-60-18"></a><span class="sd">     *</span>
<a id="__codelineno-60-19" name="__codelineno-60-19" href="#__codelineno-60-19"></a><span class="sd">     * @var int</span>
<a id="__codelineno-60-20" name="__codelineno-60-20" href="#__codelineno-60-20"></a><span class="sd">     */</span>
<a id="__codelineno-60-21" name="__codelineno-60-21" href="#__codelineno-60-21"></a>    <span class="k">public</span> <span class="nv">$maxExceptions</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-60-22" name="__codelineno-60-22" href="#__codelineno-60-22"></a>
<a id="__codelineno-60-23" name="__codelineno-60-23" href="#__codelineno-60-23"></a>    <span class="sd">/**</span>
<a id="__codelineno-60-24" name="__codelineno-60-24" href="#__codelineno-60-24"></a><span class="sd">     * ジョブを実行します。</span>
<a id="__codelineno-60-25" name="__codelineno-60-25" href="#__codelineno-60-25"></a><span class="sd">     */</span>
<a id="__codelineno-60-26" name="__codelineno-60-26" href="#__codelineno-60-26"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-60-27" name="__codelineno-60-27" href="#__codelineno-60-27"></a>    <span class="p">{</span>
<a id="__codelineno-60-28" name="__codelineno-60-28" href="#__codelineno-60-28"></a>        <span class="nx">Redis</span><span class="o">::</span><span class="na">throttle</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">allow</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">every</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-60-29" name="__codelineno-60-29" href="#__codelineno-60-29"></a>            <span class="c1">// ロックが取得され、ポッドキャストを処理します...</span>
<a id="__codelineno-60-30" name="__codelineno-60-30" href="#__codelineno-60-30"></a>        <span class="p">},</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-60-31" name="__codelineno-60-31" href="#__codelineno-60-31"></a>            <span class="c1">// ロックが取得できませんでした...</span>
<a id="__codelineno-60-32" name="__codelineno-60-32" href="#__codelineno-60-32"></a>            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">release</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-60-33" name="__codelineno-60-33" href="#__codelineno-60-33"></a>        <span class="p">});</span>
<a id="__codelineno-60-34" name="__codelineno-60-34" href="#__codelineno-60-34"></a>    <span class="p">}</span>
<a id="__codelineno-60-35" name="__codelineno-60-35" href="#__codelineno-60-35"></a><span class="p">}</span>
</code></pre></div>
<p>この例では、アプリケーションがRedisロックを取得できない場合、ジョブは10秒間リリースされ、最大25回再試行されます。ただし、ジョブが3つの未処理例外をスローした場合、ジョブは失敗します。</p>
<p><a name="timeout"></a></p>
<h4 id="_38">タイムアウト<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h4>
<p>キューに入れられたジョブがどのくらいの時間かかるか、おおよその時間がわかっていることがよくあります。そのため、Laravelでは「タイムアウト」値を指定できます。デフォルトでは、タイムアウト値は60秒です。ジョブがタイムアウト値で指定された秒数より長く処理されると、ジョブを処理しているワーカーはエラーで終了します。通常、ワーカーは<a href="#supervisor-configuration">サーバーで設定されたプロセスマネージャ</a>によって自動的に再起動されます。</p>
<p>ジョブが実行できる最大秒数は、Artisanコマンドラインで<code>--timeout</code>スイッチを使用して指定できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--timeout<span class="o">=</span><span class="m">30</span>
</code></pre></div>
<p>ジョブがタイムアウトを繰り返し超えて最大試行回数を超えた場合、ジョブは失敗としてマークされます。</p>
<p>ジョブクラス自体でジョブが実行できる最大秒数を定義することもできます。ジョブでタイムアウトが指定されている場合、コマンドラインで指定されたタイムアウトよりも優先されます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a><span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a><span class="k">class</span> <span class="nc">ProcessPodcast</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a><span class="p">{</span>
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>    <span class="sd">/**</span>
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a><span class="sd">     * ジョブがタイムアウトするまでの秒数。</span>
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a><span class="sd">     *</span>
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a><span class="sd">     * @var int</span>
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a><span class="sd">     */</span>
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>    <span class="k">public</span> <span class="nv">$timeout</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a><span class="p">}</span>
</code></pre></div>
<p>時には、ソケットや外部HTTP接続などのIOブロッキングプロセスが指定したタイムアウトを無視することがあります。そのため、これらの機能を使用する場合は、常にそれらのAPIを使用してタイムアウトを指定する必要があります。例えば、Guzzleを使用する場合は、常に接続とリクエストのタイムアウト値を指定する必要があります。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ジョブのタイムアウトを指定するには、<code>pcntl</code> PHP拡張機能がインストールされている必要があります。また、ジョブの「タイムアウト」値は、常に<a href="#job-expiration">"retry after"</a>値よりも小さくする必要があります。そうしないと、ジョブが実際に終了する前に再試行される可能性があります。</p>
</div>
<p><a name="failing-on-timeout"></a></p>
<h4 id="_39">タイムアウト時に失敗<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h4>
<p>タイムアウト時にジョブを<a href="#dealing-with-failed-jobs">失敗</a>としてマークしたい場合は、ジョブクラスに<code>$failOnTimeout</code>プロパティを定義できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="sd">/**</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="sd"> * タイムアウト時にジョブを失敗としてマークするかどうかを示します。</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="sd"> *</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="sd"> * @var bool</span>
<a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="sd"> */</span>
<a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="k">public</span> <span class="nv">$failOnTimeout</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</code></pre></div>
<p><a name="error-handling"></a></p>
<h3 id="_40">エラー処理<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>ジョブの処理中に例外がスローされた場合、ジョブは自動的にキューに戻され、再試行されます。ジョブは、アプリケーションで許可されている最大試行回数に達するまで継続的にリリースされます。最大試行回数は、<code>queue:work</code> Artisanコマンドで使用される<code>--tries</code>スイッチによって定義されます。または、ジョブクラス自体で最大試行回数を定義することもできます。キューワーカーの実行に関する詳細情報は、<a href="#running-the-queue-worker">以下</a>で見つけることができます。</p>
<p><a name="manually-releasing-a-job"></a></p>
<h4 id="_41">手動でジョブをリリース<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h4>
<p>時には、ジョブを手動でキューに戻して、後で再試行したい場合があります。これは、<code>release</code>メソッドを呼び出すことで実現できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="sd">/**</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="sd"> * ジョブを実行します。</span>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="sd"> */</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="p">{</span>
<a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>    <span class="c1">// ...</span>
<a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>
<a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">release</span><span class="p">();</span>
<a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="p">}</span>
</code></pre></div>
<p>デフォルトでは、<code>release</code>メソッドはジョブを即座にキューに戻します。ただし、整数または日付インスタンスを<code>release</code>メソッドに渡すことで、ジョブが処理されるまでの秒数を指定できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">release</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">release</span><span class="p">(</span><span class="nx">now</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">addSeconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</code></pre></div>
<p><a name="manually-failing-a-job"></a></p>
<h4 id="_42">手動でジョブを失敗<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h4>
<p>時には、ジョブを手動で「失敗」としてマークする必要があります。これを行うには、<code>fail</code>メソッドを呼び出します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="sd">/**</span>
<a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="sd"> * ジョブを実行します。</span>
<a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="sd"> */</span>
<a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-66-5" name="__codelineno-66-5" href="#__codelineno-66-5"></a><span class="p">{</span>
<a id="__codelineno-66-6" name="__codelineno-66-6" href="#__codelineno-66-6"></a>    <span class="c1">// ...</span>
<a id="__codelineno-66-7" name="__codelineno-66-7" href="#__codelineno-66-7"></a>
<a id="__codelineno-66-8" name="__codelineno-66-8" href="#__codelineno-66-8"></a>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fail</span><span class="p">();</span>
<a id="__codelineno-66-9" name="__codelineno-66-9" href="#__codelineno-66-9"></a><span class="p">}</span>
</code></pre></div>
<p>キャッチした例外のためにジョブを失敗としてマークしたい場合は、例外を<code>fail</code>メソッドに渡すことができます。また、便宜上、エラーメッセージを文字列で渡すこともでき、これは例外に変換されます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fail</span><span class="p">(</span><span class="nv">$exception</span><span class="p">);</span>
<a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a>
<a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">fail</span><span class="p">(</span><span class="s1">&#39;Something went wrong.&#39;</span><span class="p">);</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>失敗したジョブの詳細については、<a href="#dealing-with-failed-jobs">失敗したジョブの処理に関するドキュメント</a>を確認してください。</p>
</div>
<p><a name="job-batching"></a></p>
<h2 id="_43">ジョブのバッチ処理<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h2>
<p>Laravelのジョブバッチ処理機能を使用すると、ジョブのバッチを簡単に実行し、バッチのジョブが完了したときに何らかのアクションを実行できます。まず、ジョブバッチに関するメタ情報を格納するテーブルを構築するためのデータベースマイグレーションを作成する必要があります。このマイグレーションは、<code>make:queue-batches-table</code> Artisanコマンドを使用して生成できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>make:queue-batches-table
<a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>
<a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>php<span class="w"> </span>artisan<span class="w"> </span>migrate
</code></pre></div>
<p><a name="defining-batchable-jobs"></a></p>
<h3 id="_44">バッチ可能なジョブの定義<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h3>
<p>バッチ可能なジョブを定義するには、通常の<a href="#creating-jobs">キュー可能なジョブ</a>を作成する必要があります。ただし、ジョブクラスに<code>Illuminate\Bus\Batchable</code>トレイトを追加する必要があります。このトレイトは、ジョブが実行されている現在のバッチを取得するために使用できる<code>batch</code>メソッドへのアクセスを提供します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>
<a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>
<a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a>
<a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="k">use</span> <span class="nx">Illuminate\Bus\Batchable</span><span class="p">;</span>
<a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="k">use</span> <span class="nx">Illuminate\Foundation\Queue\Queueable</span><span class="p">;</span>
<a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a>
<a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a><span class="k">class</span> <span class="nc">ImportCsv</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="p">{</span>
<a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a>    <span class="k">use</span> <span class="nx">Batchable</span><span class="p">,</span> <span class="nx">Queueable</span><span class="p">;</span>
<a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a>
<a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a>    <span class="sd">/**</span>
<a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="sd">     * ジョブを実行します。</span>
<a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a><span class="sd">     */</span>
<a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a>    <span class="p">{</span>
<a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a>        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">batch</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cancelled</span><span class="p">())</span> <span class="p">{</span>
<a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a>            <span class="c1">// バッチがキャンセルされたかどうかを判断します...</span>
<a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a>
<a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a>            <span class="k">return</span><span class="p">;</span>
<a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a>        <span class="p">}</span>
<a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a>
<a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a>        <span class="c1">// CSVファイルの一部をインポートします...</span>
<a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a>    <span class="p">}</span>
<a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a><span class="p">}</span>
</code></pre></div>
<p><a name="dispatching-batches"></a></p>
<h3 id="_45">バッチのディスパッチ<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>ジョブのバッチをディスパッチするには、<code>Bus</code>ファサードの<code>batch</code>メソッドを使用する必要があります。もちろん、バッチ処理は主に完了コールバックと組み合わせて使用するのが便利です。そのため、<code>then</code>、<code>catch</code>、<code>finally</code>メソッドを使用してバッチの完了コールバックを定義できます。これらの各コールバックは、呼び出されたときに<code>Illuminate\Bus\Batch</code>インスタンスを受け取ります。この例では、CSVファイルから行を処理するジョブのバッチをキューに入れることを想像しています。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="k">use</span> <span class="nx">App\Jobs\ImportCsv</span><span class="p">;</span>
<a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="k">use</span> <span class="nx">Illuminate\Bus\Batch</span><span class="p">;</span>
<a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Bus</span><span class="p">;</span>
<a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="k">use</span> <span class="nx">Throwable</span><span class="p">;</span>
<a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a>
<a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="nv">$batch</span> <span class="o">=</span> <span class="nx">Bus</span><span class="o">::</span><span class="na">batch</span><span class="p">([</span>
<a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a>    <span class="k">new</span> <span class="nx">ImportCsv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
<a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>    <span class="k">new</span> <span class="nx">ImportCsv</span><span class="p">(</span><span class="mi">101</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
<a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a>    <span class="k">new</span> <span class="nx">ImportCsv</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span> <span class="mi">300</span><span class="p">),</span>
<a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a>    <span class="k">new</span> <span class="nx">ImportCsv</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span>
<a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a>    <span class="k">new</span> <span class="nx">ImportCsv</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
<a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a><span class="p">])</span><span class="o">-&gt;</span><span class="na">before</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-70-13" name="__codelineno-70-13" href="#__codelineno-70-13"></a>    <span class="c1">// バッチが作成されましたが、ジョブはまだ追加されていません...</span>
<a id="__codelineno-70-14" name="__codelineno-70-14" href="#__codelineno-70-14"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">progress</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-70-15" name="__codelineno-70-15" href="#__codelineno-70-15"></a>    <span class="c1">// 単一のジョブが正常に完了しました...</span>
<a id="__codelineno-70-16" name="__codelineno-70-16" href="#__codelineno-70-16"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-70-17" name="__codelineno-70-17" href="#__codelineno-70-17"></a>    <span class="c1">// すべてのジョブが正常に完了しました...</span>
<a id="__codelineno-70-18" name="__codelineno-70-18" href="#__codelineno-70-18"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">catch</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">,</span> <span class="nx">Throwable</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-70-19" name="__codelineno-70-19" href="#__codelineno-70-19"></a>    <span class="c1">// 最初のバッチジョブの失敗が検出されました...</span>
<a id="__codelineno-70-20" name="__codelineno-70-20" href="#__codelineno-70-20"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">finally</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-70-21" name="__codelineno-70-21" href="#__codelineno-70-21"></a>    <span class="c1">// バッチの実行が完了しました...</span>
<a id="__codelineno-70-22" name="__codelineno-70-22" href="#__codelineno-70-22"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
<a id="__codelineno-70-23" name="__codelineno-70-23" href="#__codelineno-70-23"></a>
<a id="__codelineno-70-24" name="__codelineno-70-24" href="#__codelineno-70-24"></a><span class="k">return</span> <span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
</code></pre></div>
<p>バッチのIDは、<code>$batch-&gt;id</code>プロパティを介してアクセスできます。これは、バッチがディスパッチされた後に<a href="#inspecting-batches">Laravelコマンドバスをクエリ</a>してバッチに関する情報を取得するために使用できます。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>バッチコールバックはシリアライズされ、後でLaravelキューによって実行されるため、コールバック内で<code>$this</code>変数を使用しないでください。また、バッチジョブはデータベーストランザクション内でラップされるため、暗黙的なコミットをトリガーするデータベースステートメントはジョブ内で実行しないでください。</p>
</div>
<p><a name="naming-batches"></a></p>
<h4 id="_46">バッチの命名<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<p>特定のバッチを識別しやすくするために、バッチに名前を付けることができます。これにより、バッチの進行状況を監視する際に、バッチを識別しやすくなります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a><span class="nv">$batch</span> <span class="o">=</span> <span class="nx">Bus</span><span class="o">::</span><span class="na">batch</span><span class="p">([</span>
<a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>    <span class="c1">// ...</span>
<a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a><span class="p">])</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>    <span class="c1">// すべてのジョブが正常に完了しました...</span>
<a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;Import CSV&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<p>Laravel HorizonやLaravel Telescopeなどのツールは、バッチに名前が付けられている場合、よりユーザーフレンドリーなデバッグ情報を提供することがあります。バッチに任意の名前を割り当てるには、バッチを定義する際に<code>name</code>メソッドを呼び出すことができます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$batch</span> <span class="o">=</span> <span class="nx">Bus</span><span class="o">::</span><span class="na">batch</span><span class="p">([</span>
    <span class="c1">// ...</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// すべてのジョブが正常に完了しました...</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;CSVのインポート&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<p><a name="batch-connection-queue"></a></p>
<h4 id="_47">バッチの接続とキュー<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h4>
<p>バッチされたジョブに使用される接続とキューを指定したい場合は、<code>onConnection</code>メソッドと<code>onQueue</code>メソッドを使用できます。すべてのバッチされたジョブは同じ接続とキュー内で実行される必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$batch</span> <span class="o">=</span> <span class="nx">Bus</span><span class="o">::</span><span class="na">batch</span><span class="p">([</span>
    <span class="c1">// ...</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// すべてのジョブが正常に完了しました...</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">onConnection</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">onQueue</span><span class="p">(</span><span class="s1">&#39;imports&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<p><a name="chains-and-batches"></a></p>
<h3 id="_48">チェーンとバッチ<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h3>
<p>バッチ内に<a href="#job-chaining">チェーンされたジョブ</a>のセットを定義するには、チェーンされたジョブを配列内に配置します。たとえば、2つのジョブチェーンを並行して実行し、両方のジョブチェーンが処理を完了したときにコールバックを実行できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Jobs\ReleasePodcast</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Jobs\SendPodcastReleaseNotification</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Bus\Batch</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Bus</span><span class="p">;</span>

<span class="nx">Bus</span><span class="o">::</span><span class="na">batch</span><span class="p">([</span>
    <span class="p">[</span>
        <span class="k">new</span> <span class="nx">ReleasePodcast</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="k">new</span> <span class="nx">SendPodcastReleaseNotification</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="p">[</span>
        <span class="k">new</span> <span class="nx">ReleasePodcast</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="k">new</span> <span class="nx">SendPodcastReleaseNotification</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<p>逆に、<a href="#job-chaining">チェーン</a>内でバッチされたジョブを実行するには、チェーン内にバッチを定義します。たとえば、まず複数のポッドキャストをリリースするためのバッチされたジョブを実行し、次にリリース通知を送信するためのバッチされたジョブを実行できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Jobs\FlushPodcastCache</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Jobs\ReleasePodcast</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Jobs\SendPodcastReleaseNotification</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Bus</span><span class="p">;</span>

<span class="nx">Bus</span><span class="o">::</span><span class="na">chain</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">FlushPodcastCache</span><span class="p">,</span>
    <span class="nx">Bus</span><span class="o">::</span><span class="na">batch</span><span class="p">([</span>
        <span class="k">new</span> <span class="nx">ReleasePodcast</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="k">new</span> <span class="nx">ReleasePodcast</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">]),</span>
    <span class="nx">Bus</span><span class="o">::</span><span class="na">batch</span><span class="p">([</span>
        <span class="k">new</span> <span class="nx">SendPodcastReleaseNotification</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="k">new</span> <span class="nx">SendPodcastReleaseNotification</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="p">]),</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<p><a name="adding-jobs-to-batches"></a></p>
<h3 id="_49">バッチへのジョブの追加<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h3>
<p>バッチされたジョブ内からバッチに追加のジョブを追加すると便利な場合があります。このパターンは、数千のジョブをバッチ処理する必要があり、Webリクエスト中にディスパッチするには時間がかかりすぎる場合に役立ちます。その代わりに、バッチにさらにジョブを追加する「ローダー」ジョブの初期バッチをディスパッチすることができます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$batch</span> <span class="o">=</span> <span class="nx">Bus</span><span class="o">::</span><span class="na">batch</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">LoadImportBatch</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">LoadImportBatch</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">LoadImportBatch</span><span class="p">,</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// すべてのジョブが正常に完了しました...</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">(</span><span class="s1">&#39;連絡先のインポート&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<p>この例では、<code>LoadImportBatch</code>ジョブを使用してバッチに追加のジョブを追加します。これを実現するには、ジョブの<code>batch</code>メソッドを介してアクセスできるバッチインスタンスの<code>add</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Jobs\ImportContacts</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Collection</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * ジョブの実行</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">batch</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cancelled</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">batch</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nx">Collection</span><span class="o">::</span><span class="na">times</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">ImportContacts</span><span class="p">;</span>
    <span class="p">}));</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>同じバッチに属するジョブ内からのみ、バッチにジョブを追加できます。</p>
</div>
<p><a name="inspecting-batches"></a></p>
<h3 id="_50">バッチの検査<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h3>
<p>バッチ完了コールバックに提供される<code>Illuminate\Bus\Batch</code>インスタンスには、指定されたバッチされたジョブと対話したり検査したりするためのさまざまなプロパティとメソッドがあります。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// バッチのUUID...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>

<span class="c1">// バッチの名前（該当する場合）...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>

<span class="c1">// バッチに割り当てられたジョブの数...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">totalJobs</span><span class="p">;</span>

<span class="c1">// キューによってまだ処理されていないジョブの数...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">pendingJobs</span><span class="p">;</span>

<span class="c1">// 失敗したジョブの数...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">failedJobs</span><span class="p">;</span>

<span class="c1">// これまでに処理されたジョブの数...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">processedJobs</span><span class="p">();</span>

<span class="c1">// バッチの完了率（0-100）...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">progress</span><span class="p">();</span>

<span class="c1">// バッチが実行を完了したかどうかを示す...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">finished</span><span class="p">();</span>

<span class="c1">// バッチの実行をキャンセルする...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">cancel</span><span class="p">();</span>

<span class="c1">// バッチがキャンセルされたかどうかを示す...</span>
<span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">cancelled</span><span class="p">();</span>
</code></pre></div>
<p><a name="returning-batches-from-routes"></a></p>
<h4 id="_51">ルートからのバッチの返却<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h4>
<p>すべての<code>Illuminate\Bus\Batch</code>インスタンスはJSONシリアライズ可能であり、アプリケーションのルートの1つから直接返すことで、バッチに関する情報（完了進捗を含む）を含むJSONペイロードを取得できます。これにより、アプリケーションのUIにバッチの完了進捗に関する情報を表示するのが便利になります。</p>
<p>バッチをそのIDで取得するには、<code>Bus</code>ファサードの<code>findBatch</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Bus</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Route</span><span class="p">;</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;/batch/{batchId}&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">string</span> <span class="nv">$batchId</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Bus</span><span class="o">::</span><span class="na">findBatch</span><span class="p">(</span><span class="nv">$batchId</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p><a name="cancelling-batches"></a></p>
<h3 id="_52">バッチのキャンセル<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h3>
<p>場合によっては、特定のバッチの実行をキャンセルする必要があります。これは、<code>Illuminate\Bus\Batch</code>インスタンスの<code>cancel</code>メソッドを呼び出すことで実現できます。</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd"> * ジョブの実行</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">user</span><span class="o">-&gt;</span><span class="na">exceedsImportLimit</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">batch</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cancel</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">batch</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">cancelled</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>前の例で見たように、バッチされたジョブは通常、実行を継続する前に対応するバッチがキャンセルされたかどうかを判断する必要があります。ただし、便宜上、代わりに<code>SkipIfBatchCancelled</code><a href="#job-middleware">ミドルウェア</a>をジョブに割り当てることができます。その名前が示すように、このミドルウェアはLaravelに対応するバッチがキャンセルされた場合にジョブを処理しないように指示します。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Queue\Middleware\SkipIfBatchCancelled</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * ジョブが通過するミドルウェアを取得</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">middleware</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="k">new</span> <span class="nx">SkipIfBatchCancelled</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<p><a name="batch-failures"></a></p>
<h3 id="_53">バッチの失敗<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>バッチされたジョブが失敗すると、<code>catch</code>コールバック（割り当てられている場合）が呼び出されます。このコールバックは、バッチ内で最初に失敗したジョブに対してのみ呼び出されます。</p>
<p><a name="allowing-failures"></a></p>
<h4 id="_54">失敗の許可<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h4>
<p>バッチ内のジョブが失敗すると、Laravelは自動的にバッチを「キャンセル済み」としてマークします。この動作を無効にして、ジョブの失敗が自動的にバッチをキャンセル済みとしてマークしないようにすることができます。これは、バッチをディスパッチする際に<code>allowFailures</code>メソッドを呼び出すことで実現できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$batch</span> <span class="o">=</span> <span class="nx">Bus</span><span class="o">::</span><span class="na">batch</span><span class="p">([</span>
    <span class="c1">// ...</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">then</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Batch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// すべてのジョブが正常に完了しました...</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">allowFailures</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">dispatch</span><span class="p">();</span>
</code></pre></div>
<p><a name="retrying-failed-batch-jobs"></a></p>
<h4 id="_55">失敗したバッチジョブの再試行<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h4>
<p>便宜上、Laravelは指定されたバッチのすべての失敗したジョブを簡単に再試行できる<code>queue:retry-batch</code> Artisanコマンドを提供しています。<code>queue:retry-batch</code>コマンドは、再試行する失敗したジョブのバッチのUUIDを受け取ります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:retry-batch<span class="w"> </span>32dbc76c-4f82-4749-b610-a639fe0099b5
</code></pre></div>
<p><a name="pruning-batches"></a></p>
<h3 id="_56">バッチの整理<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>整理を行わない場合、<code>job_batches</code>テーブルは非常に迅速にレコードを蓄積する可能性があります。これを軽減するために、<code>queue:prune-batches</code> Artisanコマンドを毎日実行するように<a href="scheduling.html">スケジュール</a>する必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Schedule</span><span class="p">;</span>

<span class="nx">Schedule</span><span class="o">::</span><span class="na">command</span><span class="p">(</span><span class="s1">&#39;queue:prune-batches&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">daily</span><span class="p">();</span>
</code></pre></div>
<p>デフォルトでは、24時間以上経過したすべての完了したバッチが整理されます。コマンドを呼び出す際に<code>hours</code>オプションを使用して、バッチデータを保持する期間を決定できます。たとえば、次のコマンドは48時間以上前に完了したすべてのバッチを削除します。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Schedule</span><span class="p">;</span>

<span class="nx">Schedule</span><span class="o">::</span><span class="na">command</span><span class="p">(</span><span class="s1">&#39;queue:prune-batches --hours=48&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">daily</span><span class="p">();</span>
</code></pre></div>
<p>場合によっては、<code>jobs_batches</code>テーブルが正常に完了しなかったバッチのレコードを蓄積することがあります。たとえば、ジョブが失敗し、そのジョブが正常に再試行されなかったバッチなどです。<code>queue:prune-batches</code>コマンドに<code>unfinished</code>オプションを使用して、これらの未完了のバッチレコードを整理するように指示できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Schedule</span><span class="p">;</span>

<span class="nx">Schedule</span><span class="o">::</span><span class="na">command</span><span class="p">(</span><span class="s1">&#39;queue:prune-batches --hours=48 --unfinished=72&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">daily</span><span class="p">();</span>
</code></pre></div>
<p>同様に、<code>jobs_batches</code>テーブルはキャンセルされたバッチのレコードを蓄積することもあります。<code>queue:prune-batches</code>コマンドに<code>cancelled</code>オプションを使用して、これらのキャンセルされたバッチレコードを整理するように指示できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Schedule</span><span class="p">;</span>

<span class="nx">Schedule</span><span class="o">::</span><span class="na">command</span><span class="p">(</span><span class="s1">&#39;queue:prune-batches --hours=48 --cancelled=72&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">daily</span><span class="p">();</span>
</code></pre></div>
<p><a name="storing-batches-in-dynamodb"></a></p>
<h3 id="dynamodb">DynamoDBへのバッチの保存<a class="headerlink" href="#dynamodb" title="Permanent link">&para;</a></h3>
<p>Laravelは、バッチのメタ情報をリレーショナルデータベースの代わりに<a href="https://aws.amazon.com/dynamodb">DynamoDB</a>に保存するためのサポートも提供しています。ただし、すべてのバッチレコードを保存するためのDynamoDBテーブルを手動で作成する必要があります。</p>
<p>通常、このテーブルは<code>job_batches</code>という名前になりますが、アプリケーションの<code>queue</code>設定ファイル内の<code>queue.batching.table</code>設定値に基づいてテーブルに名前を付ける必要があります。</p>
<p><a name="dynamodb-batch-table-configuration"></a></p>
<h4 id="dynamodb_1">DynamoDBバッチテーブルの設定<a class="headerlink" href="#dynamodb_1" title="Permanent link">&para;</a></h4>
<p><code>job_batches</code> テーブルは、<code>application</code> という名前の文字列の主パーティションキーと、<code>id</code> という名前の文字列の主ソートキーを持つべきです。キーの <code>application</code> 部分には、アプリケーションの <code>app</code> 設定ファイル内の <code>name</code> 設定値で定義されたアプリケーション名が含まれます。アプリケーション名が DynamoDB テーブルのキーの一部であるため、複数の Laravel アプリケーションのジョブバッチを同じテーブルに保存することができます。</p>
<p>さらに、<a href="#pruning-batches-in-dynamodb">自動ジョブバッチのプルーニング</a>を利用したい場合、テーブルに <code>ttl</code> 属性を定義することができます。</p>
<p><a name="dynamodb-configuration"></a></p>
<h4 id="dynamodb_2">DynamoDB の設定<a class="headerlink" href="#dynamodb_2" title="Permanent link">&para;</a></h4>
<p>次に、Laravel アプリケーションが Amazon DynamoDB と通信できるように、AWS SDK をインストールします。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a>composer<span class="w"> </span>require<span class="w"> </span>aws/aws-sdk-php
</code></pre></div>
<p>そして、<code>queue.batching.driver</code> 設定オプションの値を <code>dynamodb</code> に設定します。さらに、<code>batching</code> 設定配列内で <code>key</code>、<code>secret</code>、<code>region</code> 設定オプションを定義する必要があります。これらのオプションは AWS への認証に使用されます。<code>dynamodb</code> ドライバを使用する場合、<code>queue.batching.database</code> 設定オプションは不要です。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a><span class="s1">&#39;batching&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
<a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>    <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;QUEUE_BATCHING_DRIVER&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamodb&#39;</span><span class="p">),</span>
<a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>    <span class="s1">&#39;key&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;AWS_ACCESS_KEY_ID&#39;</span><span class="p">),</span>
<a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>    <span class="s1">&#39;secret&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;AWS_SECRET_ACCESS_KEY&#39;</span><span class="p">),</span>
<a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>    <span class="s1">&#39;region&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;AWS_DEFAULT_REGION&#39;</span><span class="p">,</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">),</span>
<a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>    <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;job_batches&#39;</span><span class="p">,</span>
<a id="__codelineno-74-7" name="__codelineno-74-7" href="#__codelineno-74-7"></a><span class="p">],</span>
</code></pre></div>
<p><a name="pruning-batches-in-dynamodb"></a></p>
<h4 id="dynamodb_3">DynamoDB でのバッチのプルーニング<a class="headerlink" href="#dynamodb_3" title="Permanent link">&para;</a></h4>
<p><a href="https://aws.amazon.com/dynamodb">DynamoDB</a> を使用してジョブバッチ情報を保存する場合、リレーショナルデータベースに保存されたバッチをプルーニングするために使用される通常のプルーニングコマンドは機能しません。代わりに、<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html">DynamoDB のネイティブ TTL 機能</a>を利用して、古いバッチのレコードを自動的に削除することができます。</p>
<p>DynamoDB テーブルに <code>ttl</code> 属性を定義した場合、Laravel にバッチレコードのプルーニング方法を指示するための設定パラメータを定義できます。<code>queue.batching.ttl_attribute</code> 設定値は TTL を保持する属性の名前を定義し、<code>queue.batching.ttl</code> 設定値はレコードが最後に更新されてからの秒数を定義し、その後バッチレコードを DynamoDB テーブルから削除できるようにします。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="s1">&#39;batching&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
<a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a>    <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;QUEUE_FAILED_DRIVER&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamodb&#39;</span><span class="p">),</span>
<a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a>    <span class="s1">&#39;key&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;AWS_ACCESS_KEY_ID&#39;</span><span class="p">),</span>
<a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a>    <span class="s1">&#39;secret&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;AWS_SECRET_ACCESS_KEY&#39;</span><span class="p">),</span>
<a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a>    <span class="s1">&#39;region&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;AWS_DEFAULT_REGION&#39;</span><span class="p">,</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">),</span>
<a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a>    <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;job_batches&#39;</span><span class="p">,</span>
<a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a>    <span class="s1">&#39;ttl_attribute&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ttl&#39;</span><span class="p">,</span>
<a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a>    <span class="s1">&#39;ttl&#39;</span> <span class="o">=&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span> <span class="c1">// 7日間...</span>
<a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="p">],</span>
</code></pre></div>
<p><a name="queueing-closures"></a></p>
<h2 id="_57">クロージャのキューイング<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h2>
<p>ジョブクラスをキューにディスパッチする代わりに、クロージャをディスパッチすることもできます。これは、現在のリクエストサイクル外で実行する必要がある簡単なタスクに最適です。クロージャをキューにディスパッチする場合、クロージャのコード内容は暗号化されて署名されるため、転送中に変更されることはありません。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="nv">$podcast</span> <span class="o">=</span> <span class="nx">App\Podcast</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a>
<a id="__codelineno-76-3" name="__codelineno-76-3" href="#__codelineno-76-3"></a><span class="nx">dispatch</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$podcast</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-76-4" name="__codelineno-76-4" href="#__codelineno-76-4"></a>    <span class="nv">$podcast</span><span class="o">-&gt;</span><span class="na">publish</span><span class="p">();</span>
<a id="__codelineno-76-5" name="__codelineno-76-5" href="#__codelineno-76-5"></a><span class="p">});</span>
</code></pre></div>
<p><code>catch</code> メソッドを使用して、キューに入れられたクロージャがすべての<a href="#max-job-attempts-and-timeout">設定された再試行回数</a>を使い果たしても正常に完了しなかった場合に実行されるクロージャを提供できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="k">use</span> <span class="nx">Throwable</span><span class="p">;</span>
<a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a>
<a id="__codelineno-77-3" name="__codelineno-77-3" href="#__codelineno-77-3"></a><span class="nx">dispatch</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$podcast</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-77-4" name="__codelineno-77-4" href="#__codelineno-77-4"></a>    <span class="nv">$podcast</span><span class="o">-&gt;</span><span class="na">publish</span><span class="p">();</span>
<a id="__codelineno-77-5" name="__codelineno-77-5" href="#__codelineno-77-5"></a><span class="p">})</span><span class="o">-&gt;</span><span class="na">catch</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Throwable</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-77-6" name="__codelineno-77-6" href="#__codelineno-77-6"></a>    <span class="c1">// このジョブは失敗しました...</span>
<a id="__codelineno-77-7" name="__codelineno-77-7" href="#__codelineno-77-7"></a><span class="p">});</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>catch</code> コールバックはシリアライズされ、後で Laravel キューによって実行されるため、<code>catch</code> コールバック内で <code>$this</code> 変数を使用しないでください。</p>
</div>
<p><a name="running-the-queue-worker"></a></p>
<h2 id="_58">キューワーカーの実行<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h2>
<p><a name="the-queue-work-command"></a></p>
<h3 id="queuework"><code>queue:work</code> コマンド<a class="headerlink" href="#queuework" title="Permanent link">&para;</a></h3>
<p>Laravel には、キューワーカーを起動し、キューにプッシュされた新しいジョブを処理する Artisan コマンドが含まれています。<code>queue:work</code> Artisan コマンドを使用してワーカーを実行できます。<code>queue:work</code> コマンドが開始されると、手動で停止するか、ターミナルを閉じるまで実行し続けます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>queue:work</code> プロセスをバックグラウンドで永続的に実行し続けるためには、<a href="#supervisor-configuration">Supervisor</a> などのプロセスモニターを使用して、キューワーカーが停止しないようにする必要があります。</p>
</div>
<p><code>queue:work</code> コマンドを呼び出す際に <code>-v</code> フラグを含めると、処理されたジョブの ID がコマンドの出力に含まれるようになります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>-v
</code></pre></div>
<p>キューワーカーは長時間実行されるプロセスであり、ブートされたアプリケーションの状態をメモリに保存します。その結果、起動後にコードベースの変更を検出しません。したがって、デプロイプロセス中に<a href="#queue-workers-and-deployment">キューワーカーを再起動</a>することを忘れないでください。また、アプリケーションによって作成または変更された静的な状態は、ジョブ間で自動的にリセットされないことに注意してください。</p>
<p>あるいは、<code>queue:listen</code> コマンドを実行することもできます。<code>queue:listen</code> コマンドを使用する場合、更新されたコードをリロードしたり、アプリケーションの状態をリセットしたりするためにワーカーを手動で再起動する必要はありません。ただし、このコマンドは <code>queue:work</code> コマンドよりも大幅に効率が悪いです。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:listen
</code></pre></div>
<p><a name="running-multiple-queue-workers"></a></p>
<h4 id="_59">複数のキューワーカーの実行<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h4>
<p>キューに複数のワーカーを割り当ててジョブを並行して処理するには、単純に複数の <code>queue:work</code> プロセスを開始するだけです。これは、ローカルではターミナルの複数のタブを使用して行うことができますし、本番環境ではプロセスマネージャの設定を使用して行うことができます。<a href="#supervisor-configuration">Supervisor を使用する場合</a>、<code>numprocs</code> 設定値を使用できます。</p>
<p><a name="specifying-the-connection-queue"></a></p>
<h4 id="_60">接続とキューの指定<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h4>
<p>ワーカーが使用するキュー接続を指定することもできます。<code>work</code> コマンドに渡される接続名は、<code>config/queue.php</code> 設定ファイルで定義された接続のいずれかに対応する必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>redis
</code></pre></div>
<p>デフォルトでは、<code>queue:work</code> コマンドは指定された接続のデフォルトキューのジョブのみを処理します。ただし、特定の接続の特定のキューのみを処理するようにキューワーカーをさらにカスタマイズすることができます。たとえば、すべてのメールが <code>redis</code> キュー接続の <code>emails</code> キューで処理される場合、次のコマンドを発行して、そのキューのみを処理するワーカーを開始できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>redis<span class="w"> </span>--queue<span class="o">=</span>emails
</code></pre></div>
<p><a name="processing-a-specified-number-of-jobs"></a></p>
<h4 id="_61">指定された数のジョブの処理<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h4>
<p><code>--once</code> オプションを使用して、ワーカーにキューから単一のジョブのみを処理するように指示できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--once
</code></pre></div>
<p><code>--max-jobs</code> オプションを使用して、ワーカーに指定された数のジョブを処理してから終了するように指示できます。このオプションは、<a href="#supervisor-configuration">Supervisor</a> と組み合わせて使用すると便利です。これにより、指定された数のジョブを処理した後にワーカーが自動的に再起動され、蓄積されたメモリが解放されます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--max-jobs<span class="o">=</span><span class="m">1000</span>
</code></pre></div>
<p><a name="processing-all-queued-jobs-then-exiting"></a></p>
<h4 id="_62">すべてのキューイングされたジョブを処理してから終了<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h4>
<p><code>--stop-when-empty</code> オプションを使用して、ワーカーにすべてのジョブを処理してから正常に終了するように指示できます。このオプションは、キューが空になった後にコンテナをシャットダウンする場合に、Docker コンテナ内で Laravel キューを処理する際に便利です。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--stop-when-empty
</code></pre></div>
<p><a name="processing-jobs-for-a-given-number-of-seconds"></a></p>
<h4 id="_63">指定された秒数のジョブの処理<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h4>
<p><code>--max-time</code> オプションを使用して、ワーカーに指定された秒数のジョブを処理してから終了するように指示できます。このオプションは、<a href="#supervisor-configuration">Supervisor</a> と組み合わせて使用すると便利です。これにより、指定された時間のジョブを処理した後にワーカーが自動的に再起動され、蓄積されたメモリが解放されます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="c1"># 1時間ジョブを処理してから終了...</span>
<a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--max-time<span class="o">=</span><span class="m">3600</span>
</code></pre></div>
<p><a name="worker-sleep-duration"></a></p>
<h4 id="_64">ワーカーのスリープ時間<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h4>
<p>キューにジョブがある場合、ワーカーはジョブ間の遅延なくジョブを処理し続けます。ただし、<code>sleep</code> オプションは、ジョブが利用できない場合にワーカーが「スリープ」する秒数を決定します。スリープ中、ワーカーは新しいジョブを処理しません。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--sleep<span class="o">=</span><span class="m">3</span>
</code></pre></div>
<p><a name="maintenance-mode-queues"></a></p>
<h4 id="_65">メンテナンスモードとキュー<a class="headerlink" href="#_65" title="Permanent link">&para;</a></h4>
<p>アプリケーションが<a href="configuration.html#maintenance-mode">メンテナンスモード</a>にある間、キューイングされたジョブは処理されません。アプリケーションがメンテナンスモードを終了すると、ジョブは通常どおり処理されます。</p>
<p>メンテナンスモードが有効な場合でもキューワーカーがジョブを処理するように強制するには、<code>--force</code> オプションを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--force
</code></pre></div>
<p><a name="resource-considerations"></a></p>
<h4 id="_66">リソースの考慮事項<a class="headerlink" href="#_66" title="Permanent link">&para;</a></h4>
<p>デーモンキューワーカーは、各ジョブを処理する前にフレームワークを「再起動」しません。したがって、各ジョブが完了した後に重いリソースを解放する必要があります。たとえば、GD ライブラリを使用して画像操作を行う場合、画像の処理が完了した後に <code>imagedestroy</code> を使用してメモリを解放する必要があります。</p>
<p><a name="queue-priorities"></a></p>
<h3 id="_67">キューの優先度<a class="headerlink" href="#_67" title="Permanent link">&para;</a></h3>
<p>キューの処理順序を優先することがあります。たとえば、<code>config/queue.php</code> 設定ファイルで、<code>redis</code> 接続のデフォルト <code>queue</code> を <code>low</code> に設定することができます。ただし、次のように <code>high</code> 優先度キューにジョブをプッシュすることがあります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="nx">dispatch</span><span class="p">((</span><span class="k">new</span> <span class="nx">Job</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">onQueue</span><span class="p">(</span><span class="s1">&#39;high&#39;</span><span class="p">));</span>
</code></pre></div>
<p><code>high</code>キューのすべてのジョブが処理されるまで、<code>low</code>キューのジョブに進まないようにするワーカーを開始するには、キュー名のカンマ区切りリストを<code>work</code>コマンドに渡します:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--queue<span class="o">=</span>high,low
</code></pre></div>
<p><a name="queue-workers-and-deployment"></a></p>
<h3 id="_68">キューワーカーとデプロイ<a class="headerlink" href="#_68" title="Permanent link">&para;</a></h3>
<p>キューワーカーは長時間実行されるプロセスであるため、コードの変更を再起動しない限り認識しません。したがって、キューワーカーを使用してアプリケーションをデプロイする最も簡単な方法は、デプロイプロセス中にワーカーを再起動することです。<code>queue:restart</code>コマンドを発行することで、すべてのワーカーを正常に再起動できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:restart
</code></pre></div>
<p>このコマンドは、現在処理中のジョブが完了した後にすべてのキューワーカーに正常に終了するよう指示するため、既存のジョブが失われることはありません。<code>queue:restart</code>コマンドが実行されるとキューワーカーは終了するため、<a href="#supervisor-configuration">Supervisor</a>などのプロセスマネージャを実行して、キューワーカーを自動的に再起動する必要があります。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>キューは<a href="cache.html">キャッシュ</a>を使用して再起動信号を保存するため、この機能を使用する前に、アプリケーションに対してキャッシュドライバが適切に設定されていることを確認する必要があります。</p>
</div>
<p><a name="job-expirations-and-timeouts"></a></p>
<h3 id="_69">ジョブの有効期限とタイムアウト<a class="headerlink" href="#_69" title="Permanent link">&para;</a></h3>
<p><a name="job-expiration"></a></p>
<h4 id="_70">ジョブの有効期限<a class="headerlink" href="#_70" title="Permanent link">&para;</a></h4>
<p><code>config/queue.php</code>設定ファイルでは、各キュー接続は<code>retry_after</code>オプションを定義します。このオプションは、キュー接続が処理中のジョブを再試行するまで待機する秒数を指定します。たとえば、<code>retry_after</code>の値が<code>90</code>に設定されている場合、ジョブは90秒間処理されていても解放または削除されない場合、キューに戻されます。通常、<code>retry_after</code>の値は、ジョブが合理的に完了するまでにかかる最大秒数に設定する必要があります。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>retry_after</code>値を含まない唯一のキュー接続はAmazon SQSです。SQSは、AWSコンソール内で管理される<a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/AboutVT.html">デフォルトの可視性タイムアウト</a>に基づいてジョブを再試行します。</p>
</div>
<p><a name="worker-timeouts"></a></p>
<h4 id="_71">ワーカーのタイムアウト<a class="headerlink" href="#_71" title="Permanent link">&para;</a></h4>
<p><code>queue:work</code> Artisanコマンドは、<code>--timeout</code>オプションを公開します。デフォルトでは、<code>--timeout</code>の値は60秒です。ジョブがタイムアウト値で指定された秒数より長く処理されている場合、ジョブを処理しているワーカーはエラーで終了します。通常、ワーカーはサーバー上で設定された<a href="#supervisor-configuration">プロセスマネージャ</a>によって自動的に再起動されます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>--timeout<span class="o">=</span><span class="m">60</span>
</code></pre></div>
<p><code>retry_after</code>設定オプションと<code>--timeout</code> CLIオプションは異なりますが、ジョブが失われず、ジョブが1回だけ正常に処理されるように連携して動作します。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>--timeout</code>値は、常に<code>retry_after</code>設定値より少なくとも数秒短くする必要があります。これにより、凍結したジョブを処理しているワーカーが、ジョブが再試行される前に常に終了するようになります。<code>--timeout</code>オプションが<code>retry_after</code>設定値より長い場合、ジョブが2回処理される可能性があります。</p>
</div>
<p><a name="supervisor-configuration"></a></p>
<h2 id="supervisor">Supervisorの設定<a class="headerlink" href="#supervisor" title="Permanent link">&para;</a></h2>
<p>本番環境では、<code>queue:work</code>プロセスを実行し続ける方法が必要です。<code>queue:work</code>プロセスは、ワーカータイムアウトを超えたり、<code>queue:restart</code>コマンドが実行されたりなど、さまざまな理由で停止する可能性があります。</p>
<p>このため、<code>queue:work</code>プロセスが終了したときにそれらを自動的に再起動できるプロセスモニタを設定する必要があります。さらに、プロセスモニタは、同時に実行したい<code>queue:work</code>プロセスの数を指定できます。Supervisorは、Linux環境で一般的に使用されるプロセスモニタであり、次のドキュメントでその設定方法について説明します。</p>
<p><a name="installing-supervisor"></a></p>
<h4 id="supervisor_1">Supervisorのインストール<a class="headerlink" href="#supervisor_1" title="Permanent link">&para;</a></h4>
<p>SupervisorはLinuxオペレーティングシステムのプロセスモニタであり、<code>queue:work</code>プロセスが失敗した場合に自動的に再起動します。UbuntuにSupervisorをインストールするには、次のコマンドを使用できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>supervisor
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Supervisorの設定と管理が難しいと感じる場合は、<a href="https://forge.laravel.com">Laravel Forge</a>の使用を検討してください。これにより、本番環境のLaravelプロジェクトに対して自動的にSupervisorがインストールおよび設定されます。</p>
</div>
<p><a name="configuring-supervisor"></a></p>
<h4 id="supervisor_2">Supervisorの設定<a class="headerlink" href="#supervisor_2" title="Permanent link">&para;</a></h4>
<p>Supervisorの設定ファイルは通常、<code>/etc/supervisor/conf.d</code>ディレクトリに保存されます。このディレクトリ内で、Supervisorにプロセスの監視方法を指示する設定ファイルをいくつでも作成できます。たとえば、<code>queue:work</code>プロセスを開始および監視する<code>laravel-worker.conf</code>ファイルを作成しましょう:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="k">[program:laravel-worker]</span>
<a id="__codelineno-94-2" name="__codelineno-94-2" href="#__codelineno-94-2"></a><span class="na">process_name</span><span class="o">=</span><span class="s">%(program_name)s_%(process_num)02d</span>
<a id="__codelineno-94-3" name="__codelineno-94-3" href="#__codelineno-94-3"></a><span class="na">command</span><span class="o">=</span><span class="s">php /home/forge/app.com/artisan queue:work sqs --sleep=3 --tries=3 --max-time=3600</span>
<a id="__codelineno-94-4" name="__codelineno-94-4" href="#__codelineno-94-4"></a><span class="na">autostart</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-94-5" name="__codelineno-94-5" href="#__codelineno-94-5"></a><span class="na">autorestart</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-94-6" name="__codelineno-94-6" href="#__codelineno-94-6"></a><span class="na">stopasgroup</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-94-7" name="__codelineno-94-7" href="#__codelineno-94-7"></a><span class="na">killasgroup</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-94-8" name="__codelineno-94-8" href="#__codelineno-94-8"></a><span class="na">user</span><span class="o">=</span><span class="s">forge</span>
<a id="__codelineno-94-9" name="__codelineno-94-9" href="#__codelineno-94-9"></a><span class="na">numprocs</span><span class="o">=</span><span class="s">8</span>
<a id="__codelineno-94-10" name="__codelineno-94-10" href="#__codelineno-94-10"></a><span class="na">redirect_stderr</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-94-11" name="__codelineno-94-11" href="#__codelineno-94-11"></a><span class="na">stdout_logfile</span><span class="o">=</span><span class="s">/home/forge/app.com/worker.log</span>
<a id="__codelineno-94-12" name="__codelineno-94-12" href="#__codelineno-94-12"></a><span class="na">stopwaitsecs</span><span class="o">=</span><span class="s">3600</span>
</code></pre></div>
<p>この例では、<code>numprocs</code>ディレクティブはSupervisorに8つの<code>queue:work</code>プロセスを実行し、すべてを監視し、失敗した場合に自動的に再起動するよう指示します。設定の<code>command</code>ディレクティブを、希望するキュー接続とワーカーオプションを反映するように変更する必要があります。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>stopwaitsecs</code>の値が、最も長い実行中のジョブが消費する秒数より大きいことを確認する必要があります。そうでない場合、Supervisorはジョブが処理を完了する前にジョブを強制終了する可能性があります。</p>
</div>
<p><a name="starting-supervisor"></a></p>
<h4 id="supervisor_3">Supervisorの起動<a class="headerlink" href="#supervisor_3" title="Permanent link">&para;</a></h4>
<p>設定ファイルが作成されたら、次のコマンドを使用してSupervisorの設定を更新し、プロセスを開始できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>sudo<span class="w"> </span>supervisorctl<span class="w"> </span>reread
<a id="__codelineno-95-2" name="__codelineno-95-2" href="#__codelineno-95-2"></a>
<a id="__codelineno-95-3" name="__codelineno-95-3" href="#__codelineno-95-3"></a>sudo<span class="w"> </span>supervisorctl<span class="w"> </span>update
<a id="__codelineno-95-4" name="__codelineno-95-4" href="#__codelineno-95-4"></a>
<a id="__codelineno-95-5" name="__codelineno-95-5" href="#__codelineno-95-5"></a>sudo<span class="w"> </span>supervisorctl<span class="w"> </span>start<span class="w"> </span><span class="s2">&quot;laravel-worker:*&quot;</span>
</code></pre></div>
<p>Supervisorの詳細については、<a href="http://supervisord.org/index.html">Supervisorのドキュメント</a>を参照してください。</p>
<p><a name="dealing-with-failed-jobs"></a></p>
<h2 id="_72">失敗したジョブの処理<a class="headerlink" href="#_72" title="Permanent link">&para;</a></h2>
<p>時には、キューに入れられたジョブが失敗することがあります。心配しないでください。物事は常に計画通りに進むわけではありません！Laravelには、ジョブを再試行する最大回数を<a href="#max-job-attempts-and-timeout">指定する便利な方法</a>が含まれています。非同期ジョブがこの試行回数を超えると、<code>failed_jobs</code>データベーステーブルに挿入されます。<a href="queues.html#synchronous-dispatching">同期ディスパッチされたジョブ</a>は失敗してもこのテーブルに保存されず、例外はアプリケーションによって即座に処理されます。</p>
<p><code>failed_jobs</code>テーブルを作成するためのマイグレーションは、通常、新しいLaravelアプリケーションに既に存在します。ただし、アプリケーションにこのテーブルのマイグレーションが含まれていない場合は、<code>make:queue-failed-table</code>コマンドを使用してマイグレーションを作成できます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>make:queue-failed-table
<a id="__codelineno-96-2" name="__codelineno-96-2" href="#__codelineno-96-2"></a>
<a id="__codelineno-96-3" name="__codelineno-96-3" href="#__codelineno-96-3"></a>php<span class="w"> </span>artisan<span class="w"> </span>migrate
</code></pre></div>
<p><a href="#running-the-queue-worker">キューワーカー</a>プロセスを実行するとき、<code>queue:work</code>コマンドの<code>--tries</code>スイッチを使用して、ジョブを再試行する最大回数を指定できます。<code>--tries</code>オプションの値を指定しない場合、ジョブは1回だけ試行されるか、ジョブクラスの<code>$tries</code>プロパティで指定された回数だけ試行されます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>redis<span class="w"> </span>--tries<span class="o">=</span><span class="m">3</span>
</code></pre></div>
<p><code>--backoff</code>オプションを使用すると、例外が発生したジョブを再試行する前にLaravelが待機する秒数を指定できます。デフォルトでは、ジョブは即座にキューに戻されて再試行されます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:work<span class="w"> </span>redis<span class="w"> </span>--tries<span class="o">=</span><span class="m">3</span><span class="w"> </span>--backoff<span class="o">=</span><span class="m">3</span>
</code></pre></div>
<p>例外が発生したジョブを再試行する前にLaravelが待機する秒数をジョブごとに設定したい場合は、ジョブクラスに<code>backoff</code>プロパティを定義することでそれを行うことができます:</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd"> * ジョブを再試行する前に待機する秒数。</span>
<span class="sd"> *</span>
<span class="sd"> * @var int</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="nv">$backoff</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</code></pre></div>
<p>ジョブのバックオフ時間を決定するためのより複雑なロジックが必要な場合は、ジョブクラスに<code>backoff</code>メソッドを定義できます:</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd">* ジョブを再試行する前に待機する秒数を計算します。</span>
<span class="sd">*/</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">backoff</span><span class="p">()</span><span class="o">:</span> <span class="nx">int</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><code>backoff</code>メソッドからバックオフ値の配列を返すことで、「指数関数的」なバックオフを簡単に設定できます。この例では、最初の再試行の遅延は1秒、2回目の再試行の遅延は5秒、3回目の再試行の遅延は10秒、それ以降の再試行の遅延は10秒になります（もっと試行回数が残っている場合）:</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd">* ジョブを再試行する前に待機する秒数を計算します。</span>
<span class="sd">*</span>
<span class="sd">* @return array&lt;int, int&gt;</span>
<span class="sd">*/</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">backoff</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div>
<p><a name="cleaning-up-after-failed-jobs"></a></p>
<h3 id="_73">失敗したジョブの後処理<a class="headerlink" href="#_73" title="Permanent link">&para;</a></h3>
<p>特定のジョブが失敗した場合、ユーザーにアラートを送信したり、ジョブによって部分的に完了したアクションを元に戻したりすることができます。これを実現するには、ジョブクラスに<code>failed</code>メソッドを定義できます。ジョブが失敗した原因となった<code>Throwable</code>インスタンスは、<code>failed</code>メソッドに渡されます:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Jobs</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Models\Podcast</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Services\AudioProcessor</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Contracts\Queue\ShouldQueue</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Foundation\Queue\Queueable</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Throwable</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ProcessPodcast</span> <span class="k">implements</span> <span class="nx">ShouldQueue</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">Queueable</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * 新しいジョブインスタンスを作成します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span>
        <span class="k">public</span> <span class="nx">Podcast</span> <span class="nv">$podcast</span><span class="p">,</span>
    <span class="p">)</span> <span class="p">{}</span>

    <span class="sd">/**</span>
<span class="sd">     * ジョブを実行します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nx">AudioProcessor</span> <span class="nv">$processor</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="c1">// アップロードされたポッドキャストを処理します...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * ジョブが失敗したときに処理します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">failed</span><span class="p">(</span><span class="nx">Throwable</span> <span class="nv">$exception</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="c1">// 失敗したジョブの後処理を行います...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="sd">/**</span>
<a id="__codelineno-99-2" name="__codelineno-99-2" href="#__codelineno-99-2"></a><span class="sd"> * ジョブの失敗を処理する。</span>
<a id="__codelineno-99-3" name="__codelineno-99-3" href="#__codelineno-99-3"></a><span class="sd"> */</span>
<a id="__codelineno-99-4" name="__codelineno-99-4" href="#__codelineno-99-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">failed</span><span class="p">(</span><span class="o">?</span><span class="nx">Throwable</span> <span class="nv">$exception</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-99-5" name="__codelineno-99-5" href="#__codelineno-99-5"></a><span class="p">{</span>
<a id="__codelineno-99-6" name="__codelineno-99-6" href="#__codelineno-99-6"></a>    <span class="c1">// 失敗に関するユーザー通知など...</span>
<a id="__codelineno-99-7" name="__codelineno-99-7" href="#__codelineno-99-7"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code>failed</code> メソッドが呼び出される前にジョブの新しいインスタンスがインスタンス化されます。したがって、<code>handle</code> メソッド内で発生した可能性のあるクラスプロパティの変更は失われます。</p>
</div>
<p><a name="retrying-failed-jobs"></a></p>
<h3 id="_74">失敗したジョブの再試行<a class="headerlink" href="#_74" title="Permanent link">&para;</a></h3>
<p><code>failed_jobs</code> データベーステーブルに挿入されたすべての失敗したジョブを表示するには、<code>queue:failed</code> Artisan コマンドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:failed
</code></pre></div>
<p><code>queue:failed</code> コマンドは、ジョブ ID、接続、キュー、失敗時間、およびその他のジョブに関する情報を一覧表示します。ジョブ ID を使用して、失敗したジョブを再試行できます。たとえば、<code>ce7bb17c-cdd8-41f0-a8ec-7b4fef4e5ece</code> という ID を持つ失敗したジョブを再試行するには、次のコマンドを発行します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:retry<span class="w"> </span>ce7bb17c-cdd8-41f0-a8ec-7b4fef4e5ece
</code></pre></div>
<p>必要に応じて、コマンドに複数の ID を渡すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:retry<span class="w"> </span>ce7bb17c-cdd8-41f0-a8ec-7b4fef4e5ece<span class="w"> </span>91401d2c-0784-4f43-824c-34f94a33c24d
</code></pre></div>
<p>特定のキューのすべての失敗したジョブを再試行することもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:retry<span class="w"> </span>--queue<span class="o">=</span>name
</code></pre></div>
<p>すべての失敗したジョブを再試行するには、<code>queue:retry</code> コマンドを実行し、ID として <code>all</code> を渡します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:retry<span class="w"> </span>all
</code></pre></div>
<p>失敗したジョブを削除したい場合は、<code>queue:forget</code> コマンドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:forget<span class="w"> </span>91401d2c-0784-4f43-824c-34f94a33c24d
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a href="horizon.html">Horizon</a> を使用している場合、失敗したジョブを削除するには <code>queue:forget</code> コマンドの代わりに <code>horizon:forget</code> コマンドを使用する必要があります。</p>
</div>
<p><code>failed_jobs</code> テーブルからすべての失敗したジョブを削除するには、<code>queue:flush</code> コマンドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:flush
</code></pre></div>
<p><a name="ignoring-missing-models"></a></p>
<h3 id="_75">存在しないモデルの無視<a class="headerlink" href="#_75" title="Permanent link">&para;</a></h3>
<p>ジョブに Eloquent モデルを注入すると、モデルはキューに入れられる前に自動的にシリアライズされ、ジョブが処理されるときにデータベースから再取得されます。ただし、ジョブがワーカーによって処理されるのを待っている間にモデルが削除された場合、ジョブは <code>ModelNotFoundException</code> で失敗する可能性があります。</p>
<p>便宜上、存在しないモデルを持つジョブを自動的に削除するように選択できます。これを行うには、ジョブの <code>deleteWhenMissingModels</code> プロパティを <code>true</code> に設定します。このプロパティが <code>true</code> に設定されている場合、Laravel は例外を発生させることなくジョブを静かに破棄します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="sd">/**</span>
<a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a><span class="sd"> * モデルが存在しない場合にジョブを削除します。</span>
<a id="__codelineno-107-3" name="__codelineno-107-3" href="#__codelineno-107-3"></a><span class="sd"> *</span>
<a id="__codelineno-107-4" name="__codelineno-107-4" href="#__codelineno-107-4"></a><span class="sd"> * @var bool</span>
<a id="__codelineno-107-5" name="__codelineno-107-5" href="#__codelineno-107-5"></a><span class="sd"> */</span>
<a id="__codelineno-107-6" name="__codelineno-107-6" href="#__codelineno-107-6"></a><span class="k">public</span> <span class="nv">$deleteWhenMissingModels</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</code></pre></div>
<p><a name="pruning-failed-jobs"></a></p>
<h3 id="_76">失敗したジョブの整理<a class="headerlink" href="#_76" title="Permanent link">&para;</a></h3>
<p>アプリケーションの <code>failed_jobs</code> テーブル内のレコードを整理するには、<code>queue:prune-failed</code> Artisan コマンドを呼び出すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:prune-failed
</code></pre></div>
<p>デフォルトでは、24 時間以上前のすべての失敗したジョブレコードが整理されます。コマンドに <code>--hours</code> オプションを指定すると、最後の N 時間以内に挿入された失敗したジョブレコードのみが保持されます。たとえば、次のコマンドは 48 時間以上前に挿入されたすべての失敗したジョブレコードを削除します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:prune-failed<span class="w"> </span>--hours<span class="o">=</span><span class="m">48</span>
</code></pre></div>
<p><a name="storing-failed-jobs-in-dynamodb"></a></p>
<h3 id="dynamodb_4">失敗したジョブを DynamoDB に保存する<a class="headerlink" href="#dynamodb_4" title="Permanent link">&para;</a></h3>
<p>Laravel は、失敗したジョブレコードをリレーショナルデータベーステーブルの代わりに <a href="https://aws.amazon.com/dynamodb">DynamoDB</a> に保存するためのサポートも提供しています。ただし、失敗したジョブレコードをすべて保存するための DynamoDB テーブルを手動で作成する必要があります。通常、このテーブルは <code>failed_jobs</code> という名前になりますが、アプリケーションの <code>queue</code> 設定ファイル内の <code>queue.failed.table</code> 設定値に基づいてテーブルに名前を付ける必要があります。</p>
<p><code>failed_jobs</code> テーブルには、<code>application</code> という名前の文字列の主パーティションキーと、<code>uuid</code> という名前の文字列の主ソートキーが必要です。<code>application</code> 部分のキーには、アプリケーションの <code>app</code> 設定ファイル内の <code>name</code> 設定値で定義されたアプリケーション名が含まれます。アプリケーション名は DynamoDB テーブルのキーの一部であるため、同じテーブルを使用して複数の Laravel アプリケーションの失敗したジョブを保存できます。</p>
<p>さらに、Laravel アプリケーションが Amazon DynamoDB と通信できるように、AWS SDK をインストールしてください。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a>composer<span class="w"> </span>require<span class="w"> </span>aws/aws-sdk-php
</code></pre></div>
<p>次に、<code>queue.failed.driver</code> 設定オプションの値を <code>dynamodb</code> に設定します。さらに、失敗したジョブ設定配列内に <code>key</code>、<code>secret</code>、および <code>region</code> 設定オプションを定義する必要があります。これらのオプションは AWS との認証に使用されます。<code>dynamodb</code> ドライバを使用する場合、<code>queue.failed.database</code> 設定オプションは不要です。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="s1">&#39;failed&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
<a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a>    <span class="s1">&#39;driver&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;QUEUE_FAILED_DRIVER&#39;</span><span class="p">,</span> <span class="s1">&#39;dynamodb&#39;</span><span class="p">),</span>
<a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a>    <span class="s1">&#39;key&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;AWS_ACCESS_KEY_ID&#39;</span><span class="p">),</span>
<a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a>    <span class="s1">&#39;secret&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;AWS_SECRET_ACCESS_KEY&#39;</span><span class="p">),</span>
<a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a>    <span class="s1">&#39;region&#39;</span> <span class="o">=&gt;</span> <span class="nx">env</span><span class="p">(</span><span class="s1">&#39;AWS_DEFAULT_REGION&#39;</span><span class="p">,</span> <span class="s1">&#39;us-east-1&#39;</span><span class="p">),</span>
<a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a>    <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;failed_jobs&#39;</span><span class="p">,</span>
<a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a><span class="p">],</span>
</code></pre></div>
<p><a name="disabling-failed-job-storage"></a></p>
<h3 id="_77">失敗したジョブの保存を無効にする<a class="headerlink" href="#_77" title="Permanent link">&para;</a></h3>
<p>失敗したジョブを保存せずに破棄するように Laravel に指示するには、<code>queue.failed.driver</code> 設定オプションの値を <code>null</code> に設定します。通常、これは <code>QUEUE_FAILED_DRIVER</code> 環境変数を介して行うことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="na">QUEUE_FAILED_DRIVER</span><span class="o">=</span><span class="s">null</span>
</code></pre></div>
<p><a name="failed-job-events"></a></p>
<h3 id="_78">失敗したジョブのイベント<a class="headerlink" href="#_78" title="Permanent link">&para;</a></h3>
<p>ジョブが失敗したときに呼び出されるイベントリスナーを登録したい場合は、<code>Queue</code> ファサードの <code>failing</code> メソッドを使用できます。たとえば、Laravel に含まれる <code>AppServiceProvider</code> の <code>boot</code> メソッドからこのイベントにクロージャをアタッチすることができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-113-2" name="__codelineno-113-2" href="#__codelineno-113-2"></a>
<a id="__codelineno-113-3" name="__codelineno-113-3" href="#__codelineno-113-3"></a><span class="k">namespace</span> <span class="nx">App\Providers</span><span class="p">;</span>
<a id="__codelineno-113-4" name="__codelineno-113-4" href="#__codelineno-113-4"></a>
<a id="__codelineno-113-5" name="__codelineno-113-5" href="#__codelineno-113-5"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Queue</span><span class="p">;</span>
<a id="__codelineno-113-6" name="__codelineno-113-6" href="#__codelineno-113-6"></a><span class="k">use</span> <span class="nx">Illuminate\Support\ServiceProvider</span><span class="p">;</span>
<a id="__codelineno-113-7" name="__codelineno-113-7" href="#__codelineno-113-7"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Events\JobFailed</span><span class="p">;</span>
<a id="__codelineno-113-8" name="__codelineno-113-8" href="#__codelineno-113-8"></a>
<a id="__codelineno-113-9" name="__codelineno-113-9" href="#__codelineno-113-9"></a><span class="k">class</span> <span class="nc">AppServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<a id="__codelineno-113-10" name="__codelineno-113-10" href="#__codelineno-113-10"></a><span class="p">{</span>
<a id="__codelineno-113-11" name="__codelineno-113-11" href="#__codelineno-113-11"></a>    <span class="sd">/**</span>
<a id="__codelineno-113-12" name="__codelineno-113-12" href="#__codelineno-113-12"></a><span class="sd">     * 任意のアプリケーションサービスを登録します。</span>
<a id="__codelineno-113-13" name="__codelineno-113-13" href="#__codelineno-113-13"></a><span class="sd">     */</span>
<a id="__codelineno-113-14" name="__codelineno-113-14" href="#__codelineno-113-14"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-113-15" name="__codelineno-113-15" href="#__codelineno-113-15"></a>    <span class="p">{</span>
<a id="__codelineno-113-16" name="__codelineno-113-16" href="#__codelineno-113-16"></a>        <span class="c1">// ...</span>
<a id="__codelineno-113-17" name="__codelineno-113-17" href="#__codelineno-113-17"></a>    <span class="p">}</span>
<a id="__codelineno-113-18" name="__codelineno-113-18" href="#__codelineno-113-18"></a>
<a id="__codelineno-113-19" name="__codelineno-113-19" href="#__codelineno-113-19"></a>    <span class="sd">/**</span>
<a id="__codelineno-113-20" name="__codelineno-113-20" href="#__codelineno-113-20"></a><span class="sd">     * 任意のアプリケーションサービスを起動します。</span>
<a id="__codelineno-113-21" name="__codelineno-113-21" href="#__codelineno-113-21"></a><span class="sd">     */</span>
<a id="__codelineno-113-22" name="__codelineno-113-22" href="#__codelineno-113-22"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-113-23" name="__codelineno-113-23" href="#__codelineno-113-23"></a>    <span class="p">{</span>
<a id="__codelineno-113-24" name="__codelineno-113-24" href="#__codelineno-113-24"></a>        <span class="nx">Queue</span><span class="o">::</span><span class="na">failing</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">JobFailed</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-113-25" name="__codelineno-113-25" href="#__codelineno-113-25"></a>            <span class="c1">// $event-&gt;connectionName</span>
<a id="__codelineno-113-26" name="__codelineno-113-26" href="#__codelineno-113-26"></a>            <span class="c1">// $event-&gt;job</span>
<a id="__codelineno-113-27" name="__codelineno-113-27" href="#__codelineno-113-27"></a>            <span class="c1">// $event-&gt;exception</span>
<a id="__codelineno-113-28" name="__codelineno-113-28" href="#__codelineno-113-28"></a>        <span class="p">});</span>
<a id="__codelineno-113-29" name="__codelineno-113-29" href="#__codelineno-113-29"></a>    <span class="p">}</span>
<a id="__codelineno-113-30" name="__codelineno-113-30" href="#__codelineno-113-30"></a><span class="p">}</span>
</code></pre></div>
<p><a name="clearing-jobs-from-queues"></a></p>
<h2 id="_79">キューからジョブをクリアする<a class="headerlink" href="#_79" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a href="horizon.html">Horizon</a> を使用している場合、キューからジョブをクリアするには <code>queue:clear</code> コマンドの代わりに <code>horizon:clear</code> コマンドを使用する必要があります。</p>
</div>
<p>デフォルトの接続のデフォルトのキューからすべてのジョブを削除したい場合は、<code>queue:clear</code> Artisan コマンドを使用して行うことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:clear
</code></pre></div>
<p>特定の接続とキューからジョブを削除するには、<code>connection</code> 引数と <code>queue</code> オプションを指定することもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:clear<span class="w"> </span>redis<span class="w"> </span>--queue<span class="o">=</span>emails
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>キューからジョブをクリアする機能は、SQS、Redis、およびデータベースキュードライバでのみ利用可能です。さらに、SQS メッセージの削除プロセスには最大 60 秒かかるため、キューをクリアしてから 60 秒以内に SQS キューに送信されたジョブも削除される可能性があります。</p>
</div>
<p><a name="monitoring-your-queues"></a></p>
<h2 id="_80">キューの監視<a class="headerlink" href="#_80" title="Permanent link">&para;</a></h2>
<p>ジョブの急増を受け取ると、キューが圧倒され、ジョブの完了までの待ち時間が長くなる可能性があります。必要に応じて、キューのジョブ数が指定したしきい値を超えたときに Laravel が通知するように設定できます。</p>
<p>まず、<code>queue:monitor</code> コマンドを <a href="scheduling.html">毎分実行するようにスケジュール</a> する必要があります。このコマンドは、監視したいキューの名前と、希望するジョブ数のしきい値を受け取ります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a>php<span class="w"> </span>artisan<span class="w"> </span>queue:monitor<span class="w"> </span>redis:default,redis:deployments<span class="w"> </span>--max<span class="o">=</span><span class="m">100</span>
</code></pre></div>
<p>このコマンドをスケジュールするだけでは、キューが圧倒された状態を通知するアラートはトリガーされません。コマンドがしきい値を超えたジョブ数のキューを検出すると、<code>Illuminate\Queue\Events\QueueBusy</code> イベントがディスパッチされます。アプリケーションの <code>AppServiceProvider</code> 内でこのイベントをリッスンして、通知を開発チームに送信することができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="k">use</span> <span class="nx">App\Notifications\QueueHasLongWaitTime</span><span class="p">;</span>
<a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="k">use</span> <span class="nx">Illuminate\Queue\Events\QueueBusy</span><span class="p">;</span>
<a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Event</span><span class="p">;</span>
<a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Notification</span><span class="p">;</span>
<a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a>
<a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a><span class="sd">/**</span>
<a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a><span class="sd"> * 任意のアプリケーションサービスを起動します。</span>
<a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a><span class="sd"> */</span>
<a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-117-10" name="__codelineno-117-10" href="#__codelineno-117-10"></a><span class="p">{</span>
<a id="__codelineno-117-11" name="__codelineno-117-11" href="#__codelineno-117-11"></a>    <span class="nx">Event</span><span class="o">::</span><span class="na">listen</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">QueueBusy</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-117-12" name="__codelineno-117-12" href="#__codelineno-117-12"></a>        <span class="nx">Notification</span><span class="o">::</span><span class="na">route</span><span class="p">(</span><span class="s1">&#39;mail&#39;</span><span class="p">,</span> <span class="s1">&#39;dev@example.com&#39;</span><span class="p">)</span>
<a id="__codelineno-117-13" name="__codelineno-117-13" href="#__codelineno-117-13"></a>                <span class="o">-&gt;</span><span class="na">notify</span><span class="p">(</span><span class="k">new</span> <span class="nx">QueueHasLongWaitTime</span><span class="p">(</span>
<a id="__codelineno-117-14" name="__codelineno-117-14" href="#__codelineno-117-14"></a>                    <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">connection</span><span class="p">,</span>
<a id="__codelineno-117-15" name="__codelineno-117-15" href="#__codelineno-117-15"></a>                    <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">queue</span><span class="p">,</span>
<a id="__codelineno-117-16" name="__codelineno-117-16" href="#__codelineno-117-16"></a>                    <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">size</span>
<a id="__codelineno-117-17" name="__codelineno-117-17" href="#__codelineno-117-17"></a>                <span class="p">));</span>
<a id="__codelineno-117-18" name="__codelineno-117-18" href="#__codelineno-117-18"></a>    <span class="p">});</span>
<a id="__codelineno-117-19" name="__codelineno-117-19" href="#__codelineno-117-19"></a><span class="p">}</span>
</code></pre></div>
<p><a name="testing"></a></p>
<h2 id="_81">テスト<a class="headerlink" href="#_81" title="Permanent link">&para;</a></h2>
<p>ジョブをディスパッチするコードをテストする際に、Laravel にジョブ自体を実行させたくない場合があります。ジョブのコードは、ディスパッチするコードとは別に直接テストできるからです。もちろん、ジョブ自体をテストするには、ジョブインスタンスを作成し、テスト内で <code>handle</code> メソッドを直接呼び出すことができます。</p>
<p><code>Queue</code> ファサードの <code>fake</code> メソッドを使用して、キューにジョブが実際にプッシュされないようにすることができます。<code>Queue</code> ファサードの <code>fake</code> メソッドを呼び出した後、アプリケーションがジョブをキューにプッシュしようとしたことをアサートできます。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:1"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Pest</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a>
<a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a><span class="k">use</span> <span class="nx">App\Jobs\AnotherJob</span><span class="p">;</span>
<a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a><span class="k">use</span> <span class="nx">App\Jobs\FinalJob</span><span class="p">;</span>
<a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a><span class="k">use</span> <span class="nx">App\Jobs\ShipOrder</span><span class="p">;</span>
<a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Queue</span><span class="p">;</span>
<a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a>
<a id="__codelineno-118-8" name="__codelineno-118-8" href="#__codelineno-118-8"></a><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;orders can be shipped&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-118-9" name="__codelineno-118-9" href="#__codelineno-118-9"></a>    <span class="nx">Queue</span><span class="o">::</span><span class="na">fake</span><span class="p">();</span>
<a id="__codelineno-118-10" name="__codelineno-118-10" href="#__codelineno-118-10"></a>
<a id="__codelineno-118-11" name="__codelineno-118-11" href="#__codelineno-118-11"></a>    <span class="c1">// 注文の出荷を実行...</span>
<a id="__codelineno-118-12" name="__codelineno-118-12" href="#__codelineno-118-12"></a>
<a id="__codelineno-118-13" name="__codelineno-118-13" href="#__codelineno-118-13"></a>    <span class="c1">// ジョブがプッシュされなかったことをアサート...</span>
<a id="__codelineno-118-14" name="__codelineno-118-14" href="#__codelineno-118-14"></a>    <span class="nx">Queue</span><span class="o">::</span><span class="na">assertNothingPushed</span><span class="p">();</span>
<a id="__codelineno-118-15" name="__codelineno-118-15" href="#__codelineno-118-15"></a>
<a id="__codelineno-118-16" name="__codelineno-118-16" href="#__codelineno-118-16"></a>    <span class="c1">// 特定のキューにジョブがプッシュされたことをアサート...</span>
<a id="__codelineno-118-17" name="__codelineno-118-17" href="#__codelineno-118-17"></a>    <span class="nx">Queue</span><span class="o">::</span><span class="na">assertPushedOn</span><span class="p">(</span><span class="s1">&#39;queue-name&#39;</span><span class="p">,</span> <span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="c1">// ジョブが2回プッシュされたことをアサートする...</span>
<a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a><span class="nx">Queue</span><span class="o">::</span><span class="na">assertPushed</span><span class="p">(</span><span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a>
<a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a><span class="c1">// ジョブがプッシュされなかったことをアサートする...</span>
<a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a><span class="nx">Queue</span><span class="o">::</span><span class="na">assertNotPushed</span><span class="p">(</span><span class="nx">AnotherJob</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a>
<a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a><span class="c1">// クロージャがキューにプッシュされたことをアサートする...</span>
<a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a><span class="nx">Queue</span><span class="o">::</span><span class="na">assertClosurePushed</span><span class="p">();</span>
<a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a>
<a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a><span class="c1">// プッシュされたジョブの総数をアサートする...</span>
<a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a><span class="nx">Queue</span><span class="o">::</span><span class="na">assertCount</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-119-12" name="__codelineno-119-12" href="#__codelineno-119-12"></a><span class="p">});</span>
</code></pre></div>
<div class="tabbed-set tabbed-alternate" data-tabs="2:1"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">PHPUnit</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a>
<a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a><span class="k">namespace</span> <span class="nx">Tests\Feature</span><span class="p">;</span>
<a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a>
<a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a><span class="k">use</span> <span class="nx">App\Jobs\AnotherJob</span><span class="p">;</span>
<a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a><span class="k">use</span> <span class="nx">App\Jobs\FinalJob</span><span class="p">;</span>
<a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a><span class="k">use</span> <span class="nx">App\Jobs\ShipOrder</span><span class="p">;</span>
<a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Queue</span><span class="p">;</span>
<a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a><span class="k">use</span> <span class="nx">Tests\TestCase</span><span class="p">;</span>
<a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a>
<a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a><span class="k">class</span> <span class="nc">ExampleTest</span> <span class="k">extends</span> <span class="nx">TestCase</span>
<a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a><span class="p">{</span>
<a id="__codelineno-120-13" name="__codelineno-120-13" href="#__codelineno-120-13"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">test_orders_can_be_shipped</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-120-14" name="__codelineno-120-14" href="#__codelineno-120-14"></a>    <span class="p">{</span>
<a id="__codelineno-120-15" name="__codelineno-120-15" href="#__codelineno-120-15"></a>        <span class="nx">Queue</span><span class="o">::</span><span class="na">fake</span><span class="p">();</span>
<a id="__codelineno-120-16" name="__codelineno-120-16" href="#__codelineno-120-16"></a>
<a id="__codelineno-120-17" name="__codelineno-120-17" href="#__codelineno-120-17"></a>        <span class="c1">// 注文の出荷を実行...</span>
<a id="__codelineno-120-18" name="__codelineno-120-18" href="#__codelineno-120-18"></a>
<a id="__codelineno-120-19" name="__codelineno-120-19" href="#__codelineno-120-19"></a>        <span class="c1">// ジョブがプッシュされなかったことをアサートする...</span>
<a id="__codelineno-120-20" name="__codelineno-120-20" href="#__codelineno-120-20"></a>        <span class="nx">Queue</span><span class="o">::</span><span class="na">assertNothingPushed</span><span class="p">();</span>
<a id="__codelineno-120-21" name="__codelineno-120-21" href="#__codelineno-120-21"></a>
<a id="__codelineno-120-22" name="__codelineno-120-22" href="#__codelineno-120-22"></a>        <span class="c1">// 特定のキューにジョブがプッシュされたことをアサートする...</span>
<a id="__codelineno-120-23" name="__codelineno-120-23" href="#__codelineno-120-23"></a>        <span class="nx">Queue</span><span class="o">::</span><span class="na">assertPushedOn</span><span class="p">(</span><span class="s1">&#39;queue-name&#39;</span><span class="p">,</span> <span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-120-24" name="__codelineno-120-24" href="#__codelineno-120-24"></a>
<a id="__codelineno-120-25" name="__codelineno-120-25" href="#__codelineno-120-25"></a>        <span class="c1">// ジョブが2回プッシュされたことをアサートする...</span>
<a id="__codelineno-120-26" name="__codelineno-120-26" href="#__codelineno-120-26"></a>        <span class="nx">Queue</span><span class="o">::</span><span class="na">assertPushed</span><span class="p">(</span><span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-120-27" name="__codelineno-120-27" href="#__codelineno-120-27"></a>
<a id="__codelineno-120-28" name="__codelineno-120-28" href="#__codelineno-120-28"></a>        <span class="c1">// ジョブがプッシュされなかったことをアサートする...</span>
<a id="__codelineno-120-29" name="__codelineno-120-29" href="#__codelineno-120-29"></a>        <span class="nx">Queue</span><span class="o">::</span><span class="na">assertNotPushed</span><span class="p">(</span><span class="nx">AnotherJob</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-120-30" name="__codelineno-120-30" href="#__codelineno-120-30"></a>
<a id="__codelineno-120-31" name="__codelineno-120-31" href="#__codelineno-120-31"></a>        <span class="c1">// クロージャがキューにプッシュされたことをアサートする...</span>
<a id="__codelineno-120-32" name="__codelineno-120-32" href="#__codelineno-120-32"></a>        <span class="nx">Queue</span><span class="o">::</span><span class="na">assertClosurePushed</span><span class="p">();</span>
<a id="__codelineno-120-33" name="__codelineno-120-33" href="#__codelineno-120-33"></a>
<a id="__codelineno-120-34" name="__codelineno-120-34" href="#__codelineno-120-34"></a>        <span class="c1">// プッシュされたジョブの総数をアサートする...</span>
<a id="__codelineno-120-35" name="__codelineno-120-35" href="#__codelineno-120-35"></a>        <span class="nx">Queue</span><span class="o">::</span><span class="na">assertCount</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-120-36" name="__codelineno-120-36" href="#__codelineno-120-36"></a>    <span class="p">}</span>
<a id="__codelineno-120-37" name="__codelineno-120-37" href="#__codelineno-120-37"></a><span class="p">}</span>
</code></pre></div>
<p><code>assertPushed</code> または <code>assertNotPushed</code> メソッドにクロージャを渡して、特定の「真偽テスト」をパスするジョブがプッシュされたことをアサートすることができます。指定された真偽テストをパスするジョブが少なくとも1つプッシュされた場合、アサーションは成功します。</p>
<div class="highlight"><pre><span></span><code><span class="nx">Queue</span><span class="o">::</span><span class="na">assertPushed</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">ShipOrder</span> <span class="nv">$job</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$order</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">order</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">===</span> <span class="nv">$order</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div>
<p><a name="faking-a-subset-of-jobs"></a></p>
<h3 id="_82">ジョブのサブセットをフェイクする<a class="headerlink" href="#_82" title="Permanent link">&para;</a></h3>
<p>通常のジョブの実行を許可しながら、特定のジョブのみをフェイクする必要がある場合は、<code>fake</code> メソッドにフェイクするジョブのクラス名を渡すことができます。</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:1"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Pest</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="nx">test</span><span class="p">(</span><span class="s1">&#39;orders can be shipped&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
<a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a>    <span class="nx">Queue</span><span class="o">::</span><span class="na">fake</span><span class="p">([</span>
<a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a>        <span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
<a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a>    <span class="p">]);</span>
<a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a>
<a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a>    <span class="c1">// 注文の出荷を実行...</span>
<a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a>
<a id="__codelineno-121-8" name="__codelineno-121-8" href="#__codelineno-121-8"></a>    <span class="c1">// ジョブが2回プッシュされたことをアサートする...</span>
<a id="__codelineno-121-9" name="__codelineno-121-9" href="#__codelineno-121-9"></a>    <span class="nx">Queue</span><span class="o">::</span><span class="na">assertPushed</span><span class="p">(</span><span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-121-10" name="__codelineno-121-10" href="#__codelineno-121-10"></a><span class="p">});</span>
</code></pre></div>
<div class="tabbed-set tabbed-alternate" data-tabs="4:1"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">PHPUnit</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">test_orders_can_be_shipped</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a><span class="p">{</span>
<a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>    <span class="nx">Queue</span><span class="o">::</span><span class="na">fake</span><span class="p">([</span>
<a id="__codelineno-122-4" name="__codelineno-122-4" href="#__codelineno-122-4"></a>        <span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
<a id="__codelineno-122-5" name="__codelineno-122-5" href="#__codelineno-122-5"></a>    <span class="p">]);</span>
<a id="__codelineno-122-6" name="__codelineno-122-6" href="#__codelineno-122-6"></a>
<a id="__codelineno-122-7" name="__codelineno-122-7" href="#__codelineno-122-7"></a>    <span class="c1">// 注文の出荷を実行...</span>
<a id="__codelineno-122-8" name="__codelineno-122-8" href="#__codelineno-122-8"></a>
<a id="__codelineno-122-9" name="__codelineno-122-9" href="#__codelineno-122-9"></a>    <span class="c1">// ジョブが2回プッシュされたことをアサートする...</span>
<a id="__codelineno-122-10" name="__codelineno-122-10" href="#__codelineno-122-10"></a>    <span class="nx">Queue</span><span class="o">::</span><span class="na">assertPushed</span><span class="p">(</span><span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-122-11" name="__codelineno-122-11" href="#__codelineno-122-11"></a><span class="p">}</span>
</code></pre></div>
<p><code>except</code> メソッドを使用して、指定されたジョブを除くすべてのジョブをフェイクすることができます。</p>
<div class="highlight"><pre><span></span><code><span class="nx">Queue</span><span class="o">::</span><span class="na">fake</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">except</span><span class="p">([</span>
    <span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div>
<p><a name="testing-job-chains"></a></p>
<h3 id="_83">ジョブチェーンのテスト<a class="headerlink" href="#_83" title="Permanent link">&para;</a></h3>
<p>ジョブチェーンをテストするには、<code>Bus</code> ファサードのフェイク機能を利用する必要があります。<code>Bus</code> ファサードの <code>assertChained</code> メソッドを使用して、<a href="queues.html#job-chaining">ジョブチェーン</a>がディスパッチされたことをアサートすることができます。<code>assertChained</code> メソッドは、チェーンされたジョブの配列を最初の引数として受け取ります。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Jobs\RecordShipment</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Jobs\ShipOrder</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Jobs\UpdateInventory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Bus</span><span class="p">;</span>

<span class="nx">Bus</span><span class="o">::</span><span class="na">fake</span><span class="p">();</span>

<span class="c1">// ...</span>

<span class="nx">Bus</span><span class="o">::</span><span class="na">assertChained</span><span class="p">([</span>
    <span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="nx">RecordShipment</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="nx">UpdateInventory</span><span class="o">::</span><span class="na">class</span>
<span class="p">]);</span>
</code></pre></div>
<p>上記の例でわかるように、チェーンされたジョブの配列は、ジョブのクラス名の配列である場合があります。ただし、実際のジョブインスタンスの配列を提供することもできます。その場合、Laravel はジョブインスタンスが同じクラスであり、アプリケーションによってディスパッチされたチェーンされたジョブと同じプロパティ値を持っていることを確認します。</p>
<div class="highlight"><pre><span></span><code><span class="nx">Bus</span><span class="o">::</span><span class="na">assertChained</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">ShipOrder</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">RecordShipment</span><span class="p">,</span>
    <span class="k">new</span> <span class="nx">UpdateInventory</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div>
<p><code>assertDispatchedWithoutChain</code> メソッドを使用して、ジョブがチェーンなしでプッシュされたことをアサートすることができます。</p>
<div class="highlight"><pre><span></span><code><span class="nx">Bus</span><span class="o">::</span><span class="na">assertDispatchedWithoutChain</span><span class="p">(</span><span class="nx">ShipOrder</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
</code></pre></div>
<p><a name="testing-chain-modifications"></a></p>
<h4 id="_84">チェーンの変更のテスト<a class="headerlink" href="#_84" title="Permanent link">&para;</a></h4>
<p>チェーンされたジョブが<a href="#adding-jobs-to-the-chain">既存のチェーンにジョブを追加または削除</a>する場合、ジョブの <code>assertHasChain</code> メソッドを使用して、ジョブが期待される残りのチェーンを持っていることをアサートすることができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="nv">$job</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a>
<a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">();</span>
<a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a>
<a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">assertHasChain</span><span class="p">([</span>
<a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a>    <span class="k">new</span> <span class="nx">TranscribePodcast</span><span class="p">,</span>
<a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a>    <span class="k">new</span> <span class="nx">OptimizePodcast</span><span class="p">,</span>
<a id="__codelineno-123-8" name="__codelineno-123-8" href="#__codelineno-123-8"></a>    <span class="k">new</span> <span class="nx">ReleasePodcast</span><span class="p">,</span>
<a id="__codelineno-123-9" name="__codelineno-123-9" href="#__codelineno-123-9"></a><span class="p">]);</span>
</code></pre></div>
<p><code>assertDoesntHaveChain</code> メソッドを使用して、ジョブの残りのチェーンが空であることをアサートすることができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">assertDoesntHaveChain</span><span class="p">();</span>
</code></pre></div>
<p><a name="testing-chained-batches"></a></p>
<h4 id="_85">チェーンされたバッチのテスト<a class="headerlink" href="#_85" title="Permanent link">&para;</a></h4>
<p>ジョブチェーンに<a href="#chains-and-batches">バッチが含まれている</a>場合、チェーンされたバッチが期待どおりであることをアサートするために、チェーンアサーション内に <code>Bus::chainedBatch</code> 定義を挿入することができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Jobs\ShipOrder</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Jobs\UpdateInventory</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Bus\PendingBatch</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Bus</span><span class="p">;</span>

<span class="nx">Bus</span><span class="o">::</span><span class="na">assertChained</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">ShipOrder</span><span class="p">,</span>
    <span class="nx">Bus</span><span class="o">::</span><span class="na">chainedBatch</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">PendingBatch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">jobs</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}),</span>
    <span class="k">new</span> <span class="nx">UpdateInventory</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div>
<p><a name="testing-job-batches"></a></p>
<h3 id="_86">ジョブバッチのテスト<a class="headerlink" href="#_86" title="Permanent link">&para;</a></h3>
<p><code>Bus</code> ファサードの <code>assertBatched</code> メソッドを使用して、<a href="queues.html#job-batching">ジョブバッチ</a>がディスパッチされたことをアサートすることができます。<code>assertBatched</code> メソッドに渡されるクロージャは、バッチ内のジョブを検査するために使用できる <code>Illuminate\Bus\PendingBatch</code> のインスタンスを受け取ります。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Bus\PendingBatch</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Bus</span><span class="p">;</span>

<span class="nx">Bus</span><span class="o">::</span><span class="na">fake</span><span class="p">();</span>

<span class="c1">// ...</span>

<span class="nx">Bus</span><span class="o">::</span><span class="na">assertBatched</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">PendingBatch</span> <span class="nv">$batch</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">==</span> <span class="s1">&#39;import-csv&#39;</span> <span class="o">&amp;&amp;</span>
           <span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">jobs</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">()</span> <span class="o">===</span> <span class="mi">10</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div>
<p><code>assertBatchCount</code> メソッドを使用して、指定された数のバッチがディスパッチされたことをアサートすることができます。</p>
<div class="highlight"><pre><span></span><code><span class="nx">Bus</span><span class="o">::</span><span class="na">assertBatchCount</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</code></pre></div>
<p><code>assertNothingBatched</code> を使用して、バッチがディスパッチされなかったことをアサートすることができます。</p>
<div class="highlight"><pre><span></span><code><span class="nx">Bus</span><span class="o">::</span><span class="na">assertNothingBatched</span><span class="p">();</span>
</code></pre></div>
<p><a name="testing-job-batch-interaction"></a></p>
<h4 id="_87">ジョブ / バッチの相互作用のテスト<a class="headerlink" href="#_87" title="Permanent link">&para;</a></h4>
<p>さらに、個々のジョブがその基礎となるバッチとどのように相互作用するかをテストする必要がある場合があります。たとえば、ジョブがそのバッチのさらなる処理をキャンセルしたかどうかをテストする必要がある場合です。これを実現するには、<code>withFakeBatch</code> メソッドを介してジョブにフェイクバッチを割り当てる必要があります。<code>withFakeBatch</code> メソッドは、ジョブインスタンスとフェイクバッチを含むタプルを返します。</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="nv">$job</span><span class="p">,</span> <span class="nv">$batch</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">ShipOrder</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">withFakeBatch</span><span class="p">();</span>

<span class="nv">$job</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">();</span>

<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">cancelled</span><span class="p">());</span>
<span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertEmpty</span><span class="p">(</span><span class="nv">$batch</span><span class="o">-&gt;</span><span class="na">added</span><span class="p">);</span>
</code></pre></div>
<p><a name="testing-job-queue-interactions"></a></p>
<h3 id="_88">ジョブ / キューの相互作用のテスト<a class="headerlink" href="#_88" title="Permanent link">&para;</a></h3>
<p>キューに入れられたジョブが<a href="#manually-releasing-a-job">自分自身をキューに再リリースする</a>か、ジョブが自分自身を削除するかをテストする必要がある場合があります。これらのキューの相互作用をテストするには、ジョブをインスタンス化し、<code>withFakeQueueInteractions</code> メソッドを呼び出すことができます。</p>
<p>ジョブのキューの相互作用がフェイクされたら、ジョブの <code>handle</code> メソッドを呼び出すことができます。ジョブを呼び出した後、<code>assertReleased</code>、<code>assertDeleted</code>、<code>assertNotDeleted</code>、<code>assertFailed</code>、および <code>assertNotFailed</code> メソッドを使用して、ジョブのキューの相互作用に対してアサーションを行うことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="k">use</span> <span class="nx">App\Jobs\ProcessPodcast</span><span class="p">;</span>
<a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a>
<a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a><span class="nv">$job</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">ProcessPodcast</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">withFakeQueueInteractions</span><span class="p">();</span>
<a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a>
<a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">();</span>
<a id="__codelineno-125-6" name="__codelineno-125-6" href="#__codelineno-125-6"></a>
<a id="__codelineno-125-7" name="__codelineno-125-7" href="#__codelineno-125-7"></a><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">assertReleased</span><span class="p">(</span><span class="nx">delay</span><span class="o">:</span> <span class="mi">30</span><span class="p">);</span>
<a id="__codelineno-125-8" name="__codelineno-125-8" href="#__codelineno-125-8"></a><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">assertDeleted</span><span class="p">();</span>
<a id="__codelineno-125-9" name="__codelineno-125-9" href="#__codelineno-125-9"></a><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">assertNotDeleted</span><span class="p">();</span>
<a id="__codelineno-125-10" name="__codelineno-125-10" href="#__codelineno-125-10"></a><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">assertFailed</span><span class="p">();</span>
<a id="__codelineno-125-11" name="__codelineno-125-11" href="#__codelineno-125-11"></a><span class="nv">$job</span><span class="o">-&gt;</span><span class="na">assertNotFailed</span><span class="p">();</span>
</code></pre></div>
<p><a name="job-events"></a></p>
<h2 id="_89">ジョブイベント<a class="headerlink" href="#_89" title="Permanent link">&para;</a></h2>
<p><code>Queue</code> <a href="facades.html">ファサード</a>の <code>before</code> および <code>after</code> メソッドを使用して、キューに入れられたジョブが処理される前後に実行されるコールバックを指定できます。これらのコールバックは、追加のログを実行したり、ダッシュボードの統計を増やしたりするのに最適な機会です。通常、これらのメソッドは <a href="providers.html">サービスプロバイダ</a> の <code>boot</code> メソッドから呼び出す必要があります。たとえば、Laravel に含まれている <code>AppServiceProvider</code> を使用できます。</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Providers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Queue</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\ServiceProvider</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Queue\Events\JobProcessed</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Queue\Events\JobProcessing</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AppServiceProvider</span> <span class="k">extends</span> <span class="nx">ServiceProvider</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * アプリケーションのすべてのサービスを登録します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * アプリケーションのすべてのサービスを起動します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
    <span class="p">{</span>
        <span class="nx">Queue</span><span class="o">::</span><span class="na">before</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">JobProcessing</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// $event-&gt;connectionName</span>
            <span class="c1">// $event-&gt;job</span>
            <span class="c1">// $event-&gt;job-&gt;payload()</span>
        <span class="p">});</span>

        <span class="nx">Queue</span><span class="o">::</span><span class="na">after</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">JobProcessed</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// $event-&gt;connectionName</span>
            <span class="c1">// $event-&gt;job</span>
            <span class="c1">// $event-&gt;job-&gt;payload()</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>Queue</code> <a href="facades.html">ファサード</a>の <code>looping</code> メソッドを使用して、ワーカーがキューからジョブを取得しようとする前に実行されるコールバックを指定できます。たとえば、以前に失敗したジョブによって残された未解決のトランザクションをロールバックするクロージャを登録できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Support\Facades\DB</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Support\Facades\Queue</span><span class="p">;</span>

<span class="nx">Queue</span><span class="o">::</span><span class="na">looping</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nx">DB</span><span class="o">::</span><span class="na">transactionLevel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">DB</span><span class="o">::</span><span class="na">rollBack</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>









  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
<nav class="md-footer-nav">
    
    
</nav>

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["back-to-top", "navigation.expand", "navigation.tabs", "navigation.footer", "navigation.sections", "navigation.expand", "content.code.copy", "hide_repository_button", "content.code.annotate", "content.tabs.link", "toc.none", "content.action.edit"], "search": "assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  </body>
</html>