
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://github.com/koriym/laravel11-ja/eloquent-relationships.html">
      
      
        <link rel="prev" href="eloquent.html">
      
      
        <link rel="next" href="eloquent-collections.html">
      
      
      <link rel="icon" href="assets/images/favicon_io/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.35">
    
    
      
        <title>リレーションシップ - L11JA</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.35f28582.min.css">
      
      


    
    

    

    
      <link rel="stylesheet" href="assets/css/php.css">
    
      <link rel="stylesheet" href="assets/css/mkdocs_material_extra.css">
    
      <link rel="stylesheet" href="assets/css/extra.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-G60CEHXLQ1"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-G60CEHXLQ1",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-G60CEHXLQ1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    

  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#eloquent" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <!-- Determine classes -->



<!-- Header -->
<header class="md-header" data-md-component="header">
  <nav
          class="md-header__inner md-grid"
          aria-label="Header"
  >

    <!-- Link to home -->
    <a
            href="."
            title="L11JA"
            class="md-header__button md-logo"
            aria-label="L11JA"
            data-md-component="logo"
    >
      
  <img src="assets/images/logo.png" alt="logo">

    </a>

    <!-- Button to open drawer -->
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            <span style="font-family: 'Noto Sans'; font-size: 20px" >
            L11JA
            </span>
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            <span style="font-family: 'Noto Sans Batak'; font-size: 20px" >
            
              リレーションシップ
            
            </span>
          </span>
        </div>
      </div>
    </div>

    <!-- Color palette toggle -->
    

    <!-- User preference: color palette -->
    
    <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    

    <!-- Site language selector -->
    

    <!-- Button to open search modal -->
    
    <label class="md-header__button md-icon" for="__search">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
    </label>

    <!-- Search interface -->
    <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    

    <!-- Repository information -->
    
    <div class="md-header__source">
      

<!--
  Check whether the repository is hosted on one of the supported code hosting
  platforms (GitHub, GitLab or Bitbucket) to show icon.
-->


  


<!-- Repository containing source -->
<a href="https://github.com/koriym/l11ja" title="source.link.title"
    class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" fill="#000"/></svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
    
  </nav>

  <!-- Navigation tabs (sticky) -->
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="releases.html" class="md-tabs__link">
          
  
  プロローグ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="installation.html" class="md-tabs__link">
          
  
  はじめに

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="lifecycle.html" class="md-tabs__link">
          
  
  アーキテクチャ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="routing.html" class="md-tabs__link">
          
  
  基本

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="artisan.html" class="md-tabs__link">
          
  
  掘り下げる

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="authentication.html" class="md-tabs__link">
          
  
  セキュリティ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="database.html" class="md-tabs__link">
          
  
  データベース

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="eloquent.html" class="md-tabs__link">
          
  
  Eloquent ORM

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="testing.html" class="md-tabs__link">
          
  
  テスト

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="starter-kits.html" class="md-tabs__link">
          
  
  パッケージ

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="L11JA" class="md-nav__button md-logo" aria-label="L11JA" data-md-component="logo">
      
  <img src="assets/images/logo.png" alt="logo">

    </a>
    L11JA
  </label>
  
    <div class="md-nav__source">
      

<!--
  Check whether the repository is hosted on one of the supported code hosting
  platforms (GitHub, GitLab or Bitbucket) to show icon.
-->


  


<!-- Repository containing source -->
<a href="https://github.com/koriym/l11ja" title="source.link.title"
    class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z" fill="#000"/></svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    プロローグ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            プロローグ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="releases.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リリースノート
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="upgrade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    アップグレードガイド
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="contributions.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    貢献ガイド
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            はじめに
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="installation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    インストール
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="configuration.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    設定
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="structure.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ディレクトリ構造
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="frontend.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    フロントエンド
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="starter-kits.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    スターターキット
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="deployment.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    デプロイ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    アーキテクチャ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            アーキテクチャ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="lifecycle.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リクエストライフサイクル
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="container.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    サービスコンテナ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="providers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    サービスプロバイダ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="facades.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ファサード
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    基本
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            基本
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="routing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ルーティング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="middleware.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ミドルウェア
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="csrf.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CSRF保護
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="controllers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コントローラ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="requests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    リクエスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="responses.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    レスポンス
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="views.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ビュー
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="blade.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bladeテンプレート
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="vite.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    アセットバンドル
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="urls.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    URL生成
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="session.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    セッション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="validation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    バリデーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="errors.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    エラー処理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="logging.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ログ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    掘り下げる
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            掘り下げる
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="artisan.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Artisanコンソール
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="broadcasting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ブロードキャスティング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cache.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    キャッシュ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="collections.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コレクション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="concurrency.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    並行処理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="context.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コンテキスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="contracts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コントラクト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="events.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    イベント
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="filesystem.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ファイルストレージ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="helpers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ヘルパー
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http-client.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTPクライアント
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="localization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ローカライゼーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mail.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    メール
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="notifications.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    通知
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="packages.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    パッケージ開発
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="processes.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    プロセス
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="queues.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    キュー
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="rate-limiting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    レート制限
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="strings.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文字列
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="scheduling.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    タスクスケジューリング
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    セキュリティ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            セキュリティ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="authentication.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    認証
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="authorization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    認可
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="verification.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    メール確認
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="encryption.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    暗号化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="hashing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ハッシュ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="passwords.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    パスワードリセット
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    データベース
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            データベース
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="database.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="queries.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    クエリビルダ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pagination.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ページネーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="migrations.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    マイグレーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="seeding.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    シーディング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="redis.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Eloquent ORM
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Eloquent ORM
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    リレーションシップ
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="eloquent-relationships.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    リレーションシップ
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      はじめに
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップの定義
    </span>
  </a>
  
    <nav class="md-nav" aria-label="リレーションシップの定義">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      1対1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1対1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップの逆の定義
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1対多
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1対多">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      子モデル上の親モデルの自動ハイドレーション
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#belongs-to" class="md-nav__link">
    <span class="md-ellipsis">
      一対多 (逆) / Belongs To
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一対多 (逆) / Belongs To">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      デフォルトモデル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#belongs-to_1" class="md-nav__link">
    <span class="md-ellipsis">
      Belongs To リレーションのクエリ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      多対一の中の一つ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="多対一の中の一つ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      多対一のリレーションを一対一のリレーションに変換する
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      高度な多対一の中の一つのリレーション
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      一対一 (中間)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一対一 (中間)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      キーの規約
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#has-many-through" class="md-nav__link">
    <span class="md-ellipsis">
      Has Many Through
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Has Many Through">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      キーの規約
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      多対多関係
    </span>
  </a>
  
    <nav class="md-nav" aria-label="多対多関係">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      テーブル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      モデル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの逆の定義
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      中間テーブルの列の取得
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中間テーブルの列の取得">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pivot" class="md-nav__link">
    <span class="md-ellipsis">
      pivot 属性名のカスタマイズ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      中間テーブルの列を介したクエリのフィルタリング
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      中間テーブルの列を介したクエリの並べ替え
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      カスタム中間テーブルモデルの定義
    </span>
  </a>
  
    <nav class="md-nav" aria-label="カスタム中間テーブルモデルの定義">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#id" class="md-nav__link">
    <span class="md-ellipsis">
      カスタムピボットモデルとインクリメントID
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      ポリモーフィックリレーションシップ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ポリモーフィックリレーションシップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      一対一 (ポリモーフィック)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一対一 (ポリモーフィック)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      テーブル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      モデル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの取得
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      キーの規約
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      一対多（ポリモーフィック）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一対多（ポリモーフィック）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      テーブル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      モデル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの取得
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      子モデルに親モデルを自動的にハイドレート
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      多対一（ポリモーフィック）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      多対多（ポリモーフィック）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="多対多（ポリモーフィック）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      テーブル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      モデル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの逆の定義
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの取得
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      カスタムポリモーフィックタイプ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      動的リレーション
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションのクエリ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="リレーションのクエリ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#orwhere" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの後にorWhere句をチェーンする
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vs" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションメソッド vs. 動的プロパティ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップの存在をクエリする
    </span>
  </a>
  
    <nav class="md-nav" aria-label="リレーションシップの存在をクエリする">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      インラインリレーションシップの存在クエリ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップの不在をクエリする
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#morph-to" class="md-nav__link">
    <span class="md-ellipsis">
      Morph To リレーションシップのクエリ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Morph To リレーションシップのクエリ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      すべての関連モデルのクエリ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      関連モデルの集約
    </span>
  </a>
  
    <nav class="md-nav" aria-label="関連モデルの集約">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      関連モデルのカウント
    </span>
  </a>
  
    <nav class="md-nav" aria-label="関連モデルのカウント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      遅延カウント読み込み
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#select" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップのカウントとカスタムselectステートメント
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      その他の集約関数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#morph-to_1" class="md-nav__link">
    <span class="md-ellipsis">
      Morph To リレーションシップに関連するモデルのカウント
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Morph To リレーションシップに関連するモデルのカウント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      遅延カウント読み込み
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eager-loading" class="md-nav__link">
    <span class="md-ellipsis">
      一緒に読み込み（Eager Loading）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一緒に読み込み（Eager Loading）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      複数のリレーションシップを一緒に読み込む
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    <span class="md-ellipsis">
      ネストされた一緒に読み込み
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#morphto" class="md-nav__link">
    <span class="md-ellipsis">
      ネストされた一緒に読み込み morphTo リレーションシップ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    <span class="md-ellipsis">
      特定のカラムを一緒に読み込む
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    <span class="md-ellipsis">
      デフォルトで一緒に読み込む
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    <span class="md-ellipsis">
      一緒に読み込みの制約
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一緒に読み込みの制約">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#morphto_1" class="md-nav__link">
    <span class="md-ellipsis">
      morphTo リレーションシップの一緒に読み込みの制約
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの存在による積極的なロードの制約
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    <span class="md-ellipsis">
      遅延積極的ロード
    </span>
  </a>
  
    <nav class="md-nav" aria-label="遅延積極的ロード">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#morphto_2" class="md-nav__link">
    <span class="md-ellipsis">
      ネストされた遅延積極的ロードとmorphTo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    <span class="md-ellipsis">
      遅延ロードの防止
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    <span class="md-ellipsis">
      関連モデルの挿入と更新
    </span>
  </a>
  
    <nav class="md-nav" aria-label="関連モデルの挿入と更新">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#save" class="md-nav__link">
    <span class="md-ellipsis">
      saveメソッド
    </span>
  </a>
  
    <nav class="md-nav" aria-label="saveメソッド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    <span class="md-ellipsis">
      再帰的にモデルとリレーションを保存
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create" class="md-nav__link">
    <span class="md-ellipsis">
      createメソッド
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#belongs-to_2" class="md-nav__link">
    <span class="md-ellipsis">
      Belongs To リレーションの更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    <span class="md-ellipsis">
      多対多リレーションの更新
    </span>
  </a>
  
    <nav class="md-nav" aria-label="多対多リレーションの更新">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    <span class="md-ellipsis">
      アタッチ / デタッチ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    <span class="md-ellipsis">
      関連付けの同期
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    <span class="md-ellipsis">
      関連付けのトグル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    <span class="md-ellipsis">
      中間テーブルのレコードを更新する
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    <span class="md-ellipsis">
      親のタイムスタンプを更新する
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-collections.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コレクション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-mutators.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ミューテータ / キャスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-resources.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    APIリソース
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-serialization.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    シリアライゼーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="eloquent-factories.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ファクトリ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    テスト
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            テスト
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="testing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    はじめに
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="http-tests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTPテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="console-tests.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    コンソールテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dusk.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ブラウザテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="database-testing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    データベース
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mocking.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    モック
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    パッケージ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            パッケージ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="starter-kits.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    スターターキット
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="billing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashier (Stripe)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="cashier-paddle.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cashier (Paddle)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="dusk.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ブラウザテスト
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="envoy.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Envoy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="fortify.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fortify
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="folio.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Folio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="homestead.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Homestead
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="horizon.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Horizon
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="mix.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Mix
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="octane.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Octane
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="passport.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Passport
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pennant.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pennant
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pint.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pint
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="precognition.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Precognition
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="prompts.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Prompts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="pulse.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pulse
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="reverb.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reverb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sail.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sail
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="sanctum.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sanctum
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="scout.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Scout
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="socialite.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Socialite
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="telescope.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Telescope
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="valet.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Valet
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      はじめに
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップの定義
    </span>
  </a>
  
    <nav class="md-nav" aria-label="リレーションシップの定義">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      1対1
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1対1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップの逆の定義
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1対多
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1対多">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      子モデル上の親モデルの自動ハイドレーション
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#belongs-to" class="md-nav__link">
    <span class="md-ellipsis">
      一対多 (逆) / Belongs To
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一対多 (逆) / Belongs To">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      デフォルトモデル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#belongs-to_1" class="md-nav__link">
    <span class="md-ellipsis">
      Belongs To リレーションのクエリ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      多対一の中の一つ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="多対一の中の一つ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      多対一のリレーションを一対一のリレーションに変換する
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      高度な多対一の中の一つのリレーション
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      一対一 (中間)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一対一 (中間)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      キーの規約
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#has-many-through" class="md-nav__link">
    <span class="md-ellipsis">
      Has Many Through
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Has Many Through">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      キーの規約
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      多対多関係
    </span>
  </a>
  
    <nav class="md-nav" aria-label="多対多関係">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      テーブル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      モデル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの逆の定義
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      中間テーブルの列の取得
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中間テーブルの列の取得">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pivot" class="md-nav__link">
    <span class="md-ellipsis">
      pivot 属性名のカスタマイズ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      中間テーブルの列を介したクエリのフィルタリング
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      中間テーブルの列を介したクエリの並べ替え
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      カスタム中間テーブルモデルの定義
    </span>
  </a>
  
    <nav class="md-nav" aria-label="カスタム中間テーブルモデルの定義">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#id" class="md-nav__link">
    <span class="md-ellipsis">
      カスタムピボットモデルとインクリメントID
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      ポリモーフィックリレーションシップ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ポリモーフィックリレーションシップ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      一対一 (ポリモーフィック)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一対一 (ポリモーフィック)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      テーブル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      モデル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの取得
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      キーの規約
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      一対多（ポリモーフィック）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一対多（ポリモーフィック）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      テーブル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      モデル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの取得
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      子モデルに親モデルを自動的にハイドレート
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      多対一（ポリモーフィック）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      多対多（ポリモーフィック）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="多対多（ポリモーフィック）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      テーブル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      モデル構造
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの逆の定義
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの取得
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      カスタムポリモーフィックタイプ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      動的リレーション
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションのクエリ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="リレーションのクエリ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#orwhere" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの後にorWhere句をチェーンする
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vs" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションメソッド vs. 動的プロパティ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップの存在をクエリする
    </span>
  </a>
  
    <nav class="md-nav" aria-label="リレーションシップの存在をクエリする">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      インラインリレーションシップの存在クエリ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップの不在をクエリする
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#morph-to" class="md-nav__link">
    <span class="md-ellipsis">
      Morph To リレーションシップのクエリ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Morph To リレーションシップのクエリ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      すべての関連モデルのクエリ
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      関連モデルの集約
    </span>
  </a>
  
    <nav class="md-nav" aria-label="関連モデルの集約">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      関連モデルのカウント
    </span>
  </a>
  
    <nav class="md-nav" aria-label="関連モデルのカウント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      遅延カウント読み込み
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#select" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションシップのカウントとカスタムselectステートメント
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      その他の集約関数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#morph-to_1" class="md-nav__link">
    <span class="md-ellipsis">
      Morph To リレーションシップに関連するモデルのカウント
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Morph To リレーションシップに関連するモデルのカウント">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_48" class="md-nav__link">
    <span class="md-ellipsis">
      遅延カウント読み込み
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#eager-loading" class="md-nav__link">
    <span class="md-ellipsis">
      一緒に読み込み（Eager Loading）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一緒に読み込み（Eager Loading）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_49" class="md-nav__link">
    <span class="md-ellipsis">
      複数のリレーションシップを一緒に読み込む
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_50" class="md-nav__link">
    <span class="md-ellipsis">
      ネストされた一緒に読み込み
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#morphto" class="md-nav__link">
    <span class="md-ellipsis">
      ネストされた一緒に読み込み morphTo リレーションシップ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_51" class="md-nav__link">
    <span class="md-ellipsis">
      特定のカラムを一緒に読み込む
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_52" class="md-nav__link">
    <span class="md-ellipsis">
      デフォルトで一緒に読み込む
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_53" class="md-nav__link">
    <span class="md-ellipsis">
      一緒に読み込みの制約
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一緒に読み込みの制約">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#morphto_1" class="md-nav__link">
    <span class="md-ellipsis">
      morphTo リレーションシップの一緒に読み込みの制約
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_54" class="md-nav__link">
    <span class="md-ellipsis">
      リレーションの存在による積極的なロードの制約
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_55" class="md-nav__link">
    <span class="md-ellipsis">
      遅延積極的ロード
    </span>
  </a>
  
    <nav class="md-nav" aria-label="遅延積極的ロード">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#morphto_2" class="md-nav__link">
    <span class="md-ellipsis">
      ネストされた遅延積極的ロードとmorphTo
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_56" class="md-nav__link">
    <span class="md-ellipsis">
      遅延ロードの防止
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_57" class="md-nav__link">
    <span class="md-ellipsis">
      関連モデルの挿入と更新
    </span>
  </a>
  
    <nav class="md-nav" aria-label="関連モデルの挿入と更新">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#save" class="md-nav__link">
    <span class="md-ellipsis">
      saveメソッド
    </span>
  </a>
  
    <nav class="md-nav" aria-label="saveメソッド">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_58" class="md-nav__link">
    <span class="md-ellipsis">
      再帰的にモデルとリレーションを保存
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create" class="md-nav__link">
    <span class="md-ellipsis">
      createメソッド
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#belongs-to_2" class="md-nav__link">
    <span class="md-ellipsis">
      Belongs To リレーションの更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_59" class="md-nav__link">
    <span class="md-ellipsis">
      多対多リレーションの更新
    </span>
  </a>
  
    <nav class="md-nav" aria-label="多対多リレーションの更新">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_60" class="md-nav__link">
    <span class="md-ellipsis">
      アタッチ / デタッチ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_61" class="md-nav__link">
    <span class="md-ellipsis">
      関連付けの同期
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_62" class="md-nav__link">
    <span class="md-ellipsis">
      関連付けのトグル
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_63" class="md-nav__link">
    <span class="md-ellipsis">
      中間テーブルのレコードを更新する
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_64" class="md-nav__link">
    <span class="md-ellipsis">
      親のタイムスタンプを更新する
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/koriym/l11ja/edit/master/docs/eloquent-relationships.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="eloquent">Eloquent: リレーションシップ<a class="headerlink" href="#eloquent" title="Permanent link">&para;</a></h1>
<ul>
<li><a href="#introduction">はじめに</a></li>
<li><a href="#defining-relationships">リレーションシップの定義</a><ul>
<li><a href="#one-to-one">1対1</a></li>
<li><a href="#one-to-many">1対多</a></li>
<li><a href="#one-to-many-inverse">1対多（逆） / 所属</a></li>
<li><a href="#has-one-of-many">多の中の1</a></li>
<li><a href="#has-one-through">中間テーブルを介した1対1</a></li>
<li><a href="#has-many-through">中間テーブルを介した1対多</a></li>
</ul>
</li>
<li><a href="#many-to-many">多対多のリレーションシップ</a><ul>
<li><a href="#retrieving-intermediate-table-columns">中間テーブルのカラムの取得</a></li>
<li><a href="#filtering-queries-via-intermediate-table-columns">中間テーブルのカラムによるクエリのフィルタリング</a></li>
<li><a href="#ordering-queries-via-intermediate-table-columns">中間テーブルのカラムによるクエリのソート</a></li>
<li><a href="#defining-custom-intermediate-table-models">カスタム中間テーブルモデルの定義</a></li>
</ul>
</li>
<li><a href="#polymorphic-relationships">ポリモーフィックリレーションシップ</a><ul>
<li><a href="#one-to-one-polymorphic-relations">1対1</a></li>
<li><a href="#one-to-many-polymorphic-relations">1対多</a></li>
<li><a href="#one-of-many-polymorphic-relations">多の中の1</a></li>
<li><a href="#many-to-many-polymorphic-relations">多対多</a></li>
<li><a href="#custom-polymorphic-types">カスタムポリモーフィックタイプ</a></li>
</ul>
</li>
<li><a href="#dynamic-relationships">動的リレーションシップ</a></li>
<li><a href="#querying-relations">リレーションシップのクエリ</a><ul>
<li><a href="#relationship-methods-vs-dynamic-properties">リレーションシップメソッド vs. 動的プロパティ</a></li>
<li><a href="#querying-relationship-existence">リレーションシップの存在のクエリ</a></li>
<li><a href="#querying-relationship-absence">リレーションシップの不在のクエリ</a></li>
<li><a href="#querying-morph-to-relationships">モーフ対リレーションシップのクエリ</a></li>
</ul>
</li>
<li><a href="#aggregating-related-models">関連モデルの集約</a><ul>
<li><a href="#counting-related-models">関連モデルのカウント</a></li>
<li><a href="#other-aggregate-functions">その他の集約関数</a></li>
<li><a href="#counting-related-models-on-morph-to-relationships">モーフ対リレーションシップの関連モデルのカウント</a></li>
</ul>
</li>
<li><a href="#eager-loading">Eagerローディング</a><ul>
<li><a href="#constraining-eager-loads">Eagerロードの制約</a></li>
<li><a href="#lazy-eager-loading">遅延Eagerローディング</a></li>
<li><a href="#preventing-lazy-loading">遅延ローディングの防止</a></li>
</ul>
</li>
<li><a href="#inserting-and-updating-related-models">関連モデルの挿入と更新</a><ul>
<li><a href="#the-save-method"><code>save</code>メソッド</a></li>
<li><a href="#the-create-method"><code>create</code>メソッド</a></li>
<li><a href="#updating-belongs-to-relationships">所属リレーションシップ</a></li>
<li><a href="#updating-many-to-many-relationships">多対多のリレーションシップ</a></li>
</ul>
</li>
<li><a href="#touching-parent-timestamps">親のタイムスタンプの更新</a></li>
</ul>
<p><a name="introduction"></a></p>
<h2 id="_1">はじめに<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>データベーステーブルはしばしば互いに関連しています。例えば、ブログ投稿には多くのコメントがあるかもしれませんし、注文はそれを行ったユーザーに関連しているかもしれません。Eloquentはこれらのリレーションシップの管理と操作を容易にし、さまざまな一般的なリレーションシップをサポートしています。</p>
<div class="content-list">
<ul>
<li><a href="#one-to-one">1対1</a></li>
<li><a href="#one-to-many">1対多</a></li>
<li><a href="#many-to-many">多対多</a></li>
<li><a href="#has-one-through">中間テーブルを介した1対1</a></li>
<li><a href="#has-many-through">中間テーブルを介した1対多</a></li>
<li><a href="#one-to-one-polymorphic-relations">1対1（ポリモーフィック）</a></li>
<li><a href="#one-to-many-polymorphic-relations">1対多（ポリモーフィック）</a></li>
<li><a href="#many-to-many-polymorphic-relations">多対多（ポリモーフィック）</a></li>
</ul>
</div>
<p><a name="defining-relationships"></a></p>
<h2 id="_2">リレーションシップの定義<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>Eloquentのリレーションシップは、Eloquentモデルクラスのメソッドとして定義されます。リレーションシップは強力な<a href="queries.html">クエリビルダ</a>としても機能するため、リレーションシップをメソッドとして定義することで、強力なメソッドチェーンとクエリ機能が提供されます。例えば、この<code>posts</code>リレーションシップに追加のクエリ制約をチェーンすることができます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">posts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>しかし、リレーションシップの使用に深く入る前に、Eloquentがサポートする各タイプのリレーションシップを定義する方法を学びましょう。</p>
<p><a name="one-to-one"></a></p>
<h3 id="11">1対1<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<p>1対1のリレーションシップは、非常に基本的なタイプのデータベースリレーションシップです。例えば、<code>User</code>モデルは1つの<code>Phone</code>モデルに関連付けられている可能性があります。このリレーションシップを定義するために、<code>User</code>モデルに<code>phone</code>メソッドを配置します。<code>phone</code>メソッドは<code>hasOne</code>メソッドを呼び出し、その結果を返す必要があります。<code>hasOne</code>メソッドは、モデルの<code>Illuminate\Database\Eloquent\Model</code>基底クラスを介してモデルで利用可能です。</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\HasOne</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * ユーザーに関連付けられた電話を取得します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">phone</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasOne</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOne</span><span class="p">(</span><span class="nx">Phone</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>hasOne</code>メソッドに渡される最初の引数は、関連モデルクラスの名前です。リレーションシップが定義されると、Eloquentの動的プロパティを使用して関連レコードを取得できます。動的プロパティを使用すると、リレーションシップメソッドにアクセスすることができます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$phone</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">phone</span><span class="p">;</span>
</code></pre></div>
<p>Eloquentは、リレーションシップの外部キーを親モデル名に基づいて決定します。この場合、<code>Phone</code>モデルは自動的に<code>user_id</code>外部キーを持つと想定されます。この規約をオーバーライドしたい場合は、<code>hasOne</code>メソッドに2番目の引数を渡すことができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOne</span><span class="p">(</span><span class="nx">Phone</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;foreign_key&#39;</span><span class="p">);</span>
</code></pre></div>
<p>さらに、Eloquentは外部キーが親の主キーカラムの値と一致することを想定しています。つまり、Eloquentはユーザーの<code>id</code>カラムの値を<code>Phone</code>レコードの<code>user_id</code>カラムで探します。リレーションシップが<code>id</code>以外の主キー値を使用する場合、またはモデルの<code>$primaryKey</code>プロパティ以外の主キー値を使用する場合は、<code>hasOne</code>メソッドに3番目の引数を渡すことができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOne</span><span class="p">(</span><span class="nx">Phone</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;foreign_key&#39;</span><span class="p">,</span> <span class="s1">&#39;local_key&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="one-to-one-defining-the-inverse-of-the-relationship"></a></p>
<h4 id="_3">リレーションシップの逆の定義<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>これで、<code>User</code>モデルから<code>Phone</code>モデルにアクセスできるようになりました。次に、<code>Phone</code>モデルにリレーションシップを定義して、電話を所有するユーザーにアクセスできるようにしましょう。<code>hasOne</code>リレーションシップの逆を定義するには、<code>belongsTo</code>メソッドを使用します。</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\BelongsTo</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Phone</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 電話を所有するユーザーを取得します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">user</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>user</code>メソッドを呼び出すと、Eloquentは<code>User</code>モデルを見つけようとします。このモデルは、<code>Phone</code>モデルの<code>user_id</code>カラムと一致する<code>id</code>を持っています。</p>
<p>Eloquentは、リレーションシップメソッドの名前を調べ、メソッド名に<code>_id</code>を付けることで外部キー名を決定します。したがって、この場合、Eloquentは<code>Phone</code>モデルに<code>user_id</code>カラムがあると想定します。ただし、<code>Phone</code>モデルの外部キーが<code>user_id</code>でない場合は、<code>belongsTo</code>メソッドにカスタムキー名を2番目の引数として渡すことができます。</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd"> * 電話を所有するユーザーを取得します。</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">user</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;foreign_key&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>親モデルが<code>id</code>を主キーとして使用していない場合、または関連モデルを見つけるために別のカラムを使用したい場合は、<code>belongsTo</code>メソッドに親テーブルのカスタムキーを3番目の引数として渡すことができます。</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd"> * 電話を所有するユーザーを取得します。</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">user</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;foreign_key&#39;</span><span class="p">,</span> <span class="s1">&#39;owner_key&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p><a name="one-to-many"></a></p>
<h3 id="1">1対多<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>1対多のリレーションシップは、1つのモデルが1つ以上の子モデルの親となるリレーションシップを定義するために使用されます。例えば、ブログ投稿には無限の数のコメントがある可能性があります。他のすべてのEloquentリレーションシップと同様に、1対多のリレーションシップはEloquentモデルにメソッドを定義することで定義されます。</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\HasMany</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Post</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * ブログ投稿のコメントを取得します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">comments</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasMany</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="nx">Comment</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Eloquentは、<code>Comment</code>モデルの適切な外部キーカラムを自動的に決定します。慣例により、Eloquentは親モデルの「スネークケース」名を取り、それに<code>_id</code>を付けます。したがって、この例では、Eloquentは<code>Comment</code>モデルの外部キーカラムが<code>post_id</code>であると想定します。</p>
<p>リレーションシップメソッドが定義されると、<code>comments</code>プロパティにアクセスすることで関連するコメントの<a href="eloquent-collections.html">コレクション</a>にアクセスできます。Eloquentは「動的リレーションシッププロパティ」を提供するため、リレーションシップメソッドにアクセスできます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>

<span class="nv">$comments</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">;</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$comments</span> <span class="k">as</span> <span class="nv">$comment</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>すべてのリレーションシップはクエリビルダとしても機能するため、<code>comments</code>メソッドを呼び出し、クエリに条件をチェーンすることでリレーションシップクエリにさらに制約を追加できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$comment</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">()</span>
                    <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
                    <span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
</code></pre></div>
<p><code>hasOne</code>メソッドと同様に、外部キーとローカルキーをオーバーライドするために<code>hasMany</code>メソッドに追加の引数を渡すこともできます。</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="nx">Comment</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;foreign_key&#39;</span><span class="p">);</span>

<span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="nx">Comment</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;foreign_key&#39;</span><span class="p">,</span> <span class="s1">&#39;local_key&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="automatically-hydrating-parent-models-on-children"></a></p>
<h4 id="_4">子モデル上の親モデルの自動ハイドレーション<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<p>EloquentのEagerローディングを利用していても、子モデルをループしながら親モデルにアクセスしようとすると、「N + 1」クエリの問題が発生する可能性があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="sb">``</span><span class="err">`</span><span class="nx">php</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$posts</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span> <span class="k">as</span> <span class="nv">$comment</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>        <span class="k">echo</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">post</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="p">}</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">}</span>
</code></pre></div>
<p>上記の例では、"N + 1" クエリ問題が発生しています。なぜなら、<code>Post</code> モデルのコメントは一括読み込みされていますが、Eloquent は自動的に各 <code>Comment</code> モデルに親の <code>Post</code> をハイドレートしないからです。</p>
<p>もし Eloquent に親モデルを子モデルに自動的にハイドレートさせたい場合、<code>hasMany</code> リレーションを定義する際に <code>chaperone</code> メソッドを呼び出すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\HasMany</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="k">class</span> <span class="nc">Post</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="p">{</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="sd">     * ブログ投稿のコメントを取得します。</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="sd">     */</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">comments</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasMany</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>    <span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="nx">Comment</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">chaperone</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    <span class="p">}</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="p">}</span>
</code></pre></div>
<p>または、実行時に親モデルの自動ハイドレーションをオプトインする場合、リレーションを一括読み込みする際に <code>chaperone</code> メソッドを呼び出すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">with</span><span class="p">([</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>    <span class="s1">&#39;comments&#39;</span> <span class="o">=&gt;</span> <span class="nx">fn</span> <span class="p">(</span><span class="nv">$comments</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$comments</span><span class="o">-&gt;</span><span class="na">chaperone</span><span class="p">(),</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="one-to-many-inverse"></a></p>
<h3 id="belongs-to">一対多 (逆) / Belongs To<a class="headerlink" href="#belongs-to" title="Permanent link">&para;</a></h3>
<p>これで投稿のすべてのコメントにアクセスできるようになったので、コメントが親投稿にアクセスできるようにするためのリレーションを定義しましょう。<code>hasMany</code> リレーションの逆を定義するには、子モデルに <code>belongsTo</code> メソッドを呼び出すリレーションメソッドを定義します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\BelongsTo</span><span class="p">;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="k">class</span> <span class="nc">Comment</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="p">{</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="sd">     * コメントを所有する投稿を取得します。</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="sd">     */</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">post</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>    <span class="p">{</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>    <span class="p">}</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="p">}</span>
</code></pre></div>
<p>リレーションが定義されたら、<code>post</code> の「動的リレーションプロパティ」にアクセスすることで、コメントの親投稿を取得できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">use</span> <span class="nx">App\Models\Comment</span><span class="p">;</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nv">$comment</span> <span class="o">=</span> <span class="nx">Comment</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="k">return</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">post</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">;</span>
</code></pre></div>
<p>上記の例では、Eloquent は <code>Comment</code> モデルの <code>post_id</code> 列と一致する <code>id</code> を持つ <code>Post</code> モデルを見つけようとします。</p>
<p>Eloquent は、リレーションメソッドの名前を調べ、メソッド名に <code>_</code> を付けて親モデルの主キーカラム名を追加することで、デフォルトの外部キー名を決定します。したがって、この例では、Eloquent は <code>comments</code> テーブルの <code>Post</code> モデルの外部キーが <code>post_id</code> であると仮定します。</p>
<p>ただし、リレーションの外部キーがこれらの規約に従っていない場合、<code>belongsTo</code> メソッドにカスタム外部キー名を2番目の引数として渡すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="sd">/**</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="sd"> * コメントを所有する投稿を取得します。</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="sd"> */</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">post</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="p">{</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;foreign_key&#39;</span><span class="p">);</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="p">}</span>
</code></pre></div>
<p>親モデルが <code>id</code> を主キーとして使用していない場合、または異なるカラムを使用して関連モデルを見つけたい場合、<code>belongsTo</code> メソッドに親テーブルのカスタムキーを3番目の引数として渡すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="sd">/**</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="sd"> * コメントを所有する投稿を取得します。</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="sd"> */</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">post</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="p">{</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;foreign_key&#39;</span><span class="p">,</span> <span class="s1">&#39;owner_key&#39;</span><span class="p">);</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="p">}</span>
</code></pre></div>
<p><a name="default-models"></a></p>
<h4 id="_5">デフォルトモデル<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p><code>belongsTo</code>、<code>hasOne</code>、<code>hasOneThrough</code>、および <code>morphOne</code> リレーションには、指定されたリレーションが <code>null</code> の場合に返されるデフォルトモデルを定義できます。このパターンは、<a href="https://en.wikipedia.org/wiki/Null_Object_pattern">Null Object パターン</a>と呼ばれ、コード内の条件チェックを削減するのに役立ちます。以下の例では、<code>user</code> リレーションは <code>Post</code> モデルにユーザーがアタッチされていない場合、空の <code>App\Models\User</code> モデルを返します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="sd">/**</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="sd"> * 投稿の作成者を取得します。</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="sd"> */</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">user</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="p">{</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">withDefault</span><span class="p">();</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="p">}</span>
</code></pre></div>
<p>デフォルトモデルに属性を設定するには、<code>withDefault</code> メソッドに配列またはクロージャを渡すことができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="sd">/**</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="sd"> * 投稿の作成者を取得します。</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="sd"> */</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">user</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="p">{</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">withDefault</span><span class="p">([</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>        <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Guest Author&#39;</span><span class="p">,</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>    <span class="p">]);</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="p">}</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="sd">/**</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="sd"> * 投稿の作成者を取得します。</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="sd"> */</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">user</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="p">{</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">withDefault</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">,</span> <span class="nx">Post</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>        <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s1">&#39;Guest Author&#39;</span><span class="p">;</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>    <span class="p">});</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="p">}</span>
</code></pre></div>
<p><a name="querying-belongs-to-relationships"></a></p>
<h4 id="belongs-to_1">Belongs To リレーションのクエリ<a class="headerlink" href="#belongs-to_1" title="Permanent link">&para;</a></h4>
<p>"belongs to" リレーションの子をクエリする場合、対応する Eloquent モデルを取得するために <code>where</code> 句を手動で構築できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>ただし、<code>whereBelongsTo</code> メソッドを使用すると、指定されたモデルの適切なリレーションと外部キーを自動的に決定できるため、より便利です。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">whereBelongsTo</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>また、<a href="eloquent-collections.html">コレクション</a>インスタンスを <code>whereBelongsTo</code> メソッドに提供することもできます。その場合、Laravel はコレクション内の親モデルのいずれかに属するモデルを取得します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nv">$users</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;vip&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">whereBelongsTo</span><span class="p">(</span><span class="nv">$users</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>デフォルトでは、Laravel はモデルのクラス名に基づいて関連するリレーションを決定します。ただし、<code>whereBelongsTo</code> メソッドの2番目の引数としてリレーション名を手動で指定することもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">whereBelongsTo</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="has-one-of-many"></a></p>
<h3 id="_6">多対一の中の一つ<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>モデルが多くの関連モデルを持つ場合がありますが、リレーションの中で「最新」または「最古」の関連モデルを簡単に取得したい場合があります。たとえば、<code>User</code> モデルは多くの <code>Order</code> モデルに関連付けられているかもしれませんが、ユーザーが最後に注文した注文を簡単に操作する方法を定義したい場合があります。これは、<code>hasOne</code> リレーションタイプと <code>ofMany</code> メソッドを組み合わせて実現できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="sd">/**</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="sd"> * ユーザーの最新の注文を取得します。</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="sd"> */</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">latestOrder</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasOne</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="p">{</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOne</span><span class="p">(</span><span class="nx">Order</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">latestOfMany</span><span class="p">();</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="p">}</span>
</code></pre></div>
<p>同様に、リレーションの「最古」または最初の関連モデルを取得するメソッドを定義できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="sd">/**</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="sd"> * ユーザーの最古の注文を取得します。</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="sd"> */</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">oldestOrder</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasOne</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="p">{</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOne</span><span class="p">(</span><span class="nx">Order</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">oldestOfMany</span><span class="p">();</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="p">}</span>
</code></pre></div>
<p>デフォルトでは、<code>latestOfMany</code> および <code>oldestOfMany</code> メソッドは、モデルの主キーに基づいて最新または最古の関連モデルを取得します。これはソート可能である必要があります。ただし、異なるソート基準を使用して大きなリレーションから単一のモデルを取得したい場合があります。</p>
<p>たとえば、<code>ofMany</code> メソッドを使用して、ユーザーの最も高価な注文を取得できます。<code>ofMany</code> メソッドは、ソート可能なカラムを最初の引数として受け取り、関連モデルをクエリする際に適用する集約関数 (<code>min</code> または <code>max</code>) を受け取ります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="sd">/**</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="sd"> * ユーザーの最も高価な注文を取得します。</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="sd"> */</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">largestOrder</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasOne</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="p">{</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOne</span><span class="p">(</span><span class="nx">Order</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">ofMany</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">);</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>PostgreSQL は UUID カラムに対して <code>MAX</code> 関数を実行することをサポートしていないため、現在 PostgreSQL UUID カラムと一緒に one-of-many リレーションを使用することはできません。</p>
</div>
<p><a name="converting-many-relationships-to-has-one-relationships"></a></p>
<h4 id="_7">多対一のリレーションを一対一のリレーションに変換する<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<p><code>latestOfMany</code>、<code>oldestOfMany</code>、または <code>ofMany</code> メソッドを使用して単一のモデルを取得する場合、同じモデルに対して既に「多対一」のリレーションが定義されていることがよくあります。便宜上、Laravel では、リレーションに <code>one</code> メソッドを呼び出すことで、このリレーションを「一対一」のリレーションに簡単に変換できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="sd">/**</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="sd"> * ユーザーの注文を取得します。</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="sd"> */</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">orders</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasMany</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="p">{</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="nx">Order</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="p">}</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="sd">/**</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="sd"> * ユーザーの最も高価な注文を取得します。</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="sd"> */</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">largestOrder</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasOne</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="p">{</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">orders</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">one</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">ofMany</span><span class="p">(</span><span class="s1">&#39;price&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">);</span>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="p">}</span>
</code></pre></div>
<p><a name="advanced-has-one-of-many-relationships"></a></p>
<h4 id="_8">高度な多対一の中の一つのリレーション<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<p>より高度な「多対一の中の一つ」のリレーションを構築することも可能です。たとえば、<code>Product</code> モデルは多くの関連する <code>Price</code> モデルを持つことがあり、新しい価格が公開された後もシステムに保持される場合があります。さらに、製品の新しい価格データは、将来の日付に効果を発揮するために事前に公開されることがあります。これは <code>published_at</code> カラムを介して行われます。</p>
<p>つまり、公開日が未来ではない最新の公開価格を取得する必要があります。さらに、2つの価格が同じ公開日を持つ場合、ID が最も大きい価格を優先します。これを実現するには、ソート可能なカラムを含む配列を <code>ofMany</code> メソッドに渡す必要があります。これにより、最新の価格が決定されます。さらに、<code>ofMany</code> メソッドの2番目の引数としてクロージャを提供します。このクロージャは、リレーションクエリに追加の公開日制約を追加する責任を負います。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="sd">/**</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="sd"> * 製品の現在の価格を取得します。</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="sd"> */</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">currentPricing</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasOne</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="p">{</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOne</span><span class="p">(</span><span class="nx">Price</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">ofMany</span><span class="p">([</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>        <span class="s1">&#39;published_at&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>        <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="p">],</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;published_at&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nx">now</span><span class="p">());</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="p">});</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="p">}</span>
</code></pre></div>
<p><a name="has-one-through"></a></p>
<h3 id="_9">一対一 (中間)<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<p>「一対一 (中間)」リレーションは、別のモデルとの一対一のリレーションを定義します。ただし、このリレーションは、宣言モデルが第三のモデルを介して別のモデルのインスタンスと一致できることを示します。</p>
<p>例えば、車両修理店のアプリケーションでは、各 <code>Mechanic</code> モデルは1つの <code>Car</code> モデルに関連付けられ、各 <code>Car</code> モデルは1つの <code>Owner</code> モデルに関連付けられるかもしれません。メカニックとオーナーはデータベース内で直接の関係を持っていませんが、メカニックは <code>Car</code> モデルを通じてオーナーにアクセスできます。この関係を定義するために必要なテーブルを見てみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="nx">mechanics</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>

<span class="nx">cars</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">model</span> <span class="o">-</span> <span class="nx">string</span>
    <span class="nx">mechanic_id</span> <span class="o">-</span> <span class="nx">integer</span>

<span class="nx">owners</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>
    <span class="nx">car_id</span> <span class="o">-</span> <span class="nx">integer</span>
</code></pre></div>
<p>関係のためのテーブル構造を見たので、<code>Mechanic</code> モデルでこの関係を定義しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\HasOneThrough</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Mechanic</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 車のオーナーを取得する。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">carOwner</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasOneThrough</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOneThrough</span><span class="p">(</span><span class="nx">Owner</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nx">Car</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>hasOneThrough</code> メソッドに渡される最初の引数は、アクセスしたい最終モデルの名前で、2番目の引数は中間モデルの名前です。</p>
<p>また、関係に関わるすべてのモデルで関係がすでに定義されている場合、<code>through</code> メソッドを呼び出し、それらの関係の名前を指定することで、"has-one-through" 関係を流れるように定義できます。例えば、<code>Mechanic</code> モデルが <code>cars</code> 関係を持ち、<code>Car</code> モデルが <code>owner</code> 関係を持つ場合、メカニックとオーナーを接続する "has-one-through" 関係を次のように定義できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">// 文字列ベースの構文...</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">through</span><span class="p">(</span><span class="s1">&#39;cars&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">&#39;owner&#39;</span><span class="p">);</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="c1">// 動的な構文...</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">throughCars</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">hasOwner</span><span class="p">();</span>
</code></pre></div>
<p><a name="has-one-through-key-conventions"></a></p>
<h4 id="_10">キーの規約<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<p>関係のクエリを実行する際には、典型的なEloquentの外部キー規約が使用されます。関係のキーをカスタマイズしたい場合は、<code>hasOneThrough</code> メソッドに3番目と4番目の引数として渡すことができます。3番目の引数は中間モデルの外部キーの名前です。4番目の引数は最終モデルの外部キーの名前です。5番目の引数はローカルキーで、6番目の引数は中間モデルのローカルキーです：</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Mechanic</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 車のオーナーを取得する。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">carOwner</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasOneThrough</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasOneThrough</span><span class="p">(</span>
            <span class="nx">Owner</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="nx">Car</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="s1">&#39;mechanic_id&#39;</span><span class="p">,</span> <span class="c1">// carsテーブルの外部キー...</span>
            <span class="s1">&#39;car_id&#39;</span><span class="p">,</span> <span class="c1">// ownersテーブルの外部キー...</span>
            <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="c1">// mechanicsテーブルのローカルキー...</span>
            <span class="s1">&#39;id&#39;</span> <span class="c1">// carsテーブルのローカルキー...</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>また、前述のように、関係に関わるすべてのモデルで関係がすでに定義されている場合、<code>through</code> メソッドを呼び出し、それらの関係の名前を指定することで、"has-one-through" 関係を流れるように定義できます。このアプローチは、既存の関係で定義されたキー規約を再利用する利点があります：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1">// 文字列ベースの構文...</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">through</span><span class="p">(</span><span class="s1">&#39;cars&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">&#39;owner&#39;</span><span class="p">);</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="c1">// 動的な構文...</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">throughCars</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">hasOwner</span><span class="p">();</span>
</code></pre></div>
<p><a name="has-many-through"></a></p>
<h3 id="has-many-through">Has Many Through<a class="headerlink" href="#has-many-through" title="Permanent link">&para;</a></h3>
<p>"has-many-through" 関係は、中間の関係を通じて遠い関係にアクセスする便利な方法を提供します。例えば、<a href="https://vapor.laravel.com">Laravel Vapor</a> のようなデプロイメントプラットフォームを構築しているとしましょう。<code>Project</code> モデルは、中間の <code>Environment</code> モデルを通じて多くの <code>Deployment</code> モデルにアクセスするかもしれません。この例を使用して、特定のプロジェクトのすべてのデプロイメントを簡単に集めることができます。この関係を定義するために必要なテーブルを見てみましょう：</p>
<div class="highlight"><pre><span></span><code><span class="nx">projects</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>

<span class="nx">environments</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">project_id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>

<span class="nx">deployments</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">environment_id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">commit_hash</span> <span class="o">-</span> <span class="nx">string</span>
</code></pre></div>
<p>関係のためのテーブル構造を見たので、<code>Project</code> モデルでこの関係を定義しましょう：</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\HasManyThrough</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Project</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * プロジェクトのすべてのデプロイメントを取得する。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">deployments</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasManyThrough</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasManyThrough</span><span class="p">(</span><span class="nx">Deployment</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nx">Environment</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>hasManyThrough</code> メソッドに渡される最初の引数は、アクセスしたい最終モデルの名前で、2番目の引数は中間モデルの名前です。</p>
<p>また、関係に関わるすべてのモデルで関係がすでに定義されている場合、<code>through</code> メソッドを呼び出し、それらの関係の名前を指定することで、"has-many-through" 関係を流れるように定義できます。例えば、<code>Project</code> モデルが <code>environments</code> 関係を持ち、<code>Environment</code> モデルが <code>deployments</code> 関係を持つ場合、プロジェクトとデプロイメントを接続する "has-many-through" 関係を次のように定義できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1">// 文字列ベースの構文...</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">through</span><span class="p">(</span><span class="s1">&#39;environments&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">&#39;deployments&#39;</span><span class="p">);</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="c1">// 動的な構文...</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">throughEnvironments</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">hasDeployments</span><span class="p">();</span>
</code></pre></div>
<p><code>Deployment</code> モデルのテーブルには <code>project_id</code> 列が含まれていませんが、<code>hasManyThrough</code> 関係は <code>$project-&gt;deployments</code> を通じてプロジェクトのデプロイメントにアクセスできます。これらのモデルを取得するために、Eloquent は中間の <code>Environment</code> モデルのテーブルの <code>project_id</code> 列を調べます。関連する環境IDを見つけた後、それらを使用して <code>Deployment</code> モデルのテーブルをクエリします。</p>
<p><a name="has-many-through-key-conventions"></a></p>
<h4 id="_11">キーの規約<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<p>関係のクエリを実行する際には、典型的なEloquentの外部キー規約が使用されます。関係のキーをカスタマイズしたい場合は、<code>hasManyThrough</code> メソッドに3番目と4番目の引数として渡すことができます。3番目の引数は中間モデルの外部キーの名前です。4番目の引数は最終モデルの外部キーの名前です。5番目の引数はローカルキーで、6番目の引数は中間モデルのローカルキーです：</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Project</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">deployments</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasManyThrough</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasManyThrough</span><span class="p">(</span>
            <span class="nx">Deployment</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="nx">Environment</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="s1">&#39;project_id&#39;</span><span class="p">,</span> <span class="c1">// environmentsテーブルの外部キー...</span>
            <span class="s1">&#39;environment_id&#39;</span><span class="p">,</span> <span class="c1">// deploymentsテーブルの外部キー...</span>
            <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="c1">// projectsテーブルのローカルキー...</span>
            <span class="s1">&#39;id&#39;</span> <span class="c1">// environmentsテーブルのローカルキー...</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>また、前述のように、関係に関わるすべてのモデルで関係がすでに定義されている場合、<code>through</code> メソッドを呼び出し、それらの関係の名前を指定することで、"has-many-through" 関係を流れるように定義できます。このアプローチは、既存の関係で定義されたキー規約を再利用する利点があります：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1">// 文字列ベースの構文...</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">through</span><span class="p">(</span><span class="s1">&#39;environments&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">has</span><span class="p">(</span><span class="s1">&#39;deployments&#39;</span><span class="p">);</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="c1">// 動的な構文...</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">throughEnvironments</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">hasDeployments</span><span class="p">();</span>
</code></pre></div>
<p><a name="many-to-many"></a></p>
<h2 id="_12">多対多関係<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<p>多対多関係は、<code>hasOne</code> や <code>hasMany</code> 関係よりも少し複雑です。多対多関係の例としては、ユーザーが多くの役割を持ち、それらの役割がアプリケーション内の他のユーザーと共有される場合があります。例えば、ユーザーは "Author" と "Editor" の役割を割り当てられるかもしれませんが、それらの役割は他のユーザーにも割り当てられるかもしれません。つまり、ユーザーは多くの役割を持ち、役割は多くのユーザーを持ちます。</p>
<p><a name="many-to-many-table-structure"></a></p>
<h4 id="_13">テーブル構造<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<p>この関係を定義するには、<code>users</code>、<code>roles</code>、<code>role_user</code> の3つのデータベーステーブルが必要です。<code>role_user</code> テーブルは関連するモデル名のアルファベット順から派生し、<code>user_id</code> と <code>role_id</code> 列を含みます。このテーブルは、ユーザーと役割をリンクする中間テーブルとして使用されます。</p>
<p>役割が多くのユーザーに属することができるため、<code>roles</code> テーブルに <code>user_id</code> 列を単純に配置することはできません。これは、役割が単一のユーザーにのみ属することを意味します。複数のユーザーに役割を割り当てるためのサポートを提供するために、<code>role_user</code> テーブルが必要です。関係のテーブル構造を次のようにまとめることができます：</p>
<div class="highlight"><pre><span></span><code><span class="nx">users</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>

<span class="nx">roles</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>

<span class="nx">role_user</span>
    <span class="nx">user_id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">role_id</span> <span class="o">-</span> <span class="nx">integer</span>
</code></pre></div>
<p><a name="many-to-many-model-structure"></a></p>
<h4 id="_14">モデル構造<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<p>多対多関係は、<code>belongsToMany</code> メソッドの結果を返すメソッドを書くことで定義されます。<code>belongsToMany</code> メソッドは、アプリケーションのすべてのEloquentモデルが使用する <code>Illuminate\Database\Eloquent\Model</code> 基底クラスによって提供されます。例えば、<code>User</code> モデルに <code>roles</code> メソッドを定義しましょう。このメソッドに渡される最初の引数は、関連するモデルクラスの名前です：</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\BelongsToMany</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * ユーザーに属する役割。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">roles</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsToMany</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Role</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>リレーションが定義されると、<code>roles</code> ダイナミックリレーションシッププロパティを使用してユーザーのロールにアクセスできます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>すべてのリレーションはクエリビルダとしても機能するため、<code>roles</code> メソッドを呼び出してクエリにさらに条件を追加することで、リレーションクエリにさらに制約を追加できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$roles</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>リレーションの中間テーブルのテーブル名を決定するために、Eloquent は2つの関連するモデル名をアルファベット順に結合します。ただし、この規則を自由に上書きできます。<code>belongsToMany</code> メソッドに2番目の引数を渡すことでこれを行うことができます:</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Role</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;role_user&#39;</span><span class="p">);</span>
</code></pre></div>
<p>中間テーブルの名前をカスタマイズするだけでなく、テーブルのキーの列名もカスタマイズできます。<code>belongsToMany</code> メソッドに追加の引数を渡すことでこれを行います。3番目の引数は、リレーションを定義しているモデルの外部キー名で、4番目の引数は、結合しているモデルの外部キー名です:</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Role</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;role_user&#39;</span><span class="p">,</span> <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="s1">&#39;role_id&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="many-to-many-defining-the-inverse-of-the-relationship"></a></p>
<h4 id="_15">リレーションの逆の定義<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h4>
<p>多対多リレーションの「逆」を定義するには、関連モデルにも <code>belongsToMany</code> メソッドの結果を返すメソッドを定義する必要があります。ユーザー / ロールの例を完了するために、<code>Role</code> モデルに <code>users</code> メソッドを定義しましょう:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\BelongsToMany</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Role</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * ロールに属するユーザー。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">users</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsToMany</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>ご覧のとおり、リレーションは <code>User</code> モデルの対応物とまったく同じように定義されていますが、<code>App\Models\User</code> モデルを参照する点が異なります。<code>belongsToMany</code> メソッドを再利用しているため、多対多リレーションの「逆」を定義するときに、すべての通常のテーブルとキーのカスタマイズオプションを利用できます。</p>
<p><a name="retrieving-intermediate-table-columns"></a></p>
<h3 id="_16">中間テーブルの列の取得<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>すでに学んだように、多対多の関係を操作するには中間テーブルが必要です。Eloquent はこのテーブルと対話するための非常に便利な方法をいくつか提供しています。たとえば、<code>User</code> モデルが関連する多くの <code>Role</code> モデルを持っているとします。この関係にアクセスした後、モデルの <code>pivot</code> 属性を使用して中間テーブルにアクセスできます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>

<span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span> <span class="k">as</span> <span class="nv">$role</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$role</span><span class="o">-&gt;</span><span class="na">pivot</span><span class="o">-&gt;</span><span class="na">created_at</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>取得した各 <code>Role</code> モデルには自動的に <code>pivot</code> 属性が割り当てられていることに注意してください。この属性には中間テーブルを表すモデルが含まれています。</p>
<p>デフォルトでは、<code>pivot</code> モデルにはモデルキーのみが存在します。中間テーブルに追加の属性が含まれている場合は、リレーションを定義するときにそれらを指定する必要があります:</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Role</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">withPivot</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;created_by&#39;</span><span class="p">);</span>
</code></pre></div>
<p>中間テーブルに Eloquent によって自動的に維持される <code>created_at</code> と <code>updated_at</code> のタイムスタンプを持たせたい場合は、リレーションを定義するときに <code>withTimestamps</code> メソッドを呼び出します:</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Role</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">withTimestamps</span><span class="p">();</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Eloquent の自動的に維持されるタイムスタンプを利用する中間テーブルには、<code>created_at</code> と <code>updated_at</code> のタイムスタンプ列の両方が必要です。</p>
</div>
<p><a name="customizing-the-pivot-attribute-name"></a></p>
<h4 id="pivot"><code>pivot</code> 属性名のカスタマイズ<a class="headerlink" href="#pivot" title="Permanent link">&para;</a></h4>
<p>前述のように、中間テーブルの属性は <code>pivot</code> 属性を介してモデルでアクセスできます。ただし、この属性の名前をアプリケーション内での目的をよりよく反映するように自由にカスタマイズできます。</p>
<p>たとえば、アプリケーションにポッドキャストを購読できるユーザーが含まれている場合、ユーザーとポッドキャストの間に多対多の関係がある可能性があります。この場合、中間テーブルの属性を <code>pivot</code> ではなく <code>subscription</code> に名前を変更したい場合があります。これは、リレーションを定義するときに <code>as</code> メソッドを使用して行うことができます:</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Podcast</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">as</span><span class="p">(</span><span class="s1">&#39;subscription&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">withTimestamps</span><span class="p">();</span>
</code></pre></div>
<p>カスタム中間テーブル属性を指定したら、カスタマイズされた名前を使用して中間テーブルデータにアクセスできます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$users</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;podcasts&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$users</span><span class="o">-&gt;</span><span class="na">flatMap</span><span class="o">-&gt;</span><span class="na">podcasts</span> <span class="k">as</span> <span class="nv">$podcast</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$podcast</span><span class="o">-&gt;</span><span class="na">subscription</span><span class="o">-&gt;</span><span class="na">created_at</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a name="filtering-queries-via-intermediate-table-columns"></a></p>
<h3 id="_17">中間テーブルの列を介したクエリのフィルタリング<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p><code>belongsToMany</code> リレーションクエリによって返される結果をフィルタリングするために、リレーションを定義するときに <code>wherePivot</code>、<code>wherePivotIn</code>、<code>wherePivotNotIn</code>、<code>wherePivotBetween</code>、<code>wherePivotNotBetween</code>、<code>wherePivotNull</code>、および <code>wherePivotNotNull</code> メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Role</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">wherePivot</span><span class="p">(</span><span class="s1">&#39;approved&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Role</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">wherePivotIn</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]);</span>

<span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Role</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">wherePivotNotIn</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]);</span>

<span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Podcast</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">as</span><span class="p">(</span><span class="s1">&#39;subscriptions&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">wherePivotBetween</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;2020-01-01 00:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31 00:00:00&#39;</span><span class="p">]);</span>

<span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Podcast</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">as</span><span class="p">(</span><span class="s1">&#39;subscriptions&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">wherePivotNotBetween</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;2020-01-01 00:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-12-31 00:00:00&#39;</span><span class="p">]);</span>

<span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Podcast</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">as</span><span class="p">(</span><span class="s1">&#39;subscriptions&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">wherePivotNull</span><span class="p">(</span><span class="s1">&#39;expired_at&#39;</span><span class="p">);</span>

<span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Podcast</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">as</span><span class="p">(</span><span class="s1">&#39;subscriptions&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">wherePivotNotNull</span><span class="p">(</span><span class="s1">&#39;expired_at&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="ordering-queries-via-intermediate-table-columns"></a></p>
<h3 id="_18">中間テーブルの列を介したクエリの並べ替え<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p><code>belongsToMany</code> リレーションクエリによって返される結果を並べ替えるために、<code>orderByPivot</code> メソッドを使用できます。次の例では、ユーザーの最新のバッジをすべて取得します:</p>
<div class="highlight"><pre><span></span><code><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">Badge</span><span class="o">::</span><span class="na">class</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;gold&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">orderByPivot</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="defining-custom-intermediate-table-models"></a></p>
<h3 id="_19">カスタム中間テーブルモデルの定義<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<p>多対多リレーションの中間テーブルを表すためにカスタムモデルを定義したい場合は、リレーションを定義するときに <code>using</code> メソッドを呼び出すことができます。カスタムピボットモデルを使用すると、ピボットモデルに追加の動作を定義する機会が得られます。</p>
<p>カスタム多対多ピボットモデルは <code>Illuminate\Database\Eloquent\Relations\Pivot</code> クラスを拡張する必要がありますが、カスタムポリモーフィック多対多ピボットモデルは <code>Illuminate\Database\Eloquent\Relations\MorphPivot</code> クラスを拡張する必要があります。たとえば、カスタム <code>RoleUser</code> ピボットモデルを使用する <code>Role</code> モデルを定義できます:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\BelongsToMany</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Role</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * ロールに属するユーザー。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">users</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsToMany</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsToMany</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">using</span><span class="p">(</span><span class="nx">RoleUser</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><code>RoleUser</code> モデルを定義するときは、<code>Illuminate\Database\Eloquent\Relations\Pivot</code> クラスを拡張する必要があります:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\Pivot</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RoleUser</span> <span class="k">extends</span> <span class="nx">Pivot</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>ピボットモデルは <code>SoftDeletes</code> トレイトを使用できません。ピボットレコードをソフトデリートする必要がある場合は、ピボットモデルを実際の Eloquent モデルに変換することを検討してください。</p>
</div>
<p><a name="custom-pivot-models-and-incrementing-ids"></a></p>
<h4 id="id">カスタムピボットモデルとインクリメントID<a class="headerlink" href="#id" title="Permanent link">&para;</a></h4>
<p>カスタムピボットモデルを使用する多対多リレーションを定義し、そのピボットモデルに自動インクリメントプライマリキーがある場合は、カスタムピボットモデルクラスに <code>incrementing</code> プロパティを <code>true</code> に設定する必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="sd">/**</span>
<span class="sd"> * ID が自動インクリメントされるかどうかを示します。</span>
<span class="sd"> *</span>
<span class="sd"> * @var bool</span>
<span class="sd"> */</span>
<span class="k">public</span> <span class="nv">$incrementing</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
</code></pre></div>
<p><a name="polymorphic-relationships"></a></p>
<h2 id="_20">ポリモーフィックリレーションシップ<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h2>
<p>ポリモーフィックリレーションシップにより、子モデルは単一の関連付けを使用して複数のタイプのモデルに属することができます。たとえば、ブログ投稿とビデオを共有するアプリケーションを構築しているとします。このようなアプリケーションでは、<code>Comment</code> モデルが <code>Post</code> モデルと <code>Video</code> モデルの両方に属することができます。</p>
<p><a name="one-to-one-polymorphic-relations"></a></p>
<h3 id="_21">一対一 (ポリモーフィック)<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p><a name="one-to-one-polymorphic-table-structure"></a></p>
<h4 id="_22">テーブル構造<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h4>
<p>一対一のポリモーフィックリレーションは、通常の一対一のリレーションに似ています。ただし、子モデルは単一の関連付けを使用して複数のタイプのモデルに属することができます。たとえば、ブログ <code>Post</code> と <code>User</code> が <code>Image</code> モデルへのポリモーフィックリレーションを共有するとします。一対一のポリモーフィックリレーションを使用すると、投稿とユーザーに関連付けられた一意の画像の単一のテーブルを持つことができます。まず、テーブル構造を見てみましょう:</p>
<div class="highlight"><pre><span></span><code><span class="nx">posts</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>

<span class="nx">users</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>

<span class="nx">images</span>
    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">url</span> <span class="o">-</span> <span class="nx">string</span>
    <span class="nx">imageable_id</span> <span class="o">-</span> <span class="nx">integer</span>
    <span class="nx">imageable_type</span> <span class="o">-</span> <span class="nx">string</span>
</code></pre></div>
<p><code>images</code> テーブルの <code>imageable_id</code> と <code>imageable_type</code> カラムに注目してください。<code>imageable_id</code> カラムには投稿やユーザーのID値が格納され、<code>imageable_type</code> カラムには親モデルのクラス名が格納されます。Eloquentは <code>imageable_type</code> カラムを使用して、<code>imageable</code> リレーションにアクセスする際にどの「タイプ」の親モデルを返すかを決定します。この場合、カラムには <code>App\Models\Post</code> または <code>App\Models\User</code> が格納されます。</p>
<p><a name="one-to-one-polymorphic-model-structure"></a></p>
<h4 id="_23">モデル構造<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h4>
<p>次に、このリレーションを構築するために必要なモデル定義を見てみましょう：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphTo</span><span class="p">;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="k">class</span> <span class="nc">Image</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="p">{</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="sd">     * 親の imageable モデル（ユーザーまたは投稿）を取得します。</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="sd">     */</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">imageable</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphTo</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>    <span class="p">{</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphTo</span><span class="p">();</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>    <span class="p">}</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="p">}</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphOne</span><span class="p">;</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="k">class</span> <span class="nc">Post</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="p">{</span>
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>    <span class="sd">/**</span>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="sd">     * 投稿の画像を取得します。</span>
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="sd">     */</span>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">image</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphOne</span>
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>    <span class="p">{</span>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphOne</span><span class="p">(</span><span class="nx">Image</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;imageable&#39;</span><span class="p">);</span>
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>    <span class="p">}</span>
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a><span class="p">}</span>
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphOne</span><span class="p">;</span>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a><span class="p">{</span>
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>    <span class="sd">/**</span>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a><span class="sd">     * ユーザーの画像を取得します。</span>
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a><span class="sd">     */</span>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">image</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphOne</span>
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>    <span class="p">{</span>
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphOne</span><span class="p">(</span><span class="nx">Image</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;imageable&#39;</span><span class="p">);</span>
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>    <span class="p">}</span>
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a><span class="p">}</span>
</code></pre></div>
<p><a name="one-to-one-polymorphic-retrieving-the-relationship"></a></p>
<h4 id="_24">リレーションの取得<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h4>
<p>データベーステーブルとモデルが定義されたら、モデルを介してリレーションにアクセスできます。例えば、投稿の画像を取得するには、<code>image</code> 動的リレーションプロパティにアクセスします：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="nv">$image</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">image</span><span class="p">;</span>
</code></pre></div>
<p>ポリモーフィックモデルの親を取得するには、<code>morphTo</code> を呼び出すメソッドの名前にアクセスします。この場合、<code>Image</code> モデルの <code>imageable</code> メソッドです。そのメソッドを動的リレーションプロパティとしてアクセスします：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">use</span> <span class="nx">App\Models\Image</span><span class="p">;</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="nv">$image</span> <span class="o">=</span> <span class="nx">Image</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="nv">$imageable</span> <span class="o">=</span> <span class="nv">$image</span><span class="o">-&gt;</span><span class="na">imageable</span><span class="p">;</span>
</code></pre></div>
<p><code>Image</code> モデルの <code>imageable</code> リレーションは、画像を所有するモデルのタイプに応じて、<code>Post</code> または <code>User</code> インスタンスを返します。</p>
<p><a name="morph-one-to-one-key-conventions"></a></p>
<h4 id="_25">キーの規約<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h4>
<p>必要に応じて、ポリモーフィック子モデルによって使用される「id」と「type」カラムの名前を指定できます。その場合、<code>morphTo</code> メソッドにリレーションの名前を最初の引数として常に渡してください。通常、この値はメソッド名と一致する必要があるため、PHPの <code>__FUNCTION__</code> 定数を使用できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="sd">/**</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="sd"> * 画像が属するモデルを取得します。</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="sd"> */</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">imageable</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphTo</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="p">{</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphTo</span><span class="p">(</span><span class="no">__FUNCTION__</span><span class="p">,</span> <span class="s1">&#39;imageable_type&#39;</span><span class="p">,</span> <span class="s1">&#39;imageable_id&#39;</span><span class="p">);</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="p">}</span>
</code></pre></div>
<p><a name="one-to-many-polymorphic-relations"></a></p>
<h3 id="_26">一対多（ポリモーフィック）<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h3>
<p><a name="one-to-many-polymorphic-table-structure"></a></p>
<h4 id="_27">テーブル構造<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h4>
<p>一対多のポリモーフィックリレーションは、通常の一対多のリレーションと似ていますが、子モデルは単一の関連付けを使用して複数のタイプのモデルに属することができます。例えば、アプリケーションのユーザーが投稿やビデオに「コメント」できると想像してください。ポリモーフィックリレーションを使用すると、投稿とビデオの両方にコメントを含むために単一の <code>comments</code> テーブルを使用できます。まず、このリレーションを構築するために必要なテーブル構造を見てみましょう：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="nx">posts</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>    <span class="nx">title</span> <span class="o">-</span> <span class="nx">string</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>    <span class="nx">body</span> <span class="o">-</span> <span class="nx">text</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="nx">videos</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>    <span class="nx">title</span> <span class="o">-</span> <span class="nx">string</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>    <span class="nx">url</span> <span class="o">-</span> <span class="nx">string</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="nx">comments</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>    <span class="nx">body</span> <span class="o">-</span> <span class="nx">text</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>    <span class="nx">commentable_id</span> <span class="o">-</span> <span class="nx">integer</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>    <span class="nx">commentable_type</span> <span class="o">-</span> <span class="nx">string</span>
</code></pre></div>
<p><a name="one-to-many-polymorphic-model-structure"></a></p>
<h4 id="_28">モデル構造<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h4>
<p>次に、このリレーションを構築するために必要なモデル定義を見てみましょう：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphTo</span><span class="p">;</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="k">class</span> <span class="nc">Comment</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="p">{</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="sd">     * 親の commentable モデル（投稿またはビデオ）を取得します。</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="sd">     */</span>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">commentable</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphTo</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>    <span class="p">{</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphTo</span><span class="p">();</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>    <span class="p">}</span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="p">}</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a>
<a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphMany</span><span class="p">;</span>
<a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a>
<a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="k">class</span> <span class="nc">Post</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="p">{</span>
<a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a>    <span class="sd">/**</span>
<a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="sd">     * 投稿のすべてのコメントを取得します。</span>
<a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="sd">     */</span>
<a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">comments</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphMany</span>
<a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a>    <span class="p">{</span>
<a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphMany</span><span class="p">(</span><span class="nx">Comment</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;commentable&#39;</span><span class="p">);</span>
<a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a>    <span class="p">}</span>
<a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="p">}</span>
<a id="__codelineno-27-32" name="__codelineno-27-32" href="#__codelineno-27-32"></a>
<a id="__codelineno-27-33" name="__codelineno-27-33" href="#__codelineno-27-33"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-27-34" name="__codelineno-27-34" href="#__codelineno-27-34"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphMany</span><span class="p">;</span>
<a id="__codelineno-27-35" name="__codelineno-27-35" href="#__codelineno-27-35"></a>
<a id="__codelineno-27-36" name="__codelineno-27-36" href="#__codelineno-27-36"></a><span class="k">class</span> <span class="nc">Video</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-27-37" name="__codelineno-27-37" href="#__codelineno-27-37"></a><span class="p">{</span>
<a id="__codelineno-27-38" name="__codelineno-27-38" href="#__codelineno-27-38"></a>    <span class="sd">/**</span>
<a id="__codelineno-27-39" name="__codelineno-27-39" href="#__codelineno-27-39"></a><span class="sd">     * ビデオのすべてのコメントを取得します。</span>
<a id="__codelineno-27-40" name="__codelineno-27-40" href="#__codelineno-27-40"></a><span class="sd">     */</span>
<a id="__codelineno-27-41" name="__codelineno-27-41" href="#__codelineno-27-41"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">comments</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphMany</span>
<a id="__codelineno-27-42" name="__codelineno-27-42" href="#__codelineno-27-42"></a>    <span class="p">{</span>
<a id="__codelineno-27-43" name="__codelineno-27-43" href="#__codelineno-27-43"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphMany</span><span class="p">(</span><span class="nx">Comment</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;commentable&#39;</span><span class="p">);</span>
<a id="__codelineno-27-44" name="__codelineno-27-44" href="#__codelineno-27-44"></a>    <span class="p">}</span>
<a id="__codelineno-27-45" name="__codelineno-27-45" href="#__codelineno-27-45"></a><span class="p">}</span>
</code></pre></div>
<p><a name="one-to-many-polymorphic-retrieving-the-relationship"></a></p>
<h4 id="_29">リレーションの取得<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h4>
<p>データベーステーブルとモデルが定義されたら、モデルの動的リレーションプロパティを介してリレーションにアクセスできます。例えば、投稿のすべてのコメントにアクセスするには、<code>comments</code> 動的プロパティを使用します：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span> <span class="k">as</span> <span class="nv">$comment</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>    <span class="c1">// ...</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="p">}</span>
</code></pre></div>
<p>ポリモーフィック子モデルの親を取得するには、<code>morphTo</code> を呼び出すメソッドの名前にアクセスします。この場合、<code>Comment</code> モデルの <code>commentable</code> メソッドです。そのメソッドを動的リレーションプロパティとしてアクセスして、コメントの親モデルにアクセスします：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">use</span> <span class="nx">App\Models\Comment</span><span class="p">;</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="nv">$comment</span> <span class="o">=</span> <span class="nx">Comment</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="nv">$commentable</span> <span class="o">=</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">commentable</span><span class="p">;</span>
</code></pre></div>
<p><code>Comment</code> モデルの <code>commentable</code> リレーションは、コメントの親モデルのタイプに応じて、<code>Post</code> または <code>Video</code> インスタンスを返します。</p>
<p><a name="polymorphic-automatically-hydrating-parent-models-on-children"></a></p>
<h4 id="_30">子モデルに親モデルを自動的にハイドレート<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h4>
<p>Eloquent の eager loading を利用しても、子モデルをループしながら親モデルにアクセスしようとすると、「N + 1」クエリ問題が発生する可能性があります：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$posts</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span> <span class="k">as</span> <span class="nv">$comment</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a>        <span class="k">echo</span> <span class="nv">$comment</span><span class="o">-&gt;</span><span class="na">commentable</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">;</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a>    <span class="p">}</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="p">}</span>
</code></pre></div>
<p>上記の例では、「N + 1」クエリ問題が発生しています。なぜなら、すべての <code>Post</code> モデルに対してコメントが eager loaded されていますが、Eloquent は自動的に各子 <code>Comment</code> モデルに親 <code>Post</code> をハイドレートしないためです。</p>
<p>Eloquent に親モデルを子モデルに自動的にハイドレートさせたい場合、<code>hasMany</code> リレーションを定義する際に <code>chaperone</code> メソッドを呼び出すことができます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">class</span> <span class="nc">Post</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="p">{</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>    <span class="sd">/**</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="sd">     * 投稿のすべてのコメントを取得します。</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="sd">     */</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">comments</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphMany</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>    <span class="p">{</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphMany</span><span class="p">(</span><span class="nx">Comment</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;commentable&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">chaperone</span><span class="p">();</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>    <span class="p">}</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="p">}</span>
</code></pre></div>
<p>または、実行時に親モデルの自動ハイドレートをオプトインする場合、リレーションを eager loading する際に <code>chaperone</code> メソッドを呼び出すことができます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">with</span><span class="p">([</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>    <span class="s1">&#39;comments&#39;</span> <span class="o">=&gt;</span> <span class="nx">fn</span> <span class="p">(</span><span class="nv">$comments</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">$comments</span><span class="o">-&gt;</span><span class="na">chaperone</span><span class="p">(),</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="p">])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="one-of-many-polymorphic-relations"></a></p>
<h3 id="_31">多対一（ポリモーフィック）<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h3>
<p>モデルが多くの関連モデルを持つ場合がありますが、リレーションの「最新」または「最古」の関連モデルと簡単にやり取りしたい場合があります。例えば、<code>User</code> モデルは多くの <code>Image</code> モデルに関連しているかもしれませんが、ユーザーがアップロードした最新の画像と簡単にやり取りする方法を定義したい場合があります。<code>morphOne</code> リレーションタイプと <code>ofMany</code> メソッドを組み合わせてこれを実現できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="sd">/**</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="sd"> * ユーザーの最新の画像を取得します。</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="sd"> */</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">latestImage</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphOne</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="p">{</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphOne</span><span class="p">(</span><span class="nx">Image</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;imageable&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">latestOfMany</span><span class="p">();</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="p">}</span>
</code></pre></div>
<p>同様に、リレーションの「最古」または最初の関連モデルを取得するメソッドを定義できます：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="sd">/**</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="sd"> * ユーザーの最古の画像を取得します。</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="sd"> */</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">oldestImage</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphOne</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="p">{</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphOne</span><span class="p">(</span><span class="nx">Image</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;imageable&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">oldestOfMany</span><span class="p">();</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="p">}</span>
</code></pre></div>
<p>デフォルトでは、<code>latestOfMany</code> および <code>oldestOfMany</code> メソッドは、モデルの主キーに基づいて最新または最古の関連モデルを取得します。これはソート可能である必要があります。ただし、異なるソート基準を使用してより大きなリレーションから単一のモデルを取得したい場合があります。</p>
<p>例えば、<code>ofMany</code> メソッドを使用して、ユーザーの最も「いいね」された画像を取得できます。<code>ofMany</code> メソッドは、ソート可能なカラムを最初の引数として受け取り、関連モデルをクエリする際に適用する集約関数（<code>min</code> または <code>max</code>）を受け取ります：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="sd">/**</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="sd"> * ユーザーの最も人気のある画像を取得します。</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="sd"> */</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">bestImage</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphOne</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="p">{</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphOne</span><span class="p">(</span><span class="nx">Image</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;imageable&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">ofMany</span><span class="p">(</span><span class="s1">&#39;likes&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">);</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>より高度な「多対一」リレーションを構築することも可能です。詳細については、<a href="#advanced-has-one-of-many-relationships">has one of many ドキュメント</a>を参照してください。</p>
</div>
<p><a name="many-to-many-polymorphic-relations"></a></p>
<h3 id="_32">多対多（ポリモーフィック）<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<p><a name="many-to-many-polymorphic-table-structure"></a></p>
<h4 id="_33">テーブル構造<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="nx">多対多のポリモーフィックリレーションは、「モルフ1」と「モルフ多」のリレーションよりも少し複雑です。例えば、</span><span class="sb">`Post`</span><span class="nx">モデルと</span><span class="sb">`Video`</span><span class="nx">モデルが</span><span class="sb">`Tag`</span><span class="nx">モデルとポリモーフィックリレーションを共有することができます。この状況で多対多のポリモーフィックリレーションを使用すると、アプリケーションは投稿やビデオに関連付けられる一意のタグの単一のテーブルを持つことができます。まず、このリレーションを構築するために必要なテーブル構造を見てみましょう。</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="sb">``</span><span class="err">`</span><span class="nx">plaintext</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="nx">posts</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a>    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="nx">videos</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a>    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="nx">tags</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a>    <span class="nx">id</span> <span class="o">-</span> <span class="nx">integer</span>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a>    <span class="nx">name</span> <span class="o">-</span> <span class="nx">string</span>
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a>
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="nx">taggables</span>
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a>    <span class="nx">tag_id</span> <span class="o">-</span> <span class="nx">integer</span>
<a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a>    <span class="nx">taggable_id</span> <span class="o">-</span> <span class="nx">integer</span>
<a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a>    <span class="nx">taggable_type</span> <span class="o">-</span> <span class="nx">string</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>ポリモーフィックな多対多リレーションに飛び込む前に、通常の<a href="#many-to-many">多対多リレーション</a>に関するドキュメントを読むことで恩恵を受けるかもしれません。</p>
</div>
<p><a name="many-to-many-polymorphic-model-structure"></a></p>
<h4 id="_34">モデル構造<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h4>
<p>次に、モデルにリレーションを定義する準備が整いました。<code>Post</code>モデルと<code>Video</code>モデルは、どちらも<code>tags</code>メソッドを持ち、これはEloquentモデルクラスが提供する<code>morphToMany</code>メソッドを呼び出します。</p>
<p><code>morphToMany</code>メソッドは、関連モデルの名前と「リレーション名」を受け取ります。中間テーブル名とそれに含まれるキーに基づいて、リレーションを「taggable」と呼ぶことにします。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphToMany</span><span class="p">;</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="k">class</span> <span class="nc">Post</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="p">{</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="sd">     * 投稿のすべてのタグを取得する。</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="sd">     */</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">tags</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphToMany</span>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a>    <span class="p">{</span>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphToMany</span><span class="p">(</span><span class="nx">Tag</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;taggable&#39;</span><span class="p">);</span>
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a>    <span class="p">}</span>
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="p">}</span>
</code></pre></div>
<p><a name="many-to-many-polymorphic-defining-the-inverse-of-the-relationship"></a></p>
<h4 id="_35">リレーションの逆の定義<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h4>
<p>次に、<code>Tag</code>モデルで、可能な親モデルごとにメソッドを定義する必要があります。この例では、<code>posts</code>メソッドと<code>videos</code>メソッドを定義します。これらのメソッドは、<code>morphedByMany</code>メソッドの結果を返す必要があります。</p>
<p><code>morphedByMany</code>メソッドは、関連モデルの名前と「リレーション名」を受け取ります。中間テーブル名とそれに含まれるキーに基づいて、リレーションを「taggable」と呼ぶことにします。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphToMany</span><span class="p">;</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="k">class</span> <span class="nc">Tag</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="p">{</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="sd">     * このタグが割り当てられているすべての投稿を取得する。</span>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="sd">     */</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">posts</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphToMany</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a>    <span class="p">{</span>
<a id="__codelineno-38-15" name="__codelineno-38-15" href="#__codelineno-38-15"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphedByMany</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;taggable&#39;</span><span class="p">);</span>
<a id="__codelineno-38-16" name="__codelineno-38-16" href="#__codelineno-38-16"></a>    <span class="p">}</span>
<a id="__codelineno-38-17" name="__codelineno-38-17" href="#__codelineno-38-17"></a>
<a id="__codelineno-38-18" name="__codelineno-38-18" href="#__codelineno-38-18"></a>    <span class="sd">/**</span>
<a id="__codelineno-38-19" name="__codelineno-38-19" href="#__codelineno-38-19"></a><span class="sd">     * このタグが割り当てられているすべてのビデオを取得する。</span>
<a id="__codelineno-38-20" name="__codelineno-38-20" href="#__codelineno-38-20"></a><span class="sd">     */</span>
<a id="__codelineno-38-21" name="__codelineno-38-21" href="#__codelineno-38-21"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">videos</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphToMany</span>
<a id="__codelineno-38-22" name="__codelineno-38-22" href="#__codelineno-38-22"></a>    <span class="p">{</span>
<a id="__codelineno-38-23" name="__codelineno-38-23" href="#__codelineno-38-23"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphedByMany</span><span class="p">(</span><span class="nx">Video</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;taggable&#39;</span><span class="p">);</span>
<a id="__codelineno-38-24" name="__codelineno-38-24" href="#__codelineno-38-24"></a>    <span class="p">}</span>
<a id="__codelineno-38-25" name="__codelineno-38-25" href="#__codelineno-38-25"></a><span class="p">}</span>
</code></pre></div>
<p><a name="many-to-many-polymorphic-retrieving-the-relationship"></a></p>
<h4 id="_36">リレーションの取得<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h4>
<p>データベーステーブルとモデルが定義されたら、モデルを介してリレーションにアクセスできます。例えば、投稿のすべてのタグにアクセスするには、<code>tags</code>動的リレーションプロパティを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">tags</span> <span class="k">as</span> <span class="nv">$tag</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>    <span class="c1">// ...</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="p">}</span>
</code></pre></div>
<p>ポリモーフィックな子モデルからポリモーフィックリレーションの親を取得するには、<code>morphedByMany</code>を呼び出すメソッドの名前にアクセスします。この場合、<code>Tag</code>モデルの<code>posts</code>メソッドまたは<code>videos</code>メソッドです。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">use</span> <span class="nx">App\Models\Tag</span><span class="p">;</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="nv">$tag</span> <span class="o">=</span> <span class="nx">Tag</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$tag</span><span class="o">-&gt;</span><span class="na">posts</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>    <span class="c1">// ...</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="p">}</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$tag</span><span class="o">-&gt;</span><span class="na">videos</span> <span class="k">as</span> <span class="nv">$video</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>    <span class="c1">// ...</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="p">}</span>
</code></pre></div>
<p><a name="custom-polymorphic-types"></a></p>
<h3 id="_37">カスタムポリモーフィックタイプ<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h3>
<p>デフォルトでは、Laravelは関連モデルの完全修飾クラス名を使用して「タイプ」を保存します。例えば、上記の1対多のリレーションの例では、<code>Comment</code>モデルが<code>Post</code>または<code>Video</code>モデルに属する可能性があり、デフォルトの<code>commentable_type</code>はそれぞれ<code>App\Models\Post</code>または<code>App\Models\Video</code>になります。ただし、アプリケーションの内部構造からこれらの値を切り離したい場合があります。</p>
<p>例えば、モデル名を「タイプ」として使用する代わりに、<code>post</code>や<code>video</code>のような単純な文字列を使用することができます。これにより、モデルがリネームされても、データベース内のポリモーフィック「タイプ」列の値は有効なままです。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\Relation</span><span class="p">;</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="nx">Relation</span><span class="o">::</span><span class="na">enforceMorphMap</span><span class="p">([</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a>    <span class="s1">&#39;post&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;App\Models\Post&#39;</span><span class="p">,</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a>    <span class="s1">&#39;video&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;App\Models\Video&#39;</span><span class="p">,</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="p">]);</span>
</code></pre></div>
<p><code>enforceMorphMap</code>メソッドは、<code>App\Providers\AppServiceProvider</code>クラスの<code>boot</code>メソッドで呼び出すか、別のサービスプロバイダを作成することができます。</p>
<p>実行時に特定のモデルのモルフアリアスを決定するには、モデルの<code>getMorphClass</code>メソッドを使用します。逆に、モルフアリアスに関連付けられた完全修飾クラス名を決定するには、<code>Relation::getMorphedModel</code>メソッドを使用します。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\Relation</span><span class="p">;</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="nv">$alias</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">getMorphClass</span><span class="p">();</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="nv">$class</span> <span class="o">=</span> <span class="nx">Relation</span><span class="o">::</span><span class="na">getMorphedModel</span><span class="p">(</span><span class="nv">$alias</span><span class="p">);</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>既存のアプリケーションに「モルフアリアスマップ」を追加する場合、データベース内のすべてのポリモーフィックな<code>*_type</code>列の値が完全修飾クラス名のままである場合、それらを「マップ」名に変換する必要があります。</p>
</div>
<p><a name="dynamic-relationships"></a></p>
<h3 id="_38">動的リレーション<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h3>
<p><code>resolveRelationUsing</code>メソッドを使用して、実行時にEloquentモデル間のリレーションを定義することができます。通常のアプリケーション開発では推奨されませんが、Laravelパッケージの開発では時々役立つことがあります。</p>
<p><code>resolveRelationUsing</code>メソッドは、最初の引数として目的のリレーション名を受け取ります。メソッドに渡される2番目の引数は、モデルインスタンスを受け取り、有効なEloquentリレーション定義を返すクロージャである必要があります。通常、動的リレーションは<a href="providers.html">サービスプロバイダ</a>の<code>boot</code>メソッド内で設定する必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">use</span> <span class="nx">App\Models\Order</span><span class="p">;</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="k">use</span> <span class="nx">App\Models\Customer</span><span class="p">;</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="nx">Order</span><span class="o">::</span><span class="na">resolveRelationUsing</span><span class="p">(</span><span class="s1">&#39;customer&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Order</span> <span class="nv">$orderModel</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>    <span class="k">return</span> <span class="nv">$orderModel</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">Customer</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="s1">&#39;customer_id&#39;</span><span class="p">);</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="p">});</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>動的リレーションを定義する場合、常にEloquentリレーションメソッドに明示的なキー名の引数を提供してください。</p>
</div>
<p><a name="querying-relations"></a></p>
<h2 id="_39">リレーションのクエリ<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h2>
<p>すべてのEloquentリレーションはメソッドを介して定義されるため、それらのメソッドを呼び出して、関連モデルを実際にクエリを実行せずにリレーションのインスタンスを取得できます。さらに、すべてのタイプのEloquentリレーションも<a href="queries.html">クエリビルダ</a>として機能し、リレーションクエリに制約を追加してから、最終的にデータベースに対してSQLクエリを実行できます。</p>
<p>例えば、<code>User</code>モデルが多くの<code>Post</code>モデルに関連付けられているブログアプリケーションを想像してみてください。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\HasMany</span><span class="p">;</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="p">{</span>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="sd">     * ユーザーのすべての投稿を取得する。</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="sd">     */</span>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">posts</span><span class="p">()</span><span class="o">:</span> <span class="nx">HasMany</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a>    <span class="p">{</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hasMany</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a>    <span class="p">}</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="p">}</span>
</code></pre></div>
<p><code>posts</code>リレーションをクエリし、リレーションに追加の制約を追加することができます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">posts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>リレーションにはLaravelの<a href="queries.html">クエリビルダ</a>の任意のメソッドを使用できるため、クエリビルダのドキュメントを確認して、利用可能なすべてのメソッドを学んでください。</p>
<p><a name="chaining-orwhere-clauses-after-relationships"></a></p>
<h4 id="orwhere">リレーションの後に<code>orWhere</code>句をチェーンする<a class="headerlink" href="#orwhere" title="Permanent link">&para;</a></h4>
<p>上記の例で示したように、リレーションに追加の制約を自由に追加できます。ただし、<code>orWhere</code>句をリレーションにチェーンする場合は注意が必要です。<code>orWhere</code>句は、リレーション制約と同じレベルで論理的にグループ化されます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">posts</span><span class="p">()</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>        <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>        <span class="o">-&gt;</span><span class="na">orWhere</span><span class="p">(</span><span class="s1">&#39;votes&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>        <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>上記の例では、次のSQLが生成されます。<code>or</code>句は、100以上の投票を持つ_任意の_投稿を返すようにクエリに指示します。クエリは特定のユーザーに制約されなくなります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="k">from</span><span class="w"> </span><span class="n">posts</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="k">where</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">votes</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100</span>
</code></pre></div>
<p>ほとんどの状況では、条件チェックを括弧で囲む<a href="queries.html#logical-grouping">論理グループ</a>を使用して、条件チェックをグループ化する必要があります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">posts</span><span class="p">()</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a>        <span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a>            <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a>                         <span class="o">-&gt;</span><span class="na">orWhere</span><span class="p">(</span><span class="s1">&#39;votes&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a>        <span class="p">})</span>
<a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a>        <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>上記の例では、次のSQLが生成されます。論理グループが制約を適切にグループ化し、クエリが特定のユーザーに制約されたままであることに注意してください。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="k">from</span><span class="w"> </span><span class="n">posts</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="k">where</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">active</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">votes</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>
<p><a name="relationship-methods-vs-dynamic-properties"></a></p>
<h3 id="vs">リレーションメソッド vs. 動的プロパティ<a class="headerlink" href="#vs" title="Permanent link">&para;</a></h3>
<p>Eloquentリレーションクエリに追加の制約を追加する必要がない場合、リレーションにプロパティとしてアクセスできます。例えば、<code>User</code>モデルと<code>Post</code>モデルを引き続き使用する場合、ユーザーのすべての投稿に次のようにアクセスできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="k">foreach</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">posts</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>    <span class="c1">// ...</span>
<a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="p">}</span>
</code></pre></div>
<p>動的なリレーションシッププロパティは「遅延読み込み」を行います。つまり、実際にアクセスしたときにのみリレーションシップデータを読み込みます。このため、開発者はしばしば<a href="#eager-loading">積極的な読み込み</a>を使用して、モデルを読み込んだ後にアクセスすることがわかっているリレーションシップを事前に読み込みます。積極的な読み込みは、モデルのリレーションシップを読み込むために実行する必要があるSQLクエリを大幅に削減します。</p>
<p><a name="querying-relationship-existence"></a></p>
<h3 id="_40">リレーションシップの存在をクエリする<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h3>
<p>モデルレコードを取得する際、リレーションシップの存在に基づいて結果を制限したい場合があります。たとえば、少なくとも1つのコメントがあるすべてのブログ投稿を取得したいとします。そのためには、リレーションシップの名前を<code>has</code>および<code>orHas</code>メソッドに渡すことができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>

<span class="c1">// 少なくとも1つのコメントがあるすべての投稿を取得する</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">has</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>さらに、演算子とカウント値を指定してクエリをカスタマイズすることもできます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 3つ以上のコメントがあるすべての投稿を取得する</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">has</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>ネストされた<code>has</code>ステートメントは、「ドット」記法を使用して構築できます。たとえば、少なくとも1つのコメントが少なくとも1つの画像を持つすべての投稿を取得することができます。</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 少なくとも1つのコメントが画像を持つ投稿を取得する</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">has</span><span class="p">(</span><span class="s1">&#39;comments.images&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>さらに強力な機能が必要な場合は、<code>whereHas</code>および<code>orWhereHas</code>メソッドを使用して、<code>has</code>クエリに追加のクエリ制約を定義することができます。たとえば、コメントの内容を検査することができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="c1">// 少なくとも1つのコメントがcode%のような単語を含む投稿を取得する</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">whereHas</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;code%&#39;</span><span class="p">);</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="c1">// 少なくとも10のコメントがcode%のような単語を含む投稿を取得する</span>
<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">whereHas</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;code%&#39;</span><span class="p">);</span>
<span class="p">},</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Eloquentは現在、データベースをまたいだリレーションシップの存在クエリをサポートしていません。リレーションシップは同じデータベース内に存在する必要があります。</p>
</div>
<p><a name="inline-relationship-existence-queries"></a></p>
<h4 id="_41">インラインリレーションシップの存在クエリ<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h4>
<p>リレーションシップの存在を単一の簡単なwhere条件でクエリする場合、<code>whereRelation</code>、<code>orWhereRelation</code>、<code>whereMorphRelation</code>、および<code>orWhereMorphRelation</code>メソッドを使用すると便利です。たとえば、承認されていないコメントを持つすべての投稿をクエリすることができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>

<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">whereRelation</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;is_approved&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>もちろん、クエリビルダーの<code>where</code>メソッドの呼び出しと同様に、演算子を指定することもできます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">whereRelation</span><span class="p">(</span>
    <span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="nx">now</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">subHour</span><span class="p">()</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="querying-relationship-absence"></a></p>
<h3 id="_42">リレーションシップの不在をクエリする<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h3>
<p>モデルレコードを取得する際、リレーションシップの不在に基づいて結果を制限したい場合があります。たとえば、コメントが<strong>ない</strong>すべてのブログ投稿を取得したいとします。そのためには、リレーションシップの名前を<code>doesntHave</code>および<code>orDoesntHave</code>メソッドに渡すことができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>

<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">doesntHave</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>さらに強力な機能が必要な場合は、<code>whereDoesntHave</code>および<code>orWhereDoesntHave</code>メソッドを使用して、<code>doesntHave</code>クエリに追加のクエリ制約を追加することができます。たとえば、コメントの内容を検査することができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">whereDoesntHave</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;code%&#39;</span><span class="p">);</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>「ドット」記法を使用して、ネストされたリレーションシップに対してクエリを実行することができます。たとえば、次のクエリはコメントがないすべての投稿を取得します。ただし、禁止されていない著者からのコメントを持つ投稿は結果に含まれます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">whereDoesntHave</span><span class="p">(</span><span class="s1">&#39;comments.author&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;banned&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="querying-morph-to-relationships"></a></p>
<h3 id="morph-to">Morph To リレーションシップのクエリ<a class="headerlink" href="#morph-to" title="Permanent link">&para;</a></h3>
<p>「morph to」リレーションシップの存在をクエリするために、<code>whereHasMorph</code>および<code>whereDoesntHaveMorph</code>メソッドを使用することができます。これらのメソッドは、最初の引数としてリレーションシップの名前を受け取ります。次に、クエリに含めたい関連モデルの名前を受け取ります。最後に、リレーションシップクエリをカスタマイズするクロージャを提供することができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Comment</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Models\Video</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="c1">// 投稿またはビデオに関連するコメントで、タイトルがcode%のようなものを取得する</span>
<span class="nv">$comments</span> <span class="o">=</span> <span class="nx">Comment</span><span class="o">::</span><span class="na">whereHasMorph</span><span class="p">(</span>
    <span class="s1">&#39;commentable&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nx">Video</span><span class="o">::</span><span class="na">class</span><span class="p">],</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;code%&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="c1">// 投稿に関連するコメントで、タイトルがcode%のようでないものを取得する</span>
<span class="nv">$comments</span> <span class="o">=</span> <span class="nx">Comment</span><span class="o">::</span><span class="na">whereDoesntHaveMorph</span><span class="p">(</span>
    <span class="s1">&#39;commentable&#39;</span><span class="p">,</span>
    <span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;code%&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>関連するポリモーフィックモデルの「タイプ」に基づいてクエリ制約を追加する必要がある場合があります。<code>whereHasMorph</code>メソッドに渡されるクロージャは、2番目の引数として<code>$type</code>値を受け取ることができます。この引数を使用して、構築されているクエリの「タイプ」を検査することができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="nv">$comments</span> <span class="o">=</span> <span class="nx">Comment</span><span class="o">::</span><span class="na">whereHasMorph</span><span class="p">(</span>
    <span class="s1">&#39;commentable&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nx">Video</span><span class="o">::</span><span class="na">class</span><span class="p">],</span>
    <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$type</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$column</span> <span class="o">=</span> <span class="nv">$type</span> <span class="o">===</span> <span class="nx">Post</span><span class="o">::</span><span class="na">class</span> <span class="o">?</span> <span class="s1">&#39;content&#39;</span> <span class="o">:</span> <span class="s1">&#39;title&#39;</span><span class="p">;</span>

        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="nv">$column</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;code%&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="querying-all-morph-to-related-models"></a></p>
<h4 id="_43">すべての関連モデルのクエリ<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h4>
<p>ポリモーフィックモデルの配列を渡す代わりに、ワイルドカード値として<code>*</code>を指定することができます。これにより、Laravelにデータベースからすべての可能なポリモーフィックタイプを取得するよう指示されます。Laravelはこの操作を実行するために追加のクエリを実行します。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="nv">$comments</span> <span class="o">=</span> <span class="nx">Comment</span><span class="o">::</span><span class="na">whereHasMorph</span><span class="p">(</span><span class="s1">&#39;commentable&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;foo%&#39;</span><span class="p">);</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="aggregating-related-models"></a></p>
<h2 id="_44">関連モデルの集約<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h2>
<p><a name="counting-related-models"></a></p>
<h3 id="_45">関連モデルのカウント<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>特定のリレーションシップの関連モデルの数をカウントしたい場合がありますが、実際にモデルを読み込む必要はありません。これを実現するために、<code>withCount</code>メソッドを使用することができます。<code>withCount</code>メソッドは、結果のモデルに<code>{relation}_count</code>属性を配置します。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>

<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">withCount</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$posts</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments_count</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>配列を<code>withCount</code>メソッドに渡すことで、複数のリレーションシップの「カウント」を追加し、クエリに追加の制約を追加することもできます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">withCount</span><span class="p">([</span><span class="s1">&#39;votes&#39;</span><span class="p">,</span> <span class="s1">&#39;comments&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;code%&#39;</span><span class="p">);</span>
<span class="p">}])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="k">echo</span> <span class="nv">$posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">votes_count</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">comments_count</span><span class="p">;</span>
</code></pre></div>
<p>リレーションシップのカウント結果に別名を付けることもできます。これにより、同じリレーションシップに対して複数のカウントを行うことができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">withCount</span><span class="p">([</span>
    <span class="s1">&#39;comments&#39;</span><span class="p">,</span>
    <span class="s1">&#39;comments as pending_comments_count&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;approved&#39;</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="k">echo</span> <span class="nv">$posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">comments_count</span><span class="p">;</span>
<span class="k">echo</span> <span class="nv">$posts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">pending_comments_count</span><span class="p">;</span>
</code></pre></div>
<p><a name="deferred-count-loading"></a></p>
<h4 id="_46">遅延カウント読み込み<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h4>
<p><code>loadCount</code>メソッドを使用すると、親モデルがすでに取得された後にリレーションシップのカウントを読み込むことができます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$book</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">first</span><span class="p">();</span>

<span class="nv">$book</span><span class="o">-&gt;</span><span class="na">loadCount</span><span class="p">(</span><span class="s1">&#39;genres&#39;</span><span class="p">);</span>
</code></pre></div>
<p>カウントクエリに追加のクエリ制約を設定する必要がある場合は、カウントしたいリレーションシップをキーとする配列を渡すことができます。配列の値は、クエリビルダーインスタンスを受け取るクロージャである必要があります。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$book</span><span class="o">-&gt;</span><span class="na">loadCount</span><span class="p">([</span><span class="s1">&#39;reviews&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;rating&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}])</span>
</code></pre></div>
<p><a name="relationship-counting-and-custom-select-statements"></a></p>
<h4 id="select">リレーションシップのカウントとカスタムselectステートメント<a class="headerlink" href="#select" title="Permanent link">&para;</a></h4>
<p><code>withCount</code>を<code>select</code>ステートメントと組み合わせる場合、<code>select</code>メソッドの後に<code>withCount</code>を呼び出すようにしてください。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">])</span>
                <span class="o">-&gt;</span><span class="na">withCount</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="other-aggregate-functions"></a></p>
<h3 id="_47">その他の集約関数<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p><code>withCount</code>メソッドに加えて、Eloquentは<code>withMin</code>、<code>withMax</code>、<code>withAvg</code>、<code>withSum</code>、および<code>withExists</code>メソッドを提供します。これらのメソッドは、結果のモデルに<code>{relation}_{function}_{column}</code>属性を配置します。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>

<span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">withSum</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;votes&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$posts</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments_sum_votes</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>集約関数の結果に別の名前を付けたい場合は、独自のエイリアスを指定することができます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">withSum</span><span class="p">(</span><span class="s1">&#39;comments as total_comments&#39;</span><span class="p">,</span> <span class="s1">&#39;votes&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$posts</span> <span class="k">as</span> <span class="nv">$post</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">total_comments</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><code>loadCount</code>メソッドと同様に、これらのメソッドの遅延バージョンも利用できます。これらの追加の集約操作は、すでに取得されたEloquentモデルに対して実行できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">first</span><span class="p">();</span>

<span class="nv">$post</span><span class="o">-&gt;</span><span class="na">loadSum</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">,</span> <span class="s1">&#39;votes&#39;</span><span class="p">);</span>
</code></pre></div>
<p>これらの集約メソッドを<code>select</code>ステートメントと組み合わせる場合、<code>select</code>メソッドの後に集約メソッドを呼び出すようにしてください。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$posts</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">select</span><span class="p">([</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">])</span>
                <span class="o">-&gt;</span><span class="na">withExists</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span>
                <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="counting-related-models-on-morph-to-relationships"></a></p>
<h3 id="morph-to_1">Morph To リレーションシップに関連するモデルのカウント<a class="headerlink" href="#morph-to_1" title="Permanent link">&para;</a></h3>
<p>「morph to」リレーションシップを一緒に読み込みたい場合、そのリレーションシップによって返される可能性のあるさまざまなエンティティの関連モデルのカウントも取得したい場合は、<code>with</code>メソッドと<code>morphTo</code>リレーションシップの<code>morphWithCount</code>メソッドを組み合わせて使用できます。</p>
<p>この例では、<code>Photo</code>モデルと<code>Post</code>モデルが<code>ActivityFeed</code>モデルを作成する可能性があるとします。<code>ActivityFeed</code>モデルは、<code>parentable</code>という「morph to」リレーションシップを定義しており、これにより特定の<code>ActivityFeed</code>インスタンスの親<code>Photo</code>または<code>Post</code>モデルを取得できます。さらに、<code>Photo</code>モデルは「多くの」<code>Tag</code>モデルを持ち、<code>Post</code>モデルは「多くの」<code>Comment</code>モデルを持つとします。</p>
<p>さて、<code>ActivityFeed</code>インスタンスを取得し、各<code>ActivityFeed</code>インスタンスの<code>parentable</code>親モデルを一緒に読み込みたいとします。さらに、各親フォトに関連付けられたタグの数と、各親投稿に関連付けられたコメントの数を取得したいとします。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphTo</span><span class="p">;</span>

<span class="nv">$activities</span> <span class="o">=</span> <span class="nx">ActivityFeed</span><span class="o">::</span><span class="na">with</span><span class="p">([</span>
    <span class="s1">&#39;parentable&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">MorphTo</span> <span class="nv">$morphTo</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$morphTo</span><span class="o">-&gt;</span><span class="na">morphWithCount</span><span class="p">([</span>
            <span class="nx">Photo</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span>
            <span class="nx">Post</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">],</span>
        <span class="p">]);</span>
    <span class="p">}])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="morph-to-deferred-count-loading"></a></p>
<h4 id="_48">遅延カウント読み込み<a class="headerlink" href="#_48" title="Permanent link">&para;</a></h4>
<p>すでに一連の<code>ActivityFeed</code>モデルを取得しており、現在はアクティビティフィードに関連付けられたさまざまな<code>parentable</code>モデルのネストされたリレーションシップのカウントを読み込みたいとします。これを実現するには、<code>loadMorphCount</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$activities</span> <span class="o">=</span> <span class="nx">ActivityFeed</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;parentable&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="nv">$activities</span><span class="o">-&gt;</span><span class="na">loadMorphCount</span><span class="p">(</span><span class="s1">&#39;parentable&#39;</span><span class="p">,</span> <span class="p">[</span>
    <span class="nx">Photo</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span>
    <span class="nx">Post</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;comments&#39;</span><span class="p">],</span>
<span class="p">]);</span>
</code></pre></div>
<p><a name="eager-loading"></a></p>
<h2 id="eager-loading">一緒に読み込み（Eager Loading）<a class="headerlink" href="#eager-loading" title="Permanent link">&para;</a></h2>
<p>Eloquentリレーションシップにプロパティとしてアクセスすると、関連するモデルは「遅延読み込み」されます。これは、プロパティに最初にアクセスするまでリレーションシップデータが実際に読み込まれないことを意味します。しかし、Eloquentは親モデルをクエリするときにリレーションシップを「一緒に読み込む」ことができます。一緒に読み込みは、「N + 1」クエリ問題を軽減します。N + 1クエリ問題を説明するために、<code>Book</code>モデルが<code>Author</code>モデルに「属する」と考えてみましょう。</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\BelongsTo</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 本を書いた著者を取得します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">author</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">Author</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>さて、すべての本とその著者を取得してみましょう。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Book</span><span class="p">;</span>

<span class="nv">$books</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">all</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$books</span> <span class="k">as</span> <span class="nv">$book</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$book</span><span class="o">-&gt;</span><span class="na">author</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>このループは、データベーステーブル内のすべての本を取得するために1つのクエリを実行し、次に各本の著者を取得するために別のクエリを実行します。したがって、25冊の本がある場合、上記のコードは26回のクエリを実行します。1つは元の本のクエリで、25回は各本の著者を取得するための追加のクエリです。</p>
<p>幸いなことに、一緒に読み込みを使用してこの操作を2つのクエリに減らすことができます。クエリを構築するときに、<code>with</code>メソッドを使用してどのリレーションシップを一緒に読み込むかを指定できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$books</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nv">$books</span> <span class="k">as</span> <span class="nv">$book</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nv">$book</span><span class="o">-&gt;</span><span class="na">author</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>この操作では、2つのクエリのみが実行されます。1つはすべての本を取得するためのクエリで、もう1つはすべての本の著者を取得するためのクエリです。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">books</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">authors</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</code></pre></div>
<p><a name="eager-loading-multiple-relationships"></a></p>
<h4 id="_49">複数のリレーションシップを一緒に読み込む<a class="headerlink" href="#_49" title="Permanent link">&para;</a></h4>
<p>時には、いくつかの異なるリレーションシップを一緒に読み込む必要があるかもしれません。その場合は、リレーションシップの配列を<code>with</code>メソッドに渡すだけです。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$books</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">with</span><span class="p">([</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="nested-eager-loading"></a></p>
<h4 id="_50">ネストされた一緒に読み込み<a class="headerlink" href="#_50" title="Permanent link">&para;</a></h4>
<p>リレーションシップのリレーションシップを一緒に読み込むには、「ドット」構文を使用できます。たとえば、すべての本の著者とすべての著者の個人連絡先を一緒に読み込むには、次のようにします。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$books</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;author.contacts&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>または、<code>with</code>メソッドにネストされた配列を提供することで、複数のネストされたリレーションシップを一緒に読み込むことができます。これは、複数のネストされたリレーションシップを一緒に読み込む場合に便利です。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$books</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">with</span><span class="p">([</span>
    <span class="s1">&#39;author&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">&#39;contacts&#39;</span><span class="p">,</span>
        <span class="s1">&#39;publisher&#39;</span><span class="p">,</span>
    <span class="p">],</span>
<span class="p">])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="nested-eager-loading-morphto-relationships"></a></p>
<h4 id="morphto">ネストされた一緒に読み込み <code>morphTo</code> リレーションシップ<a class="headerlink" href="#morphto" title="Permanent link">&para;</a></h4>
<p><code>morphTo</code>リレーションシップを一緒に読み込みたい場合、そのリレーションシップによって返される可能性のあるさまざまなエンティティのネストされたリレーションシップも一緒に読み込みたい場合は、<code>with</code>メソッドと<code>morphTo</code>リレーションシップの<code>morphWith</code>メソッドを組み合わせて使用できます。このメソッドを説明するために、次のモデルを考えてみましょう。</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphTo</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ActivityFeed</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * アクティビティフィードレコードの親を取得します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">parentable</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphTo</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphTo</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>この例では、<code>Event</code>、<code>Photo</code>、<code>Post</code>モデルが<code>ActivityFeed</code>モデルを作成する可能性があるとします。さらに、<code>Event</code>モデルは<code>Calendar</code>モデルに属し、<code>Photo</code>モデルは<code>Tag</code>モデルに関連付けられ、<code>Post</code>モデルは<code>Author</code>モデルに属するとします。</p>
<p>これらのモデル定義とリレーションシップを使用して、<code>ActivityFeed</code>モデルインスタンスを取得し、すべての<code>parentable</code>モデルとそれぞれのネストされたリレーションシップを一緒に読み込むことができます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphTo</span><span class="p">;</span>

<span class="nv">$activities</span> <span class="o">=</span> <span class="nx">ActivityFeed</span><span class="o">::</span><span class="na">query</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">with</span><span class="p">([</span><span class="s1">&#39;parentable&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">MorphTo</span> <span class="nv">$morphTo</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$morphTo</span><span class="o">-&gt;</span><span class="na">morphWith</span><span class="p">([</span>
            <span class="nx">Event</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;calendar&#39;</span><span class="p">],</span>
            <span class="nx">Photo</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span>
            <span class="nx">Post</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span>
        <span class="p">]);</span>
    <span class="p">}])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="eager-loading-specific-columns"></a></p>
<h4 id="_51">特定のカラムを一緒に読み込む<a class="headerlink" href="#_51" title="Permanent link">&para;</a></h4>
<p>取得するリレーションシップから常にすべてのカラムが必要なわけではないかもしれません。このため、Eloquentではリレーションシップから取得したいカラムを指定できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$books</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;author:id,name,book_id&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>この機能を使用する場合、常に<code>id</code>カラムと関連する外部キーカラムを取得したいカラムのリストに含める必要があります。</p>
</div>
<p><a name="eager-loading-by-default"></a></p>
<h4 id="_52">デフォルトで一緒に読み込む<a class="headerlink" href="#_52" title="Permanent link">&para;</a></h4>
<p>モデルを取得するときに常にいくつかのリレーションシップを読み込みたい場合があります。これを実現するには、モデルに<code>$with</code>プロパティを定義できます。</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\BelongsTo</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * 常に読み込まれるべきリレーションシップ。</span>
<span class="sd">     *</span>
<span class="sd">     * @var array</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$with</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">];</span>

    <span class="sd">/**</span>
<span class="sd">     * 本を書いた著者を取得します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">author</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">Author</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * 本のジャンルを取得します。</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">genre</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">Genre</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>単一のクエリで<code>$with</code>プロパティからアイテムを削除したい場合は、<code>without</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$books</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">without</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>単一のクエリで<code>$with</code>プロパティ内のすべてのアイテムを上書きしたい場合は、<code>withOnly</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$books</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">withOnly</span><span class="p">(</span><span class="s1">&#39;genre&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="constraining-eager-loads"></a></p>
<h3 id="_53">一緒に読み込みの制約<a class="headerlink" href="#_53" title="Permanent link">&para;</a></h3>
<p>時には、リレーションシップを一緒に読み込みたいが、一緒に読み込みクエリに追加のクエリ条件を指定したい場合があります。これを実現するには、リレーションシップ名をキーとし、一緒に読み込みクエリに追加の制約を追加するクロージャを値とする配列を<code>with</code>メソッドに渡します。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Contracts\Database\Eloquent\Builder</span><span class="p">;</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">with</span><span class="p">([</span><span class="s1">&#39;posts&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span><span class="p">,</span> <span class="s1">&#39;%code%&#39;</span><span class="p">);</span>
<span class="p">}])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>この例では、Eloquentは投稿の<code>title</code>カラムに<code>code</code>という単語を含む投稿のみを一緒に読み込みます。他の<a href="queries.html">クエリビルダ</a>メソッドを呼び出して、一緒に読み込み操作をさらにカスタマイズすることができます。</p>
<div class="highlight"><pre><span></span><code><span class="nv">$users</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">with</span><span class="p">([</span><span class="s1">&#39;posts&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">);</span>
<span class="p">}])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="constraining-eager-loading-of-morph-to-relationships"></a></p>
<h4 id="morphto_1"><code>morphTo</code> リレーションシップの一緒に読み込みの制約<a class="headerlink" href="#morphto_1" title="Permanent link">&para;</a></h4>
<p><code>morphTo</code>リレーションシップを一緒に読み込む場合、Eloquentは各タイプの関連モデルを取得するために複数のクエリを実行します。<code>MorphTo</code>リレーションシップの<code>constrain</code>メソッドを使用して、これらの各クエリに追加の制約を追加できます。</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphTo</span><span class="p">;</span>

<span class="nv">$comments</span> <span class="o">=</span> <span class="nx">Comment</span><span class="o">::</span><span class="na">with</span><span class="p">([</span><span class="s1">&#39;commentable&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">MorphTo</span> <span class="nv">$morphTo</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$morphTo</span><span class="o">-&gt;</span><span class="na">constrain</span><span class="p">([</span>
        <span class="nx">Post</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">whereNull</span><span class="p">(</span><span class="s1">&#39;hidden_at&#39;</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">Video</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;educational&#39;</span><span class="p">);</span>
        <span class="p">},</span>
    <span class="p">]);</span>
<span class="p">}])</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p>この例では、Eloquentは非表示になっていない投稿と<code>type</code>が"educational"の動画のみを積極的にロードします。</p>
<p><a name="constraining-eager-loads-with-relationship-existence"></a></p>
<h4 id="_54">リレーションの存在による積極的なロードの制約<a class="headerlink" href="#_54" title="Permanent link">&para;</a></h4>
<p>リレーションの存在をチェックしながら、同じ条件に基づいてリレーションをロードする必要がある場合があります。例えば、特定のクエリ条件に一致する子の<code>Post</code>モデルを持つ<code>User</code>モデルのみを取得し、同時に一致する投稿を積極的にロードしたい場合があります。これは<code>withWhereHas</code>メソッドを使用して実現できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>

<span class="nv">$users</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">withWhereHas</span><span class="p">(</span><span class="s1">&#39;posts&#39;</span><span class="p">,</span> <span class="k">function</span> <span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">&#39;featured&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="p">})</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</code></pre></div>
<p><a name="lazy-eager-loading"></a></p>
<h3 id="_55">遅延積極的ロード<a class="headerlink" href="#_55" title="Permanent link">&para;</a></h3>
<p>親モデルが既に取得された後にリレーションを積極的にロードする必要がある場合があります。例えば、関連モデルをロードするかどうかを動的に決定する場合に便利です:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Book</span><span class="p">;</span>

<span class="nv">$books</span> <span class="o">=</span> <span class="nx">Book</span><span class="o">::</span><span class="na">all</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$someCondition</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$books</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;publisher&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>積極的なロードクエリに追加のクエリ制約を設定する必要がある場合、ロードしたいリレーションをキーとする配列を渡すことができます。配列の値はクエリインスタンスを受け取るクロージャインスタンスであるべきです:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$author</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">([</span><span class="s1">&#39;books&#39;</span> <span class="o">=&gt;</span> <span class="k">function</span> <span class="p">(</span><span class="nx">Builder</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">orderBy</span><span class="p">(</span><span class="s1">&#39;published_date&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">);</span>
<span class="p">}]);</span>
</code></pre></div>
<p>リレーションがまだロードされていない場合にのみリレーションをロードするには、<code>loadMissing</code>メソッドを使用します:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$book</span><span class="o">-&gt;</span><span class="na">loadMissing</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a name="nested-lazy-eager-loading-morphto"></a></p>
<h4 id="morphto_2">ネストされた遅延積極的ロードと<code>morphTo</code><a class="headerlink" href="#morphto_2" title="Permanent link">&para;</a></h4>
<p><code>morphTo</code>リレーションを積極的にロードし、そのリレーションによって返される可能性のあるさまざまなエンティティのネストされたリレーションも積極的にロードしたい場合、<code>loadMorph</code>メソッドを使用できます。</p>
<p>このメソッドは、<code>morphTo</code>リレーションの名前を最初の引数として受け取り、モデル/リレーションのペアの配列を2番目の引数として受け取ります。このメソッドを説明するために、次のモデルを考えてみましょう:</p>
<div class="highlight"><pre><span></span><code><span class="o">&lt;?</span><span class="nx">php</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\MorphTo</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ActivityFeed</span> <span class="k">extends</span> <span class="nx">Model</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * Get the parent of the activity feed record.</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">parentable</span><span class="p">()</span><span class="o">:</span> <span class="nx">MorphTo</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">morphTo</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>この例では、<code>Event</code>、<code>Photo</code>、<code>Post</code>モデルが<code>ActivityFeed</code>モデルを作成する可能性があると仮定します。さらに、<code>Event</code>モデルは<code>Calendar</code>モデルに属し、<code>Photo</code>モデルは<code>Tag</code>モデルに関連付けられ、<code>Post</code>モデルは<code>Author</code>モデルに属していると仮定します。</p>
<p>これらのモデル定義とリレーションを使用して、<code>ActivityFeed</code>モデルインスタンスを取得し、すべての<code>parentable</code>モデルとそれらのネストされたリレーションを積極的にロードできます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$activities</span> <span class="o">=</span> <span class="nx">ActivityFeed</span><span class="o">::</span><span class="na">with</span><span class="p">(</span><span class="s1">&#39;parentable&#39;</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">get</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">loadMorph</span><span class="p">(</span><span class="s1">&#39;parentable&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="nx">Event</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;calendar&#39;</span><span class="p">],</span>
        <span class="nx">Photo</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;tags&#39;</span><span class="p">],</span>
        <span class="nx">Post</span><span class="o">::</span><span class="na">class</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span>
    <span class="p">]);</span>
</code></pre></div>
<p><a name="preventing-lazy-loading"></a></p>
<h3 id="_56">遅延ロードの防止<a class="headerlink" href="#_56" title="Permanent link">&para;</a></h3>
<p>前述のように、リレーションの積極的なロードは、アプリケーションのパフォーマンスに大きなメリットをもたらすことが多いです。したがって、Laravelにリレーションの遅延ロードを常に防止するよう指示することができます。これを実現するには、Eloquentモデルクラスが提供する<code>preventLazyLoading</code>メソッドを呼び出すことができます。通常、このメソッドはアプリケーションの<code>AppServiceProvider</code>クラスの<code>boot</code>メソッド内で呼び出すべきです。</p>
<p><code>preventLazyLoading</code>メソッドは、遅延ロードを防止するかどうかを示すオプションのブール引数を受け取ります。例えば、遅延ロードを非本番環境でのみ無効にしたい場合があります。これにより、本番環境は遅延ロードされたリレーションが誤って本番コードに含まれていても正常に機能し続けます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="sd">/**</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="sd"> * Bootstrap any application services.</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="sd"> */</span>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="k">public</span> <span class="k">function</span> <span class="nf">boot</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="p">{</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a>    <span class="nx">Model</span><span class="o">::</span><span class="na">preventLazyLoading</span><span class="p">(</span><span class="o">!</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">app</span><span class="o">-&gt;</span><span class="na">isProduction</span><span class="p">());</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="p">}</span>
</code></pre></div>
<p>遅延ロードを防止した後、アプリケーションがEloquentリレーションを遅延ロードしようとすると、<code>Illuminate\Database\LazyLoadingViolationException</code>例外がスローされます。</p>
<p><code>handleLazyLoadingViolationsUsing</code>メソッドを使用して、遅延ロード違反の動作をカスタマイズすることができます。例えば、このメソッドを使用して、遅延ロード違反が例外で中断される代わりにログに記録されるように指示することができます:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="nx">Model</span><span class="o">::</span><span class="na">handleLazyLoadingViolationUsing</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nx">Model</span> <span class="nv">$model</span><span class="p">,</span> <span class="nx">string</span> <span class="nv">$relation</span><span class="p">)</span> <span class="p">{</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>    <span class="nv">$class</span> <span class="o">=</span> <span class="nv">$model</span><span class="o">::</span><span class="na">class</span><span class="p">;</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>    <span class="nx">info</span><span class="p">(</span><span class="s2">&quot;Attempted to lazy load [</span><span class="si">{</span><span class="nv">$relation</span><span class="si">}</span><span class="s2">] on model [</span><span class="si">{</span><span class="nv">$class</span><span class="si">}</span><span class="s2">].&quot;</span><span class="p">);</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="p">});</span>
</code></pre></div>
<p><a name="inserting-and-updating-related-models"></a></p>
<h2 id="_57">関連モデルの挿入と更新<a class="headerlink" href="#_57" title="Permanent link">&para;</a></h2>
<p><a name="the-save-method"></a></p>
<h3 id="save"><code>save</code>メソッド<a class="headerlink" href="#save" title="Permanent link">&para;</a></h3>
<p>Eloquentは、リレーションに新しいモデルを追加するための便利なメソッドを提供します。例えば、投稿に新しいコメントを追加する必要がある場合です。<code>Comment</code>モデルに<code>post_id</code>属性を手動で設定する代わりに、リレーションの<code>save</code>メソッドを使用してコメントを挿入できます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Comment</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>

<span class="nv">$comment</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Comment</span><span class="p">([</span><span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;A new comment.&#39;</span><span class="p">]);</span>

<span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>
</code></pre></div>
<p>動的プロパティとして<code>comments</code>リレーションにアクセスするのではなく、<code>comments</code>メソッドを呼び出してリレーションのインスタンスを取得したことに注意してください。<code>save</code>メソッドは自動的に新しい<code>Comment</code>モデルに適切な<code>post_id</code>値を追加します。</p>
<p>複数の関連モデルを保存する必要がある場合、<code>saveMany</code>メソッドを使用できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">saveMany</span><span class="p">([</span>
    <span class="k">new</span> <span class="nx">Comment</span><span class="p">([</span><span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;A new comment.&#39;</span><span class="p">]),</span>
    <span class="k">new</span> <span class="nx">Comment</span><span class="p">([</span><span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Another new comment.&#39;</span><span class="p">]),</span>
<span class="p">]);</span>
</code></pre></div>
<p><code>save</code>および<code>saveMany</code>メソッドは、指定されたモデルインスタンスを永続化しますが、新しく永続化されたモデルを親モデルに既にロードされているメモリ内のリレーションに追加しません。<code>save</code>または<code>saveMany</code>メソッドを使用した後にリレーションにアクセスする予定がある場合、<code>refresh</code>メソッドを使用してモデルとそのリレーションを再読み込みすることができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$comment</span><span class="p">);</span>

<span class="nv">$post</span><span class="o">-&gt;</span><span class="na">refresh</span><span class="p">();</span>

<span class="c1">// 新しく保存されたコメントを含むすべてのコメント...</span>
<span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">;</span>
</code></pre></div>
<p><a name="the-push-method"></a></p>
<h4 id="_58">再帰的にモデルとリレーションを保存<a class="headerlink" href="#_58" title="Permanent link">&para;</a></h4>
<p>モデルとそのすべての関連リレーションを<code>save</code>したい場合、<code>push</code>メソッドを使用できます。この例では、<code>Post</code>モデルとそのコメント、およびコメントの著者が保存されます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">message</span> <span class="o">=</span> <span class="s1">&#39;Message&#39;</span><span class="p">;</span>
<span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="na">author</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="s1">&#39;Author Name&#39;</span><span class="p">;</span>

<span class="nv">$post</span><span class="o">-&gt;</span><span class="na">push</span><span class="p">();</span>
</code></pre></div>
<p><code>pushQuietly</code>メソッドを使用して、イベントを発生させずにモデルとその関連リレーションを保存することができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$post</span><span class="o">-&gt;</span><span class="na">pushQuietly</span><span class="p">();</span>
</code></pre></div>
<p><a name="the-create-method"></a></p>
<h3 id="create"><code>create</code>メソッド<a class="headerlink" href="#create" title="Permanent link">&para;</a></h3>
<p><code>save</code>および<code>saveMany</code>メソッドに加えて、属性の配列を受け取り、モデルを作成し、データベースに挿入する<code>create</code>メソッドを使用することもできます。<code>save</code>と<code>create</code>の違いは、<code>save</code>が完全なEloquentモデルインスタンスを受け取るのに対し、<code>create</code>はプレーンなPHPの<code>array</code>を受け取ることです。<code>create</code>メソッドによって新しく作成されたモデルが返されます:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Post</span><span class="p">;</span>

<span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$comment</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">([</span>
    <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;A new comment.&#39;</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div>
<p><code>createMany</code>メソッドを使用して複数の関連モデルを作成できます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$post</span> <span class="o">=</span> <span class="nx">Post</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$post</span><span class="o">-&gt;</span><span class="na">comments</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createMany</span><span class="p">([</span>
    <span class="p">[</span><span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;A new comment.&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Another new comment.&#39;</span><span class="p">],</span>
<span class="p">]);</span>
</code></pre></div>
<p><code>createQuietly</code>および<code>createManyQuietly</code>メソッドを使用して、イベントを発生させずにモデルを作成することができます:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">posts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createQuietly</span><span class="p">([</span>
    <span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Post title.&#39;</span><span class="p">,</span>
<span class="p">]);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">posts</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">createManyQuietly</span><span class="p">([</span>
    <span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;First post.&#39;</span><span class="p">],</span>
    <span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Second post.&#39;</span><span class="p">],</span>
<span class="p">]);</span>
</code></pre></div>
<p><code>findOrNew</code>、<code>firstOrNew</code>、<code>firstOrCreate</code>、および<code>updateOrCreate</code>メソッドを使用して、<a href="eloquent.html#upserts">リレーション上のモデルを作成および更新</a>することもできます。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>create</code>メソッドを使用する前に、<a href="eloquent.html#mass-assignment">マスアサインメント</a>のドキュメントを確認してください。</p>
</div>
<p><a name="updating-belongs-to-relationships"></a></p>
<h3 id="belongs-to_2">Belongs To リレーションの更新<a class="headerlink" href="#belongs-to_2" title="Permanent link">&para;</a></h3>
<p>子モデルを新しい親モデルに割り当てたい場合、<code>associate</code>メソッドを使用できます。この例では、<code>User</code>モデルは<code>Account</code>モデルへの<code>belongsTo</code>リレーションを定義しています。この<code>associate</code>メソッドは、子モデルの外部キーを設定します:</p>
<div class="highlight"><pre><span></span><code><span class="k">use</span> <span class="nx">App\Models\Account</span><span class="p">;</span>

<span class="nv">$account</span> <span class="o">=</span> <span class="nx">Account</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">account</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">associate</span><span class="p">(</span><span class="nv">$account</span><span class="p">);</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</code></pre></div>
<p>親モデルを子モデルから削除するには、<code>dissociate</code>メソッドを使用できます。このメソッドは、リレーションの外部キーを<code>null</code>に設定します:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">account</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">dissociate</span><span class="p">();</span>

<span class="nv">$user</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>
</code></pre></div>
<p><a name="updating-many-to-many-relationships"></a></p>
<h3 id="_59">多対多リレーションの更新<a class="headerlink" href="#_59" title="Permanent link">&para;</a></h3>
<p><a name="attaching-detaching"></a></p>
<h4 id="_60">アタッチ / デタッチ<a class="headerlink" href="#_60" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="nx">Eloquentは、多対多のリレーションシップをより便利に扱うためのメソッドも提供しています。例えば、ユーザーが多くの役割を持ち、役割が多くのユーザーを持つ場合を想像してみましょう。</span><span class="sb">`attach`</span><span class="nx">メソッドを使用して、リレーションシップの中間テーブルにレコードを挿入することで、ユーザーに役割を付与できます。</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="sb">``</span><span class="err">`</span><span class="nx">php</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="k">use</span> <span class="nx">App\Models\User</span><span class="p">;</span>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a>
<a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="nv">$roleId</span><span class="p">);</span>
</code></pre></div>
<p>モデルにリレーションシップを付与する際、中間テーブルに挿入される追加データの配列を渡すこともできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">(</span><span class="nv">$roleId</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;expires&#39;</span> <span class="o">=&gt;</span> <span class="nv">$expires</span><span class="p">]);</span>
</code></pre></div>
<p>ユーザーから役割を削除する必要がある場合もあります。多対多のリレーションシップレコードを削除するには、<code>detach</code>メソッドを使用します。<code>detach</code>メソッドは中間テーブルから適切なレコードを削除しますが、両方のモデルはデータベースに残ります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="c1">// ユーザーから単一の役割を外す...</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">detach</span><span class="p">(</span><span class="nv">$roleId</span><span class="p">);</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="c1">// ユーザーからすべての役割を外す...</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">detach</span><span class="p">();</span>
</code></pre></div>
<p>便宜上、<code>attach</code>と<code>detach</code>はIDの配列を入力として受け取ることもできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">detach</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">attach</span><span class="p">([</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a>    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;expires&#39;</span> <span class="o">=&gt;</span> <span class="nv">$expires</span><span class="p">],</span>
<a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a>    <span class="mi">2</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;expires&#39;</span> <span class="o">=&gt;</span> <span class="nv">$expires</span><span class="p">],</span>
<a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="p">]);</span>
</code></pre></div>
<p><a name="syncing-associations"></a></p>
<h4 id="_61">関連付けの同期<a class="headerlink" href="#_61" title="Permanent link">&para;</a></h4>
<p>多対多の関連付けを構築するために、<code>sync</code>メソッドを使用することもできます。<code>sync</code>メソッドは、中間テーブルに配置するIDの配列を受け取ります。指定された配列に含まれないIDは、中間テーブルから削除されます。したがって、この操作が完了した後、指定された配列内のIDのみが中間テーブルに存在することになります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">sync</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</code></pre></div>
<p>IDとともに追加の中間テーブルの値を渡すこともできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">sync</span><span class="p">([</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;expires&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</code></pre></div>
<p>同期する各モデルIDに同じ中間テーブルの値を挿入したい場合は、<code>syncWithPivotValues</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">syncWithPivotValues</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;active&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">]);</span>
</code></pre></div>
<p>指定された配列に含まれない既存のIDを切り離したくない場合は、<code>syncWithoutDetaching</code>メソッドを使用できます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">syncWithoutDetaching</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</code></pre></div>
<p><a name="toggling-associations"></a></p>
<h4 id="_62">関連付けのトグル<a class="headerlink" href="#_62" title="Permanent link">&para;</a></h4>
<p>多対多のリレーションシップは、指定された関連モデルIDの付与状態を「トグル」する<code>toggle</code>メソッドも提供しています。指定されたIDが現在付与されている場合は切り離され、現在切り離されている場合は付与されます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">toggle</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]);</span>
</code></pre></div>
<p>IDとともに追加の中間テーブルの値を渡すこともできます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">toggle</span><span class="p">([</span>
<a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>    <span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;expires&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">],</span>
<a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>    <span class="mi">2</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">&#39;expires&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">],</span>
<a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="p">]);</span>
</code></pre></div>
<p><a name="updating-a-record-on-the-intermediate-table"></a></p>
<h4 id="_63">中間テーブルのレコードを更新する<a class="headerlink" href="#_63" title="Permanent link">&para;</a></h4>
<p>リレーションシップの中間テーブルの既存の行を更新する必要がある場合は、<code>updateExistingPivot</code>メソッドを使用できます。このメソッドは、中間レコードの外部キーと更新する属性の配列を受け取ります。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="nv">$user</span> <span class="o">=</span> <span class="nx">User</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>
<a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">updateExistingPivot</span><span class="p">(</span><span class="nv">$roleId</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>    <span class="s1">&#39;active&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,</span>
<a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="p">]);</span>
</code></pre></div>
<p><a name="touching-parent-timestamps"></a></p>
<h2 id="_64">親のタイムスタンプを更新する<a class="headerlink" href="#_64" title="Permanent link">&para;</a></h2>
<p>モデルが別のモデルへの<code>belongsTo</code>または<code>belongsToMany</code>リレーションシップを定義している場合、例えば<code>Comment</code>が<code>Post</code>に属している場合、子モデルが更新されたときに親のタイムスタンプを自動的に更新すると便利なことがあります。</p>
<p>例えば、<code>Comment</code>モデルが更新されたとき、所有する<code>Post</code>の<code>updated_at</code>タイムスタンプを現在の日付と時刻に設定したい場合があります。これを実現するには、子モデルに<code>touches</code>プロパティを追加し、子モデルが更新されたときに<code>updated_at</code>タイムスタンプを更新する必要があるリレーションシップの名前を含めます。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="o">&lt;?</span><span class="nx">php</span>
<a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
<a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="k">namespace</span> <span class="nx">App\Models</span><span class="p">;</span>
<a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a>
<a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Relations\BelongsTo</span><span class="p">;</span>
<a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a>
<a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="k">class</span> <span class="nc">Comment</span> <span class="k">extends</span> <span class="nx">Model</span>
<a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="p">{</span>
<a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a>    <span class="sd">/**</span>
<a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="sd">     * 更新されるリレーションシップ</span>
<a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="sd">     *</span>
<a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a><span class="sd">     * @var array</span>
<a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a><span class="sd">     */</span>
<a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>    <span class="k">protected</span> <span class="nv">$touches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">];</span>
<a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a>
<a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a>    <span class="sd">/**</span>
<a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a><span class="sd">     * コメントが属する投稿を取得する</span>
<a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a><span class="sd">     */</span>
<a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a>    <span class="k">public</span> <span class="k">function</span> <span class="nf">post</span><span class="p">()</span><span class="o">:</span> <span class="nx">BelongsTo</span>
<a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a>    <span class="p">{</span>
<a id="__codelineno-65-22" name="__codelineno-65-22" href="#__codelineno-65-22"></a>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">belongsTo</span><span class="p">(</span><span class="nx">Post</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-65-23" name="__codelineno-65-23" href="#__codelineno-65-23"></a>    <span class="p">}</span>
<a id="__codelineno-65-24" name="__codelineno-65-24" href="#__codelineno-65-24"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>親モデルのタイムスタンプは、子モデルがEloquentの<code>save</code>メソッドを使用して更新された場合にのみ更新されます。</p>
</div>









  




                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
<nav class="md-footer-nav">
    
    
</nav>

    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["back-to-top", "navigation.expand", "navigation.tabs", "navigation.footer", "navigation.sections", "navigation.expand", "content.code.copy", "hide_repository_button", "content.code.annotate", "content.tabs.link", "toc.none", "content.action.edit"], "search": "assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.56dfad97.min.js"></script>
      
    
  </body>
</html>